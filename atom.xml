<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>杨帅的博客</title>
  
  <subtitle>amosyang</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="yd.yangshuaiweb.com/"/>
  <updated>2021-04-14T01:47:15.798Z</updated>
  <id>yd.yangshuaiweb.com/</id>
  
  <author>
    <name>杨帅</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从一道题浅聊 await v8 实现</title>
    <link href="yd.yangshuaiweb.com/2021/04/12/cong-yi-dao-ti-qian-liao-await-v8-shi-xian/"/>
    <id>yd.yangshuaiweb.com/2021/04/12/cong-yi-dao-ti-qian-liao-await-v8-shi-xian/</id>
    <published>2021-04-12T13:53:00.000Z</published>
    <updated>2021-04-14T01:47:15.798Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一道很简单的-event-loop-面试题"><a href="#一道很简单的-event-loop-面试题" class="headerlink" title="一道很简单的 event loop 面试题"></a>一道很简单的 event loop 面试题</h1><pre class=" language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end after await'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise.then 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise.then 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这道题看起来很简单，但是其中隐含了一个极度迷惑的点，究竟是 <strong>async1 end after await</strong> 先执行还是 <strong>promise.then 1</strong> 先执行？看起来好像都属于 Promise 这一趴的微任务，那么先进先出对不对？</p><p><strong>答案是错误的，这个跟 node 版本有关系，确切的说跟 v8 版本是有关系的，具体 node 版本表现如下</strong></p><ul><li><strong>8 ~ 9： await 后面的打印先执行，其中 7 中并没有完全支持 async 方法，这里暂且不做讨论。</strong></li><li><strong>10 ~ 11： promise.then 先执行。</strong></li><li><strong>12+： await 后面的打印先执行。</strong><image src="https://tva1.sinaimg.cn/large/008eGmZEly1gpi0pce214j30fo1dynhm.jpg" width="200"></image></li></ul><h1 id="为什么会这样呢？-v8做了什么手脚？"><a href="#为什么会这样呢？-v8做了什么手脚？" class="headerlink" title="为什么会这样呢？ v8做了什么手脚？"></a>为什么会这样呢？ v8做了什么手脚？</h1><p>v8 从 Node.js 8(V8 v6.2/Chrome 62)开始，就完全支持异步函数(Async)，从 Node.js 10(V8 v6.8/Chrome 68)开始，就完全支持异步迭代器(Async iterators)和生成器(Generators)！</p><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>在 V8 v5.5(chrome55 &amp; Node.js 7)和 V8 v6.8(chrome68 &amp; Node.js 10)之间，v8 已经成功地提高了异步代码的性能，开发人员可以安全地使用这些新的编程范例，而不必担心速度问题。</p><p><strong>异步代码执行时间测试：</strong><br><image src="https://v8.dev/_img/fast-async/doxbee-benchmark.svg" width="500"></image></p><p><strong>并行异步代码测试（Promise.all）：</strong><br><image src="https://v8.dev/_img/fast-async/parallel-benchmark.svg" width="500"><br>可以看到，并行的异步代码，在新的 node 版本上性能提升了 8 倍之多。</image></p><p>然而，上述测试都是在单独测试的异步代码，那么在实际项目中表现如何呢？这里，v8 官方公布了在不同 node 框架上的性能提升对比。</p><p><strong>不同框架下，每秒请求量统计：</strong><br><image src="https://v8.dev/_img/fast-async/http-benchmarks.svg" width="500"><br>上面的图表可视化了一些流行的 HTTP 中间件框架的性能，这些框架大量使用了 promises 和 async 函数。请注意，这个图表显示的是请求/秒的数量，因此与前面的图表不同，越高越好。在 Node.js 7(V8 v5.5)和 Node.js 10(V8 v6.8)之间，这些框架的性能有了显著提高。</image></p><p>这些性能的提升来自三个地方：</p><ol><li>编译器的优化 <a href="https://v8.dev/docs/turbofan" target="_blank" rel="noopener">the new optimizing compiler 🎉</a></li><li>新的垃圾回收机制 <a href="https://v8.dev/blog/orinoco" target="_blank" rel="noopener">the new garbage collector 🚛</a></li><li>a Node.js 8 bug causing await to skip microticks</li></ol><p><strong>注意第三点，Node 8 存在一个 bug，它会使 await 后面的代码跳过微任务，直接导致 await 后的代码先于 promise.then 执行，也就是前面测试得到的结果, 此 bug 在 Node 10 中被修复，并于 Node 12 中给予 v8 开发团队启发， 做了类似的优化。</strong></p><h2 id="让我们看下-v8-引擎对-await-做了什么"><a href="#让我们看下-v8-引擎对-await-做了什么" class="headerlink" title="让我们看下 v8 引擎对 await 做了什么"></a>让我们看下 v8 引擎对 await 做了什么</h2><p>这里有一个简单的 async 函数 foo:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">await</span> v<span class="token punctuation">;</span>  <span class="token keyword">return</span> w<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>大体上，我们可以认为，当调用时，它将参数 v 封装到一个 promise 中，并挂起 async 函数的执行，直到这个 promise 被解析。一旦发生这种情况，函数的执行将继续，并为 w 分配 返回的 promise 对象。然后从 async 函数返回这个值。</p><p><strong>让我们来看一些 v8 更细节的实现流程，这也是我们今天主要讨论的内容(这里是 node 10的实现)，如图所示：</strong><br><image src="https://v8.dev/_img/fast-async/await-under-the-hood.svg" width="500"></image></p><ol><li><strong>首先把 v8 把函数 foo 标记成可恢复的(resumable), 这意味着执行可以暂停并在稍后恢复。 然后它创建所谓的 implicit_promise，这是在调用 async 函数时返回的 promise 对象，并最终解析为 async 函数返回的值，这点很类似 new 调用函数，创建一个空对象一样。</strong></li><li><strong>又创建一个 promise，然后包裹传入的值 v，也就是说把传入的值包装成了一个 promise。</strong></li><li><strong>再次创建 promise，也就是 throwway，去把这个附加到包装后的值上面，也就是说，当包装成 promise 后的 v 执行的时候(pending)，此时 throwway 负责暂停了 foo 函数的执行，并将 implicit_promise 返回给调用者，一旦包装后的 v 得到成功的结果(fulfilled), 首先会恢复 foo 函数的执行，然后将返回值赋给 implicit_promise，再转交给 w 来表示。</strong></li></ol><p>三次创建 promise 就是我们性能开销的主要来源，特别是如果输入的 v 已经是一个 promise 对象，这是对性能的极大浪费，我们是否判断它本身是不是一个 promise 再决定是否创建新的 promise 来包装它呢。</p><p><strong>事实上，新版规范中已经有一个 promiseResolve 操作，只在需要时执行包装:</strong><br><image src="https://v8.dev/_img/fast-async/await-code-comparison.svg" width="600"><br><strong>我们可以看到，如果 v 已经是一个 promise 对象的话，就省略了一次包装 v 的构建，其次又复用了 implicit_promise(取代掉累赘的 throwway)，从三次构建 promise 到 一次构建，执行速度提升了三倍，在这种情况下，我们将从最少3微秒变为仅仅1微秒。这种行为类似于 Node.js 8所做的，只不过现在它不再是一个 bug ーー 它现在是一个标准化的优化！</strong></image></p><p><strong>这个新行为在 V8 v7.2 (node v12)中已经默认启用。对于 V8 v7.1，可以使用 – harmony-await-optimization 标志启用新行为。</strong><br><image src="https://v8.dev/_img/fast-async/node-10-vs-node-12.svg" width="600"></image></p><p><strong>比较 Node.js 10中的 await 和 Node.js 12中可能出现的优化 await，可以看出这一变化对性能的影响:</strong><br><image src="https://v8.dev/_img/fast-async/benchmark-optimization.svg" width="600"></image></p><p>Async/await 现在比手写的承诺代码性能更好。这里的关键要点是，我们通过修补规范，大大降低了异步函数的开销——不仅在 V8中，而且在所有 JavaScript 引擎中都是如此。</p><p><strong>在 V8 v7.2和 chrome72中，默认启用了 harmony-await 优化。ECMAScript 规范的补丁被合并了。</strong></p><p><strong>你明白了么？</strong></p><p>参考资料：<br><a href="!https://v8.dev/blog/fast-async">v8 blog</a><br><a href="!https://blog.csdn.net/lovermeiy/article/details/110985294">v8 如何执行一段 JS 代码</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;一道很简单的-event-loop-面试题&quot;&gt;&lt;a href=&quot;#一道很简单的-event-loop-面试题&quot; class=&quot;headerlink&quot; title=&quot;一道很简单的 event loop 面试题&quot;&gt;&lt;/a&gt;一道很简单的 event loop 面试题&lt;/
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>webpack5 新特性</title>
    <link href="yd.yangshuaiweb.com/2020/12/19/webpack5-xin-te-xing/"/>
    <id>yd.yangshuaiweb.com/2020/12/19/webpack5-xin-te-xing/</id>
    <published>2020-12-19T07:45:00.000Z</published>
    <updated>2020-12-19T10:25:31.937Z</updated>
    
    <content type="html"><![CDATA[<h1 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h1><ul><li>新建项目  webpack5-taste</li><li>yarn init -y</li><li>yarn add webpack webpack-cli -D</li><li>新建 webpack.config.js</li></ul><h1 id="0-配置打包（webpack4也可以0配置，但是远没有5强大）"><a href="#0-配置打包（webpack4也可以0配置，但是远没有5强大）" class="headerlink" title="0 配置打包（webpack4也可以0配置，但是远没有5强大）"></a>0 配置打包（webpack4也可以0配置，但是远没有5强大）</h1><p>新建 src/a.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'Jack'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span></code></pre><p>src/b.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> b <span class="token keyword">from</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>a<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>webpack.config.js</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">}</span></code></pre><p>执行打包命令 webpack，发现可以成功打包，并且打包后代码的启动文件等均为箭头函数了！</p><h1 id="更小打包体积"><a href="#更小打包体积" class="headerlink" title="更小打包体积"></a>更小打包体积</h1><p>在切换 mode 为 production 后，我们发现打包内容只有代码 438 字节。</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">[</span>webpack<span class="token operator">-</span>cli<span class="token punctuation">]</span> Compilation finishedasset main<span class="token punctuation">.</span>js <span class="token number">43</span> bytes <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span> <span class="token punctuation">[</span>minimized<span class="token punctuation">]</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> main<span class="token punctuation">)</span>orphan modules <span class="token number">93</span> bytes <span class="token punctuation">[</span>orphan<span class="token punctuation">]</span> <span class="token number">2</span> modules<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token operator">+</span> <span class="token number">1</span> modules <span class="token number">102</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span> <span class="token punctuation">[</span>code generated<span class="token punctuation">]</span>webpack <span class="token number">5.11</span><span class="token punctuation">.</span><span class="token number">0</span> compiled successfully <span class="token keyword">in</span> <span class="token number">176</span> ms</code></pre><p>而 webpack4 同样代码，打包内容为 1.07kb，这么点代码 5 比 4 打包小了接近1kb..</p><pre class=" language-js"><code class="language-js">Hash<span class="token punctuation">:</span> 32dfad9d9e7e2bb3313aVersion<span class="token punctuation">:</span> webpack <span class="token number">4.44</span><span class="token punctuation">.</span><span class="token number">2</span>Time<span class="token punctuation">:</span> 225msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">38</span>    Asset      Size  Chunks             Chunk Namesbundle<span class="token punctuation">.</span>js  <span class="token number">1.05</span> KiB       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainEntrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token operator">+</span> <span class="token number">2</span> modules <span class="token number">145</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">52</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>b<span class="token punctuation">.</span>js <span class="token number">43</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>a<span class="token punctuation">.</span>js <span class="token number">50</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre><h1 id="嵌套的-tree-shaking"><a href="#嵌套的-tree-shaking" class="headerlink" title="嵌套的 tree shaking"></a>嵌套的 tree shaking</h1><p>分析 webpack5 打包后的文件</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token string">"use strict"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>excuse me? </p><p>age = 18 被完全干掉了，在 webpack4 中无法处理包装了一层的模块引用中的 tree shaking，在webpack5 中得以修复，并删除了全部的 runtime 注入代码。</p><p>并且也支持 common JS 的 tree shaking 啦。</p><p>同样再看一个栗子</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> something <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./something'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> something<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>如果 test 方法没有被调用，在 webpack4 中， something 这个模块也会被打包，而在 webpack5 中会被干掉。</p><h1 id="不再为-Node-js-模块-自动引用-Polyfills"><a href="#不再为-Node-js-模块-自动引用-Polyfills" class="headerlink" title="不再为 Node.js 模块 自动引用 Polyfills"></a>不再为 Node.js 模块 自动引用 Polyfills</h1><p>不再为 Node.js 内置模块自动添加 Polyfills。任何项目中有引用 Node.js 内置模块，在 webpack 4 或之前的版本中会自动添加 Polyfills。但 webpack 5 将不会再这样做，webpack会投入更多的精力到前端模块的兼容性工作中。</p><p>如果你的代码中有引用这些 Node.js 的模块，要升级到 webpack 5, 将尽量使用前端的模块，或者自行手动添加适合的 Polyfills。</p><p>而针对那些类库的开发者，请在 package.json 中定义 browser 字段，使类库在前端能适用。</p><h1 id="清理已弃用的功能"><a href="#清理已弃用的功能" class="headerlink" title="清理已弃用的功能"></a>清理已弃用的功能</h1><p>所有在 webpack 4 标记即将过期的功能，都已在该版移除。因此在迁移到 webpack 5 之前，请确保你在 webpack 4 运行的构建不会有任何的功能过期警告。</p><h1 id="不再需要的魔法注释"><a href="#不再需要的魔法注释" class="headerlink" title="不再需要的魔法注释"></a>不再需要的魔法注释</h1><p>在开发模式下，默认启用的新命名代码块 ID 算法为模块（和文件名）提供了人类可读的名称。 模块 ID 由其路径决定，相对于 context。代码块 ID 由代码块的内容决定。</p><p>所以你不再需要使用import(/* webpackChunkName: “name” */ “module”)来调试。但如果你想控制生产环境的文件名，还是有意义的。</p><p>可以在生产环境中使用 chunkIds: “named” 在生产环境中使用，但要确保不要不小心暴露模块名的敏感信息。</p><p>迁移：如果你不喜欢在开发中改变文件名，你可以通过 chunkIds: “natural” 来使用旧的数字模式。</p><h1 id="模块联邦"><a href="#模块联邦" class="headerlink" title="模块联邦"></a>模块联邦</h1><p>Webpack 5 增加了一个新的功能 “模块联邦”，它允许多个 webpack 构建一起工作。从运行时的角度来看，多个构建的模块将表现得像一个巨大的连接模块图。从开发者的角度来看，模块可以从指定的远程构建中导入，并以最小的限制来使用。</p><h1 id="output-可选的输出-ecma-标准"><a href="#output-可选的输出-ecma-标准" class="headerlink" title="output 可选的输出 ecma 标准"></a>output 可选的输出 ecma 标准</h1><p>webpack4 默认只能输出 ES5 代码，webpack5 开始新增一个属性 oupput.ecmaVersion，可以生吃 ES5 和 ES6/ES2015 代码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  out<span class="token punctuation">:</span> <span class="token punctuation">{</span>    ecmaVersion<span class="token punctuation">:</span> <span class="token number">2015</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="splitChunk-设置不同资源的分割阈值"><a href="#splitChunk-设置不同资源的分割阈值" class="headerlink" title="splitChunk 设置不同资源的分割阈值"></a>splitChunk 设置不同资源的分割阈值</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack4</span>mionSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 超过30k 提取出单独chunk</span><span class="token comment" spellcheck="true">// webpack5 可以对不同类型的资源单独设置</span>miniSize<span class="token punctuation">:</span> <span class="token punctuation">{</span>  javascript<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>  style<span class="token punctuation">:</span> <span class="token number">50000</span>  <span class="token punctuation">}</span></code></pre><h1 id="持久缓存提高构建性能"><a href="#持久缓存提高构建性能" class="headerlink" title="持久缓存提高构建性能"></a>持久缓存提高构建性能</h1><p>我们之前有 babel 的 cache 做源文件处理的缓存，或者通过 terser-webpack-plugin 进行 js 压缩的时候来做文件的缓存。webpack5 新增了个属性 cache，可以更好地缓存构建后的资源，从而第二次打包的速度会大大加快。</p><pre class=" language-js"><code class="language-js">cache<span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 磁盘存储 filesystem, 内存存储 memorage</span>  type<span class="token punctuation">:</span> <span class="token string">"filesystem"</span><span class="token punctuation">,</span>     buildDependencies<span class="token punctuation">:</span> <span class="token punctuation">{</span>    config<span class="token punctuation">:</span> <span class="token punctuation">[</span> __filename <span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 当你 CLI 自动添加它时，你可以忽略它</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="更好的监视文件打包机制"><a href="#更好的监视文件打包机制" class="headerlink" title="更好的监视文件打包机制"></a>更好的监视文件打包机制</h1><p>webpack4 总是在第一次构建时输出全部文件，但是监视重新构建时会只更新修改的文件。此次更新在第一次构建时会找到输出文件看是否有变化，从而决定要不要输出全部文件。</p><h1 id="更好的算法和默认值来改善长期缓存"><a href="#更好的算法和默认值来改善长期缓存" class="headerlink" title="更好的算法和默认值来改善长期缓存"></a>更好的算法和默认值来改善长期缓存</h1><p>contenthash 会以更好的算法来进行计算，从而优化性能。<strong>当使用[contenthash]时，Webpack 5 将使用真正的文件内容哈希值。之前它 “只 “使用内部结构的哈希值。当只有注释被修改或变量被重命名时，这对长期缓存会有积极影响。这些变化在压缩后是不可见的。</strong></p><h1 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h1><ul><li>entry: ‘./src/index.js’</li><li>output.path: path.resolve(__dirname, ‘dist’)</li><li>output.filename: ‘[name].js’</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;创建项目&quot;&gt;&lt;a href=&quot;#创建项目&quot; class=&quot;headerlink&quot; title=&quot;创建项目&quot;&gt;&lt;/a&gt;创建项目&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;新建项目  webpack5-taste&lt;/li&gt;
&lt;li&gt;yarn init -y&lt;/li&gt;
&lt;li&gt;yarn
      
    
    </summary>
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/categories/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>贪心算法的实现、特性以及实战题目解析</title>
    <link href="yd.yangshuaiweb.com/2020/11/15/tan-xin-suan-fa-de-shi-xian-te-xing-yi-ji-shi-zhan-ti-mu-jie-xi/"/>
    <id>yd.yangshuaiweb.com/2020/11/15/tan-xin-suan-fa-de-shi-xian-te-xing-yi-ji-shi-zhan-ti-mu-jie-xi/</id>
    <published>2020-11-15T08:25:00.000Z</published>
    <updated>2020-11-15T10:14:15.840Z</updated>
    
    <content type="html"><![CDATA[<h1 id="贪心算法-Greedy-是什么"><a href="#贪心算法-Greedy-是什么" class="headerlink" title="贪心算法(Greedy)是什么"></a>贪心算法(Greedy)是什么</h1><p>贪心算法是一种在每一步选择中都采取在当前状态下最好或最优(即最有利)的选择，从而希望导致结果是全局最好或最优的算法。</p><p><strong>贪心算法与动态规划的不同在于它对每个子问题的解决方案都做出选择，不能回退。动态规划则会保存以前的运算结果，并根据以前的结果对当前进行选择，有回退功能。</strong></p><p>贪心法可以解决一些最优化问题，比如：求图中的最小生成树、求哈夫曼编码等。然而对于工程和生活中的问题，贪心法一般不能得到我们所要求的的答案。</p><p>一旦一个问题可以通过贪心法来解决，那么贪心法一般是解决这个问题的最好办法。由于贪心法的高效性以及其所求得的答案比较接近最优结果，贪心法也可以用作辅助算法或者直接解决一些要求结果不特别精确的问题。</p><h1 id="实战题目"><a href="#实战题目" class="headerlink" title="实战题目"></a>实战题目</h1><p>Coin Change 特别版本:</p><p><a href="https://leetcode-cn.com/problems/coin-change/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/coin-change/</a></p><p>当硬币可选集合固定：Coins = [20, 10, 5, 1]</p><p>求最少可以几个硬币拼出总数。比如 total = 36</p><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpyp0uifcj30r60e63yr.jpg" alt><br>这时候就可以用一种贪心法，比如先匹配20这个硬币，36最多能用去1个20，还剩16，再用次大的硬币(10)去匹配，还剩6，这样依次去匹配。这种情况下，就是贪心法的例子。贪心法的话，就每次用最优的去匹配，既然你能用20，为何用10或5或1呢。</p><p>但是很多情况下，贪心法是不成立的，这里成立的原因是因为硬币有整除的关系，看下一个例子<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpz5c8uhwj30rq0aw3yr.jpg" alt></p><p>我们明显看出，两个9相加为18即可，但是如果你用最大的10去匹配，如下图<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpz7krx0cj30rr0ckq35.jpg" alt><br>这时候得到的结果为[10, 1, 1, 1, 1, 1, 1, 1, 1]，明显不是最优结果。</p><p><strong>所以如果我们想用贪心法解决问题，第一问题要比较特殊，第二你要能够证明这个地方用最简单粗暴的贪心法是能够得到最优解的。</strong></p><h1 id="什么情况下用的贪心算法"><a href="#什么情况下用的贪心算法" class="headerlink" title="什么情况下用的贪心算法"></a>什么情况下用的贪心算法</h1><p>简单地说，问题能够分解成子问题来解决，子问题的最优解能递推到最终问题的最优解。这种子问题最优解称为最优子结构。其次还是重复下贪心和动规的差异~<br><strong>贪心算法与动态规划的不同在于它对每个子问题的解决方案都做出选择，不能回退。动态规划则会保存以前的运算结果，并根据以前的结果对当前进行选择，有回退功能。</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;贪心算法-Greedy-是什么&quot;&gt;&lt;a href=&quot;#贪心算法-Greedy-是什么&quot; class=&quot;headerlink&quot; title=&quot;贪心算法(Greedy)是什么&quot;&gt;&lt;/a&gt;贪心算法(Greedy)是什么&lt;/h1&gt;&lt;p&gt;贪心算法是一种在每一步选择中都采取在
      
    
    </summary>
    
      <category term="算法" scheme="yd.yangshuaiweb.com/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="yd.yangshuaiweb.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>深度优先搜索、广度优先搜索</title>
    <link href="yd.yangshuaiweb.com/2020/11/15/shen-du-you-xian-sou-suo-guang-du-you-xian-sou-suo/"/>
    <id>yd.yangshuaiweb.com/2020/11/15/shen-du-you-xian-sou-suo-guang-du-you-xian-sou-suo/</id>
    <published>2020-11-15T03:37:00.000Z</published>
    <updated>2020-11-15T08:24:20.574Z</updated>
    
    <content type="html"><![CDATA[<p>搜索的话，我们绝大多数处理方式都是暴力搜索，或者说是比较简单的搜索。也就是说，在搜索的时候，并没有人为的智能地去操作搜索，很多情况下它做的一件事情，就是把所有节点全部都遍历一次，然后找到你要的结果。</p><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkppsf4sxsj30rs0c8aag.jpg" alt></p><p>比如在上图中，如果我们要找个某个子节点，毫无疑问，是从根这边开始，先搜左子树，然后往下一个一个点走过去，然后走完之后再走右子树，直到找到我们的点。</p><p>我们要实现这样的遍历和搜索的话，每个节点都要访问一次，且仅访问一次(不然的话，我们的访问效率会非常低)，<strong>对于节点的访问顺序不同，就有深度优先和广度优先这两个概念，当然还有其他搜索，比如优先级优先，优先级优先的算法一般我们称为启发式搜索，而启发式搜索采用的估价函数以及搜索的整个效率问题的话，就已经超出了我们讨论的范围，而更多的是深度学习了。</strong></p><p>这种优先级优先，现在已经广泛应用在各种推荐算法和高级的搜索算法， 让你搜出你自己最感兴趣的内容，比如你每天打开抖音或者快手的话，就会给你推荐你最感兴趣的内容。</p><h1 id="DFS-深度优先搜索"><a href="#DFS-深度优先搜索" class="headerlink" title="DFS 深度优先搜索"></a>DFS 深度优先搜索</h1><h2 id="python-代码示例-二叉树"><a href="#python-代码示例-二叉树" class="headerlink" title="python 代码示例 (二叉树)"></a>python 代码示例 (二叉树)</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> dfs <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">//</span> 递归终止条件  <span class="token keyword">if</span> node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>    <span class="token keyword">return</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>  dfs<span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span>  dfs<span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h2 id="二叉树深度优先的遍历顺序"><a href="#二叉树深度优先的遍历顺序" class="headerlink" title="二叉树深度优先的遍历顺序"></a>二叉树深度优先的遍历顺序</h2><p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkptkp1yf9j314n0u0qan.jpg" width="400"></image></p><h2 id="多叉树的代码示例"><a href="#多叉树的代码示例" class="headerlink" title="多叉树的代码示例"></a>多叉树的代码示例</h2><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">递归</font></p><pre class=" language-python"><code class="language-python">visited <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> dfs <span class="token punctuation">(</span>node<span class="token punctuation">,</span> visited<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true"># 递归终止条件</span>  <span class="token keyword">if</span> node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>    <span class="token keyword">return</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># do some thing on here</span>  <span class="token comment" spellcheck="true"># drill down</span>  <span class="token keyword">for</span> next_node <span class="token keyword">in</span> node<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> next_node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>      dfs<span class="token punctuation">(</span>next_node<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">非递归</font></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">DFS</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tree<span class="token punctuation">)</span>  <span class="token keyword">if</span> tree<span class="token punctuation">.</span>root <span class="token keyword">is</span> None<span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  visited<span class="token punctuation">,</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>tree<span class="token punctuation">.</span>root<span class="token punctuation">]</span>  <span class="token keyword">while</span> stack<span class="token punctuation">:</span>    node <span class="token operator">=</span> stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>    visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 对node节点做一些业务操作</span>    process<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 生成新的nodes</span>    nodes <span class="token operator">=</span> generate_related_nodes<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    stack<span class="token punctuation">.</span>push<span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># other processing work</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="图的深度优先遍历"><a href="#图的深度优先遍历" class="headerlink" title="图的深度优先遍历"></a>图的深度优先遍历</h2><p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpuicfcssj30rs0lsdg7.jpg" width="400"></image></p><h1 id="BFS-广度优先遍历"><a href="#BFS-广度优先遍历" class="headerlink" title="BFS 广度优先遍历"></a>BFS 广度优先遍历</h1><p>广度优先遍历就不再利用递归或者栈来实现了，而是用队列来实现。我们先从表象来看下广度优先遍历的顺序~<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpvmb60m4j30rs0l2aac.jpg" width="400"></image></p><h2 id="BFS-代码结构"><a href="#BFS-代码结构" class="headerlink" title="BFS 代码结构"></a>BFS 代码结构</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> BFS <span class="token punctuation">(</span>graph<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>  queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  queue<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">)</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>start<span class="token punctuation">)</span>  <span class="token keyword">while</span> queue<span class="token punctuation">:</span>    node <span class="token operator">=</span> queue<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>    visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    process<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    nodes <span class="token operator">=</span> generate_related_nodes<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    queue<span class="token punctuation">.</span>push<span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># other processing work</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;搜索的话，我们绝大多数处理方式都是暴力搜索，或者说是比较简单的搜索。也就是说，在搜索的时候，并没有人为的智能地去操作搜索，很多情况下它做的一件事情，就是把所有节点全部都遍历一次，然后找到你要的结果。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://tva1.sinaimg
      
    
    </summary>
    
      <category term="算法" scheme="yd.yangshuaiweb.com/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="yd.yangshuaiweb.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>分治、回溯的实现和特性</title>
    <link href="yd.yangshuaiweb.com/2020/11/14/fen-zhi-hui-su-de-shi-xian-he-te-xing/"/>
    <id>yd.yangshuaiweb.com/2020/11/14/fen-zhi-hui-su-de-shi-xian-he-te-xing/</id>
    <published>2020-11-14T08:36:00.000Z</published>
    <updated>2020-11-14T09:41:37.375Z</updated>
    
    <content type="html"><![CDATA[<p>分治和回溯其实本质上就是一个递归，这里单独拎出来讲解，你可以理解分治和回溯就是一种特殊或者较为复杂的递归即可。<strong>可以这么说，遇到一个需要递归的题目，我们会分析它的重复项，最近重复项的话，根据重复项怎么构造、怎么分解就有了分治、回溯之类的各种办法，最优重复性的话就是动态规划~</strong></p><h1 id="分治"><a href="#分治" class="headerlink" title="分治"></a>分治</h1><h2 id="什么是分治"><a href="#什么是分治" class="headerlink" title="什么是分治"></a>什么是分治</h2><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">分治，字面上的解释是“分而治之”，就是把一个复杂的问题分成两个或更多的相同或相似的子问题，再把子问题分成更小的子问题……直到最后子问题可以简单的直接求解，原问题的解即子问题的解的合并。</font></p><h2 id="分治的递归状态树"><a href="#分治的递归状态树" class="headerlink" title="分治的递归状态树"></a>分治的递归状态树</h2><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkosp54ahmj31xd0u0nos.jpg" alt></p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>看一个比较傻的问题，我们要把全部英文字母转成大写，分治的思路就是把问题拆分成单个字母转成大写，再组装结果返回的过程。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkota3j5cfj32140u0tad.jpg" alt></p><p>在计算机科学中，分治法就是运用分治思想的一种很重要的算法。分治法是很多高效算法的基础，如排序算法（快速排序，归并排序），傅立叶变换（快速傅立叶变换）等等。 <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">跟一般的递归相比，分治多了一步合并子结果得到最终结果的过程。</font></p><h1 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h1><h2 id="什么是回溯"><a href="#什么是回溯" class="headerlink" title="什么是回溯"></a>什么是回溯</h2><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">回溯法采用试错的思想，它尝试分步的去解决一个问题。在分步的过程中，当它通过尝试发现现有的分步答案不能得到有效的正确的解答的时候，它将取消上一步甚至是上几步的计算，再通过其他的可能的分步解答再次尝试寻找问题的答案。</font></p><p>回溯法通常用最简单的递归方法来实现，在反复重复上述的步骤后可能出现两种情况：</p><ul><li>找到一个可能存在的正确答案</li><li>在尝试了所有可能的分步方法后宣告该问题没有答案</li></ul><p><strong>在最坏的情况下，回溯法会导致一次复杂度为指数时间的计算。</strong></p><p>最典型的应用是在八皇后或者数独上面。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;分治和回溯其实本质上就是一个递归，这里单独拎出来讲解，你可以理解分治和回溯就是一种特殊或者较为复杂的递归即可。&lt;strong&gt;可以这么说，遇到一个需要递归的题目，我们会分析它的重复项，最近重复项的话，根据重复项怎么构造、怎么分解就有了分治、回溯之类的各种办法，最优重复性的话
      
    
    </summary>
    
      <category term="算法" scheme="yd.yangshuaiweb.com/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="yd.yangshuaiweb.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>二分查找的实现、特性及实战题目解析</title>
    <link href="yd.yangshuaiweb.com/2020/11/11/er-fen-cha-zhao-de-shi-xian-te-xing-ji-shi-zhan-ti-mu-jie-xi/"/>
    <id>yd.yangshuaiweb.com/2020/11/11/er-fen-cha-zhao-de-shi-xian-te-xing-ji-shi-zhan-ti-mu-jie-xi/</id>
    <published>2020-11-11T04:41:00.000Z</published>
    <updated>2020-11-15T12:31:39.121Z</updated>
    
    <content type="html"><![CDATA[<h1 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h1><p>二分查找也称折半查找（Binary Search），它是一种效率较高的查找方法。但是，折半查找要求线性表必须采用顺序存储结构，而且表中元素按关键字有序排列。</p><p>所以，想要进行二分查找，需要数据有以下前提：</p><ol><li>目标函数单调性(单调递增或者递减)</li><li>存在上下界(bounded)</li><li>能够通过索引访问(index accessible)</li></ol><h1 id="代码模板"><a href="#代码模板" class="headerlink" title="代码模板"></a>代码模板</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> right <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能不能整除哦</span>    <span class="token comment" spellcheck="true">// 找到啦</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token keyword">return</span> mid<span class="token punctuation">;</span>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">(</span>left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">(</span>right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>比如 在递增数组 [10, 14, 19, 26, 27, 31, 33, 42, 44]中，查找 31 所在的下标<br><image src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq2psc4z6j30rs0l13zs.jpg" width="500"><br>先查找中间值27, 发现 31 比27大，左边界变成 31 所在下标，右边界仍是数组结尾，这时会对比中间值 35 与 31 大小，接着移动边界，直到找出 31</image></p><h1 id="实战题目"><a href="#实战题目" class="headerlink" title="实战题目"></a>实战题目</h1><p><a href="https://leetcode-cn.com/problems/sqrtx/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/sqrtx/</a></p><p>实现 int sqrt(int x) 函数。</p><p>计算并返回 x 的平方根，其中 x 是非负整数。</p><p>由于返回类型是整数，结果只保留整数的部分，小数部分将被舍去。</p><h2 id="分析题目"><a href="#分析题目" class="headerlink" title="分析题目"></a>分析题目</h2><p>因为 x = y²，这个抛物线是在第一象限的，所以 y 的值是单调递增的，且有边界，因为 x 是非负整数，所以 y 最小值为0 (当x为0时), y最大值就为 x，所以针对 y 的求值可以用二分查找。</p><h2 id="coding"><a href="#coding" class="headerlink" title="coding"></a>coding</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mySqrt <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> right <span class="token operator">=</span> x<span class="token punctuation">;</span>  <span class="token keyword">var</span> mid<span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 防止越界</span>    mid <span class="token operator">=</span> left <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid <span class="token operator">*</span> mid <span class="token operator">></span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>      right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> right<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;二分查找&quot;&gt;&lt;a href=&quot;#二分查找&quot; class=&quot;headerlink&quot; title=&quot;二分查找&quot;&gt;&lt;/a&gt;二分查找&lt;/h1&gt;&lt;p&gt;二分查找也称折半查找（Binary Search），它是一种效率较高的查找方法。但是，折半查找要求线性表必须采用顺序存储结构
      
    
    </summary>
    
      <category term="算法" scheme="yd.yangshuaiweb.com/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="yd.yangshuaiweb.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>递归的实现、特性以及思维要点</title>
    <link href="yd.yangshuaiweb.com/2020/11/11/di-gui-de-shi-xian-te-xing-yi-ji-si-wei-yao-dian/"/>
    <id>yd.yangshuaiweb.com/2020/11/11/di-gui-de-shi-xian-te-xing-yi-ji-si-wei-yao-dian/</id>
    <published>2020-11-11T04:41:00.000Z</published>
    <updated>2020-11-14T07:59:26.498Z</updated>
    
    <content type="html"><![CDATA[<h1 id="递归是什么"><a href="#递归是什么" class="headerlink" title="递归是什么"></a>递归是什么</h1><p>递归本质上也是一种循环，只不过通过循环体调用自己来进行所谓的循环。</p><h1 id="一个简单的栗子"><a href="#一个简单的栗子" class="headerlink" title="一个简单的栗子"></a>一个简单的栗子</h1><p>我们拿阶乘举例</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这里拓展下 我们可以开启尾递归优化</span><span class="token keyword">function</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> total <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> total<span class="token punctuation">;</span>  total <span class="token operator">*</span><span class="token operator">=</span> n<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>递归实际执行过程如下<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkl55gtp1yj316y0t8duo.jpg" width="800"></image></p><h1 id="递归的代码模板"><a href="#递归的代码模板" class="headerlink" title="递归的代码模板"></a>递归的代码模板</h1><p>记住递归的结构能让我们在遇到这类问题的时候，更快、更完整的找到问题的方法。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">recursion</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> parma1<span class="token punctuation">,</span> parma1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 递归终止条件 返回结果</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> Max_level<span class="token punctuation">)</span> <span class="token keyword">return</span> process_result<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 处理当前层逻辑</span>  <span class="token function">process</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> data<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 下探到下一层</span>  self<span class="token punctuation">.</span><span class="token function">recursion</span><span class="token punctuation">(</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 清理当前层(当需要时)</span>  clear something<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h1 id="递归的思维要点"><a href="#递归的思维要点" class="headerlink" title="递归的思维要点"></a>递归的思维要点</h1><ul><li>不要人肉进行递归(最大误区)</li><li>找到最近最简的办法，将其拆解成可重复解决的问题(重复子问题)，比如计算n的阶乘，我们可以把这个问题拆解成找 n 和 Factorial(n - 1)相乘的结果</li><li>数学归纳法，寻找n = 1，n = 2成立，且直到 n 都成立的方法。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;递归是什么&quot;&gt;&lt;a href=&quot;#递归是什么&quot; class=&quot;headerlink&quot; title=&quot;递归是什么&quot;&gt;&lt;/a&gt;递归是什么&lt;/h1&gt;&lt;p&gt;递归本质上也是一种循环，只不过通过循环体调用自己来进行所谓的循环。&lt;/p&gt;
&lt;h1 id=&quot;一个简单的栗子&quot;&gt;&lt;a 
      
    
    </summary>
    
      <category term="算法" scheme="yd.yangshuaiweb.com/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="yd.yangshuaiweb.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>4. 树 -二叉树、二叉搜索树</title>
    <link href="yd.yangshuaiweb.com/2020/10/31/shu-er-cha-shu-er-cha-sou-suo-shu/"/>
    <id>yd.yangshuaiweb.com/2020/10/31/shu-er-cha-shu-er-cha-sou-suo-shu/</id>
    <published>2020-10-31T03:47:02.000Z</published>
    <updated>2020-11-08T07:19:10.961Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>回忆下，我们说的链表是一维结构，它的查找节点时间复杂度是O(n)的，正式因为这个原因的话，后来就出现了跳表一样的结构，加上了更快的索引，比如从头指针直接跨到第二个节点，注意，这里涉及一个理念，前面也提到过，如果我们想加速，关键点是<strong>升维</strong>，常见的二维的数据结构有<strong>树和图</strong>。</p></blockquote><p>链表结构:<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dn0euezj30rr08zdgf.jpg" width="600"><br><span style="font-weight: bold;">如果链表的节点有多个next指针，指向多个节点，那么它就变成了一个数🌲状结构了。接下来，我们认识一种新的数据结构 - 树。<span></span></span></image></p><h1 id="Tree-树"><a href="#Tree-树" class="headerlink" title="Tree 树"></a>Tree 树</h1><blockquote><p>树是一种数据结构，它是由n(n&gt;=1)个有限结点组成一个具有层次关系的集合。把它叫做“树”是因为它看起来像一棵倒挂的树，也就是说它是根朝上，而叶朝下的。每个结点有零个或多个子结点；没有父结点的结点称为根结点；每一个非根结点有且只有一个父结点；除了根结点外，每个子结点可以分为多个不相交的子树.</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dsdgrhqj30rq0db74j.jpg" alt><br>首先它有个根节点(root)，B节点和C节点都是它的子树🌲，我们称B和C为左子树和右子树，它们是彼此的兄弟节点，同时B和C节点又为它们子节点的父节点。树还分了不同的层，root节点为第0层，B和C为第一层。</p><h2 id="定义树节点"><a href="#定义树节点" class="headerlink" title="定义树节点"></a>定义树节点</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="Binary-Tree-二叉树"><a href="#Binary-Tree-二叉树" class="headerlink" title="Binary Tree 二叉树"></a>Binary Tree 二叉树</h2><blockquote><p>现实中用的更多的还是二叉树，二叉树的子节点只有2个。</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dz9qlsqj30rr0cemxe.jpg" alt></p><h2 id="树的延伸-Graph-图-简介"><a href="#树的延伸-Graph-图-简介" class="headerlink" title="树的延伸 - Graph 图(简介)"></a>树的延伸 - Graph 图(简介)</h2><p>那么树和图最关键的一个差别是什么呢，就是看有没有环装结构，如果节点本身的话，只连到新的儿子节点，永远不会走回去，如下图，如果F节点有个next指针指向了E，或者指向了A，或者指向了它的父节点C的话，那么就相当于形成了一个环，这是我们按照定义不称为树，而是叫做图。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8e5tnehlj30rs0evq3b.jpg" width="600"></image></p><p><strong>但是在特殊情况下，你也可以理解为Linked list就是特殊化的Tree(多个next指针的链表), Tree就是特殊化的Graph(没有环的🌲)。</strong></p><h2 id="树的遍历"><a href="#树的遍历" class="headerlink" title="树的遍历"></a>树的遍历</h2><ul><li>前序遍历(pre-order)：根-左-右</li><li>中序遍历(In-order)：左-根-右</li><li>后序遍历(Post-order)：右根左</li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * @descripe 前序遍历 * @param {TreeNode} root * @return {number[]} */</span><span class="token keyword">var</span> preorderTraversal <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">{</span>        arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前节点收集</span>        <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 左节点搜集</span>        <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 右节点搜集</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这么看来，我们要想查找某个节点的值，时间复杂度还是O(n)的，因为看来需要整个遍历一下，它和一个链表基本上没有太大的区别，那么树到底有什么优势呢？一般来说，树的结构我们会把它变得更加有序，这就好像你的宿舍或者你的办公室、或者你的电脑里面，经常使用的东西，把它排的相对有序的话，那你查找和维护起来就会更加有效，二叉树也是这样，这就是我们接下来要介绍的二叉搜索树。</p><h1 id="二叉搜索树-Binary-Search-Tree"><a href="#二叉搜索树-Binary-Search-Tree" class="headerlink" title="二叉搜索树 (Binary Search Tree)"></a>二叉搜索树 (Binary Search Tree)</h1><blockquote><p>二叉搜索树，也称为二叉排序树、有序二叉树(Ordered Binary Tree)、排序二叉树(Sorted Binary Tree)，是指一棵空树或者具有下列性质的二叉树：</p><ol><li>左子节点树上<strong>所有节点</strong>的值均小于它的根节点上的值</li><li>右子节点树上<strong>所有节点</strong>的值均大于它的根节点上的值</li><li>以此类推，左、右子树也分别为二叉查找树。(这就是重复性！)</li></ol></blockquote><p><strong>二叉搜索树的中序遍历就是升序遍历！！</strong> </p><h2 id="二叉搜索树常见操作"><a href="#二叉搜索树常见操作" class="headerlink" title="二叉搜索树常见操作"></a>二叉搜索树常见操作</h2><ul><li>查询</li><li>插入新节点(创建)</li><li>删除</li></ul><p>它的查询和插入都是O(logn)了，所以就相当于加速了。</p><p><a href="https://visualgo.net/zh/bst" target="_blank" rel="noopener">可视化操作</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;回忆下，我们说的链表是一维结构，它的查找节点时间复杂度是O(n)的，正式因为这个原因的话，后来就出现了跳表一样的结构，加上了更快的索引，比如从头指针直接跨到第二个节点，注意，这里涉及一个理念，前面也提到过，如果我们想加速，关键点是&lt;strong&gt;升
      
    
    </summary>
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>5. 堆和二叉堆</title>
    <link href="yd.yangshuaiweb.com/2020/10/31/dui-he-er-cha-dui/"/>
    <id>yd.yangshuaiweb.com/2020/10/31/dui-he-er-cha-dui/</id>
    <published>2020-10-31T02:30:20.000Z</published>
    <updated>2020-11-01T07:10:43.542Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Heap-堆"><a href="#Heap-堆" class="headerlink" title="Heap 堆"></a>Heap 堆</h1><p>Heap: <strong>可以迅速找到一堆数中的最大值或者最小值的数据结构，</strong>注意找<strong>最大值或最小值</strong>，两者只能取其一。</p><p><strong>将根节点最大的堆叫做大顶堆或大根堆，根节点最小的堆叫小顶堆或小根堆。常见的堆有二叉堆、斐波那契堆等。</strong></p><p>假设是大顶堆，则常见操作(API)及其对应复杂度：</p><ul><li>find-max：O(1)</li><li>delete-max：O(logN)</li><li>insert(create): O(logN) 或者 O(1)</li></ul><p>不同实现的比较：<a href="https://en.wikipedia.org/wiki/Heap_(data_structure)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Heap_(data_structure)</a></p><h1 id="二叉堆"><a href="#二叉堆" class="headerlink" title="二叉堆"></a>二叉堆</h1><p>通过完全二叉树来实现(注意：不是二叉搜索树)；二叉堆(大顶)它满足以下性质：</p><ol><li><strong>是一颗完全树🌲(根和每个节点都是满的，最下面一层最后一个节点之前所有的坑位都要占满)</strong></li><li><strong>树中任意节点的值总是 &gt;= 其子节点的值</strong></li><li><strong>它的实现相对比较容易，但是其实二叉堆的时间复杂度在所有堆类型里只是刚刚及格。</strong></li></ol><p>以下就为完全二叉树，除了最下面一层不是丰满状态以外，每一层都是满的，而且任意节点的值都是大于等于其子节点的。注意，这里70是最下面一层最后一个节点，70之前元素必须满才行，如果去掉50就不是完全树了，但是去掉70是可以的，去掉70之后50变成最后一个节点了，50之前节点满就行。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8wjpw0rtj30rs0fsq36.jpg" width="600"></image></p><p>由于它的这个性质，我们就能保证根节点就是最大的节点。</p><h2 id="二叉堆实现细节"><a href="#二叉堆实现细节" class="headerlink" title="二叉堆实现细节"></a>二叉堆实现细节</h2><ol><li>二叉堆一般都通过”数组”来实现</li><li>因为二叉堆是从根节点到左子，再到右子依次排下来，假设”第一个元素”在数组中的索引为0的话，上图中二叉堆对应数组为[110, 100, 90, 40, …]，则父节点和子节点的位置关系如下：<blockquote><ul><li>索引为i的左孩子的索引是(2 * i + 1)</li><li>索引为i的右孩子的索引是(2 * i + 2)</li><li>索引为i的父节点的索引是 Math.floor((n - 1) / 2) (向下取整)</li></ul></blockquote></li></ol><h2 id="二叉堆插入元素-Insert-O-logN"><a href="#二叉堆插入元素-Insert-O-logN" class="headerlink" title="二叉堆插入元素 Insert(O(logN))"></a>二叉堆插入元素 Insert(O(logN))</h2><ol><li>新元素一律插入到堆的尾部</li><li>依次向上调整到整个堆的结构(一直到根即可)</li></ol><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk937l4oxuj315l0u0n9d.jpg" width="500"><p>插入新元素会先添加到堆的尾部，也就是插到40的左子节点。</p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93bv0ly0j31ku0p0tgj.jpg" width="500"><p>然后要把85依次往上浮动，如果85大于他的父亲节点，那么就跟它的父亲节点交换位置，直到走到根节点。整个操作最坏会遍历一侧的堆，也就是O(log2的N次方)</p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93hf9nwdj31f00tgguz.jpg" width="500"><h2 id="二叉堆删除堆顶操作-Delete-Max-logn"><a href="#二叉堆删除堆顶操作-Delete-Max-logn" class="headerlink" title="二叉堆删除堆顶操作 Delete Max (logn)"></a>二叉堆删除堆顶操作 Delete Max (logn)</h2><ol><li>将堆尾的元素替换到顶部(即堆顶被替换删除掉)</li><li>依次从<strong>根部向下</strong>调整整个堆的结构(挪上去然后调整下来)</li></ol><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93r32959j31p50u0e0n.jpg" alt></p></image></image></image>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Heap-堆&quot;&gt;&lt;a href=&quot;#Heap-堆&quot; class=&quot;headerlink&quot; title=&quot;Heap 堆&quot;&gt;&lt;/a&gt;Heap 堆&lt;/h1&gt;&lt;p&gt;Heap: &lt;strong&gt;可以迅速找到一堆数中的最大值或者最小值的数据结构，&lt;/strong&gt;注意找&lt;st
      
    
    </summary>
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>6. 图</title>
    <link href="yd.yangshuaiweb.com/2020/10/31/tu/"/>
    <id>yd.yangshuaiweb.com/2020/10/31/tu/</id>
    <published>2020-10-31T02:30:20.000Z</published>
    <updated>2020-11-01T08:19:32.257Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><blockquote><p>不管是在面试还是在平时工程的时候，图相关的算法和应用都越来越少，特别是在现在算法面试中，基本上很少考图相关的东西，在这里的话，我们就粗略了解下即可，如果工程中需要用到图的，肯定要和实际要解决的业务情况相结合来考虑。</p></blockquote><h1 id="什么是图"><a href="#什么是图" class="headerlink" title="什么是图"></a>什么是图</h1><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pp8mv2rj307y057gm2.jpg" alt><br>图论〔Graph Theory〕是数学的一个分支。它以图为研究对象。<strong>图论中的图是由若干给定的点及连接两点的线所构成的图形</strong>，这种图形通常用来描述某些事物之间的某种特定关系，用点代表事物，用连接两点的线表示相应两个事物间具有这种关系。</p><p><strong>图论是一种表示 “多对多” 的关系。</strong></p><p><strong>图是由顶点和边组成的：(可以无边，但至少包含一个顶点)</strong></p><ul><li>一组顶点：通常用 V(vertex) 表示顶点集合</li><li>一组边：通常用 E(edge) 表示边的集合</li></ul><p><strong>图可以分为有向图和无向图，在图中：</strong></p><ul><li>(v, w) 表示无向边，即 v 和 w 是互通的</li><li>&lt;v, w&gt; 表示有向边，该边始于 v，终于 w</li></ul><p><strong>图可以分为有权图和无权图：</strong></p><ul><li>有权图：每条边具有一定的权重(weight)，通常是一个数字</li><li>无权图：每条边均没有权重，也可以理解为权为 1</li></ul><p><strong>图又可以分为连通图和非连通图：</strong></p><ul><li>连通图：所有的点都有路径相连</li><li>非连通图：存在某两个点没有路径相连</li></ul><p><strong>图中的顶点有度的概念：</strong></p><ul><li>度(Degree)：所有与它连接点的个数之和</li><li>入度(Indegree)：存在于有向图中，所有接入该点的边数之和</li><li>出度(Outdegree)：存在于有向图中，所有接出该点的边数之和</li></ul><h1 id="图的表示方法"><a href="#图的表示方法" class="headerlink" title="图的表示方法"></a>图的表示方法</h1><ol><li><strong>邻阶矩阵</strong><ul><li>在 n 个顶点的图需要有一个 n × n 大小的矩阵</li><li>在一个无权图中，矩阵坐标中每个位置值为 1 代表两个点是相连的，0 表示两点是不相连的</li><li>在一个有权图中，矩阵坐标中每个位置值代表该两点之间的权重，0 表示该两点不相连</li><li>在无向图中，邻接矩阵关于对角线相等</li></ul></li><li><strong>邻阶表</strong><ul><li>对于每个点，存储着一个链表，用来指向所有与该点直接相连的点</li><li>对于有权图来说，链表中元素值对应着权重</li></ul></li></ol><p>例如在无向无权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pv1nvexj30k00akgmx.jpg" alt></p><p>在无向有权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pxk9j16j31is0teqki.jpg" alt></p><p>可以看出<strong>在无向图中，邻接矩阵关于对角线对称。</strong></p><p>而在有向无权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9q26nmqxj31dw0t2gw2.jpg" alt></p><p><strong>邻接矩阵和链表对比：</strong><br>邻接矩阵由于没有相连的边也占有空间，因此存在浪费空间的问题，而邻接链表则比较合理地利用空间。<br>邻接链表比较耗时，牺牲很大的时间来查找，因此比较耗时，而邻接矩阵法相比邻接链表法来说，时间复杂度低。</p><h1 id="图的遍历"><a href="#图的遍历" class="headerlink" title="图的遍历"></a>图的遍历</h1><p>图的遍历就是要找出图中所有的点，一般有以下两种方法：</p><p><strong>1. 深度优先遍历：(Depth First Search, DFS)</strong><br>基本思路：深度优先遍历图的方法是，从图中某顶点 v 出发</p><ol><li>访问顶点 v</li><li>从 v 的未被访问的邻接点中选取一个顶点 w，从 w 出发进行深度优先遍历</li><li>重复上述两步，直至图中所有和v有路径相通的顶点都被访问到</li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 伪代码实现，类似于树的先序遍历</span><span class="token comment" spellcheck="true">// 图的遍历和树的DFS或者BFS最大区别是，树不会重复遍历节点，但是图会，所以需要加visited标识</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">DFS</span><span class="token punctuation">(</span>Vertex v<span class="token punctuation">)</span> <span class="token punctuation">{</span>  visited<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>v 的每个邻接点 W<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">DFS</span><span class="token punctuation">(</span>W<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>2. 广度优先搜索：(Breadth First Search, BFS)</strong><br>广度优先搜索，可以被形象地描述为 “浅尝辄止”，它也需要一个队列以保持遍历过的顶点顺序，以便按出队的顺序再去访问这些顶点的邻接顶点。<br>实现思路：</p><ol><li>顶点 v 入队列</li><li>当队列非空时则继续执行，否则算法结束</li><li>出队列取得队头顶点 v；访问顶点 v 并标记顶点 v 已被访问</li><li>查找顶点 v 的第一个邻接顶点 col</li><li>若 v 的邻接顶点 col 未被访问过的，则 col 继续</li><li>查找顶点 v 的另一个新的邻接顶点 col，转到步骤 5 入队列，直到顶点 v 的所有未被访问过的邻接点处理完。转到步骤 2</li></ol><p>要理解深度优先和广度优先搜索，首先要理解搜索步，一个完整的搜索步包括两个处理：</p><ol><li>获得当前位置上，有几条路可供选择</li><li>根据选择策略，选择其中一条路，并走到下个位置</li></ol><p><strong>相当于在漆黑的夜里，你只能看清你站的位置和你前面的路，但你不知道每条路能够通向哪里。</strong>搜索的任务就是，给出初始位置和目标位置，要求找到一条到达目标的路径。 </p><ul><li>深度优先就是，从初始点出发，不断向前走，如果碰到死路了，就往回走一步，尝试另一条路，直到发现了目标位置。这种不撞南墙不回头的方法，即使成功也不一定找到一条好路，但好处是需要记住的位置比较少。</li><li>广度优先就是，从初始点出发，把所有可能的路径都走一遍，如果里面没有目标位置，则尝试把所有两步能够到的位置都走一遍，看有没有目标位置；如果还不行，则尝试所有三步可以到的位置。这种方法，一定可以找到一条最短路径，但需要记忆的内容实在很多，要量力而行。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;不管是在面试还是在平时工程的时候，图相关的算法和应用都越来越少，特别是在现在算法面试中，基本上很少考图相关的东西，
      
    
    </summary>
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>3. 哈希表、映射、集合</title>
    <link href="yd.yangshuaiweb.com/2020/10/29/ha-xi-biao-ying-she-ji-he/"/>
    <id>yd.yangshuaiweb.com/2020/10/29/ha-xi-biao-ying-she-ji-he/</id>
    <published>2020-10-29T04:24:02.000Z</published>
    <updated>2020-10-31T03:47:26.272Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h1><blockquote><p>我们通常使用的 Map，Set 结构底层基本都是用 Hash 表来实现的，当然还有些会用到二叉树来实现。<strong>哈希表也叫散列表，是根据关键码值(key value)而直接进行访问的数据结构。它通过把要存储的值映射到表中的一个位置(key 或者 index)来访问记录，以加快查找的速度。</strong>这个映射函数叫散列函数(Hash Function)，存放记录的数组叫做哈希表(或散列表)。</p></blockquote><h1 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h1><blockquote><p>根据一个key(比如人名)来存储值的一些场景</p><ul><li>电话号码薄</li><li>用户信息表</li><li>缓存 (LRU Cache)</li><li>键值对存储 (比如Redis)</li></ul></blockquote><h1 id="Hash-Function"><a href="#Hash-Function" class="headerlink" title="Hash Function"></a>Hash Function</h1><p>我们首先来看下哈希表中，映射函数Hash Fuction做了什么<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6k96qiiij30ru0b8t9f.jpg" alt></p><blockquote><p>我们有一个string需要存储，它的值为 lies， 那如何存呢，方块代表哈希函数，lies传入后返回一个下标，如图所示返回一个整数9，这样存下即可。</p></blockquote><p>有同学可能会问，lies 下标为何对应9呢，有什么规律么，这就是所谓的 Hash 函数的处理，这个 Hash 函数有很多种，我们在这里列举一个简单的 Hash 函数，就是把每一个字符的 ASCII 码加在一起，然后再模上一个数，比如模上10，429 % 10 得到9。这就是一个简单的 Hash 函数，现实中一些 Hash 函数往往比较复杂，而且 Hash 函数选得好的话，可以让这些数值尽量的分散，而不会发生所谓的碰撞，因为这里的话，lies 算出来得9，那么其他字符也有可能为9，如下图:<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6myjezknj324i0tytrf.jpg" alt></p><p>也就是说，对于不同的要存储的数据，它经过 Hash 函数之后，如果得到一个相同的值，这种情况就叫做 <strong>Hash 碰撞</strong>。 </p><p>如果9这个位置要存多个元素，我们要做的事情也比较简单，可以依次往下面存，占别人的位置。当然还有一种更好的办法或者在工程上常用的一种方式是再增加一个维度，这个位置不止存一个数了，也就是从这里开始，拉出来一个链表，这样的方法叫做<strong>拉链式解决冲突法</strong>。原本需要 O(1) 复杂度的查询，<strong>最坏的情况下</strong>: 如果发生了很多 Hash 碰撞，它的查询时间就要遍历链表，如果链表很长，它就会效率退化，退化到所谓的 O(n) 级别。<strong>好的情况下</strong>: 如果设计的很好的话，Hash 函数碰撞的几率很小，所以在平均时刻的话，我们可以认为，整个 Hash 表的查询是 O(1)。</p><p>借助下图的完整结构，好好体会下。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6nbqnenxj31ni0u00z9.jpg" alt></p><h1 id="Hash-表的时间复杂度"><a href="#Hash-表的时间复杂度" class="headerlink" title="Hash 表的时间复杂度"></a>Hash 表的时间复杂度</h1><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6ngpd1o6j31me0u04fi.jpg" alt><br>我们发现，它的查询、添加、删除大部分都是 O(1) 的时间复杂度，但是在最坏的情况下，比如哈希函数选的非常不好，或者哈希表的整个 Size 太小了，就导致经常发生冲突，一冲突的话当前存储的值就会退化一个链表了，这个时候，它的时间复杂度就是 O(n) 了。现在计算机的内存越来越大，Hash 表可以开的很大很大，同时随着哈希函数的不断优化，一般来说，我们都可以认为哈希表在正常的情况下，就是 O(1) 的时间复杂度进行查询、添加和删除元素。</p><h1 id="Map-和-Set-结构"><a href="#Map-和-Set-结构" class="headerlink" title="Map 和 Set 结构"></a>Map 和 Set 结构</h1><blockquote><p>真正的工程中，我们使用的就不是 hash 表了，而是在它的基础上抽象出来的，使用比较多的就是 Map 和 Set。</p></blockquote><p><strong>Map： key-value对，key不重复</strong></p><ul><li>new HasMap() / new TreeMap() </li><li>map.Set(key, val)</li><li>map.get(key)</li><li>map.has(key)</li><li>map.size()</li><li>map.clear()</li></ul><p><strong>Set： 不重复元素的集合</strong></p><ul><li>new HashSet() / new TreeSet()</li><li>set.add(value)</li><li>set.delete(value)</li><li>set.has(value)</li></ul><p>注意：js中对象并不是严格意义上的hash映射<br><a href="https://juejin.im/post/6844903422420844557" target="_blank" rel="noopener">JS中 Object 作为 Hash 表使用避坑指北</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Hash-Table&quot;&gt;&lt;a href=&quot;#Hash-Table&quot; class=&quot;headerlink&quot; title=&quot;Hash Table&quot;&gt;&lt;/a&gt;Hash Table&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;我们通常使用的 Map，Set 结构底层基本都是用
      
    
    </summary>
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>实现 instanceof</title>
    <link href="yd.yangshuaiweb.com/2020/10/27/shou-xie-instanceof/"/>
    <id>yd.yangshuaiweb.com/2020/10/27/shou-xie-instanceof/</id>
    <published>2020-10-27T06:11:09.000Z</published>
    <updated>2020-10-27T06:13:45.810Z</updated>
    
    <content type="html"><![CDATA[<pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>left<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// left实例没有原型链了</span>    <span class="token keyword">let</span> proto <span class="token operator">=</span> left<span class="token punctuation">.</span>__proto__<span class="token punctuation">;</span>​    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ​        <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">==</span> right<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        proto <span class="token operator">=</span> proto<span class="token punctuation">.</span>__proto__<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;pre class=&quot; language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_instanceof&lt;/sp
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>手写Promise</title>
    <link href="yd.yangshuaiweb.com/2020/10/27/shou-xie-promise/"/>
    <id>yd.yangshuaiweb.com/2020/10/27/shou-xie-promise/</id>
    <published>2020-10-27T06:11:09.000Z</published>
    <updated>2020-11-18T02:13:33.317Z</updated>
    
    <content type="html"><![CDATA[<p>我们分步来实现promise</p><h1 id="step1-声明-Promise类并绑定this"><a href="#step1-声明-Promise类并绑定this" class="headerlink" title="step1: 声明_Promise类并绑定this"></a>step1: 声明_Promise类并绑定this</h1><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "fulfilled", value: "success"}</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "rejected", value: "fail"}</span></code></pre><p>这里需要注意的一点就是，回调函数需要绑定当前的this，不然因为class内部是严格模式，如果传入的函数执行了resolve或者reject方法时，里面的this为undefined，就会报错。</p><p><strong>我们发现，可以先执行resolve，再执行reject，不符合promise状态不可变的特性，所以进行我们的第二步修饰~</strong></p><h1 id="step2-状态保护与执行者异步错误捕获"><a href="#step2-状态保护与执行者异步错误捕获" class="headerlink" title="step2: 状态保护与执行者异步错误捕获"></a>step2: 状态保护与执行者异步错误捕获</h1><p>这个步骤我们做了两件事</p><ul><li><strong>当promise的状态为pending时，resolve和reject方法中才能更改状态。</strong></li><li><strong>如果cb执行过程中，出现错误，promise状态应该变成reject。所以要给cb增加try catch。</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "fulfilled", value: "success"}</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xxxsksks<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Promise {status: "rejected", value: ReferenceError: xxxsksks is not defined</span><span class="token comment" spellcheck="true">//     at &lt;anonymous>:3:17</span><span class="token comment" spellcheck="true">//     at new _Promise (&lt;anonymous>:6:…}</span></code></pre><h1 id="step3-Then的基础构建"><a href="#step3-Then的基础构建" class="headerlink" title="step3: Then的基础构建"></a>step3: Then的基础构建</h1><ul><li><strong>可以通过then接收promise返回结果，类中声明then方法</strong></li><li><strong>onFulfilled, onReject方法可以不传</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// success</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// fail</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不传reject回调 不会报错</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  </code></pre><h1 id="step4-实现Then的异步操作-微任务-与异常捕获"><a href="#step4-实现Then的异步操作-微任务-与异常捕获" class="headerlink" title="step4: 实现Then的异步操作(微任务)与异常捕获"></a>step4: 实现Then的异步操作(微任务)与异常捕获</h1><ul><li><strong>Then方法里的函数也可能报错，报错也要把promise变成rejected状态，也需要加try catch</strong></li><li><strong>利用setTimeout模拟微任务的执行顺序</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模拟微任务顺序</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ReferenceError: sn is not defined</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ReferenceError: sn is not defined</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// success</span></code></pre><h1 id="step5-Promise的-pending-状态处理"><a href="#step5-Promise的-pending-状态处理" class="headerlink" title="step5: _Promise的 pending 状态处理"></a>step5: _Promise的 pending 状态处理</h1><ul><li><strong>如果promise不是立即返回结果，也就是.then方法执行而且状态为pending，这时候需要记录回调函数，等待resolve或者reject执行时，执行回调</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 执行reslove时 执行成功回调</span>                task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行reslove时 执行失败回调</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 记录then方法中的回调函数 注意是一对一对的压哦 </span>                <span class="token comment" spellcheck="true">// 注意所有错误都交给reject方法 后续优化</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// VM8622:3 ReferenceError: cc is not defined</span></code></pre><h1 id="step6-异步回调执行顺序跳转"><a href="#step6-异步回调执行顺序跳转" class="headerlink" title="step6: 异步回调执行顺序跳转"></a>step6: 异步回调执行顺序跳转</h1><ul><li><strong>我们希望.then的回调永远是异步的 比如以下代码，我们期望先输出2，再输出1</strong><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  </code></pre></li></ul><p>ok， 来改写代码</p><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 记录then方法中的回调函数 注意是一对一对的压哦 </span>                <span class="token comment" spellcheck="true">// 注意所有错误都交给reject方法 后续优化</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 2</span><span class="token comment" spellcheck="true">// 1</span></code></pre><h1 id="step7-then-then-链式操作"><a href="#step7-then-then-链式操作" class="headerlink" title="step7: .then().then()链式操作"></a>step7: .then().then()链式操作</h1><ul><li><strong>因为每个.then都返回一个promise，我们可以用递归的方式，让.then方法返回一个新的_promsie, 新的_Promise 执行resolve或者reject方法传递上个then 的返回值</strong></li><li><strong>注意 then 返回值的promise状态默认是成功的</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'ys'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Uncaught TypeError: Cannot read property 'then' of undefined</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "000"</span><span class="token comment" spellcheck="true">// VM15140:9 success 111</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "111"</span><span class="token comment" spellcheck="true">// VM15140:9 fail 222</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "111"</span><span class="token comment" spellcheck="true">// VM15140:9 fail 222</span></code></pre><h1 id="step8-then-方法错误传递"><a href="#step8-then-方法错误传递" class="headerlink" title="step8: then()方法错误传递"></a>step8: then()方法错误传递</h1><ul><li><strong>.then方法内部错误，需要下一个.then的onReject来捕捉, 修改返回的_Promise的错误处理即可</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aaa<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'错了错了'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 错了错了 ReferenceError: aaa is not defined</span></code></pre><h1 id="step9-实现then-的穿透传递【reject穿透有问题呀】"><a href="#step9-实现then-的穿透传递【reject穿透有问题呀】" class="headerlink" title="step9: 实现then()的穿透传递【reject穿透有问题呀】"></a>step9: 实现then()的穿透传递【reject穿透有问题呀】</h1><ul><li><strong>如果then方法内部没有传递参数，把变量继续往下传递 return this.value</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 原生promise具有穿透的能力</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// reject 1</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve 1 我们也实现了这种穿透 但是reject 变成了 resolve ？？</span></code></pre><h1 id="step7-then返回promise的处理"><a href="#step7-then返回promise的处理" class="headerlink" title="step7: then返回promise的处理"></a>step7: then返回promise的处理</h1><ul><li><strong>如果then返回了一个new _Promise 需要找到对它进行取值返回操作</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 原生promise具有穿透的能力</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve  1</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token punctuation">}</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token punctuation">}</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve 1</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// reject 111</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//  reject 111</span></code></pre><h1 id="step10-优化重复代码"><a href="#step10-优化重复代码" class="headerlink" title="step10: 优化重复代码"></a>step10: 优化重复代码</h1><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><h1 id="step11-then返回类型约束-不能返回实例自身哦"><a href="#step11-then返回类型约束-不能返回实例自身哦" class="headerlink" title="step11: then返回类型约束(不能返回实例自身哦)"></a>step11: then返回类型约束(不能返回实例自身哦)</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'解决'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// TypeError: Chaining cycle detected for promise #&lt;Promise></span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'解决'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Uncaught TypeError: Chaining cycle detected</span></code></pre><h1 id="step12-resolve，reject静态方法实现-Promise-xxx"><a href="#step12-resolve，reject静态方法实现-Promise-xxx" class="headerlink" title="step12: resolve，reject静态方法实现(_Promise.xxx)"></a>step12: resolve，reject静态方法实现(_Promise.xxx)</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 普通值</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// promise 【我们发现后面的成功或者失败状态是依赖返回的promise的状态】</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// resolve: 成功</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// reject: 失败</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token comment" spellcheck="true">// 普通值</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// promsie</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 成功</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 失败</span></code></pre><h1 id="step13-Promise-all方法实现"><a href="#step13-Promise-all方法实现" class="headerlink" title="step13: _Promise.all方法实现"></a>step13: _Promise.all方法实现</h1><p><strong>Promise有以下特性:</strong></p><ul><li><strong>接收一个iterable作为参数</strong></li><li><strong>全部成功，按传入顺序返回结果集</strong></li><li><strong>一个失败，返回失败项</strong></li><li><strong>参数列表内元素如果非promise，原样返回</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 全部成功 返回成功结果的集合</span><span class="token keyword">let</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ["ys", "笑嘻嘻"]</span><span class="token comment" spellcheck="true">// 如果有一个失败 则返回失败项 状态为rejected</span><span class="token keyword">let</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'哭唧唧'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 哭唧唧</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的是一个promise实例列表</span>    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// if (!Array.isArray(promises)) {</span>        <span class="token comment" spellcheck="true">//   throw new Error("promises must be an iterator")</span>        <span class="token comment" spellcheck="true">// }</span>        <span class="token comment" spellcheck="true">// 注意 参数必须为迭代器对象</span>        <span class="token comment" spellcheck="true">// 迭代器对象能调用...方法转为数组</span>        <span class="token comment" spellcheck="true">// Array.form能将一个没有部署迭代器的类数组转成数组 所以不适合判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'object is not iterable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">let</span> resolvedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> successPromiseSet <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 成功的结果数组</span>            <span class="token comment" spellcheck="true">// 迭代器对象能调用...方法转为数组 再调用forEach</span>            Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 可能输入的不是一个promise 如果不是promise对象原样返回</span>                <span class="token comment" spellcheck="true">// 为了兼容都能调用then方法 用resolve包一层</span>                _Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    successPromiseSet<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>                    resolvedCount<span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 如果结果的数量 = 传递的promise数量 则返回结果集</span>                    resolvedCount <span class="token operator">==</span> promises<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'lalal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u4 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// all result is : ["ys","笑嘻嘻","lalal",4]</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// reject: 笑嘻嘻</span></code></pre><h1 id="step14-Promise-race静态方法实现"><a href="#step14-Promise-race静态方法实现" class="headerlink" title="step14: _Promise.race静态方法实现"></a>step14: _Promise.race静态方法实现</h1><p><strong>谁快用谁，这个实现起来相当好写， 有值回来 返回即可</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : 笑嘻嘻</span><span class="token comment" spellcheck="true">// 失败状态也可以哦</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// VM117142:14 reject: race winner is : 笑嘻嘻</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的是一个promise实例列表</span>    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> successPromiseSet <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 成功的结果数组</span>            promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>promise <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    successPromiseSet<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 如果结果的数量 = 传递的promise数量 则返回结果集</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">.</span>length <span class="token operator">==</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">resolve</span><span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的也是一个promise实例列表 </span>    <span class="token comment" spellcheck="true">// promise 一个状态改变 就不能再次更改</span>    <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>promise <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : ys</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : 笑嘻嘻</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我们分步来实现promise&lt;/p&gt;
&lt;h1 id=&quot;step1-声明-Promise类并绑定this&quot;&gt;&lt;a href=&quot;#step1-声明-Promise类并绑定this&quot; class=&quot;headerlink&quot; title=&quot;step1: 声明_Promise类并绑定t
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>2. 栈、队列、双端队列和优先队列</title>
    <link href="yd.yangshuaiweb.com/2020/10/25/zhan-dui-lie-shuang-duan-dui-lie-he-you-xian-dui-lie/"/>
    <id>yd.yangshuaiweb.com/2020/10/25/zhan-dui-lie-shuang-duan-dui-lie-he-you-xian-dui-lie/</id>
    <published>2020-10-24T16:00:00.000Z</published>
    <updated>2020-10-31T03:46:57.091Z</updated>
    
    <content type="html"><![CDATA[<h1 id="栈-Stack"><a href="#栈-Stack" class="headerlink" title="栈 (Stack)"></a>栈 (Stack)</h1><blockquote><p>栈的话，可以想象成一个先入后出的容器结构，先进来的元素就叠在一起了，不能从最下面出任何元素。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1eet4h7ij31240u0h4g.jpg" width="500"></image></p></blockquote><h1 id="队列-Queue"><a href="#队列-Queue" class="headerlink" title="队列 (Queue)"></a>队列 (Queue)</h1><blockquote><p>队列的话，更好理解，类似去银行窗口排队，先进先出。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1ehobyzhj328m0li459.jpg"></image></p></blockquote><h1 id="Stack-amp-Queue-总结"><a href="#Stack-amp-Queue-总结" class="headerlink" title="Stack &amp; Queue 总结"></a>Stack &amp; Queue 总结</h1><ul><li>Stack: 先入后出，添加、删除皆为O(1)，因为是无序的，所以查询操作为O(n)</li><li>Queue: 先入先出，添加、删除皆为O(1)，因为是无序的，所以查询操作为O(n)</li></ul><h1 id="双端队列-Deque"><a href="#双端队列-Deque" class="headerlink" title="双端队列 (Deque)"></a>双端队列 (Deque)</h1><blockquote><p>Double-Ended Queue的缩写</p></blockquote><blockquote><p>实战中，我们可能会更多用到栈或队列的衍生结构，双端队列就是队列的衍生结构其中的一种，我们可以在它的头部添加或删除元素，也可以在尾部添加或删除元素。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1enulhbkj31lw0m6qac.jpg"></image></p></blockquote><h1 id="Deque-总结"><a href="#Deque-总结" class="headerlink" title="Deque 总结"></a>Deque 总结</h1><ul><li>简单理解：两端都可以进出的队列</li><li>插入和删除都是O(1操作)，因为是无序的，查询操作为O(n)</li></ul><h1 id="优先队列-Priority-Queue"><a href="#优先队列-Priority-Queue" class="headerlink" title="优先队列 (Priority Queue)"></a>优先队列 (Priority Queue)</h1><ul><li>插入操作O(1)</li><li>取出操作O(logN) - 按照元素的优先级取出，看起来是比普通队列取出操作O(1)变慢了，但是这样设计的一个好处是，比如排队，vip可以先行，类似于这种现象。其实如果用普通队列来实现优先取出的话，时间复杂度为O(n)，更慢了</li><li>底层具体实现的数据结构较为多样和复杂(只要知道有很多种方法可以实现即可)：<ol><li>heap(堆)实现: 但是heap也有多种实现，不一定是二叉树实现的堆，它可能是Fibonacci(斐波那契)堆，也可能是其他形式的堆。</li><li>bst(二叉搜索树)实现: 也可以是平衡的二叉搜索树来实现，比如说红黑树或者AVL来实现。</li><li>treap等一些高级数据结构来实现</li></ol></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;栈-Stack&quot;&gt;&lt;a href=&quot;#栈-Stack&quot; class=&quot;headerlink&quot; title=&quot;栈 (Stack)&quot;&gt;&lt;/a&gt;栈 (Stack)&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;栈的话，可以想象成一个先入后出的容器结构，先进来的元素就叠在一起了
      
    
    </summary>
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
      <category term="数据结构" scheme="yd.yangshuaiweb.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>js继承</title>
    <link href="yd.yangshuaiweb.com/2020/10/20/js-ji-cheng/"/>
    <id>yd.yangshuaiweb.com/2020/10/20/js-ji-cheng/</id>
    <published>2020-10-20T07:10:09.000Z</published>
    <updated>2020-10-20T08:49:14.196Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>众所周知，在 ES 6 之前没有类的概念，所以不能像 Java 中一个 extends 关键字就搞定了继承关系，需要一些 tricks 来实现，下面就介绍一些比较常用的方法。</p><h1 id="原型链继承"><a href="#原型链继承" class="headerlink" title="原型链继承"></a>原型链继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 继承开始</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>只要是原型链中出现过的原型，都可以说是该原型链派生的实例的原型。<br>优点：</p><ol><li>简单易于实现，父类的新增的实例与属性子类都能访问<br>缺点：</li><li>子类型无法给超类型传递参数，在面向对象的继承中，我们总希望通过 var child = new Child(‘son’, ‘father’); 让子类去调用父类的构造器来完成继承。而不是通过像这样 new Parent(‘father’) 去调用父类。</li><li>Child.prototype.sayName 必须写在 Child.prototype = new Parent(‘father’); 之后，不然就会被覆盖掉。</li><li>无法实现多继承</li></ol><h1 id="构造函数继承"><a href="#构造函数继承" class="headerlink" title="构造函数继承"></a>构造函数继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>doSomthing <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 继承开始</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>相当于 Parent 这个函数在 Child 函数中执行了一遍，并且将所有与 this 绑定的变量都切换到了 Child 上，这样就克服了第一种方式带来的问题。<br>优点：</p><ol><li>解决了子类构造函数向父类构造函数中传递参数</li><li>可以实现多继承（call或者apply多个父类）<br>缺点：</li><li>只能继承父类的实例属性和方法，不能继承原型属性和方法</li><li>无法实现函数复用，每个子类都有父类实例函数的副本，影响性能</li></ol><h1 id="组合式继承"><a href="#组合式继承" class="headerlink" title="组合式继承"></a>组合式继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>doSomething <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 第二次调用 Parent</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 第一次调用 Parent</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 修正指向</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>组合式继承是比较常用的一种继承方法，其背后的思路是使用原型链实现对原型属性和方法的继承，而通过借用构造函数来实现对实例属性的继承。</p><p>这样，既通过在原型上定义方法实现了函数复用，又保证每个实例都有它自己的属性。<br><strong>组合式继承是 JS 最常用的继承模式，但组合继承使用过程中会被调用两次：一次是创建子类型的时候，另一次是在子类型构造函数的内部。</strong></p><p>显然从上述的代码中可以看出，第一次调用构造函数显然是没有必要的，因为第一次调用构造函数时候不需要函数内部的那些实例属性，这么写只是想获得其原型上的方法罢了，所以这时候你可能会这样写：</p><pre class=" language-js"><code class="language-js">Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></code></pre><p>这样写显然是不对的：</p><ol><li>首先，你这样写的话相当于是子类和父类都指向同一个对象，这时候如果你添加了新的方法给 Child 但实际上 Parent 并不需要，相当于强行给 Parent 添加了一个未知的方法。</li><li>其次，仔细想想，这样体现不出继承的多态性，比如此时子类想要重写父类的 getName 的方法，那么父类的方法也就会随之修改，这显然违背了多态性。</li></ol><p>也就是说我们第一次调用构造函数的时候，其实是不管构造函数里面的内容，所以我们何不 new 一个空函数，将其 prototype 指向 Parent.prototype</p><h1 id="寄生组合式继承"><a href="#寄生组合式继承" class="headerlink" title="寄生组合式继承"></a>寄生组合式继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    F<span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>parent<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// parent name: father</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'son'</span><span class="token punctuation">,</span> <span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// child name: son</span></code></pre><p>这就是所谓的<strong>寄生组合式继承方式</strong>，跟组合式继承的区别在于，他不需要在一次实例中调用两次父类的构造函数，假如说父类的构造器代码很多，还需要调用两次的话对系统肯定会有影响，<strong>寄生组合式继承的思想在于：用一个 F 空的构造函数去取代执行了 Parent 这个构造函数。</strong></p><p>在上面的代码中，我们手动创建了一个 create 函数，但是其实是存在于 Object 对象中，不需要我们手动去创建，所以上面的代码可以改为：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 利用Object.create创建一个空对象 对象的__proto__执行Parent.prototype</span><span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Parent<span class="token punctuation">,</span> Child<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>     Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Parent<span class="token punctuation">,</span> Child<span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>parent<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// parent name: father</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'son'</span><span class="token punctuation">,</span> <span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// child name: son</span></code></pre><h1 id="ES6继承"><a href="#ES6继承" class="headerlink" title="ES6继承"></a>ES6继承</h1><p>当然，如果你学习过 ES 6，那么写继承关系就会特别简单，如果你学过 Java 就会发现，ES 6 中的继承跟 Java 太像了，上述的代码可改为：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// super关键字作为函数调用 会创建this为{} </span>    <span class="token comment" spellcheck="true">// 并隐式调用 Parent.constructor.call(this, parentName) </span>      <span class="token keyword">super</span><span class="token punctuation">(</span>parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 取值时 super关键字为父类构造函数</span>       <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;众所周知，在 ES 6 之前没有类的概念，所以不能像 Java 中一个 extends 关键字就搞定了继承关系，需要一些 tricks 来实
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>prototype、__proto__与constructor</title>
    <link href="yd.yangshuaiweb.com/2020/10/20/prototype-proto-yu-constructor/"/>
    <id>yd.yangshuaiweb.com/2020/10/20/prototype-proto-yu-constructor/</id>
    <published>2020-10-20T04:48:09.000Z</published>
    <updated>2020-10-20T05:13:36.527Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为一名前端工程师，必须搞懂JS中的prototype、__proto__与constructor属性，相信很多初学者对这些属性存在许多困惑，容易把它们混淆，本文旨在帮助大家理清它们之间的关系并彻底搞懂它们。这里说明一点，__proto__属性的两边是各由两个下划线构成。</p><h1 id="现在正式开始"><a href="#现在正式开始" class="headerlink" title="现在正式开始"></a>现在正式开始</h1><p>让我们从如下一个简单的例子展开讨论，并配以相关的图帮助理解。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">let</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以上代码表示创建一个构造函数Foo()，并用new关键字实例化该构造函数得到一个实例化对象f1。<br>虽然是简简单单的两行代码，然而它们背后的关系却是错综复杂的，如下图所示：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpbgowbjj31d40rkacr.jpg" alt></p><p>看到这图<strong>别怕</strong>，让我们一步步剖析，彻底搞懂它们。</p><p><strong>图的说明：</strong></p><p>右下角为图例，红色箭头表示__proto__属性指向；</p><p>绿色箭头表示prototype属性的指向；</p><p>棕色箭头表示constructor属性的指向；</p><p>蓝色方块表示对象，浅绿色方块表示函数；</p><p>图的中间部分即为它们之间的联系，图的最左边即为例子代码；</p><p><strong>首先，我们需要牢记两点：</strong></p><ol><li><strong>__proto__和constructor属性是对象所独有的；</strong></li><li><strong>prototype属性是函数所独有的。</strong></li><li>但是由于JS中<strong>函数也是一种对象，所以函数也拥有__proto__和constructor属性，这点是致使我们产生困惑的很大原因之一。</strong></li></ol><p>上图有点复杂，我们把它按照属性分别拆开，然后进行分析：</p><h1 id="proto"><a href="#proto" class="headerlink" title="__proto__"></a>__proto__</h1><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpicbo25j31dq0qg40w.jpg" alt></p><p><strong>第一</strong>，这里我们仅留下__proto__属性，它是<strong>对象所独有的，可以看到__proto__属性都是由一个对象指向一个对象</strong>，即指向它们的原型对象（也可以理解为父对象），那么这个属性的作用是什么呢？</p><p style="worr-break: break-all;">它的作用就是当访问一个对象的属性时，如果该对象内部不存在这个属性，那么就会去它的__proto__属性所指向的那个对象（可以理解为父对象）里找，如果父对象也不存在这个属性，则继续往父对象的__proto__属性所指向的那个对象（可以理解为爷爷对象）里找，如果还没找到，则继续往上找….直到原型链顶端null（可以理解为原始人。。。）</p><p>此时若还没找到，则返回undefined（可以理解为，再往上就已经不是“人”的范畴了，找不到了，到此为止），由以上这种通过__proto__属性来连接对象直到null的一条链即为我们所谓的原型链。</p><h1 id="prototype"><a href="#prototype" class="headerlink" title="prototype"></a>prototype</h1><p>第二，接下来我们看prototype属性：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpoidwrnj31bf0oojt6.jpg" alt></p><p>prototype属性，别忘了一点，就是我们前面提到要牢记的两点中的第二点，它是<strong>函数所独有的，它是从一个函数指向一个对象。</strong></p><p>它的含义是函数的原型对象，也就是这个函数（其实所有函数都可以作为构造函数）所创建的实例的原型对象，由此可知：f1.__proto__ === Foo.prototype，它们两个完全一样。</p><p>那prototype属性的作用又是什么呢？</p><p>它的作用就是包含可以由特定类型的所有实例共享的属性和方法，也就是让该函数所实例化的对象们都可以找到公用的属性和方法。</p><h1 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h1><p>最后，我们来看一下constructor属性：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpr2jeexj31c80q90uv.jpg" alt><br><strong>constructor属性也是对象才拥有的，它是从一个对象指向一个函数</strong>，含义就是指向该对象的构造函数，每个对象都有构造函数(本身拥有或继承而来，继承而来的要结合__proto__属性查看会更清楚点，如下图所示)，从图中可以看出Function这个对象比较特殊，它的构造函数就是它自己（因为Function可以看成是一个函数，也可以是一个对象），所有函数最终都是由Function()构造函数得来，所以constructor属性的终点就是Function()。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvptqdjiij31cx0qwacx.jpg" alt></p><p>这里解释一下上段中“每个对象都有构造函数”这句话。这里的意思是每个对象都可以找到其对应的constructor，因为创建对象的前提是需要有constructor，而这个constructor可能是对象自己本身显式定义的或者通过__proto__在原型链中找到的。而单从constructor这个属性来讲，只有prototype对象才有。每个函数在创建的时候，JS会同时创建一个该函数对应的prototype对象，而函数创建的对象.__proto__ === 该函数.prototype，该函数.prototype.constructor===该函数本身，故通过函数创建的对象即使自己没有constructor属性，它也能通过__proto__找到对应的constructor，所以任何对象最终都可以找到其构造函数（null如果当成对象的话，将null除外）。如下：<br><image src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpvfaxejj30sw0grt9y.jpg" width="500"></image></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol><li><p>我们需要牢记两点：①<strong>__proto__和constructor属性是对象所独有的；</strong> ② <strong>prototype属性是函数所独有的，因为函数也是一种对象，所以函数也拥有__proto__和constructor属性。</strong></p></li><li><p><strong>__proto__属性的作用就是当访问一个对象的属性时，如果该对象内部不存在这个属性，那么就会去它的__proto__属性所指向的那个对象（父对象）里找，一直找，直到__proto__属性的终点null，然后返回undefined，通过__proto__属性将对象连接起来的这条链路即我们所谓的原型链。</strong></p></li><li><p><strong>prototype属性的作用就是让该函数所实例化的对象们都可以找到公用的属性和方法，即f1.__proto__ === Foo.prototype。</strong></p></li><li><p><strong>constructor属性的含义就是指向该对象的构造函数，所有函数（此时看成对象了）最终的构造函数都指向Function()。</strong></p></li></ol><p>本文就此结束了，希望对那些对JS中的prototype、__proto__与constructor属性有困惑的同学有所帮助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;作为一名前端工程师，必须搞懂JS中的prototype、__proto__与constructor属性，相信很多初学者对这些属性存在许多困惑
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>webpack4篇(上)</title>
    <link href="yd.yangshuaiweb.com/2020/10/13/webpack4-pian-shang/"/>
    <id>yd.yangshuaiweb.com/2020/10/13/webpack4-pian-shang/</id>
    <published>2020-10-13T07:00:00.000Z</published>
    <updated>2020-11-30T08:39:25.015Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是webpack"><a href="#什么是webpack" class="headerlink" title="什么是webpack"></a>什么是webpack</h1><p>webpack4 可以看做是模块打包机：它做的事情是，分析你的项目结构，找到JS模板以及其他的一些浏览器不能直接运行的拓展语言(Scss, Ts)等，并将其打包为合适的格式以供浏览器使用。</p><h1 id="webpack可以做什么"><a href="#webpack可以做什么" class="headerlink" title="webpack可以做什么"></a>webpack可以做什么</h1><ul><li><strong>代码转换： es6转es5，sccc、less转css等</strong></li><li><strong>文件优化： 压缩代码体积，合并文件，摇树优化等</strong></li><li><strong>代码分割： 公共模块抽离，路由懒加载等</strong></li><li><strong>模块合并： 多个模块合并成一个模块，按功能来分类</strong></li><li><strong>自动刷新： 自己启动一个本地服务，来实现代码变更后，可以更新我们的页面</strong></li><li><strong>代码校验： 校验代码是否符合规范</strong></li><li><strong>自动发布： 打包结果发布到服务器上，后面提到的方法</strong></li></ul><h1 id="webpack安装"><a href="#webpack安装" class="headerlink" title="webpack安装"></a>webpack安装</h1><p>安装本地的webpack</p><pre class=" language-js"><code class="language-js">yarn add webpack@<span class="token operator">^</span><span class="token number">4.32</span><span class="token punctuation">.</span><span class="token number">2</span> webpack<span class="token operator">-</span>cli@<span class="token operator">^</span><span class="token number">3.3</span><span class="token punctuation">.</span><span class="token number">2</span> <span class="token operator">-</span>D</code></pre><h1 id="webpack可以进行零配置"><a href="#webpack可以进行零配置" class="headerlink" title="webpack可以进行零配置"></a>webpack可以进行零配置</h1><p>webpack默认支持js、json，所以我们可以零配置打包js代码，默认会找src/index.js作为入口文件。</p><pre class=" language-js"><code class="language-js"><span class="token operator">-</span> src  <span class="token operator">-</span> index<span class="token punctuation">.</span>js<span class="token comment" spellcheck="true">// index.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后执行 npx webpack, 就在我们的dist/文件夹生成了一个打包后的main.js，此时默认采用mode为生产环境(production)，会自动优化、压缩。</p><h1 id="手动配置webpack"><a href="#手动配置webpack" class="headerlink" title="手动配置webpack"></a>手动配置webpack</h1><p>比如我们想更改mode为开发环境，希望打包后的代码不被压缩，我们可以手动配置webpack。<strong>默认配置文件的名字为 webpack.config.js或 webpackfile.js</strong>，其实扒开 webpack-cli 中就能找到这样一段代码，</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// node_modules/webpack-cli/bin/config/config.yargs.js</span>defaultDescription<span class="token punctuation">:</span> <span class="token string">"webpack.config.js or webpackfile.js"</span></code></pre><p><strong>如果我们期望更改webpack启动配置文件的名称，可以通过 npx webpack --config someName.js来来指定文件。</strong></p><p>新建文件 src/a.js，webpack.conf.my.js 并修改代码如下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/a.js</span><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span>  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> obj <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.conf.my.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 更清晰的打包结果</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 入口</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 打包后的文件名</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 路径必须是个绝对路径</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>package.json中增加build命令</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>    <span class="token operator">...</span><span class="token punctuation">,</span>    <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"build"</span><span class="token punctuation">:</span> <span class="token string">"npx webpack --config webpack.conf.my.js"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><h1 id="分析打包后的文件"><a href="#分析打包后的文件" class="headerlink" title="分析打包后的文件"></a>分析打包后的文件</h1><p>执行npm run build (如果需要额外参数 需要加一个 --)，生成打包后的文件 build/build.js， 我们来分析下这个文件</p><details><summary> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">CODE</font></summary><pre class=" language-js"><code class="language-js"> <span class="token comment" spellcheck="true">// webpack自执行启动函数 入参是一个对象 { './src/a.js': function, './src/index.js': function }</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 已缓存的模块 非首次加载的模块从这里面拿</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 实现了一个require方法 接收一个模块id 模块id即是路径 类似 './src/a.js'</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)  声明一个新的module对象 并在缓存对象中缓存</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块id</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块状态 是否加载成功</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 模块导出</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 解析模块(传入的 moduleId对应的 function) 把 module.exports这个对象当成 this，把 module，module.exports，__webpack_require__作为实参传给函数使用 modules[moduleId]是一个函数 模块内部的 require换成了 __webpack_require__</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded 更改模块加载状态</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// Return the exports of the module 导出模块返回结果</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__) __webpack_require__上挂在全部传入的modules参数</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// expose the module cache __webpack_require__上挂在cache的模块对象</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports 给每个exports出的对象设置可枚举和可取值属性</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// define __esModule on exports 为每个模块exports出对象设置Symbol.toStringTag 也就是Object.toString.call(exports)返回的[object Module]</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports 函数默认值 不传的话为src/index.js 加载并return出加载到的模块exports的值</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = {\n  a: 1\n}\n\n//# sourceURL=webpack:///./src/a.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 注意这里 obj接收了 __webpack_require__的返回值，也就是对应模块的exports，所以是{ a: 1 }，然后打印obj 得出结果</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"var obj  = __webpack_require__(/*! ./a.js */ \"./src/a.js\");\n\nconsole.log(obj);\n\n//# sourceURL=webpack:///./src/index.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details><ol><li><strong>webpack启动函数是一个自执行函数，接收参数为{ 模块路径1: function, 模块路径2: function }这样一个对象，内部实现了自己require方法，先分析的入口文件问src/index.js，代码中遇到模块加载，则继续调用<strong>webpack_require</strong>方法加载模块。</strong></li><li><strong>加载过的文件会被缓存，第二次加载直接从内存中的缓存对象中拿。</strong></li><li><strong>任何打包进build.js中的模块，都有三个属性，{ 模块id，模块加载状态，模块exports }， 入口文件的导入的其实是其他模块的module.exports。</strong></li></ol><h1 id="热启动-webpack-dev-server"><a href="#热启动-webpack-dev-server" class="headerlink" title="热启动 webpack-dev-server"></a>热启动 webpack-dev-server</h1><p>内部通过express来实现的这样一个静态服务。</p><pre class=" language-js"><code class="language-js">yarn add webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server <span class="token operator">-</span>D</code></pre><p><strong>webpack-dev-server把打包文件写在内存中，所以不会在我们build文件夹中体现，可以通过npx webpack-dev-server来启动一个服务</strong>，当然更多我们会用到一些配置，webpack配置文件增加以下配置项</p><pre class=" language-js"><code class="language-js">  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpack-dev-server配置</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 启动端口</span>    progress<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 进度条</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./build'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 以 build目录作为静态服务启动的文件</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 自动打开浏览器</span>  <span class="token punctuation">}</span></code></pre><p>build文件加新增文件index.html</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./bundle.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>配置启动命令</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// package.json</span><span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"webpack-dev-server --config webpack.conf.my.js"</span></code></pre><p>执行npm run dev，可以打开一个页面，并输出我们的结果。</p><h1 id="html-webpack-plugin"><a href="#html-webpack-plugin" class="headerlink" title="html-webpack-plugin"></a>html-webpack-plugin</h1><p>我们并不希望在build文件夹中手动添加index.html，并手动引入资源，我们希望我们项目真正的html模板被打包，这时候，可以使用 html-webpack-plugin</p><pre class=" language-js"><code class="language-js">yarn add html<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>src目录下新建index.html, 不用引入任何文件~ </p><pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span><span class="token operator">&lt;</span>head<span class="token operator">></span>  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>title<span class="token operator">></span>webpack4 学习<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre><p>webpack配置中增加plugin配置</p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 是一个数组 放着所有的webpack插件的实例</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      template<span class="token punctuation">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模板路径</span>      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 打包后的文件名</span>      minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>        removeAttributeQuotes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 删除html中的属性双引号</span>        <span class="token comment" spellcheck="true">// collapseWhitespace: true // 压缩成一行</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      hash<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// 引入资源路径后的hash值 比如./build?xxssss</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>打包结果</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>bundle.5cd64a02.js?5cd64a021942ccddb94f</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h1 id="css-loader-style-loader"><a href="#css-loader-style-loader" class="headerlink" title="css-loader, style-loader"></a>css-loader, style-loader</h1><p>loader的作用就是对我们的源代码进行转换，要引入 css，需要正确的 loader将它转换成真正的 module。比如常用的css-loader，style-loader，需要注意它们的区别：</p><ul><li><strong>css-loader 是用来解析 @import这种语法的，并将css包装成一个模块，模块导出的是base.css的内容，然后webpack将@import替换成<strong>webpack_require</strong>，去加载这个模块</strong></li><li><strong>style-loader 是把生成的css插入header标签中</strong></li><li><strong>可以use多个loader，方法是把use对应的value配置成数组</strong></li><li><strong>loader是有顺序的，默认是从右向左执行，从下到上执行，比如我需要先处理css文件，然后把css内容插入到html的header标签的最底部，所以我需要把css-loader写后面, style-loader写在前面。</strong></li></ul><p><strong>比如 index.css中引用 base.css，此时会打包出一个</strong></p><pre class=" language-js"><code class="language-js"> <span class="token comment" spellcheck="true">// ./node_modules/css-loader/dist/cjs.js!./base.css</span> __webpack_exports__<span class="token punctuation">[</span>\"<span class="token keyword">default</span>\"<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>___CSS_LOADER_EXPORT___<span class="token punctuation">)</span><span class="token punctuation">;</span> 并且在打包出的index<span class="token punctuation">.</span>css文件中把@<span class="token keyword">import</span>替换成了 <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>"<span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>css<span class="token operator">-</span>loader<span class="token operator">/</span>dist<span class="token operator">/</span>cjs<span class="token punctuation">.</span>js<span class="token operator">!</span><span class="token punctuation">.</span><span class="token operator">/</span>base<span class="token punctuation">.</span>css\"<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>配置style-loader, css-loader</p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>             test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>             use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                     <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                    opttions<span class="token punctuation">:</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 插入到head标签顶部 这里略 </span>                        insert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">insertAtTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                 <span class="token punctuation">}</span><span class="token punctuation">,</span>                 <span class="token string">'css-loader'</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><h1 id="配置less-loader"><a href="#配置less-loader" class="headerlink" title="配置less-loader"></a>配置less-loader</h1><p>less-loader 能帮我们处理less文件，把less文件转换成css文件，所以它应该在css-loader之前执行，根据单模块从右向左的执行顺序，less-loader应该配置在最右边。注意，less-loader会调用 less来进行语法转换，所以我们需要安装 less和 less-loader两个包。</p><pre class=" language-js"><code class="language-js">yarn add less less<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>更改配置</p><pre class=" language-js"><code class="language-js">    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                    <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                     <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'less-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span></code></pre><h1 id="mini-css-extract-plugin-抽离css文件"><a href="#mini-css-extract-plugin-抽离css文件" class="headerlink" title="mini-css-extract-plugin 抽离css文件"></a>mini-css-extract-plugin 抽离css文件</h1><p>我们可以看到，现在所有的css都放在style标签中了<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkwvg3a2lkj314e0nck0k.jpg" width="500"><br>能不能把他提取成一个文件，通过link标签去引用呢，ok，mini-css-extract-plugin 就是做这样一个事儿，它的loader也取代了style-loader，因为我们不再需要style标签引入css了。</image></p><pre class=" language-js"><code class="language-js">yarn add mini<span class="token operator">-</span>css<span class="token operator">-</span>extract<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>改下配置文件</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 如果需要抽离成多个css 可以多次引用 不同的变量名即可</span><span class="token keyword">let</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// plgin中使用</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 抽离css</span>            filename<span class="token punctuation">:</span> <span class="token string">'main.css'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 抽离出的文件名</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'less-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>看下打包后的文件</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span>en</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span>main.css?acd7a28111ac8e884862</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span>stylesheet</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>study</span><span class="token punctuation">></span></span>         学习使我快乐    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>bundle.js?acd7a28111ac8e884862</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h1 id="postcss-loader-autoprefixer-添加css前缀"><a href="#postcss-loader-autoprefixer-添加css前缀" class="headerlink" title="postcss-loader, autoprefixer 添加css前缀"></a>postcss-loader, autoprefixer 添加css前缀</h1><p>我们使用autoprefixer来给css文件添加加各类浏览器兼容的前缀，以 Can I Use 上的 浏览器支持数据 为基础，自动处理兼容性问题，它需要搭配postcss-loader(后处理器)使用。</p><pre class=" language-js"><code class="language-js">yarn add postcss<span class="token operator">-</span>loader autoprefixer  <span class="token operator">-</span>D</code></pre><p>修改webpack配置文件</p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>             test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>             use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>                <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 在解析css为模块和解析css内@import之前使用</span>                <span class="token string">'less-loader'</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><p>根目录添加postcss.config.js 或者直接写进postcss-loader配置中</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// postcss.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>最后一步: 在package.json中增加配置，也可以根目录创建.browserslistrc文件</p><pre class=" language-js"><code class="language-js">  <span class="token string">"browserslist"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token string">"last 2 versions"</span><span class="token punctuation">,</span>    <span class="token string">"> 1%"</span><span class="token punctuation">,</span>    <span class="token string">"iOS 7"</span><span class="token punctuation">,</span>    <span class="token string">"last 3 iOS versions"</span>  <span class="token punctuation">]</span></code></pre><h1 id="uglifyjs-webpack-plugin-optimize-css-assetts-webpack-plugin-js，css压缩"><a href="#uglifyjs-webpack-plugin-optimize-css-assetts-webpack-plugin-js，css压缩" class="headerlink" title="uglifyjs-webpack-plugin, optimize-css-assetts-webpack-plugin (js，css压缩)"></a>uglifyjs-webpack-plugin, optimize-css-assetts-webpack-plugin (js，css压缩)</h1><p>我们知道，当 mode为 production时，js会自动压缩，那 css不能压缩怎么办呢。</p><p><strong>抽离css后，需要借助 optimize-css-assetts-webpack-plugin 帮我们压缩css，需要配置optimization.minimizer，然而配置之后，js又不能自动压缩了， 所以我们一般配合 uglify完成 css和 js的压缩任务。</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> OptimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> UglifyjsWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglifyjs-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 压缩js 配置css压缩后 js自动压缩失效 需要用此插件进行压缩</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    optimization<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 优化项 只在生产环境生效</span>        <span class="token keyword">new</span> <span class="token class-name">UglifyjsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 压缩js</span>            cache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 是否使用缓存</span>            parallel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 是否是并发压缩js的</span>            sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// 压缩完后 源码映射 为了更好调试</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">OptimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 压缩 css</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="babel-loader，-babell-core，-babel-preset-env-es6-转成-es5"><a href="#babel-loader，-babell-core，-babel-preset-env-es6-转成-es5" class="headerlink" title="babel-loader，@babell/core，@babel/preset-env (es6 转成 es5)"></a>babel-loader，@babell/core，@babel/preset-env (es6 转成 es5)</h1><p>如果我们在a.js中加了一个箭头函数，然后在入口文件引入a.js，却发现打包后的 bundle.js里面还是箭头函数(webpack预设的js模块解析并没有对js进行语法转换，我们需要添加自己的loader去干这件事)，这在一些不支持es6语法的浏览器中会报错的，为了解决这个问题，我们需要把高版本的 js按照es5标准进行转换。</p><pre class=" language-js"><code class="language-js">yarn add babel<span class="token operator">-</span>loader @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span>D</code></pre><p><strong>babel-loader： 用于对 js源文件进行处理。</strong><br><strong>@babel/core： 调用transform方法去转换 js源代码。</strong><br><strong>@babel/preset-env：转化规则，把标准的语法转换为低级的语法。</strong></p><p>webpack 增加 babel-loader 配置</p><pre class=" language-js"><code class="language-js">    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                    loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                    options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库</span>                            <span class="token string">'@babel/preset-env'</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-syntax-class-properties-解析class类提案语法"><a href="#babel-plugin-syntax-class-properties-解析class类提案语法" class="headerlink" title="@babel/plugin-syntax-class-properties 解析class类提案语法"></a>@babel/plugin-syntax-class-properties 解析class类提案语法</h1><p>如果我们在 a.js中添加了以下这段豪横无比的代码，webpack会无情报错的。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这时候，@babel/plugin-syntax-class-properties懂你</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>syntax<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>properties <span class="token operator">-</span>D</code></pre><p>更改webpack配置 </p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>          test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>          use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>            loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>            options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库 是大的插件的集合</span>                    <span class="token string">'@babel/preset-env'</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                plugins<span class="token punctuation">:</span>  <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置一个个的插件</span>                    <span class="token string">'@babel/plugin-proposal-class-properties'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-proposal-decorators-解析类装饰器"><a href="#babel-plugin-proposal-decorators-解析类装饰器" class="headerlink" title="@babel/plugin-proposal-decorators 解析类装饰器"></a>@babel/plugin-proposal-decorators 解析类装饰器</h1><pre class=" language-js"><code class="language-js">@log<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> ys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们给class类加一个修饰器，build的时候还是会报错的，因为修饰器提案想要进行语法转换也需要一个包，@babel/plugin-proposal-decorators</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>proposal<span class="token operator">-</span>decorators <span class="token operator">-</span>D</code></pre><p>修改 babel-loader配置 此处参考babel官网提供的用法 <a href="https://babeljs.io/docs/en/babel-plugin-proposal-decorators" target="_blank" rel="noopener">babel-plugin-proposal-decorators</a></p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                    presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库 是大的插件的集合</span>                    <span class="token string">'@babel/preset-env'</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    plugins<span class="token punctuation">:</span>  <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置一个个的插件</span>                        <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-decorators"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"legacy"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-class-properties"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"loose"</span> <span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-transform-runtime-babel-runtime-注入运行时辅助代码"><a href="#babel-plugin-transform-runtime-babel-runtime-注入运行时辅助代码" class="headerlink" title="@babel/plugin-transform-runtime @babel/runtime 注入运行时辅助代码"></a>@babel/plugin-transform-runtime @babel/runtime 注入运行时辅助代码</h1><p>此时我们再给入口index.js增加 </p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">class</span> <span class="token class-name">Person2</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>打包后我们看到，<strong>bundle.js里面声明了两次 _classCallCheck 方法，是否可以公用呢?</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> Constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>\"Cannot call a <span class="token keyword">class</span> <span class="token class-name">as</span> a <span class="token keyword">function</span>\"<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们在index.js文件中继续添加 </p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后npm run dev启动服务，打开页面，报错如下</p><pre class=" language-js"><code class="language-js">Uncaught ReferenceError<span class="token punctuation">:</span> regeneratorRuntime is not defined</code></pre><p>wtf? 这个方法是哪里来的？ 其实 Generator 或者更高级的 Promise 语法进行转化的时候，使用了 regeneratorRuntime 辅助方法却并没有加上这个辅助方法，需要增强编译，我们可以是使用 @babel/plugin-transform-runtime，这是一个代码运行时的包，会在代码运行时根据需要注入一些辅助性的代码。</p><p>@babel/plugin-transform-runtime是我们开发时候需要用的包，但是上线打包的话，我们也需要带上这些补丁代码，babel为我们提供了 @babel/runtime 去处理线上代码的打包。</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>runtime <span class="token operator">-</span>Dyarn add @babel<span class="token operator">/</span>runtime   <span class="token comment" spellcheck="true">// 生产环境需要用的 就不加-D</span></code></pre><p>webpack增加配置，注意，这步操作要排除 node_modules 中的js，仅包含 src目录下的 js代码</p><pre class=" language-js"><code class="language-js"></code></pre><p>这时候可以看到，打包出的源码中自动引入了@babel/runtime下的包啦</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/@babel/runtime/helpers/classCallCheck.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/@babel/runtime/helpers/classCallCheck.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span></code></pre><h1 id="babel-polyfill-高级api不能使？垫一下！"><a href="#babel-polyfill-高级api不能使？垫一下！" class="headerlink" title="@babel/polyfill  高级api不能使？垫一下！"></a>@babel/polyfill  高级api不能使？垫一下！</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token string">'sss'</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>如果我们使用再高级的语法，比如 es7 新增的字符串的 includes 方法，依旧不会被解析出 es5 标准的语法，打包后仍是includes，我们需要引入 @babel/polyfill 来解决此类问题。</strong></p><p>注意，这个包在生产环境打包也是需要的</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>polyfill</code></pre><p>在需要的地方引入</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> <span class="token string">'@babel/polyfill'</span><span class="token punctuation">;</span><span class="token string">'sss'</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>打包后发现引入了数组的includes方法模块</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/core-js/fn/array/includes.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span></code></pre><h1 id="expose-loader，webpack-ProvidePlugin-引全局包"><a href="#expose-loader，webpack-ProvidePlugin-引全局包" class="headerlink" title="expose-loader，webpack.ProvidePlugin 引全局包"></a>expose-loader，webpack.ProvidePlugin 引全局包</h1><p>很多第三方模块依赖jquery，而且依赖的是window.jquery，也就是全局的 jquery。</p><pre class=" language-js"><code class="language-js">yarn add jquery</code></pre><p>比如我们在a.js中增加如下代码</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>$<span class="token punctuation">,</span> $<span class="token punctuation">,</span> <span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn undefined jquery</span></code></pre><p>我们看到打包后的文件里是有jquery的, jquery被包成一个闭包去执行，暴露出去，但是 window 上没有。如果有插件依赖了 window.jquery怎么办呢，别急，expose-loader可以暴露全局变量，注意，<strong>它是一个内联loader</strong>，</p><pre class=" language-js"><code class="language-js">yarn add expose<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>语法如下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// expose-loader?exposes[]=暴露到全局的别名!引用包名</span><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'expose-loader?exposes[]=$!jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>$<span class="token punctuation">,</span> $<span class="token punctuation">,</span> <span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn fn jquery</span></code></pre><p>当然也可以不用内联loader，配到webpack文件里去，参考官方写法。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             loader<span class="token punctuation">:</span> <span class="token string">'expose-loader'</span><span class="token punctuation">,</span>            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                exposes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><p>但是我们发现，这样不是很友好，能不能直接用，而不需要每个模块都去去 import 呢？</p><p>可以使用webpack.ProvidePlugin去声明全局变量</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token comment" spellcheck="true">// 把包引为全局变量，需要注意的是，这种全局变量并不会挂到 window 上</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>             $<span class="token punctuation">:</span> <span class="token string">'jquery'</span> <span class="token comment" spellcheck="true">// 引入 node_modules/jquery 声明为 $, 每个模块中都注入，而不是挂在window</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>consolle<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn</span></code></pre><h1 id="externals-忽略不需要被打包的模块-外部引入，模块内二次引入"><a href="#externals-忽略不需要被打包的模块-外部引入，模块内二次引入" class="headerlink" title="externals 忽略不需要被打包的模块(外部引入，模块内二次引入)"></a>externals 忽略不需要被打包的模块(外部引入，模块内二次引入)</h1><p>如果我在index.html通过 cdn 引入了 jquery，此时 window.jquery 即为 jquery，但是呢，我很任性，不希望用的时候写那么长的变量名，于是我做了以下操作</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span></code></pre><p>这时一看打包文件，引入了双份的 jquery，我 emm..</p><p>我又比较有洁癖，只想引入一个包，怎么办呢？ webpack提供了 externals属性，它可以让我们打包时忽略已经外部引用的包。</p><pre class=" language-js"><code class="language-js">externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>    jquery<span class="token punctuation">:</span> <span class="token string">'$'</span><span class="token punctuation">}</span></code></pre><h1 id="file-loader和更强大的url-loader进行图片处理"><a href="#file-loader和更强大的url-loader进行图片处理" class="headerlink" title="file-loader和更强大的url-loader进行图片处理"></a>file-loader和更强大的url-loader进行图片处理</h1><p>图片有几种引入方式</p><ul><li>在 js 中创建图片引入</li><li>css background引入<br>file-loader用来解析图片，file-loader 默认会在内部生成一张带hash的图片，到 build 目录下，并且把生成的图片路径返回回来。<pre class=" language-js"><code class="language-js">yarn add file<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre></li></ul><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>js中引入图片</strong></font></p><p>新建img.js，并在 index.js 中引入它。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> logo <span class="token keyword">from</span> <span class="token string">'../logo.png'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注意 返回的是一个图片地址</span><span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>image<span class="token punctuation">.</span>src <span class="token operator">=</span> logo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 思考，如果我们这里直接访问一个图片呢，比如 '../logo.png' 它会被打包么？</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>增加loader规则</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token string">'file-loader'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p>ok， 大功告成</p><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>css中引入图片</strong></font></p><pre class=" language-css"><code class="language-css"><span class="token selector">// index<span class="token class">.less</span>body </span><span class="token punctuation">{</span>  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url">url(./logo.png)</span> no-repeat<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>因为 css-loader 默认会把引入的图片 css中引入的图片，转换成一个外部模块，比如以上代码，实际上被 css-loader转换成以下代码，所以他也会打包。</p><pre class=" language-css"><code class="language-css"><span class="token selector">body </span><span class="token punctuation">{</span>  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url">url(require('./logo.png')</span><span class="token punctuation">)</span> no-repeat<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>假设我们有一个场景，如果图片小于 5k，就把它转成 base64(不会发请求，但是大小会比源文件大三分之一)，否则用 file-loader产生真实的图片，防止过多的静态资源请求，这时候我们可以使用 url-loader。</p><pre class=" language-js"><code class="language-js">yarn add url<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>替换file-loader</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 5k以下转成base64 以上转成真正的图片</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ok，重新打包后，可以看到小图片被转成base64了</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>data:image/png;base64,/9j/4AAQSkZJRgABAQAASABIAAD<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><h1 id="文件按类型打包到各自目录"><a href="#文件按类型打包到各自目录" class="headerlink" title="文件按类型打包到各自目录"></a>文件按类型打包到各自目录</h1><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">图片分类</font><br>图片分类很简单，只需要把 url-loader 配置中加个 outputPath即可，url-loader会自动帮我们处理好图片的引入路径哦。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 5k以下转成base64 以上转成真正的图片</span>                    outputPath<span class="token punctuation">:</span> <span class="token string">'img/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">css分类</font><br>css分类只需要更改 MiniCssExtractPlugin 输出的 filename即可。</p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 是一个数组 放着所有的webpack插件的实例</span>    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 抽离css</span>      filename<span class="token punctuation">:</span> <span class="token string">'css/main.css'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 抽离出的文件名</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>这时候 build 目录会出现 css/index.css 文件引入的背景图片路径为 img/xxx.png，解决办法是给 MiniCssExtractPlugin.loader增加 publicPath</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>     test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>     use<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>            loader<span class="token punctuation">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>            options<span class="token punctuation">:</span><span class="token punctuation">{</span>                publicPath<span class="token punctuation">:</span> <span class="token string">'../'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token string">'css-loader'</span><span class="token punctuation">,</span>        <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>        <span class="token string">'less-loader'</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ok，齐活儿。</p><h1 id="打包多页应用"><a href="#打包多页应用" class="headerlink" title="打包多页应用"></a>打包多页应用</h1><p>多页应用比单页应用复杂的一点是，多个入口，多个出口。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 抽离html</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 多入口</span>        home<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>        other<span class="token punctuation">:</span> <span class="token string">'./src/other.js'</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>     output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>        path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> <span class="token string">'home.html'</span><span class="token punctuation">,</span>            chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'home'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 该页使用到的代码块儿</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> <span class="token string">'other.html'</span><span class="token punctuation">,</span>            chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'other'</span><span class="token punctuation">]</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="sourcemap"><a href="#sourcemap" class="headerlink" title="sourcemap"></a>sourcemap</h1><p>我们在解析 js 中，会把一些高级语法转换成低级语法，甚至生产环境伴随着代码，比如下面一行代码报错，我们很难追溯到报错的地方。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">class</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">'报错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们把 mode 改成 production，执行 npm run dev去启动服务。<br>页面报错了，错误出现在 bundle.js 第一行。</p><pre class=" language-js"><code class="language-js">Uncaught TypeError<span class="token punctuation">:</span> console<span class="token punctuation">.</span>lo is not a <span class="token keyword">function</span>    at <span class="token keyword">new</span> <span class="token class-name">t</span> <span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>js<span class="token operator">?</span>03a176d0736bff01997d<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p>点进去一看，都是压缩过的代码(这里截取一部分)，实际情况更复杂，更难调试。</p><pre class=" language-js"><code class="language-js"><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"sssss"</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">"报错了"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">159</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>是不是应该有一个映射文件，我点进去看到的应该是源码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1) 源码映射 会单独生成一个 sourcemap文件 出错了会标识当前报错的列和行</span>    devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 增加映射文件 可以帮我们调试源代码</span>    <span class="token comment" spellcheck="true">// 2) 'eval-source-map' 不会单独打包出 sourcemap 文件(集成到打包后的文件中)，也可以显示行和列，并且显示源码</span>    <span class="token comment" spellcheck="true">// devtool: 'eval-source-map',</span>    <span class="token comment" spellcheck="true">// 3) 'cheap-module-source-map' 不会产生列，单独生成一个 sourcemap 文件</span>    <span class="token comment" spellcheck="true">// devtool: 'eval-source-map',</span>    <span class="token comment" spellcheck="true">// 4) 'cheap-module-eval-source-map' 不会产生列，不会产生文件，集成到打包后的文件中</span>    <span class="token comment" spellcheck="true">// devtool: 'cheap-module-eval-source-map',</span></code></pre><p>这时候打包，页面能看到报错列和行</p><pre class=" language-js"><code class="language-js">index<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">28</span> Uncaught TypeError<span class="token punctuation">:</span> console<span class="token punctuation">.</span>lo is not a <span class="token keyword">function</span>    at <span class="token keyword">new</span> <span class="token class-name">t</span> <span class="token punctuation">(</span>index<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">)</span></code></pre><p>点进去，可以看到源码</p><pre class=" language-js"><code class="language-js"><span class="token operator">...</span><span class="token comment" spellcheck="true">// 测试 source map</span><span class="token keyword">class</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">'报错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">...</span></code></pre><h1 id="watch-监听文件改动-可以看到实体文件"><a href="#watch-监听文件改动-可以看到实体文件" class="headerlink" title="watch 监听文件改动 可以看到实体文件"></a>watch 监听文件改动 可以看到实体文件</h1><p>就算用 webpack-dev-server 启动， 监测到代码变化后，浏览器可以看到及时更新的效果，但是并没有自动打包修改目录中的代码，是在内存中打包，我们可以用 watch 方法来实现监测到代码变化后自动打包修改的代码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span></code></pre><p>这时候执行 npm run build 就不会退出 build 进程，会等待文件改变，并实时打包。<br>也可以加一些额外配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    watchOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 监控选项</span>        poll<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 每秒检查 1000 次</span>        aggregateTimeout<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 防抖 500ms触发一次</span>        ignored<span class="token punctuation">:</span> <span class="token operator">/</span>node_modules<span class="token operator">/</span> <span class="token comment" spellcheck="true">// 忽略文件</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><h1 id="copy-webpack-plugin-拷贝文件到打包目录"><a href="#copy-webpack-plugin-拷贝文件到打包目录" class="headerlink" title="copy-webpack-plugin 拷贝文件到打包目录"></a>copy-webpack-plugin 拷贝文件到打包目录</h1><pre class=" language-js"><code class="language-js">yarn add copy<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>文件根目录创建 doc文件夹，新增 doc/a.txt</p><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>             <span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 可以执行多个拷贝</span>            patterns<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">"doc"</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token string">"doc"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="bannerPlugin-代码版权声明插件"><a href="#bannerPlugin-代码版权声明插件" class="headerlink" title="bannerPlugin 代码版权声明插件"></a>bannerPlugin 代码版权声明插件</h1><p>webpack内置插件，用于代码前署名。</p><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>BannerPlugin</span><span class="token punctuation">(</span><span class="token string">'make 2020 by ys'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 代码版权声明</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>打包可以看见版权的声明</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/*! make 2020 by ys */</span>body<span class="token punctuation">,</span><span class="token operator">**</span><span class="token comment" spellcheck="true">/*! make 2020 by ys */</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">**</span></code></pre><h1 id="devServer-配置跨域-amp-mock数据"><a href="#devServer-配置跨域-amp-mock数据" class="headerlink" title="devServer 配置跨域 &amp; mock数据"></a>devServer 配置跨域 &amp; mock数据</h1><p>设置代理</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        proxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>             <span class="token string">'/api'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                target<span class="token punctuation">:</span> <span class="token string">'http://xxx.com'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//  配置api代理 转发到一个地址</span>                pathRewrite<span class="token punctuation">:</span>  <span class="token punctuation">{</span> <span class="token string">'/api'</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 匹配到之后 转发时去掉 /api </span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>因为 webpack-dev-server 也是启动了一个 express 服务，所以我们如果可以拿到 app 实例，是不是就可以 mock 接口了?  方便的是，devServer 提供了这样的钩子。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token function">before</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>            app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'ys'</span><span class="token punctuation">,</span>                    action<span class="token punctuation">:</span> <span class="token string">'moce data'</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样配合上面，我们就可以在前端通过 /api/user 访问到这个接口啦。</p><h1 id="resolve-配置解析三方包规则-amp-别名"><a href="#resolve-配置解析三方包规则-amp-别名" class="headerlink" title="resolve 配置解析三方包规则 &amp; 别名"></a>resolve 配置解析三方包规则 &amp; 别名</h1><p>我们可以通过配置 resolve 设置解析第三方包的范围，入口文件，别名等。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// 包的查找范围只在本级目录下 node_modus</span>        modules<span class="token punctuation">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 引入包时 后缀查找规则 先后排序</span>        extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.css'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">'.vue'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 引入包时 默认读包 package.json 中字段找入口时候的优先级(默认先找main属性)</span>        mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 入口文件的名字 默认是 index.js</span>        mainFiles<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'base.js'</span><span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 配置解析别名 解决引入包名过长问题</span>        alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">'@/assets'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'src/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">'@/libs'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'src/libs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="利用DefinePlugin-定义环境变量-其实是全局变量哦"><a href="#利用DefinePlugin-定义环境变量-其实是全局变量哦" class="headerlink" title="利用DefinePlugin 定义环境变量(其实是全局变量哦)"></a>利用DefinePlugin 定义环境变量(其实是全局变量哦)</h1><p>我们可以通过 webpack 内置插件 DefinePlugin 来为页面注入全局变量。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            ENV<span class="token punctuation">:</span> <span class="token string">'"dev"'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 页面就能拿到啦 这个可以动态给值 注意引号</span>            flag<span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Boolean true</span>            SUM<span class="token punctuation">:</span> <span class="token string">'1+1'</span> <span class="token comment" spellcheck="true">// 2</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="webpack-merge-区分环境做配置合并"><a href="#webpack-merge-区分环境做配置合并" class="headerlink" title="webpack-merge 区分环境做配置合并"></a>webpack-merge 区分环境做配置合并</h1><pre class=" language-js"><code class="language-js">yarn add webpack<span class="token operator">-</span>merge <span class="token operator">-</span>D</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.dev.js</span><span class="token keyword">let</span>  <span class="token punctuation">{</span> smart <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'developmeent'</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// do something on dev</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// loaders/babel-loader.js</span><span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  <span class="token comment" spellcheck="true">// 调用 @babel/core 内 transform 方法进行转换 </span>  babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>    presets<span class="token punctuation">:</span> options<span class="token punctuation">.</span>presets<span class="token punctuation">,</span>    sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到参数(错误，编译后源码，souremap) 自动帮我们返回结果</span>    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;什么是webpack&quot;&gt;&lt;a href=&quot;#什么是webpack&quot; class=&quot;headerlink&quot; title=&quot;什么是webpack&quot;&gt;&lt;/a&gt;什么是webpack&lt;/h1&gt;&lt;p&gt;webpack4 可以看做是模块打包机：它做的事情是，分析你的项目结构，找到
      
    
    </summary>
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/categories/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>模块化发展史</title>
    <link href="yd.yangshuaiweb.com/2020/10/13/mo-kuai-hua/"/>
    <id>yd.yangshuaiweb.com/2020/10/13/mo-kuai-hua/</id>
    <published>2020-10-13T07:00:00.000Z</published>
    <updated>2020-11-18T04:42:49.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="为何前端需要模块化"><a href="#为何前端需要模块化" class="headerlink" title="为何前端需要模块化"></a>为何前端需要模块化</h1><p>为了彻底弄清楚模块化这个东西，我们要从最开始模块化的起源说起。</p><h2 id="无模块化的原始时代"><a href="#无模块化的原始时代" class="headerlink" title="无模块化的原始时代"></a>无模块化的原始时代</h2><p>最开始js只是作为一个脚本语言来使用，做一些简单的表单校验，动画实现等。<br>代码都是这样，直接把代码写在script标签里，而且代码量很少</p><pre class=" language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'Btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onClick <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><h2 id="代码量剧增带来的灾难性问题"><a href="#代码量剧增带来的灾难性问题" class="headerlink" title="代码量剧增带来的灾难性问题"></a>代码量剧增带来的灾难性问题</h2><p>后来随着ajax异步请求的出现，前端能做的事情越来越多，代码量飞速增长。<br>也暴露出一些问题。</p><ol><li><strong>全局变量的灾难</strong><br>这个非常好理解，就是大家的代码都在一个作用域，不同的人定义的变量可能会重复从而产生覆盖。</li></ol><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 试想彭彭定义了一个变量 </span>name <span class="token operator">=</span> <span class="token string">'pengpeng'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 后来，丁满后面又定义了</span>name <span class="token operator">=</span>  <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 再后来， 彭彭开始使用他定义的变量</span><span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'pengpeng'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><p>这就杯具了。</p><ol start="2"><li><strong>依赖关系管理的灾难</strong><pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"a.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"b.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"c.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>如果c依赖了b，b依赖了a，则script引入的顺序必须被依赖的放在前面，试想要是有几十个文件，我们都要弄清楚文件依赖关系然后手动，按顺序引入，无疑这是非常痛苦的事情。</li></ol><h2 id="早期的解决方式"><a href="#早期的解决方式" class="headerlink" title="早期的解决方式"></a>早期的解决方式</h2><ol><li><p><strong>闭包</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> moduleA <span class="token operator">=</span> <span class="token keyword">function</span>（） <span class="token punctuation">{</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token punctuation">{</span>   add<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这样function内部的变量就对全局隐藏了，达到了封装的目的，但是最外层模块名还是暴露在全局，要是模快越来越多，依然会存在模块名冲突的问题.</p></li><li><p><strong>命名空间</strong><br>Yahoo的YUI早起的做法</p><pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>moduleA<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> app<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>moduleA<span class="token punctuation">.</span>a <span class="token operator">+</span> c<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>毫无疑问以上两种方法都不够优雅。<br>那么，模块化到底需要解决什么问题提呢？我们先设想一下可能有以下几点:</p><blockquote><ul><li>安全的包装一个模块的代码，避免全局污染</li><li>唯一标识一个模块</li><li>优雅的将模块api暴露出去</li><li>方便的使用模块</li></ul></blockquote></li></ol><h1 id="服务端模块化"><a href="#服务端模块化" class="headerlink" title="服务端模块化"></a>服务端模块化</h1><p>Nodejs出现开创了一个新的纪元，使得我们可以使用javascript写服务器代码，对于服务端而言必然是需要模块化的。</p><h2 id="Nodejs-与-CommonJs的关系"><a href="#Nodejs-与-CommonJs的关系" class="headerlink" title="Nodejs 与 CommonJs的关系"></a>Nodejs 与 CommonJs的关系</h2><ul><li>node的模块化能以一种成熟的姿态出现离不开CommonJs规范</li><li>在服务器端CommonJS能以一种寻常的姿态写进各个公司的项目代码中，离不开Node的优异表现</li><li>Node并非完全按照规范实现，针对模块规范进行了一定的取舍，同时也增加了少许自身特性<blockquote><p>以上三点是摘自朴灵的《深入浅出Nodejs》</p></blockquote></li></ul><h2 id="CommonJS规范简介"><a href="#CommonJS规范简介" class="headerlink" title="CommonJS规范简介"></a>CommonJS规范简介</h2><p>CommonJS对模块的定义非常简单，主要分为<strong>模块引用</strong>，<strong>模块定义</strong>和<strong>模块标识</strong>3部分</p><h3 id="模块引用"><a href="#模块引用" class="headerlink" title="模块引用"></a><strong>模块引用</strong></h3><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./add.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'config.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="模块定义"><a href="#模块定义" class="headerlink" title="模块定义"></a><strong>模块定义</strong></h3><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> xx<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以在另一个文件中引入模块并导出另一个模块</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./add.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>其实，<strong>一个文件代表一个模块，一个模块除了自己的函数作用域之外，最外层还有一个模块作用域，module就是代表这个模块，exports是module的属性。require也在这个模块的上下文中，用来引入外部模块。</strong></p><h3 id="模块标识"><a href="#模块标识" class="headerlink" title="模块标识"></a><strong>模块标识</strong></h3><p>模块标识就是require( )函数的参数，规范是这样的：</p><blockquote><ul><li>必须是字符串</li><li>可以是以./ ../开头的相对路径</li><li>可以是绝对路径</li><li>可以省略后缀名</li></ul></blockquote><p>CommonJS的模块规范定义比较简单，意义在于将类聚的方法和变量等限定在私有的作用域中，同时支持引入和导出将上下游模块无缝衔接，每个模块具有独立的空间，它们互不干扰。</p><h2 id="Nodejs的模块化实现"><a href="#Nodejs的模块化实现" class="headerlink" title="Nodejs的模块化实现"></a>Nodejs的模块化实现</h2><p><strong>Node模块在实现中并非完全按照CommonJS来，进行了取舍，增加了一些自身的的特性。</strong><br>Node中一个文件是一个模块——module<br>一个模块就是一个Module的实例<br>Node中Module构造函数:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> Module（id<span class="token punctuation">,</span> parent）<span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>    parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实例化一个模块</span> <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>其中id 是模块id，exports是这个模块要暴露出来的api，parent是父级模块，loaded表示这个模块是否加载完成，因为CommonJS是运行时加载，loaded表示文件是否已经执行完毕返回一个对象。</p><h1 id="前端模块化"><a href="#前端模块化" class="headerlink" title="前端模块化"></a>前端模块化</h1><p>前面我们所说的CommonJS规范，都是基于node来说的，所以前面说的CommonJS都是针对服务端的实现。</p><h2 id="前端模块化和服务端模块化有什么区别？"><a href="#前端模块化和服务端模块化有什么区别？" class="headerlink" title="前端模块化和服务端模块化有什么区别？"></a>前端模块化和服务端模块化有什么区别？</h2><ul><li>服务端加载一个模块，直接就从硬盘或者内存中读取了，消耗时间可以忽略不计</li><li>浏览器需要从服务端下载这个文件，所以说如果用CommonJS的require方式加载模块，需要等代码模块下载完毕，并运行之后才能得到所需要的API。</li></ul><h2 id="为什么CommonJS不适用于前端模块？"><a href="#为什么CommonJS不适用于前端模块？" class="headerlink" title="为什么CommonJS不适用于前端模块？"></a>为什么CommonJS不适用于前端模块？</h2><p><strong>如果我们在某个代码模块里使用CommonJS的方法require了一个模块，而这个模块需要通过http请求从服务器去取，如果网速很慢，而CommonJS又是同步的，所以将阻塞后面代码的执行，从而阻塞浏览器渲染页面，使得页面出现假死状态。</strong></p><p>因此后面AMD规范随着RequireJS的推广被提出，异步模块加载，不阻塞后面代码执行的模块引入方式，就是解决了前端模块异步模块加载的问题。</p><h2 id="AMD-amp-amp-requieJs"><a href="#AMD-amp-amp-requieJs" class="headerlink" title="AMD &amp;&amp; requieJs"></a>AMD &amp;&amp; requieJs</h2><p>AMD——异步模块加载规范 与CommonJS的主要区别就是异步模块加载，就是模块加载过程中即使require的模块还没有获取到，也不会影响后面代码的执行。</p><p>RequireJS——AMD规范的实现。其实也可以说AMD是RequireJS在推广过程中对模块定义的规范化产出。</p><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 独立模块定义 ---- 不依赖其它模块的模块定义</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  method1<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  method2<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 或者</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    method1<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    method2<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 非独立模块——依赖其他模块的模块定义</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'math'</span><span class="token punctuation">,</span> <span class="token string">'graph'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>math<span class="token punctuation">,</span> graph<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 模块引用：</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>  a<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  b<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h3 id="对比CommonJs和AMD"><a href="#对比CommonJs和AMD" class="headerlink" title="对比CommonJs和AMD"></a>对比CommonJs和AMD</h3><ul><li>CommonJS一般用于服务端，AMD一般用于浏览器客户端</li><li>CommonJS和AMD都是<strong>运行时加载</strong><blockquote><p>如果一种模块加载方式满足两种条件，那就是运行时加载</p><ol><li>运行时能确定模块之间的依赖关系(依赖前置)</li><li>require一个模块的时候，模块会先被执行，并返回一个对象，并且这个对象是整体加载的</li></ol></blockquote></li></ul><h2 id="CMD-amp-amp-SeaJS"><a href="#CMD-amp-amp-SeaJS" class="headerlink" title="CMD &amp;&amp; SeaJS"></a>CMD &amp;&amp; SeaJS</h2><p>CMD——通用模块规范，由国内的玉伯提出。<br>SeaJS——CMD的实现，其实也可以说CMD是SeaJS在推广过程中对模块定义的规范化产出。<br>与AMD规范的主要区别在于定义模块和依赖引入的部分。<strong>AMD需要在声明模块的时候指定所有的依赖</strong>，通过形参传递依赖到模块内容中：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dep1'</span><span class="token punctuation">,</span> <span class="token string">'dep2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>dep1<span class="token punctuation">,</span> dep2<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>与AMD模块规范相比，CMD模块更接近于Node对CommonJS规范的定义，CMD规范中，一个文件就是一个模块，使用define来进行模块：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span></code></pre><p>这里的define是一个全局函数，用来定义模块，这里的factory参数既可以是函数，又可以是字符串或对象。<strong>如果参数是字符串或对象时，表示该模块的接口就是是该对象或字符串</strong></p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'website'</span><span class="token punctuation">:</span><span class="token string">'oecom'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'这里是OECOM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>当factory为函数时，此函数就是模块的构造方法，该函数默认为提供三个参数：require,exports,module，在需要依赖模块时，随时调用require( )引入即可</strong>，示例如下：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//依赖模块a 推崇就近原则</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//调用模块a的方法</span>  a<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>也就是说与AMD相比，<strong>CMD推崇依赖就近(延迟执行，用到再引入)， AMD推崇依赖前置(提前执行)</strong></p><h2 id="UMD-Universal-Module-Definition-通用模块规范"><a href="#UMD-Universal-Module-Definition-通用模块规范" class="headerlink" title="UMD(Universal Module Definition), 通用模块规范"></a>UMD(Universal Module Definition), 通用模块规范</h2><p>如下是codemirror模块lib/codemirror.js模块的定义方式：</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">,</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span>        <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// Node , CommonJS</span>       <span class="token punctuation">:</span> <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd           <span class="token operator">?</span> <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span>                   <span class="token comment" spellcheck="true">//AMD CMD</span>         <span class="token punctuation">:</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>CodeMirror <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//模块挂载到全局</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>可以看说所谓的兼容模式是将几种常见模块定义方式都兼容处理。<br>目前为止，前端常用的几种模块化规范都已经提到，还有一种我们项目里用得非常多的模块化引入和导出，就是ES6的模块化。</p><h2 id="ES6模块化"><a href="#ES6模块化" class="headerlink" title="ES6模块化"></a>ES6模块化</h2><p>如前面所述，<strong>CommonJS和AMD都是运行时加载。ES6在语言规格层面上实现了模块功能，是编译时加载</strong>，完全可以取代现有的CommonJS和AMD规范，可以成为<strong>浏览器和服务器通用的模块解决方案</strong>。这里关于ES6模块我们项目里使用非常多，所以详细讲解。</p><p><strong>Es6模块导出—export</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 导出变量</span><span class="token keyword">export</span> <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'pengpeng'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 导出函数</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 常用导出方式(推荐)</span><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token string">'18'</span><span class="token punctuation">;</span><span class="token keyword">const</span> addr <span class="token operator">=</span> <span class="token string">'卡尔斯特森林'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> year <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// as 用法</span><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span>  s <span class="token keyword">as</span> t<span class="token punctuation">,</span>  s <span class="token keyword">as</span> m<span class="token punctuation">,</span> <span class="token punctuation">}</span></code></pre><p><strong>Es6模块导出—import</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 一般用法</span><span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// as 用法</span><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> personName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>整体模块加载</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> name <span class="token operator">=</span> <span class="token string">'xixi'</span><span class="token punctuation">;</span><span class="token keyword">export</span> age <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//逐一加载</span><span class="token keyword">import</span> <span class="token punctuation">{</span> age<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//整体加载</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> person <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>ES6模块使用——export default</strong><br>其实export default，在项目里用的非常多，一般一个Vue组件或者React组件我们都是使用export default命令，需要注意的是使用export default命令时，import是不需要加{}的。而不使用export default时，import是必须加{}，示例如下：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> getName <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>export default其实是导出一个叫做default的变量，所以其后面不能跟变量声明语句。</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//错误</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><p><strong>值得注意的是我们可以同时使用export 和export default</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> name <span class="token operator">=</span> <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> getName<span class="token punctuation">,</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>import命令具有提升效果，会提升到整个模块的头部，首先执行，如下也不会报错</strong></p><pre class=" language-js"><code class="language-js"><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'person_module'</span><span class="token punctuation">;</span></code></pre><p>前面一直提到，<strong>CommonJS是运行时加载，ES6时编译时加载</strong>，那么两个有什么本质的区别呢？</p><h2 id="ES6模块与CommonJS模块加载区别"><a href="#ES6模块与CommonJS模块加载区别" class="headerlink" title="ES6模块与CommonJS模块加载区别"></a>ES6模块与CommonJS模块加载区别</h2><p><strong>ES6模块的设计思想，是尽量的静态化，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。所以说ES6是编译时加载</strong>，不同于CommonJS的运行时加载(实际加载的是一整个对象)，ES6模块不是对象，而是通过export命令显式指定输出的代码，输入时也采用静态命令的形式：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ES6模块</span><span class="token keyword">import</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// CommonJS模块</span><span class="token keyword">let</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以上这种写法es6加载与CommonJS的模块加载有什么不同？</p><ul><li>当require path模块时，其实 <strong>CommonJS会将path模块运行一遍，并返回一个对象，并将这个对象缓存起来，这个对象包含path这个模块的所有API。以后无论多少次加载这个模块都是取这个缓存的值，也就是第一次运行的结果，除非手动清除。</strong></li><li>ES6会从path模块只加载3个方法，其他不会加载，这就是编译时加载。ES6可以在编译时就完成模块加载，当ES6遇到import时，不会像CommonJS一样去执行模块，而是生成一个动态的只读引用，当真正需要的时候再到模块里去取值，所以<strong>ES6模块是动态引用，并且不会缓存值。</strong></li></ul><p>因为CommonJS模块输出的是值的拷贝，所以当模块内值变化时，不会影响到输出的值。基于Node做以下尝试：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js Node环境</span><span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span><span class="token punctuation">{</span>  age<span class="token punctuation">:</span> age<span class="token punctuation">,</span>  addAge<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    age<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./person.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>person<span class="token punctuation">.</span><span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出结果 可以看到内部age的变化并不会影响person.age的值，这是因为person.age的值始终是第一次运行时的结果的拷贝。s</span><span class="token number">18</span><span class="token number">18</span></code></pre><p>再看ES6</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> <span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  age<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> <span class="token punctuation">{</span> age<span class="token punctuation">,</span> addAge <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出结果</span><span class="token number">18</span><span class="token number">19</span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>前端模块化规范包括CommonJS/ AMD/CMD/ES6模块化，平时我们可能只知其中一种但不能全面了解他们的发展历史、用法和区别，以及当我们使用require 和import的时候到底发生了什么，这篇文章给大家算是比较全面的做了一次总结。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;为何前端需要模块化&quot;&gt;&lt;a href=&quot;#为何前端需要模块化&quot; class=&quot;headerlink&quot; title=&quot;为何前端需要模块化&quot;&gt;&lt;/a&gt;为何前端需要模块化&lt;/h1&gt;&lt;p&gt;为了彻底弄清楚模块化这个东西，我们要从最开始模块化的起源说起。&lt;/p&gt;
&lt;h2 id
      
    
    </summary>
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/categories/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>webpack4篇(下)</title>
    <link href="yd.yangshuaiweb.com/2020/10/13/webpack4-pian-xia/"/>
    <id>yd.yangshuaiweb.com/2020/10/13/webpack4-pian-xia/</id>
    <published>2020-10-13T07:00:00.000Z</published>
    <updated>2020-12-01T02:56:05.486Z</updated>
    
    <content type="html"><![CDATA[<p>书接上篇。</p><h1 id="优化-module-noParse-不解析某些包的依赖库"><a href="#优化-module-noParse-不解析某些包的依赖库" class="headerlink" title="[优化] module.noParse 不解析某些包的依赖库"></a>[优化] module.noParse 不解析某些包的依赖库</h1><p>如果我们确信，某个包不会依赖其他包，那么可以配置 module.noParse 不去解析依赖库，如果依赖库很多的情况下，这种方法能明显提升打包效率。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>       noParse<span class="token punctuation">:</span> <span class="token regex">/jquery/</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 不去解析 jquery 中的依赖库</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="优化-webpack-IgnorePlugin-忽略包内引用-手动维护引用"><a href="#优化-webpack-IgnorePlugin-忽略包内引用-手动维护引用" class="headerlink" title="[优化] webpack.IgnorePlugin 忽略包内引用 手动维护引用"></a>[优化] webpack.IgnorePlugin 忽略包内引用 手动维护引用</h1><p>比如我们有一个moment包，使用如下:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置语言</span>moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endof</span><span class="token punctuation">(</span><span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "十四天前"</span></code></pre><p>我这里面只用了一个方法，打包却有 1.2M，分析了下，原来在 moment 入口文件 moment.js 中，它帮我们引入了各国的语言包。</p><pre class=" language-js"><code class="language-js"><span class="token function">aliasedRequire</span><span class="token punctuation">(</span><span class="token string">'./locale/'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>不过，我们实际需要的只有一个中文的包，这时候我们可以屏蔽掉包内对外部的某一个依赖，手动去维护这个引用。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>         <span class="token comment" spellcheck="true">// 如果从 moment 引入了 .locale 就把它忽略掉</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorPlugin</span><span class="token punctuation">(</span><span class="token regex">/\.\/locale/</span><span class="token punctuation">,</span> <span class="token regex">/moment/</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>然后执行我们代码，发现打包文件少了500k，moment设置语言不好使了，打印出去 in 14 hours，这时候我们需要手动引入需要的中文包。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 手动引入所需要的语言包</span><span class="token keyword">import</span> <span class="token string">'moment/locale/zh-cn'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置语言</span>moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endof</span><span class="token punctuation">(</span><span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "十四天前"</span></code></pre><h1 id="优化-dllPlugin-动态链接库-生成mainfest-json-构建速度提升10倍"><a href="#优化-dllPlugin-动态链接库-生成mainfest-json-构建速度提升10倍" class="headerlink" title="[优化] dllPlugin 动态链接库 生成mainfest.json 构建速度提升10倍"></a>[优化] dllPlugin 动态链接库 生成mainfest.json 构建速度提升10倍</h1><p>当我们一个项目引入了多个较大的包以后，这些包本身并不会运行，我们也不会修改这些包的代码，但是每当我们修改了业务代码之后，这些包也会被重新打包。极大的浪费了时间，这时我们就需要使用这个工具预先把静态资源提前打包，以后修改源文件再打包时就不会打包这些静态资源文件了。</p><p><strong>将静态资源文件（运行依赖包）与源文件分开打包，先使用DllPlugin给静态资源打包，再使用DllReferencePlugin让源文件引用资源文件。</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>h1<span class="token operator">></span>hello webpack<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>贴上webpack配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./dist'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>              <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span>              <span class="token string">'@babel/preset-react'</span> <span class="token comment" spellcheck="true">// 解析webpack语法</span>            <span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模板路径</span>      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>执行 npx webpack</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 3110msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">:</span><span class="token number">50</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js    <span class="token number">870</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">251</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>   </code></pre><p>可以看到，每次打包耗时3s，打包出来的文件有 870k，可是我们只写了一句代码~ 这其中包含了 react 和 react-dom 包的内容，这两个文件我们不会更改，我们能不能每次打包前，把这两个包抽离出去，引入到页面，打包后直接用呢。</p><p>我们新增两个文件</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.react.js</span><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    test<span class="token punctuation">:</span> <span class="token string">'./src/test.js'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>分析打包后的 test.js，此处只留下一些关键代码</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span>    <span class="token comment" spellcheck="true">// The module cache</span>    <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The require function</span>    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token punctuation">{</span>    <span class="token string">"./src/test.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = 123;\n\n//# sourceURL=webpack:///./src/test.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>可以看到，打包后的文件把我们的 exports 返回了，却并没有接收。我们可以在外部定义一个变量结束模块返回值。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span>    <span class="token comment" spellcheck="true">// The module cache</span>    <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The require function</span>    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token punctuation">{</span>    <span class="token string">"./src/test.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = 123;\n\n//# sourceURL=webpack:///./src/test.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 123</span></code></pre><p>ok，可以拿到我们模块的输出结果，但是不能每次都这么手动去加啊，其实 output 属性提供了配置项 library: ‘a’</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    test<span class="token punctuation">:</span> <span class="token string">'./src/test.js'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 用变量 a 接收模块输出的结果  var a = (fn() {  return module.exports; } ())</span>    library<span class="token punctuation">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 解析方式 </span>    <span class="token comment" spellcheck="true">// 不写默认为var 代表 var a = 模块返回结果 </span>    <span class="token comment" spellcheck="true">// 如果是 commonjs 代表 export['a'] = 模块返回结果</span>    <span class="token comment" spellcheck="true">// umd 代表兼容各版本写法</span>    libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这时候，a变量就能拿到模块的返回值了，我们需要做一件事儿，就是把入口文件，换成真正需要提取的库名</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 把两个包统一作为名为 react 的入口文件</span>     react<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 打包出的应为 _dll_react_vendor.js</span>    filename<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor.js'</span><span class="token punctuation">,</span>     path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 用变量 _dll_react_vendor 接收模块输出的结果  </span>    <span class="token comment" spellcheck="true">// var _dll_react_vendor = (fn() {  return module.exports; } ())</span>    library<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor'</span><span class="token punctuation">,</span>     libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>       name<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 需要跟上面变量名一致，便于查找</span>      path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'mainfest.json'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 生成资产清单文件</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>这时候打包，我们就发现 dist 目录新增文件 _dll_react_vendor.js，mainfest.json</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mainfest.json</span><span class="token punctuation">{</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"_dll_react_vendor"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 根据这个去找对应 js 所以要跟 js 文件名一样</span>  <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"./node_modules/object-assign/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/object-assign/index.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"./node_modules/react-dom/cjs/react-dom.development.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/react-dom/cjs/react-dom.development.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"./node_modules/react-dom/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/react-dom/index.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>资产清单上记录着 [name].js 上提供了哪些包。</strong></p><p>修改 html</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- 引入dll动态库 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/_dll_react_vendor.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p><strong>此时我们引入了 dll 动态库，我们是不是需要告诉 webpack，你引入包的时候，先去我动态库中查找是否有这些包，如果有的话，就别打包了。怎么告诉它呢，webpack 提供了配套使用的 c，我们来修改 webpack.config.js 代码，注意，不是 webpack.config.react.js 哦。</strong></p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// 先去查找 dll 资源清单，清单找不到的时候，再去打包文件</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>       manifest<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'manifest.json'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>第一次要先执行dll文件的打包命令(不然因为 manifest.json 未生成，DllReferencePlugin 会报错哦)</p><pre class=" language-js"><code class="language-js">npx webpack <span class="token operator">--</span>config<span class="token operator">=</span>webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>react<span class="token punctuation">.</span>js</code></pre><p>然后打包我们的主文件即可</p><pre class=" language-js"><code class="language-js">npx webpack</code></pre><p>发现主文件大小从 870k 变为 6k，打包时间从 3110ms 变为 409ms</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 409msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">12</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js   <span class="token number">6.27</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">299</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js</code></pre><h1 id="优化-happypack-多线程打包"><a href="#优化-happypack-多线程打包" class="headerlink" title="[优化] happypack 多线程打包"></a>[优化] happypack 多线程打包</h1><p>由于HappyPack 对file-loader、url-loader 支持的不友好，所以不建议对该loader使用。</p><pre class=" language-js"><code class="language-js">yarn add happypack <span class="token operator">-</span>D</code></pre><p>修改 js的loader 为 happypack/loader，并添加 plugin 配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'Happypack/loader?id=haha'</span> <span class="token comment" spellcheck="true">// 代表 js 需要多线程</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// css 同</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// css 同</span>    <span class="token keyword">new</span> <span class="token class-name">Happypack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      id<span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// id 标识符，要和 rules 中指定的 id 对应起来</span>      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>           loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>           options<span class="token punctuation">:</span> <span class="token punctuation">{</span>             presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-react'</span><span class="token punctuation">]</span>           <span class="token punctuation">}</span>         <span class="token punctuation">}</span>      <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>打包下，发现启动了三个线程去打包，但是打包比之前还慢了 100ms，这是怎么回事呢？</p><pre class=" language-js"><code class="language-js"><span class="token operator">></span> npx webpackHappy<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">:</span> Version<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span> Threads<span class="token punctuation">:</span> <span class="token number">3</span>Happy<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">:</span> All <span class="token keyword">set</span><span class="token punctuation">;</span> signaling webpack to proceed<span class="token punctuation">.</span>Hash<span class="token punctuation">:</span> 5107dc46f2f09ddd86c9Version<span class="token punctuation">:</span> webpack <span class="token number">4.44</span><span class="token punctuation">.</span><span class="token number">2</span>Time<span class="token punctuation">:</span> 989msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">15</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js   <span class="token number">6.27</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">299</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js</code></pre><p>原来，如果代码量不多的话，使用 happypack 反而会拖慢打包速度哦，所以酌情看需不需要开启多线程打包~</p><h1 id="自带优化-js-的-tree-shaking-生产环境-amp-amp-import-语法生效"><a href="#自带优化-js-的-tree-shaking-生产环境-amp-amp-import-语法生效" class="headerlink" title="[自带优化] js 的 tree-shaking (生产环境 &amp;&amp;  import 语法生效)"></a>[自带优化] js 的 tree-shaking (生产环境 &amp;&amp;  import 语法生效)</h1><p>修改下代码</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> calc <span class="token keyword">from</span> <span class="token string">'./test'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span><span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">'sum'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> minus <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token string">'minus'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> sum<span class="token punctuation">,</span> minus <span class="token punctuation">}</span></code></pre><p>这时候打包，我们发现 sum 和 minus 都在 dist/bundle.js 中，但是我只用到了 sum 呀，能不能把我没用到的方法不打包呢，这时候我们把 mode 改为生成环境再次打包，发现 minus 方法被优化掉了，这就是 webpack4 自带的摇树优化。</p><p>需要注意的是，摇树优化只针对 import 语法导入的模块生效，require 无效哦。</p><h1 id="自带优化-scope-hoisting-作用域提升-生效条件如上"><a href="#自带优化-scope-hoisting-作用域提升-生效条件如上" class="headerlink" title="[自带优化] scope hoisting 作用域提升 (生效条件如上)"></a>[自带优化] scope hoisting 作用域提升 (生效条件如上)</h1><p><strong>webpack3之后，webpack新增了 scope hoisting优化，在 webpack 中会自动省略一些可以简化的代码(import语法)，并且正常来说 webpack 的引入都是把各个模块分开，通过 <strong>webpack_require</strong>  导入导出模块，但是使用 scope hoisting 后会把需要导入的文件直接移入导入者顶部，这就是所谓的 hoisting。</strong></p><p><strong>记得设置 mode 为 production哦</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// inex.js</span><span class="token keyword">import</span> calc <span class="token keyword">from</span> <span class="token string">'./test'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">let</span> d <span class="token operator">=</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">'----------------'</span><span class="token punctuation">)</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span><span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">'sum'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> minus <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token string">'minus'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> sum<span class="token punctuation">,</span> minus <span class="token punctuation">}</span></code></pre><p>我们分析打包后的代码， 发现一些重复的代码都被干掉了(a，b，c，d)，直接把结果6放上了，而且引用其他模块的方法，也是直接声明在了当前模块的顶端，减少了引用操作，这就是 scope hoisting!!!</p><pre class=" language-js"><code class="language-js">  <span class="token operator">...</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token string">"use strict"</span><span class="token punctuation">;</span>    r<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> e <span class="token operator">+</span> t <span class="token operator">+</span> <span class="token string">"sum"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">n</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token operator">...</span></code></pre><h1 id="优化-splitChunks-抽取公共代码-避免多次打包"><a href="#优化-splitChunks-抽取公共代码-避免多次打包" class="headerlink" title="[优化] splitChunks 抽取公共代码 避免多次打包"></a>[优化] splitChunks 抽取公共代码 避免多次打包</h1><p>新增 a.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">,</span> <span class="token string">'--------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>新增 b.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// b.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">,</span> <span class="token string">'--------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>新增 other.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// other.js</span><span class="token keyword">import</span> <span class="token string">'./a'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./b'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'other.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> <span class="token string">'./a'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./b'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 入口和出口配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    index<span class="token punctuation">:</span> <span class="token string">'./src/index'</span><span class="token punctuation">,</span>    other<span class="token punctuation">:</span> <span class="token string">'./src/other'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p>执行打包，可以看到，dist/index.js 和 dist/other.js 都有公共模块的代码。</p><p>能不能把这两个模块抽离出来，变成一个公共模块，然后在 index 和 other分别引入这个模块呢，这样就不会打包两遍 a.js 和 b.js 啦。webpack提供了 splitChunks 来帮助我们抽离公共文件。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 分割代码块</span>      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 缓存组</span>        common<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 我们定义一个公共的模块</span>          chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>          minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这时候进行打包，我们发现 dist 目录多了一个 common~index~other.js，这里面就是我们要提取的公共模块代码，而 dist/index.js 和 dist/other.js 则没有公共模块的代码。</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span>window<span class="token punctuation">.</span>webpackJsonp <span class="token operator">=</span> window<span class="token punctuation">.</span>webpackJsonp <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token string">"--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token string">"--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>这时候我们又有一个想法，如果我们引了两次 jquery，你都给我提到 common 模块中，那得多大呀，我想把第三方包抽成一个 vendor包！</strong></p><p>我们来模拟一下，在 index.js 和 other.js 中都加上如下代码</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这时候打包，一看 common~index~other.js 增加了 80k，这是不能容忍的！</p><p>这时我们可以加一个要抽离出的公共包，叫 vendor。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 分割代码块</span>      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 缓存组</span>        common<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 我们定义一个公共的模块</span>          chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>          minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      vendor<span class="token punctuation">:</span> <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 如果引了 node_modules 下的包才考虑抽离</span>        chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>        minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>        minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        priority<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// 权重比上面的高一点 优先检查三方包的抽离以免全部打进 common</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行打包命令，我们发现 jquery 已经从 common包中抽离出去了</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 3910msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">28</span>                Asset       Size  Chunks             Chunk Namescommon<span class="token operator">~</span>index<span class="token operator">~</span>other<span class="token punctuation">.</span>js  <span class="token number">163</span> bytes       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  common<span class="token operator">~</span>index<span class="token operator">~</span>other           index<span class="token punctuation">.</span>html  <span class="token number">396</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>               index<span class="token punctuation">.</span>js   <span class="token number">1.58</span> KiB       <span class="token number">2</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  index             other<span class="token punctuation">.</span>js   <span class="token number">1.58</span> KiB       <span class="token number">3</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  othervendor<span class="token operator">~</span>index<span class="token operator">~</span>other<span class="token punctuation">.</span>js   <span class="token number">88.5</span> KiB       <span class="token number">1</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  vendor<span class="token operator">~</span>index<span class="token operator">~</span>other</code></pre><h1 id="import-懒加载"><a href="#import-懒加载" class="headerlink" title="import() 懒加载"></a>import() 懒加载</h1><p>比如页面有个按钮，点击按钮，我希望加载某段js。</p><p>新建 src/source.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// source.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'ys'</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'杨帅加油'</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// es2020 草案中的语法 jsonp实现动态加载文件 返回一个 promise 实例</span>  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./source.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们点击按钮，可以看到 network加载了一段 js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 5.js</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>webpackJsonp<span class="token operator">=</span>window<span class="token punctuation">.</span>webpackJsonp<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>s<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">"use strict"</span><span class="token punctuation">;</span>w<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token operator">=</span><span class="token string">"ys"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>同时页面打印出 模块的导出值 ys</p><p><strong>import()函数可以用在任何地方，不仅仅是模块，非模块的脚本也可以使用。它是也是 vue 和 react 路由懒加载的实现，它是运行时执行，也就是说，什么时候运行到这一句，就会加载指定的模块。另外，import()函数与所加载的模块没有静态连接关系，这点也是与import语句不相同。import()类似于 Node 的require方法，区别主要是前者是异步加载，后者是同步加载。</strong></p><h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>在之前，每次更改代码，都会导致页面重新刷新，我们能不能做到，只更新某一部分，let do it</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// source.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'log from source!'</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> str <span class="token keyword">from</span> <span class="token string">'./source'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 热更关键代码</span><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./source'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件更新了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./source'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 因为 import只能在顶上用</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>    hot<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 注意加了这行代码</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./dist'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>       <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 热更新插件</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>这时候修改代码，页面就会热更啦</p><h1 id="Tapable-webpack核心之事件流"><a href="#Tapable-webpack核心之事件流" class="headerlink" title="Tapable  - webpack核心之事件流"></a>Tapable  - webpack核心之事件流</h1><p><strong>webpack 本质上是一种事件流的机制，它的工作流程就是将各种插件串联起来，而实现这一切的核心就是 Tapable，Tapable有点类似于 nodejs 的 events 库，核心原理也是依赖于发布订阅模式。</strong></p><p>在 webpack/lib/Compiler.js中 </p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>    Tapable<span class="token punctuation">,</span>    SyncHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 同步钩子</span>    SyncBailHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 同步钩子</span>    AsyncParallelHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 异步钩子</span>    AsyncSeriesHook <span class="token comment" spellcheck="true">// 异步钩子</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里我们就来应用下这些方法，并且实现它的原理，为后面手写代码做准备。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gl2tjc7kk4j30re0cgmxj.jpg" alt></p><p>安装 tapable</p><pre><code>yarn add tapable</code></pre><h2 id="SyncHook-同步钩子"><a href="#SyncHook-同步钩子" class="headerlink" title="SyncHook -- 同步钩子"></a>SyncHook -- 同步钩子</h2><p>维护同步函数队列，调用时依次执行，不可以中止执行。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ysvue 学习 ys</code></pre><p>实现这样一个同步的钩子也很简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ysSyncHook.js</span><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span></code></pre><h2 id="SyncBailHook-带保险-可以控制是否往下执行-的同步钩子"><a href="#SyncBailHook-带保险-可以控制是否往下执行-的同步钩子" class="headerlink" title="SyncBailHook -- 带保险(可以控制是否往下执行)的同步钩子"></a>SyncBailHook -- 带保险(可以控制是否往下执行)的同步钩子</h2><p>维护同步函数队列，调用时依次执行，可以中止执行。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'太难了，学不会了'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回一个非 undefined 的值 即终止！</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ys</code></pre><p>手动实现也特别简单，只需要修改边界条件即可</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncBailHook</span><span class="token keyword">class</span> <span class="token class-name">SyncBailHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 终止条件为某次执行结果不为undefined 或者全部执行完毕</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!==</span> undefined <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="SyncWaterfallHook-函数执行结果依次传递的同步钩子"><a href="#SyncWaterfallHook-函数执行结果依次传递的同步钩子" class="headerlink" title="SyncWaterfallHook -- 函数执行结果依次传递的同步钩子"></a>SyncWaterfallHook -- 函数执行结果依次传递的同步钩子</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'webpack4 学会了！！'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 传递给下一个函数的data</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ysvue 学习 webpack4 学会了！！</code></pre><p>emm.. 实现起来也比较简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncWaterfallHook</span><span class="token keyword">class</span> <span class="token class-name">SyncWaterfallHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ret<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 有结果就传递结果给下个函数 没有结果则传递 args</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="SyncLoopHook-循环执行的可控制同步钩子"><a href="#SyncLoopHook-循环执行的可控制同步钩子" class="headerlink" title="SyncLoopHook -- 循环执行的可控制同步钩子"></a>SyncLoopHook -- 循环执行的可控制同步钩子</h2><p>webpack 本身没有用到这个方法，但这个方法挺有意思的，这个钩子一旦被调用，就会循环执行，直到钩子回调函数返回 undefined。</p><p>比如下面这个例子，webpack4 我想学习三遍之后，再学习 vue。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token comment" spellcheck="true">// let { SyncLoopHook } = require('./ysSyncLoopHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">++</span>_this<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token string">'继续学习 webpack4'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 yswebpakc4 学习 yswebpakc4 学习 ysvue 学习 ys</code></pre><p>哈.. 实现起来也比较简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncLoopHook</span><span class="token keyword">class</span> <span class="token class-name">SyncLoopHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 某次循环终止条件为返回值等于 undefined</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> i<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncParallelHook-异步并行的钩子-tapAsync版"><a href="#AsyncParallelHook-异步并行的钩子-tapAsync版" class="headerlink" title="AsyncParallelHook -- 异步并行的钩子(tapAsync版)"></a>AsyncParallelHook -- 异步并行的钩子(tapAsync版)</h2><p>异步钩子的用法和同步区别在于，异步钩子是用 tapAsync 方法注册监听函数 callAsync 方法执行回调，并且每个监听函数都要调用 cb。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncParallelHook } = require('./ysAsyncParallelHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 1s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 2s later</span></code></pre><p>可以看到，上面代码监听函数每次回调中都执行了cb()，原理是存在着一个计数器，如果执行完毕的任务数等于注册的监听函数数量，则执行我们传入的回调函数，它的实现特别像 Promise.all。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncParallelHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapAsync</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> finallyCb <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 弹出最后一个参数</span>    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 计数</span>    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      count<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">finallyCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 并发执行 forEach</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncParallelHook-异步并行的钩子-tapPromise版"><a href="#AsyncParallelHook-异步并行的钩子-tapPromise版" class="headerlink" title="AsyncParallelHook -- 异步并行的钩子(tapPromise版)"></a>AsyncParallelHook -- 异步并行的钩子(tapPromise版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapPromise 方法注册监听函数 promise 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><h2 id="AsyncParallelBillHook-异步并行可取消的钩子-不再赘述"><a href="#AsyncParallelBillHook-异步并行可取消的钩子-不再赘述" class="headerlink" title="AsyncParallelBillHook -- 异步并行可取消的钩子 不再赘述"></a>AsyncParallelBillHook -- 异步并行可取消的钩子 不再赘述</h2><h2 id="AsyncSeriesHook-异步串行的钩子-tapAsync版"><a href="#AsyncSeriesHook-异步串行的钩子-tapAsync版" class="headerlink" title="AsyncSeriesHook -- 异步串行的钩子(tapAsync版)"></a>AsyncSeriesHook -- 异步串行的钩子(tapAsync版)</h2><p>如果我们下一个注册的监听函数回调依赖了上一个函数回调的返回结果，这时候就不能并发执行了。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesHook } = require('./ysAsyncSeriesHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>手动实现它并不费劲</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncSeriesHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapAsync</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> finallyCb <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 全部执行完毕 触发最终钩子回调</span>    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 每个函数回调内执行后(cb执行)，调用该方法执行下一个函数(递归)</span>    <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finallyCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> tasks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncSeriesHook-异步串行的钩子-tapPromise版"><a href="#AsyncSeriesHook-异步串行的钩子-tapPromise版" class="headerlink" title="AsyncSeriesHook -- 异步串行的钩子(tapPromise版)"></a>AsyncSeriesHook -- 异步串行的钩子(tapPromise版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapPromise 方法注册监听函数 promise 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesHook } = require('./ysAsyncSeriesHookPromise'); // promise 版 同步并发</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 promise 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>ok，我们来实现它</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncParallelHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapPromise</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">...</span>other<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取出第一个任务</span>    <span class="token keyword">return</span> other<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 类似 redux 源码</span>      <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapAsync版"><a href="#AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapAsync版" class="headerlink" title="AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapAsync版)"></a>AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapAsync版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesWaterfallHook } = require('./ysAsyncSeriesWaterfallHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// cb第一个参数为error 则不继续调用 为null 则往下继续调用 第二个参数为传递的参数</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 result <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦 <span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>实现一下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// let { AsyncSeriesWaterfallHook } = require('tapable'); // 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ysAsyncSeriesWaterfallHook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// cb第一个参数为error 则不继续调用 为null 则往下继续调用 第二个参数为传递的参数</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><h2 id="AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapPromise版"><a href="#AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapPromise版" class="headerlink" title="AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapPromise版)"></a>AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapPromise版)</h2><p>略..</p><h2 id="tapable库用法总结"><a href="#tapable库用法总结" class="headerlink" title="tapable库用法总结"></a>tapable库用法总结</h2><p>tapable提供的钩子函数，有<strong>三种注册监听函数的方法</strong>，分别是 </p><ul><li>tap 同步注册</li><li>tapAsync(cb) 异步注册</li><li>tapPromise(异步注册的是promise)</li></ul><p><strong>调用的方法也是有三种</strong></p><ul><li>call </li><li>callAsync</li><li>promise</li></ul><h1 id="手写-webpack"><a href="#手写-webpack" class="headerlink" title="手写 webpack"></a>手写 webpack</h1><p>目录结构</p><pre class=" language-js"><code class="language-js"><span class="token operator">-</span>bin  <span class="token operator">-</span> ys<span class="token operator">-</span>pack<span class="token operator">-</span> lib  <span class="token operator">-</span> Compiler<span class="token punctuation">.</span>js<span class="token operator">-</span> src  <span class="token operator">-</span> index<span class="token punctuation">.</span>js<span class="token operator">-</span> webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">var</span>  a  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'导入模块: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span></code></pre><h2 id="1-读取-webpack-config-js-文件"><a href="#1-读取-webpack-config-js-文件" class="headerlink" title="1) 读取 webpack.config.js 文件"></a>1) 读取 webpack.config.js 文件</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// bin/ys-pack</span>#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 拿到 webpack 配置文件</span><span class="token keyword">let</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用来编译的类</span><span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 配置传入</span>compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 运行编译</span></code></pre><h2 id="2）添加-compiler-编译类-解析模块id-模块内容"><a href="#2）添加-compiler-编译类-解析模块id-模块内容" class="headerlink" title="2）添加 compiler 编译类 解析模块id 模块内容"></a>2）添加 compiler 编译类 解析模块id 模块内容</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// lib/Compiler.js</span><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 需要保存入口文件的路径</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './src/index.js' </span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前执行命令的文件根目录 用于查找入口文件的真实路径</span>    <span class="token comment" spellcheck="true">// 需要保存所有的模块依赖</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 结构为 路径: 代码 也就是编译后源码的webpack启动函数参数</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`模块id：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p>此刻执行 npx-pack</p><pre class=" language-js"><code class="language-js">模块id：<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">,</span>模块内容：<span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-添加-parse方法-替换require、修复依赖模块id"><a href="#3-添加-parse方法-替换require、修复依赖模块id" class="headerlink" title="3) 添加 parse方法 替换require、修复依赖模块id"></a>3) 添加 parse方法 替换require、修复依赖模块id</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`模块id：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @description 生成 AST 解析语法树   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">,</span> <span class="token string">'bingo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><h2 id="4-parse-方法实现"><a href="#4-parse-方法实现" class="headerlink" title="4) parse 方法实现"></a>4) parse 方法实现</h2><p>这里介绍几个node包</p><ul><li>babylon 将 js 转换成 ast</li><li>@babel/traverse 遍历 ast </li><li>@babel/types 替换 ast 某节点</li><li>@babel/generator 将 ast 解码生 js代码</li></ul><p><a href="https://astexplorer.net/" target="_blank" rel="noopener">在线查看 ast 结构</a></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 源码解析成 ast</span>    <span class="token keyword">let</span> dependncies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块依赖的模块数组</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token function">CallExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里建议在以上贴的网站参考 require('a.js') 转成的 ast结构</span>        <span class="token keyword">let</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对应的节点</span>        <span class="token comment" spellcheck="true">// 如果标签为 require</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span><span class="token punctuation">;</span>          <span class="token keyword">let</span> moduleName <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './a.js'</span>          <span class="token comment" spellcheck="true">// 拼上扩展名</span>          moduleName <span class="token operator">=</span> moduleName <span class="token operator">+</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 拼上要处理的父路径</span>          moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ./src/a.js</span>          node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 通过 types 替换掉 ast 某节点</span>          dependncies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 放入依赖数组</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 重新转成 js 代码</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p>执行 npx ys-pack</p><pre class=" language-js"><code class="language-js">修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>模块依赖包列表：<span class="token punctuation">[</span><span class="token string">"./src/a.js"</span><span class="token punctuation">]</span></code></pre><h2 id="5-递归解析依赖模块"><a href="#5-递归解析依赖模块" class="headerlink" title="5) 递归解析依赖模块"></a>5) 递归解析依赖模块</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 递归完毕后 this.modules保存着所有加载的模块</span>    <span class="token comment" spellcheck="true">// 递归 解析主模块依赖的模块 </span>    dependncies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行 npx ys-pack</p><pre class=" language-js"><code class="language-js">修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>'模块依赖包列表：<span class="token punctuation">[</span><span class="token string">"./src/a.js"</span><span class="token punctuation">]</span>修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span>模块依赖包列表：<span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>run 方法内增加打印</p><pre class=" language-js"><code class="language-js"><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>输出</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">'./src/index.js'</span><span class="token punctuation">:</span> <span class="token string">'var a = __webpack_require__("./src/a.js");\n\nconsole.log("导入模块:" + a);'</span><span class="token punctuation">,</span>  <span class="token string">'./src/a.js'</span><span class="token punctuation">:</span> <span class="token string">'var a = 1;\nmodule.exports = a;'</span><span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js</code></pre><h2 id="6-增加-emitFile-方法-使用-modules-组装-ejs模板-并输出"><a href="#6-增加-emitFile-方法-使用-modules-组装-ejs模板-并输出" class="headerlink" title="6) 增加 emitFile 方法 使用 modules 组装 ejs模板 并输出"></a>6) 增加 emitFile 方法 使用 modules 组装 ejs模板 并输出</h2><p>安装 ejs 模块</p><pre class=" language-js"><code class="language-js">yarn add ejs <span class="token operator">-</span>D</code></pre><p>新增文件 lib/template.ejs</p><details><summary>模板代码</summary><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The module cache</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The require function</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Execute the module function</span><span class="token comment" spellcheck="true">/******/</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded</span><span class="token comment" spellcheck="true">/******/</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Return the exports of the module</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__)</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the module cache</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define __esModule on exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// create a fake namespace object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 1: value is a module id, require it</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 2: merge all properties of value into the ns</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 4: return value when already ns object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 8|1: behave like require</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"&lt;%-entryId%>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/************************************************************************/</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> modules<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">%</span><span class="token operator">></span>              <span class="token string">"&lt;%-key%>"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;%-modules[key]%>`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 这里有个逗号哦</span>            <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span> <span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span> code<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token operator">-</span>modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token operator">-</span>key<span class="token operator">%</span><span class="token operator">></span></code></pre></details><p>修改 Compiler.js 增加 emitFile 方法</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span><span class="token keyword">const</span> getDirName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dirname<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 发射文件 用数据渲染我们的 lib/template.ejs 并输出到 this.config.output.path</span>    <span class="token comment" spellcheck="true">// 输出路径</span>    <span class="token keyword">let</span> outPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> templateString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取 ejs 模板</span>    <span class="token keyword">let</span> outputCode <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>templateString<span class="token punctuation">,</span> <span class="token punctuation">{</span> entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span> modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 渲染 ejs 模板 得到打包后的源码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能会有多个出口文件~</span>    <span class="token comment" spellcheck="true">// 资源中 输出路径对应的打包后代码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>outPath<span class="token punctuation">]</span> <span class="token operator">=</span> outputCode<span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 循环输出 output files</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  writeFileSync <span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 没有文件夹则自动创建的 writeFileSync 方法</span>    <span class="token function">mkdirp</span><span class="token punctuation">(</span><span class="token function">getDirName</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行 npx ys-pack</p><details><summary>dist/bundle.js</summary><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The module cache</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The require function</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Execute the module function</span><span class="token comment" spellcheck="true">/******/</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded</span><span class="token comment" spellcheck="true">/******/</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Return the exports of the module</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__)</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the module cache</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define __esModule on exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// create a fake namespace object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 1: value is a module id, require it</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 2: merge all properties of value into the ns</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 4: return value when already ns object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 8|1: behave like require</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/************************************************************************/</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>              <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`var a = __webpack_require__("./src/a.js");console.log('导入模块: ' + a);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`// a.jsvar a = 1;module.exports = a;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details>run code 执行该文件<pre class=" language-js"><code class="language-js">导入模块<span class="token punctuation">:</span> <span class="token number">1</span></code></pre><h2 id="7-简易webpack完成，附-Compiler-完整代码"><a href="#7-简易webpack完成，附-Compiler-完整代码" class="headerlink" title="7) 简易webpack完成，附 Compiler 完整代码"></a>7) 简易webpack完成，附 Compiler 完整代码</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span><span class="token keyword">const</span> getDirName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dirname<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 需要保存入口文件的路径</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './src/index.js' </span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前执行命令的文件根目录 用于查找入口文件的真实路径</span>    <span class="token comment" spellcheck="true">// 需要保存所有的模块依赖</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 结构为 路径: 代码 也就是编译后源码的webpack启动函数参数</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>    <span class="token comment" spellcheck="true">// 递归 依赖性也进行解析</span>    dependncies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 发射文件 用数据渲染我们的 lib/template.ejs 并输出到 this.config.output.path</span>    <span class="token comment" spellcheck="true">// 输出路径</span>    <span class="token keyword">let</span> outPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> templateString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取 ejs 模板</span>    <span class="token keyword">let</span> outputCode <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>templateString<span class="token punctuation">,</span> <span class="token punctuation">{</span> entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span> modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 渲染 ejs 模板 得到打包后的源码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能会有多个出口文件~</span>    <span class="token comment" spellcheck="true">// 资源中 输出路径对应的打包后代码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>outPath<span class="token punctuation">]</span> <span class="token operator">=</span> outputCode<span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 循环输出 output files</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 源码解析成 ast</span>    <span class="token keyword">let</span> dependncies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块依赖的模块数组</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token function">CallExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里建议在以上贴的网站参考 require('a.js') 转成的 ast结构</span>        <span class="token keyword">let</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对应的节点</span>        <span class="token comment" spellcheck="true">// 如果标签为 require</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span><span class="token punctuation">;</span>          <span class="token keyword">let</span> moduleName <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './a.js'</span>          <span class="token comment" spellcheck="true">// 拼上扩展名</span>          moduleName <span class="token operator">=</span> moduleName <span class="token operator">+</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 拼上要处理的父路径</span>          moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ./src/a.js</span>          node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 通过 types 替换掉 ast 某节点</span>          dependncies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 放入依赖数组</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 重新转成 js 代码</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  writeFileSync <span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 没有文件夹则自动创建的 writeFileSync 方法</span>    <span class="token function">mkdirp</span><span class="token punctuation">(</span><span class="token function">getDirName</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p><strong>至此 我们自己的打包工具拥有了简单的打包能力，那怎么引用loader跟plugin呢~</strong></p><h2 id="8-增加-loader-less-loader，style-loader"><a href="#8-增加-loader-less-loader，style-loader" class="headerlink" title="8) 增加 loader (less-loader，style-loader)"></a>8) 增加 loader (less-loader，style-loader)</h2><p>新增 loader 文件夹，增加 less-loader，style-loader两个文件。</p><p>安装 less</p><pre class=" language-js"><code class="language-js">yarn add less <span class="token operator">-</span>D</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// less-loader.js</span><span class="token keyword">let</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">lessLoader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> css <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    css <span class="token operator">=</span> res<span class="token punctuation">.</span>css<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> css<span class="token punctuation">;</span><span class="token punctuation">}</span>css <span class="token operator">=</span> css<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\n/g</span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 处理换行符</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> lessLoader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// style-loader.js</span><span class="token keyword">function</span> <span class="token function">styleLoader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 接收源码(到这里已经是css啦) 塞进页面 style 标签</span>  <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`    let style = document.createElement('style');    style.innerHtml = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;    document.head.appendChild(style);  `</span></span>  <span class="token keyword">return</span> style<span class="token punctuation">;</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> styleLoader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span>  path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token comment" spellcheck="true">// 这里是绝对路径 如果不写路径直接写 loader 名称 默认从 node_modules 中引入</span>          path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'style-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compole.js 增加使用 loader 逻辑</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token comment" spellcheck="true">// require 模块走这里 先读取模块内容 再经过 loader 转换 </span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 所有 rules</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 拿到每个规则来处理</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> rule <span class="token operator">=</span> rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> <span class="token punctuation">{</span> test<span class="token punctuation">,</span> use<span class="token punctuation">:</span> loaderList <span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>      <span class="token keyword">let</span> loaderListLen <span class="token operator">=</span> loaderList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// test的正则能匹配到的模块路径，则启用 loader 从右向左依次处理源码</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">function</span> <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderList<span class="token punctuation">[</span><span class="token operator">--</span>loaderListLen<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取最后一个loader 且每次减 1</span>          source <span class="token operator">=</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>loaderListLen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 递归执行</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行编译 npx ys-pack</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// build.js</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>              <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`var a = __webpack_require__("./src/a.js");__webpack_require__("./src/index.less"); // 引入lessconsole.log('导入模块: ' + a);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`// a.jsvar a = 1;module.exports = a;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/index.less"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`let style = document.createElement('style');style.innerHtml = "body {\n  background: red;\n}\n";document.head.appendChild(style);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </code></pre><p>可以看到，less文件以及正常打包了~<br>dist 文件新建 index.html，引入 build.js，打开 html，可以看到页面变红哦</p><p>总结:</p><ul><li><strong>loader 是一个函数，主要是对输出内容做二次处理。</strong></li><li><strong>loader 在 require 且 正则匹配后缀成功时调用。</strong></li><li><strong>loader 从右向左执行，从下到上</strong></li></ul><h2 id="9-增加-plugins"><a href="#9-增加-plugins" class="headerlink" title="9) 增加 plugins"></a>9) 增加 plugins</h2><p>安装 tapable 到你了~</p><pre class=" language-js"><code class="language-js">yarn add tapable</code></pre><p>增加插件plugins/emit-plugin.js，entry-options-plugin.js(插件内部提供了一个apply方法去注册监听函数，接收 Compiler实例)</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// plugins/emit.plugin.js</span><span class="token keyword">class</span> <span class="token class-name">EmitPlugin</span> <span class="token punctuation">{</span>  <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数 但是并没有执行哦</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'emit结束，也就是 bundle.js 生成后执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EmitPlugin<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// plugins/emit.plugin.js</span><span class="token keyword">class</span> <span class="token class-name">EmitPlugin</span> <span class="token punctuation">{</span>  <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数 但是并没有执行哦</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'emit结束，也就是 bundle.js 生成后执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EmitPlugin<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> EmitPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/emit-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> EntryOptionsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/entry-options-pllugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">EntryOptionsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">EmitPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ys-pack 新增 entryOptions 钩子初始化 钩子调用 </p><pre class=" language-js"><code class="language-js">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 1) 需要找到当前执行的路径 拿到 webpack.config.js</span><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 拿到 webpack 配置文件</span><span class="token keyword">let</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用来编译的类</span><span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 配置传入</span><span class="token comment" spellcheck="true">// 这时候调用 entryOptions 钩子 </span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 标识运行编译</span></code></pre><p>Compiler.js 中增加钩子执行调用</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 入口钩子 new Compiler 传入 webpack 配置时 调用</span>      afterPlugins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译完插件后加载钩子(插件此时并没有执行，只是注册了监听函数) </span>      run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 运行时钩子 this.run方法执行，webpack开始编译前调用</span>      compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译钩子 this.buildModule 执行前调用</span>      afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译后钩子 this.buildModule 执行后调用</span>      emit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 发射文件 // this.emit 执行完毕 生成 bundle.js 时调用</span>      done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 执行完成钩子 全部完成调用</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果webpack配置传递了 plugins 参数</span>    <span class="token keyword">let</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 这一步只是在 plugin 内部通过 apply 方法完成监听函数注册，也就是调用了 tap 方法，没有 call 哦</span>      plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>plugin <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>         plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 依次执行 把当前 Compiler 实例放进去</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterPlugins<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 插件编译完成 监听函数通过 apply 注册上了</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// run 方法执行时候</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 编译开始钩子</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 编译结束</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 完事儿啦</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行编译 npx ys-pack</p><pre class=" language-js"><code class="language-js">入口执行，也就是 <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>就会执行emit结束，也就是 bundle<span class="token punctuation">.</span>js 生成后执行</code></pre><h1 id="再探-loader-特性"><a href="#再探-loader-特性" class="headerlink" title="再探 loader 特性"></a>再探 loader 特性</h1><h2 id="resolveLoader-别名和模块配置！"><a href="#resolveLoader-别名和模块配置！" class="headerlink" title="resolveLoader 别名和模块配置！"></a>resolveLoader 别名和模块配置！</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 参数即为源代码</span>  <span class="token comment" spellcheck="true">// do something</span>  <span class="token keyword">return</span> source<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> loader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>          path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>每次都写绝对路径是不是太长了呢，但是不写路径又默认从 node_modules 引，怎么办。可以使用 resolveLoader 起一个别名。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoder<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 别名</span>      loader1<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>但是这样还是比较麻烦，能不能就不用手动写路径，自动寻找 loader 呢，其实我们可以规定从哪里找 loader</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样的话，如果 node_modules 中找不到 loader, 就会自动去我们 loader 文件夹下找。</p><h2 id="loader-真的是-从右往左，从下往上执行的么？"><a href="#loader-真的是-从右往左，从下往上执行的么？" class="headerlink" title="loader 真的是 从右往左，从下往上执行的么？"></a>loader 真的是 从右往左，从下往上执行的么？</h2><p>我们知道，常规的loader是从下到上执行，比如我有3个loader，都是处理 js 的，那么默认是从下到上执行，我们能手动操控执行顺序么(也可以倒序写)，这里我们来认识下 loader 的分类。</p><ul><li><strong>pre(前置执行的loader)</strong></li><li><strong>normal(正常的loader)</strong></li><li><strong>inline(行内的loader)</strong></li><li><strong>post(后置执行的loader)</strong></li></ul><p><strong>执行顺序是 pre &gt; normal &gt; inline &gt; post</strong><br>我们可以给每个loader 增加一个 enforce 属性，来改变它的类型来影响执行顺序。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoder<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span><span class="token punctuation">,</span>        enforce<span class="token punctuation">:</span> <span class="token string">'pre'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader2'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader3'</span><span class="token punctuation">,</span>        enforce<span class="token punctuation">:</span> <span class="token string">'post'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样，执行顺序就变成 1， 2， 3了。</p><p><strong>注意: inline-loader 和原本的 loader 定义并没有什么不同，除了用法！以下是内联 loader的一些特殊用法</strong></p><ol><li>加入!前缀， 不使用 config loader 中的normal loader，例如 require(‘!a-loader!./a.js’);</li><li>加入!!前缀，不执行其他类型 loader，例如 require(‘!!a-loader!./a.js’);</li><li>加入-!前缀，不使用 config loader 中的 normal loader, pre loader，例如 require(‘-!a-loader!./a.js’);</li></ol><p><strong>那相同分类的 loader，难道执行顺序就是从右往左，从上到下么？</strong></p><p>loader其实由两部分组成，也可以说是它的两个阶段。</p><ul><li><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>Pitch loader，它会按正常传递顺序执行</strong></font></li><li><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>Normal loader，我们实际运行的执行顺序</strong></font></li></ul><p><span style="font-weight: 900; word-break: break-all; color: #bf30ac;">比如 [‘a’, ‘b’, ‘c’]，正常调用顺序应该是 c、b、a，但是真正调用顺序是 a.pitch()、b.pitch()、c.pitch()、c、b、a， 如果其中任何一个 pitch loader 返回了值就相当于在它以及它右边的 loader 已经执行完毕。比如如果 b 返回了字符串 “result b”，接下来只有 a 会被系统执行，且 a 的loader收到的参数是 result b。</span></p><p>也就是说 Pitch loader 的初衷是为了提升效率，少执行几个 loader。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gl6fq52nxzj30yh0u0dve.jpg" width="500"></p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader 3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> source<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>pitch <span class="token operator">=</span> res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">'i will go back'</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h1 id="实现-babel-loader"><a href="#实现-babel-loader" class="headerlink" title="实现 babel-loader"></a>实现 babel-loader</h1><p>安装其他 babel 相关</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span>Dyarn add loader<span class="token operator">-</span>utils <span class="token operator">-</span>D <span class="token comment" spellcheck="true">// loader 工具库 用于帮我们拿到 loader中配置的 options</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//  loader-utils 可以帮我们在 loader 中拿到该配置</span>            presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>babel-loader实现</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// /Users/ys/study/webpack学习源码/手写各种loader/src/index.js</span>  <span class="token comment" spellcheck="true">// 调用 @babel/core 内 transform 方法进行转换 </span>  babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>    presets<span class="token punctuation">:</span> options<span class="token punctuation">.</span>presets<span class="token punctuation">,</span>    sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    filename<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 生成的文件名(source查看 webpack:// 源码展示的名字)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到参数(错误，编译后源码，souremap) 自动帮我们返回结果</span>    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">class</span> <span class="token class-name">Ys</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ys'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> ys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ys<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>执行 npx webpack进行打包，发现我们的 es6 语法被转成 es5了，但是没有 sourcemap 怎么办，需要知道，我们想让打包出 sourcemap，webpack 配置必须把 devtool 置为相应模式才行。</p><pre class=" language-js"><code class="language-js">devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span></code></pre><h1 id="自创-loader-之-banner-loader"><a href="#自创-loader-之-banner-loader" class="headerlink" title="自创 loader 之 banner-loader"></a>自创 loader 之 banner-loader</h1><p>我们实现一个 loader，来根据配置或者读取文件内容来为源码署名，如果配置 options.filename，则使用 options.filename 中的文件进行署名，不然使用 options.text！</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 工具类 我们需要它拿到 options</span><span class="token keyword">let</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 校验模块</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'banner-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            text<span class="token punctuation">:</span> <span class="token string">'amosyang署名'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'banner-template.js'</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>根目录创建 banner-template.js</p><pre class=" language-js"><code class="language-js">杨帅署名<span class="token number">2</span></code></pre><p>loaders 目录下创建 banner-loader.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 校验模块</span><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 是否启用缓存</span>  <span class="token comment" spellcheck="true">// this.cacheable(false); // 每次均重新打包</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>cacheable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 不传参数默认为 true  </span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  <span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 创建 options 骨架</span>    type<span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>    properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token punctuation">{</span>        type<span class="token punctuation">:</span> <span class="token string">'string'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      filename<span class="token punctuation">:</span> <span class="token punctuation">{</span>        type<span class="token punctuation">:</span> <span class="token string">'string'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 参数(传入的骨架 实际接收的参数 参数错误时，抛出错误的文件名)</span>  <span class="token function">validateOptions</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'banner-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当 webpack 配置为 true 时，监听此文件修改</span>    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> data <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> options<span class="token punctuation">.</span>text <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行 npx webpack 可以看到我们的文件都被加上签名啦</p><pre class=" language-js"><code class="language-js"><span class="token operator">...</span><span class="token string">"use strict"</span><span class="token punctuation">;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"/**杨帅署名2221**/\n\nfunction _classCallCheck(){...}"</span></code></pre><p>这时候有一个问题，如果我在 webpack 中开启了监听</p><pre class=" language-js"><code class="language-js">watch<span class="token punctuation">:</span> <span class="token boolean">true</span></code></pre><p>这时候我修改了 banner-template.js 内的模板内容，发现重新 build了，这一切都归功于其中一句代码，我们在 loader 内添加了这个模板为监听文件。</p><pre class=" language-js"><code class="language-js"> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当 webpack 配置为 true 时，监听此文件修改</span></code></pre><h1 id="实现-file-loader"><a href="#实现-file-loader" class="headerlink" title="实现 file-loader"></a>实现 file-loader</h1><p>src 下 copy 进来一张图片 public.png</p><p>修改 src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> p <span class="token keyword">from</span> <span class="token string">'./public.png'</span><span class="token punctuation">;</span><span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> p<span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.png|jpg|gif$/</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 目的就是根据图片生成一个 md5 戳 发射到 dist目录下，发射完成后，模块本身返回一个带 hash 的图片名</span>        use<span class="token punctuation">:</span> <span class="token string">'file-loader'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// laoders/file-loader.js</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 根据传入的格式 二进制内容 产生一个 文件名</span>  <span class="token keyword">let</span> filename <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'[hash].[ext]'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> content<span class="token punctuation">:</span> source <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 发射文件</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实际导出的是这个处理过文件名</span><span class="token punctuation">}</span>loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置接收的 source 为二进制</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行编译 npx build，成功~</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 437msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">32</span>                               Asset      Size  Chunks             Chunk Names                           bundle<span class="token punctuation">.</span>js  <span class="token number">4.65</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainc37f803ecaf165e89ca5344e6120b7af<span class="token punctuation">.</span>png   <span class="token number">693</span> KiB          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">]</span> <span class="token number">508</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span><span class="token keyword">public</span><span class="token punctuation">.</span>png<span class="token punctuation">]</span> <span class="token number">53</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre><h1 id="实现-url-loader"><a href="#实现-url-loader" class="headerlink" title="实现 url-loader"></a>实现 url-loader</h1><p>src 下 copy 进来一张图片 public.png</p><p>修改 src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> p <span class="token keyword">from</span> <span class="token string">'./public.png'</span><span class="token punctuation">;</span><span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> p<span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>           <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.png|jpg|gif$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            limit<span class="token punctuation">:</span> <span class="token number">200</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token comment" spellcheck="true">// 大于 200k 产生文件 小于200k 变成 base64</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// laoders/file-loader.js</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取文件类型</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> <span class="token punctuation">{</span> limit <span class="token punctuation">}</span> <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">&amp;&amp;</span> limit <span class="token operator">></span> source<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注意此处根据 source.length 判断文件大小</span>    <span class="token comment" spellcheck="true">// 把文件变成 base64</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports="data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 调用 file-loader 完成此步操作</span>    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>loader<span class="token punctuation">.</span>row <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行编译 npx build，成功~</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 437msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">32</span>                               Asset      Size  Chunks             Chunk Names                           bundle<span class="token punctuation">.</span>js  <span class="token number">4.65</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainc37f803ecaf165e89ca5344e6120b7af<span class="token punctuation">.</span>png   <span class="token number">693</span> KiB          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">]</span> <span class="token number">508</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span><span class="token keyword">public</span><span class="token punctuation">.</span>png<span class="token punctuation">]</span> <span class="token number">53</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;书接上篇。&lt;/p&gt;
&lt;h1 id=&quot;优化-module-noParse-不解析某些包的依赖库&quot;&gt;&lt;a href=&quot;#优化-module-noParse-不解析某些包的依赖库&quot; class=&quot;headerlink&quot; title=&quot;[优化] module.noParse 不解析
      
    
    </summary>
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/categories/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
    
      <category term="模块化" scheme="yd.yangshuaiweb.com/tags/%E6%A8%A1%E5%9D%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>http缓存策略</title>
    <link href="yd.yangshuaiweb.com/2020/10/12/liu-lan-qi-huan-cun-ce-lue/"/>
    <id>yd.yangshuaiweb.com/2020/10/12/liu-lan-qi-huan-cun-ce-lue/</id>
    <published>2020-10-12T08:52:09.000Z</published>
    <updated>2020-11-10T15:55:11.749Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是缓存"><a href="#什么是缓存" class="headerlink" title="什么是缓存"></a>什么是缓存</h1><p> 是应用程序中很重要的一个概念，在有大量数据交换的应用程序中，我们会采取一些方式将那些实时性要求不高的数据生成副本并存储在某个相对来说可快速到达、访问、获取的仓库，这样在需要这些数据的时候我们直接从这个仓库中获取数据。</p><h1 id="缓存带来的好处"><a href="#缓存带来的好处" class="headerlink" title="缓存带来的好处"></a>缓存带来的好处</h1><ol><li>提升数据交换的性能（速度）</li><li>缓解服务器或数据库的压力</li></ol><h1 id="缓存策略"><a href="#缓存策略" class="headerlink" title="缓存策略"></a>缓存策略</h1><p>HTTP缓存分为强缓存和协商缓存两种，其中强缓存的优先级最高，在浏览器没有命中强缓存的情况下，会选择协商缓存。注意：强缓存和协商缓存的资源文件全部取自本地缓存。</p><h2 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h2><ol><li>不会发送http请求到服务器，状态码200, 缓存空间为 <font style="font-weight: 900;">memory cache</font>(内存存储, 浏览器或页面标签关闭后内存中的缓存就会被释放) 或者 <font style="font-weight: 900;">disk cache</font>(硬盘存储, 浏览器或页面标签关闭后硬盘中的缓存不会消失，下次进入页面还能从硬盘中获取)</li><li>根据两个字段判断是否命中缓存，分别是 expires(http1.0) 和 cache-control (http1.1，优先级大于expires), 为了向下兼容，两者一般同时设置</li></ol><p><strong>expires: -1 | 绝对时间(Thu Jul 16 2020 14:22:59 GM)</strong> </p><blockquote><p>首次加载，响应头包含此字段，下次访问，服务器会对比本地时间和expires，这个资源在这个时间点之前都可以直接从缓存中获取。<br>expires依赖于本地时间，如果服务端与客户端设置的时间不同，或者手动改变了本地时间，就会出现问题，不能达到预期的效果。</p></blockquote><p><strong>cache-control: public, max-age=7200</strong></p><blockquote><p>这是一个相对时间（单位：秒），这里代表资源的缓存在这个请求之后的2小时内都有效。</p></blockquote><h2 id="协商缓存-对比缓存"><a href="#协商缓存-对比缓存" class="headerlink" title="协商缓存(对比缓存)"></a>协商缓存(对比缓存)</h2><ol><li>会发送http请求到服务器，命中时状态码为200，意为not modified，标识服务器文件并没有改变，本地缓存空间的文件仍然可用, 此时状态码为304</li><li>根据两对字段判断是否命中缓存，分别是Last-Modified / If-Modified-Since 和 Etag / If-None-Match (优先级高)</li></ol><p><strong>Last-Modified / If-Modified-Since：绝对时间(Thu Jul 16 2020 14:22:59 GM)</strong></p><blockquote><p>第一次访问一个资源的时候，服务器会在response header中返回一个Last-Modified，代表这个资源最后的修改时间，当浏览器再次访问这个资源的时候，会在request header中带上 If-Modified-Since，值为上次请求时服务器返回的 Last-Modified 的值，然后服务器根据资源上次修改的时间确认资源在这段期间内是否更改过，如果没有，则返回304，如果有，则返回200并返回最新的资源。但是这样会有个问题，如果资源的修改时间变了，但是内容却没变，这是再利用Last-Modified来计算是否需要重新响应这无疑会带来资源浪费，所以Etag诞生了</p></blockquote><p><strong>Etag / If-None-Match：’5b506e03-25856’</strong> </p><blockquote><p> Etag是通过一个校验码来对比资源是否更改过的，而不是通过资源的修改时间。当一个资源修改时，其校验码也会更改。当浏览器请求资源时，服务器会返回一个Etag字段，然后浏览器下一次请求时，会带上 If-None-Match ，值为上次服务器返回的Etag的值，服务器经过校验码的对比后决定返回200或304。</p></blockquote><p>Etag和Last-Modified优先级</p><blockquote><p>Etag可以解决 Last-Modified 不太好处理的问题，Etag能更准确地控制缓存，因此，如果http请求中若同时出现Etag和Last-Modified，Etag的优先级是高于 Last-Modified 的。具体地说，Last-Modified 有以下一些问题：</p><ol><li>一些文件也许会周期性的更改，但是他的内容并不改变(仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新GET；</li><li>某些文件修改非常频繁，比如在秒以下的时间内进行修改，(比方说1s内修改了N次)，If-Modified-Since能检查到的粒度是s级的，这种修改无法判断(或者说UNIX记录MTIME只能精确到秒)；</li><li>某些服务器不能精确的得到文件的最后修改时间。</li></ol></blockquote><p><strong>拓展:</strong><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvwdln8qlj30l10dodhf.jpg" alt></p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">强 ETag 要求资源在字节级别必须完全相符，弱 ETag 在值前有个“W/”标记，只要求资源在语义上没有变化，但内部可能会有部分发生了改变（例如 HTML 里的标签顺序调整，或者多了几个空格）。</font><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.jianshu.com/p/c78b5de7a889" target="_blank" rel="noopener">详解Http缓存策略</a><br><a href="https://blog.csdn.net/zhanghuimin_0214/article/details/105619895" target="_blank" rel="noopener">浏览器缓存机制与缓存策略</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;什么是缓存&quot;&gt;&lt;a href=&quot;#什么是缓存&quot; class=&quot;headerlink&quot; title=&quot;什么是缓存&quot;&gt;&lt;/a&gt;什么是缓存&lt;/h1&gt;&lt;p&gt; 是应用程序中很重要的一个概念，在有大量数据交换的应用程序中，我们会采取一些方式将那些实时性要求不高的数据生成副本并
      
    
    </summary>
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/categories/Javascript/"/>
    
    
      <category term="Javascript" scheme="yd.yangshuaiweb.com/tags/Javascript/"/>
    
  </entry>
  
</feed>
