<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>从一道题浅聊 await v8 实现</title>
      <link href="/2021/04/12/cong-yi-dao-ti-qian-liao-await-v8-shi-xian/"/>
      <url>/2021/04/12/cong-yi-dao-ti-qian-liao-await-v8-shi-xian/</url>
      
        <content type="html"><![CDATA[<h1 id="一道很简单的-event-loop-面试题"><a href="#一道很简单的-event-loop-面试题" class="headerlink" title="一道很简单的 event loop 面试题"></a>一道很简单的 event loop 面试题</h1><pre class=" language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end after await'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise.then 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise.then 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这道题看起来很简单，但是其中隐含了一个极度迷惑的点，究竟是 <strong>async1 end after await</strong> 先执行还是 <strong>promise.then 1</strong> 先执行？看起来好像都属于 Promise 这一趴的微任务，那么先进先出对不对？</p><p><strong>答案是错误的，这个跟 node 版本有关系，确切的说跟 v8 版本是有关系的，具体 node 版本表现如下</strong></p><ul><li><strong>8 ~ 9： await 后面的打印先执行，其中 7 中并没有完全支持 async 方法，这里暂且不做讨论。</strong></li><li><strong>10 ~ 11： promise.then 先执行。</strong></li><li><strong>12+： await 后面的打印先执行。</strong><image src="https://tva1.sinaimg.cn/large/008eGmZEly1gpi0pce214j30fo1dynhm.jpg" width="200"></image></li></ul><h1 id="为什么会这样呢？-v8做了什么手脚？"><a href="#为什么会这样呢？-v8做了什么手脚？" class="headerlink" title="为什么会这样呢？ v8做了什么手脚？"></a>为什么会这样呢？ v8做了什么手脚？</h1><p>v8 从 Node.js 8(V8 v6.2/Chrome 62)开始，就完全支持异步函数(Async)，从 Node.js 10(V8 v6.8/Chrome 68)开始，就完全支持异步迭代器(Async iterators)和生成器(Generators)！</p><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>在 V8 v5.5(chrome55 &amp; Node.js 7)和 V8 v6.8(chrome68 &amp; Node.js 10)之间，v8 已经成功地提高了异步代码的性能，开发人员可以安全地使用这些新的编程范例，而不必担心速度问题。</p><p><strong>异步代码执行时间测试：</strong><br><image src="https://v8.dev/_img/fast-async/doxbee-benchmark.svg" width="500"></image></p><p><strong>并行异步代码测试（Promise.all）：</strong><br><image src="https://v8.dev/_img/fast-async/parallel-benchmark.svg" width="500"><br>可以看到，并行的异步代码，在新的 node 版本上性能提升了 8 倍之多。</image></p><p>然而，上述测试都是在单独测试的异步代码，那么在实际项目中表现如何呢？这里，v8 官方公布了在不同 node 框架上的性能提升对比。</p><p><strong>不同框架下，每秒请求量统计：</strong><br><image src="https://v8.dev/_img/fast-async/http-benchmarks.svg" width="500"><br>上面的图表可视化了一些流行的 HTTP 中间件框架的性能，这些框架大量使用了 promises 和 async 函数。请注意，这个图表显示的是请求/秒的数量，因此与前面的图表不同，越高越好。在 Node.js 7(V8 v5.5)和 Node.js 10(V8 v6.8)之间，这些框架的性能有了显著提高。</image></p><p>这些性能的提升来自三个地方：</p><ol><li>编译器的优化 <a href="https://v8.dev/docs/turbofan" target="_blank" rel="noopener">the new optimizing compiler 🎉</a></li><li>新的垃圾回收机制 <a href="https://v8.dev/blog/orinoco" target="_blank" rel="noopener">the new garbage collector 🚛</a></li><li>a Node.js 8 bug causing await to skip microticks</li></ol><p><strong>注意第三点，Node 8 存在一个 bug，它会使 await 后面的代码跳过微任务，直接导致 await 后的代码先于 promise.then 执行，也就是前面测试得到的结果, 此 bug 在 Node 10 中被修复，并于 Node 12 中给予 v8 开发团队启发， 做了类似的优化。</strong></p><h2 id="让我们看下-v8-引擎对-await-做了什么"><a href="#让我们看下-v8-引擎对-await-做了什么" class="headerlink" title="让我们看下 v8 引擎对 await 做了什么"></a>让我们看下 v8 引擎对 await 做了什么</h2><p>这里有一个简单的 async 函数 foo:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">await</span> v<span class="token punctuation">;</span>  <span class="token keyword">return</span> w<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>大体上，我们可以认为，当调用时，它将参数 v 封装到一个 promise 中，并挂起 async 函数的执行，直到这个 promise 被解析。一旦发生这种情况，函数的执行将继续，并为 w 分配 返回的 promise 对象。然后从 async 函数返回这个值。</p><p><strong>让我们来看一些 v8 更细节的实现流程，这也是我们今天主要讨论的内容(这里是 node 10的实现)，如图所示：</strong><br><image src="https://v8.dev/_img/fast-async/await-under-the-hood.svg" width="500"></image></p><ol><li><strong>首先把 v8 把函数 foo 标记成可恢复的(resumable), 这意味着执行可以暂停并在稍后恢复。 然后它创建所谓的 implicit_promise，这是在调用 async 函数时返回的 promise 对象，并最终解析为 async 函数返回的值，这点很类似 new 调用函数，创建一个空对象一样。</strong></li><li><strong>又创建一个 promise，然后包裹传入的值 v，也就是说把传入的值包装成了一个 promise。</strong></li><li><strong>再次创建 promise，也就是 throwway，去把这个附加到包装后的值上面，也就是说，当包装成 promise 后的 v 执行的时候(pending)，此时 throwway 负责暂停了 foo 函数的执行，并将 implicit_promise 返回给调用者，一旦包装后的 v 得到成功的结果(fulfilled), 首先会恢复 foo 函数的执行，然后将返回值赋给 implicit_promise，再转交给 w 来表示。</strong></li></ol><p>三次创建 promise 就是我们性能开销的主要来源，特别是如果输入的 v 已经是一个 promise 对象，这是对性能的极大浪费，我们是否判断它本身是不是一个 promise 再决定是否创建新的 promise 来包装它呢。</p><p><strong>事实上，新版规范中已经有一个 promiseResolve 操作，只在需要时执行包装:</strong><br><image src="https://v8.dev/_img/fast-async/await-code-comparison.svg" width="600"><br><strong>我们可以看到，如果 v 已经是一个 promise 对象的话，就省略了一次包装 v 的构建，其次又复用了 implicit_promise(取代掉累赘的 throwway)，从三次构建 promise 到 一次构建，执行速度提升了三倍，在这种情况下，我们将从最少3微秒变为仅仅1微秒。这种行为类似于 Node.js 8所做的，只不过现在它不再是一个 bug ーー 它现在是一个标准化的优化！</strong></image></p><p><strong>这个新行为在 V8 v7.2 (node v12)中已经默认启用。对于 V8 v7.1，可以使用 – harmony-await-optimization 标志启用新行为。</strong><br><image src="https://v8.dev/_img/fast-async/node-10-vs-node-12.svg" width="600"></image></p><p><strong>比较 Node.js 10中的 await 和 Node.js 12中可能出现的优化 await，可以看出这一变化对性能的影响:</strong><br><image src="https://v8.dev/_img/fast-async/benchmark-optimization.svg" width="600"></image></p><p>Async/await 现在比手写的承诺代码性能更好。这里的关键要点是，我们通过修补规范，大大降低了异步函数的开销——不仅在 V8中，而且在所有 JavaScript 引擎中都是如此。</p><p><strong>在 V8 v7.2和 chrome72中，默认启用了 harmony-await 优化。ECMAScript 规范的补丁被合并了。</strong></p><p><strong>你明白了么？</strong></p><p>参考资料：<br><a href="!https://v8.dev/blog/fast-async">v8 blog</a><br><a href="!https://blog.csdn.net/lovermeiy/article/details/110985294">v8 如何执行一段 JS 代码</a></p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack5 新特性</title>
      <link href="/2020/12/19/webpack5-xin-te-xing/"/>
      <url>/2020/12/19/webpack5-xin-te-xing/</url>
      
        <content type="html"><![CDATA[<h1 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h1><ul><li>新建项目  webpack5-taste</li><li>yarn init -y</li><li>yarn add webpack webpack-cli -D</li><li>新建 webpack.config.js</li></ul><h1 id="0-配置打包（webpack4也可以0配置，但是远没有5强大）"><a href="#0-配置打包（webpack4也可以0配置，但是远没有5强大）" class="headerlink" title="0 配置打包（webpack4也可以0配置，但是远没有5强大）"></a>0 配置打包（webpack4也可以0配置，但是远没有5强大）</h1><p>新建 src/a.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'Jack'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span></code></pre><p>src/b.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> b <span class="token keyword">from</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>a<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>webpack.config.js</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">}</span></code></pre><p>执行打包命令 webpack，发现可以成功打包，并且打包后代码的启动文件等均为箭头函数了！</p><h1 id="更小打包体积"><a href="#更小打包体积" class="headerlink" title="更小打包体积"></a>更小打包体积</h1><p>在切换 mode 为 production 后，我们发现打包内容只有代码 438 字节。</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">[</span>webpack<span class="token operator">-</span>cli<span class="token punctuation">]</span> Compilation finishedasset main<span class="token punctuation">.</span>js <span class="token number">43</span> bytes <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span> <span class="token punctuation">[</span>minimized<span class="token punctuation">]</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> main<span class="token punctuation">)</span>orphan modules <span class="token number">93</span> bytes <span class="token punctuation">[</span>orphan<span class="token punctuation">]</span> <span class="token number">2</span> modules<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token operator">+</span> <span class="token number">1</span> modules <span class="token number">102</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span> <span class="token punctuation">[</span>code generated<span class="token punctuation">]</span>webpack <span class="token number">5.11</span><span class="token punctuation">.</span><span class="token number">0</span> compiled successfully <span class="token keyword">in</span> <span class="token number">176</span> ms</code></pre><p>而 webpack4 同样代码，打包内容为 1.07kb，这么点代码 5 比 4 打包小了接近1kb..</p><pre class=" language-js"><code class="language-js">Hash<span class="token punctuation">:</span> 32dfad9d9e7e2bb3313aVersion<span class="token punctuation">:</span> webpack <span class="token number">4.44</span><span class="token punctuation">.</span><span class="token number">2</span>Time<span class="token punctuation">:</span> 225msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">38</span>    Asset      Size  Chunks             Chunk Namesbundle<span class="token punctuation">.</span>js  <span class="token number">1.05</span> KiB       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainEntrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token operator">+</span> <span class="token number">2</span> modules <span class="token number">145</span> bytes <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js <span class="token number">52</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>b<span class="token punctuation">.</span>js <span class="token number">43</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span>    <span class="token operator">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>a<span class="token punctuation">.</span>js <span class="token number">50</span> bytes <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre><h1 id="嵌套的-tree-shaking"><a href="#嵌套的-tree-shaking" class="headerlink" title="嵌套的 tree shaking"></a>嵌套的 tree shaking</h1><p>分析 webpack5 打包后的文件</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token string">"use strict"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>excuse me? </p><p>age = 18 被完全干掉了，在 webpack4 中无法处理包装了一层的模块引用中的 tree shaking，在webpack5 中得以修复，并删除了全部的 runtime 注入代码。</p><p>并且也支持 common JS 的 tree shaking 啦。</p><p>同样再看一个栗子</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> something <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./something'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> something<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>如果 test 方法没有被调用，在 webpack4 中， something 这个模块也会被打包，而在 webpack5 中会被干掉。</p><h1 id="不再为-Node-js-模块-自动引用-Polyfills"><a href="#不再为-Node-js-模块-自动引用-Polyfills" class="headerlink" title="不再为 Node.js 模块 自动引用 Polyfills"></a>不再为 Node.js 模块 自动引用 Polyfills</h1><p>不再为 Node.js 内置模块自动添加 Polyfills。任何项目中有引用 Node.js 内置模块，在 webpack 4 或之前的版本中会自动添加 Polyfills。但 webpack 5 将不会再这样做，webpack会投入更多的精力到前端模块的兼容性工作中。</p><p>如果你的代码中有引用这些 Node.js 的模块，要升级到 webpack 5, 将尽量使用前端的模块，或者自行手动添加适合的 Polyfills。</p><p>而针对那些类库的开发者，请在 package.json 中定义 browser 字段，使类库在前端能适用。</p><h1 id="清理已弃用的功能"><a href="#清理已弃用的功能" class="headerlink" title="清理已弃用的功能"></a>清理已弃用的功能</h1><p>所有在 webpack 4 标记即将过期的功能，都已在该版移除。因此在迁移到 webpack 5 之前，请确保你在 webpack 4 运行的构建不会有任何的功能过期警告。</p><h1 id="不再需要的魔法注释"><a href="#不再需要的魔法注释" class="headerlink" title="不再需要的魔法注释"></a>不再需要的魔法注释</h1><p>在开发模式下，默认启用的新命名代码块 ID 算法为模块（和文件名）提供了人类可读的名称。 模块 ID 由其路径决定，相对于 context。代码块 ID 由代码块的内容决定。</p><p>所以你不再需要使用import(/* webpackChunkName: “name” */ “module”)来调试。但如果你想控制生产环境的文件名，还是有意义的。</p><p>可以在生产环境中使用 chunkIds: “named” 在生产环境中使用，但要确保不要不小心暴露模块名的敏感信息。</p><p>迁移：如果你不喜欢在开发中改变文件名，你可以通过 chunkIds: “natural” 来使用旧的数字模式。</p><h1 id="模块联邦"><a href="#模块联邦" class="headerlink" title="模块联邦"></a>模块联邦</h1><p>Webpack 5 增加了一个新的功能 “模块联邦”，它允许多个 webpack 构建一起工作。从运行时的角度来看，多个构建的模块将表现得像一个巨大的连接模块图。从开发者的角度来看，模块可以从指定的远程构建中导入，并以最小的限制来使用。</p><h1 id="output-可选的输出-ecma-标准"><a href="#output-可选的输出-ecma-标准" class="headerlink" title="output 可选的输出 ecma 标准"></a>output 可选的输出 ecma 标准</h1><p>webpack4 默认只能输出 ES5 代码，webpack5 开始新增一个属性 oupput.ecmaVersion，可以生吃 ES5 和 ES6/ES2015 代码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  out<span class="token punctuation">:</span> <span class="token punctuation">{</span>    ecmaVersion<span class="token punctuation">:</span> <span class="token number">2015</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="splitChunk-设置不同资源的分割阈值"><a href="#splitChunk-设置不同资源的分割阈值" class="headerlink" title="splitChunk 设置不同资源的分割阈值"></a>splitChunk 设置不同资源的分割阈值</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack4</span>mionSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 超过30k 提取出单独chunk</span><span class="token comment" spellcheck="true">// webpack5 可以对不同类型的资源单独设置</span>miniSize<span class="token punctuation">:</span> <span class="token punctuation">{</span>  javascript<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>  style<span class="token punctuation">:</span> <span class="token number">50000</span>  <span class="token punctuation">}</span></code></pre><h1 id="持久缓存提高构建性能"><a href="#持久缓存提高构建性能" class="headerlink" title="持久缓存提高构建性能"></a>持久缓存提高构建性能</h1><p>我们之前有 babel 的 cache 做源文件处理的缓存，或者通过 terser-webpack-plugin 进行 js 压缩的时候来做文件的缓存。webpack5 新增了个属性 cache，可以更好地缓存构建后的资源，从而第二次打包的速度会大大加快。</p><pre class=" language-js"><code class="language-js">cache<span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 磁盘存储 filesystem, 内存存储 memorage</span>  type<span class="token punctuation">:</span> <span class="token string">"filesystem"</span><span class="token punctuation">,</span>     buildDependencies<span class="token punctuation">:</span> <span class="token punctuation">{</span>    config<span class="token punctuation">:</span> <span class="token punctuation">[</span> __filename <span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 当你 CLI 自动添加它时，你可以忽略它</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="更好的监视文件打包机制"><a href="#更好的监视文件打包机制" class="headerlink" title="更好的监视文件打包机制"></a>更好的监视文件打包机制</h1><p>webpack4 总是在第一次构建时输出全部文件，但是监视重新构建时会只更新修改的文件。此次更新在第一次构建时会找到输出文件看是否有变化，从而决定要不要输出全部文件。</p><h1 id="更好的算法和默认值来改善长期缓存"><a href="#更好的算法和默认值来改善长期缓存" class="headerlink" title="更好的算法和默认值来改善长期缓存"></a>更好的算法和默认值来改善长期缓存</h1><p>contenthash 会以更好的算法来进行计算，从而优化性能。<strong>当使用[contenthash]时，Webpack 5 将使用真正的文件内容哈希值。之前它 “只 “使用内部结构的哈希值。当只有注释被修改或变量被重命名时，这对长期缓存会有积极影响。这些变化在压缩后是不可见的。</strong></p><h1 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h1><ul><li>entry: ‘./src/index.js’</li><li>output.path: path.resolve(__dirname, ‘dist’)</li><li>output.filename: ‘[name].js’</li></ul>]]></content>
      
      
      <categories>
          
          <category> 模块化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>贪心算法的实现、特性以及实战题目解析</title>
      <link href="/2020/11/15/tan-xin-suan-fa-de-shi-xian-te-xing-yi-ji-shi-zhan-ti-mu-jie-xi/"/>
      <url>/2020/11/15/tan-xin-suan-fa-de-shi-xian-te-xing-yi-ji-shi-zhan-ti-mu-jie-xi/</url>
      
        <content type="html"><![CDATA[<h1 id="贪心算法-Greedy-是什么"><a href="#贪心算法-Greedy-是什么" class="headerlink" title="贪心算法(Greedy)是什么"></a>贪心算法(Greedy)是什么</h1><p>贪心算法是一种在每一步选择中都采取在当前状态下最好或最优(即最有利)的选择，从而希望导致结果是全局最好或最优的算法。</p><p><strong>贪心算法与动态规划的不同在于它对每个子问题的解决方案都做出选择，不能回退。动态规划则会保存以前的运算结果，并根据以前的结果对当前进行选择，有回退功能。</strong></p><p>贪心法可以解决一些最优化问题，比如：求图中的最小生成树、求哈夫曼编码等。然而对于工程和生活中的问题，贪心法一般不能得到我们所要求的的答案。</p><p>一旦一个问题可以通过贪心法来解决，那么贪心法一般是解决这个问题的最好办法。由于贪心法的高效性以及其所求得的答案比较接近最优结果，贪心法也可以用作辅助算法或者直接解决一些要求结果不特别精确的问题。</p><h1 id="实战题目"><a href="#实战题目" class="headerlink" title="实战题目"></a>实战题目</h1><p>Coin Change 特别版本:</p><p><a href="https://leetcode-cn.com/problems/coin-change/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/coin-change/</a></p><p>当硬币可选集合固定：Coins = [20, 10, 5, 1]</p><p>求最少可以几个硬币拼出总数。比如 total = 36</p><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpyp0uifcj30r60e63yr.jpg" alt><br>这时候就可以用一种贪心法，比如先匹配20这个硬币，36最多能用去1个20，还剩16，再用次大的硬币(10)去匹配，还剩6，这样依次去匹配。这种情况下，就是贪心法的例子。贪心法的话，就每次用最优的去匹配，既然你能用20，为何用10或5或1呢。</p><p>但是很多情况下，贪心法是不成立的，这里成立的原因是因为硬币有整除的关系，看下一个例子<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpz5c8uhwj30rq0aw3yr.jpg" alt></p><p>我们明显看出，两个9相加为18即可，但是如果你用最大的10去匹配，如下图<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpz7krx0cj30rr0ckq35.jpg" alt><br>这时候得到的结果为[10, 1, 1, 1, 1, 1, 1, 1, 1]，明显不是最优结果。</p><p><strong>所以如果我们想用贪心法解决问题，第一问题要比较特殊，第二你要能够证明这个地方用最简单粗暴的贪心法是能够得到最优解的。</strong></p><h1 id="什么情况下用的贪心算法"><a href="#什么情况下用的贪心算法" class="headerlink" title="什么情况下用的贪心算法"></a>什么情况下用的贪心算法</h1><p>简单地说，问题能够分解成子问题来解决，子问题的最优解能递推到最终问题的最优解。这种子问题最优解称为最优子结构。其次还是重复下贪心和动规的差异~<br><strong>贪心算法与动态规划的不同在于它对每个子问题的解决方案都做出选择，不能回退。动态规划则会保存以前的运算结果，并根据以前的结果对当前进行选择，有回退功能。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深度优先搜索、广度优先搜索</title>
      <link href="/2020/11/15/shen-du-you-xian-sou-suo-guang-du-you-xian-sou-suo/"/>
      <url>/2020/11/15/shen-du-you-xian-sou-suo-guang-du-you-xian-sou-suo/</url>
      
        <content type="html"><![CDATA[<p>搜索的话，我们绝大多数处理方式都是暴力搜索，或者说是比较简单的搜索。也就是说，在搜索的时候，并没有人为的智能地去操作搜索，很多情况下它做的一件事情，就是把所有节点全部都遍历一次，然后找到你要的结果。</p><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkppsf4sxsj30rs0c8aag.jpg" alt></p><p>比如在上图中，如果我们要找个某个子节点，毫无疑问，是从根这边开始，先搜左子树，然后往下一个一个点走过去，然后走完之后再走右子树，直到找到我们的点。</p><p>我们要实现这样的遍历和搜索的话，每个节点都要访问一次，且仅访问一次(不然的话，我们的访问效率会非常低)，<strong>对于节点的访问顺序不同，就有深度优先和广度优先这两个概念，当然还有其他搜索，比如优先级优先，优先级优先的算法一般我们称为启发式搜索，而启发式搜索采用的估价函数以及搜索的整个效率问题的话，就已经超出了我们讨论的范围，而更多的是深度学习了。</strong></p><p>这种优先级优先，现在已经广泛应用在各种推荐算法和高级的搜索算法， 让你搜出你自己最感兴趣的内容，比如你每天打开抖音或者快手的话，就会给你推荐你最感兴趣的内容。</p><h1 id="DFS-深度优先搜索"><a href="#DFS-深度优先搜索" class="headerlink" title="DFS 深度优先搜索"></a>DFS 深度优先搜索</h1><h2 id="python-代码示例-二叉树"><a href="#python-代码示例-二叉树" class="headerlink" title="python 代码示例 (二叉树)"></a>python 代码示例 (二叉树)</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> dfs <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">//</span> 递归终止条件  <span class="token keyword">if</span> node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>    <span class="token keyword">return</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>  dfs<span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span>  dfs<span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h2 id="二叉树深度优先的遍历顺序"><a href="#二叉树深度优先的遍历顺序" class="headerlink" title="二叉树深度优先的遍历顺序"></a>二叉树深度优先的遍历顺序</h2><p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkptkp1yf9j314n0u0qan.jpg" width="400"></image></p><h2 id="多叉树的代码示例"><a href="#多叉树的代码示例" class="headerlink" title="多叉树的代码示例"></a>多叉树的代码示例</h2><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">递归</font></p><pre class=" language-python"><code class="language-python">visited <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> dfs <span class="token punctuation">(</span>node<span class="token punctuation">,</span> visited<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true"># 递归终止条件</span>  <span class="token keyword">if</span> node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>    <span class="token keyword">return</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># do some thing on here</span>  <span class="token comment" spellcheck="true"># drill down</span>  <span class="token keyword">for</span> next_node <span class="token keyword">in</span> node<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> next_node <span class="token keyword">in</span> visited<span class="token punctuation">:</span>      dfs<span class="token punctuation">(</span>next_node<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">非递归</font></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">DFS</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tree<span class="token punctuation">)</span>  <span class="token keyword">if</span> tree<span class="token punctuation">.</span>root <span class="token keyword">is</span> None<span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  visited<span class="token punctuation">,</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>tree<span class="token punctuation">.</span>root<span class="token punctuation">]</span>  <span class="token keyword">while</span> stack<span class="token punctuation">:</span>    node <span class="token operator">=</span> stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>    visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 对node节点做一些业务操作</span>    process<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 生成新的nodes</span>    nodes <span class="token operator">=</span> generate_related_nodes<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    stack<span class="token punctuation">.</span>push<span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># other processing work</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="图的深度优先遍历"><a href="#图的深度优先遍历" class="headerlink" title="图的深度优先遍历"></a>图的深度优先遍历</h2><p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpuicfcssj30rs0lsdg7.jpg" width="400"></image></p><h1 id="BFS-广度优先遍历"><a href="#BFS-广度优先遍历" class="headerlink" title="BFS 广度优先遍历"></a>BFS 广度优先遍历</h1><p>广度优先遍历就不再利用递归或者栈来实现了，而是用队列来实现。我们先从表象来看下广度优先遍历的顺序~<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkpvmb60m4j30rs0l2aac.jpg" width="400"></image></p><h2 id="BFS-代码结构"><a href="#BFS-代码结构" class="headerlink" title="BFS 代码结构"></a>BFS 代码结构</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> BFS <span class="token punctuation">(</span>graph<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>  queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  queue<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">)</span>  visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>start<span class="token punctuation">)</span>  <span class="token keyword">while</span> queue<span class="token punctuation">:</span>    node <span class="token operator">=</span> queue<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>    visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    process<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    nodes <span class="token operator">=</span> generate_related_nodes<span class="token punctuation">(</span>node<span class="token punctuation">)</span>    queue<span class="token punctuation">.</span>push<span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># other processing work</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分治、回溯的实现和特性</title>
      <link href="/2020/11/14/fen-zhi-hui-su-de-shi-xian-he-te-xing/"/>
      <url>/2020/11/14/fen-zhi-hui-su-de-shi-xian-he-te-xing/</url>
      
        <content type="html"><![CDATA[<p>分治和回溯其实本质上就是一个递归，这里单独拎出来讲解，你可以理解分治和回溯就是一种特殊或者较为复杂的递归即可。<strong>可以这么说，遇到一个需要递归的题目，我们会分析它的重复项，最近重复项的话，根据重复项怎么构造、怎么分解就有了分治、回溯之类的各种办法，最优重复性的话就是动态规划~</strong></p><h1 id="分治"><a href="#分治" class="headerlink" title="分治"></a>分治</h1><h2 id="什么是分治"><a href="#什么是分治" class="headerlink" title="什么是分治"></a>什么是分治</h2><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">分治，字面上的解释是“分而治之”，就是把一个复杂的问题分成两个或更多的相同或相似的子问题，再把子问题分成更小的子问题……直到最后子问题可以简单的直接求解，原问题的解即子问题的解的合并。</font></p><h2 id="分治的递归状态树"><a href="#分治的递归状态树" class="headerlink" title="分治的递归状态树"></a>分治的递归状态树</h2><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkosp54ahmj31xd0u0nos.jpg" alt></p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>看一个比较傻的问题，我们要把全部英文字母转成大写，分治的思路就是把问题拆分成单个字母转成大写，再组装结果返回的过程。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkota3j5cfj32140u0tad.jpg" alt></p><p>在计算机科学中，分治法就是运用分治思想的一种很重要的算法。分治法是很多高效算法的基础，如排序算法（快速排序，归并排序），傅立叶变换（快速傅立叶变换）等等。 <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">跟一般的递归相比，分治多了一步合并子结果得到最终结果的过程。</font></p><h1 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h1><h2 id="什么是回溯"><a href="#什么是回溯" class="headerlink" title="什么是回溯"></a>什么是回溯</h2><p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">回溯法采用试错的思想，它尝试分步的去解决一个问题。在分步的过程中，当它通过尝试发现现有的分步答案不能得到有效的正确的解答的时候，它将取消上一步甚至是上几步的计算，再通过其他的可能的分步解答再次尝试寻找问题的答案。</font></p><p>回溯法通常用最简单的递归方法来实现，在反复重复上述的步骤后可能出现两种情况：</p><ul><li>找到一个可能存在的正确答案</li><li>在尝试了所有可能的分步方法后宣告该问题没有答案</li></ul><p><strong>在最坏的情况下，回溯法会导致一次复杂度为指数时间的计算。</strong></p><p>最典型的应用是在八皇后或者数独上面。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二分查找的实现、特性及实战题目解析</title>
      <link href="/2020/11/11/er-fen-cha-zhao-de-shi-xian-te-xing-ji-shi-zhan-ti-mu-jie-xi/"/>
      <url>/2020/11/11/er-fen-cha-zhao-de-shi-xian-te-xing-ji-shi-zhan-ti-mu-jie-xi/</url>
      
        <content type="html"><![CDATA[<h1 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h1><p>二分查找也称折半查找（Binary Search），它是一种效率较高的查找方法。但是，折半查找要求线性表必须采用顺序存储结构，而且表中元素按关键字有序排列。</p><p>所以，想要进行二分查找，需要数据有以下前提：</p><ol><li>目标函数单调性(单调递增或者递减)</li><li>存在上下界(bounded)</li><li>能够通过索引访问(index accessible)</li></ol><h1 id="代码模板"><a href="#代码模板" class="headerlink" title="代码模板"></a>代码模板</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> right <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    mid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能不能整除哦</span>    <span class="token comment" spellcheck="true">// 找到啦</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token keyword">return</span> mid<span class="token punctuation">;</span>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">(</span>left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">(</span>right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>比如 在递增数组 [10, 14, 19, 26, 27, 31, 33, 42, 44]中，查找 31 所在的下标<br><image src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq2psc4z6j30rs0l13zs.jpg" width="500"><br>先查找中间值27, 发现 31 比27大，左边界变成 31 所在下标，右边界仍是数组结尾，这时会对比中间值 35 与 31 大小，接着移动边界，直到找出 31</image></p><h1 id="实战题目"><a href="#实战题目" class="headerlink" title="实战题目"></a>实战题目</h1><p><a href="https://leetcode-cn.com/problems/sqrtx/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/sqrtx/</a></p><p>实现 int sqrt(int x) 函数。</p><p>计算并返回 x 的平方根，其中 x 是非负整数。</p><p>由于返回类型是整数，结果只保留整数的部分，小数部分将被舍去。</p><h2 id="分析题目"><a href="#分析题目" class="headerlink" title="分析题目"></a>分析题目</h2><p>因为 x = y²，这个抛物线是在第一象限的，所以 y 的值是单调递增的，且有边界，因为 x 是非负整数，所以 y 最小值为0 (当x为0时), y最大值就为 x，所以针对 y 的求值可以用二分查找。</p><h2 id="coding"><a href="#coding" class="headerlink" title="coding"></a>coding</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mySqrt <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span>  <span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> right <span class="token operator">=</span> x<span class="token punctuation">;</span>  <span class="token keyword">var</span> mid<span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 防止越界</span>    mid <span class="token operator">=</span> left <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid <span class="token operator">*</span> mid <span class="token operator">></span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>      right <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> right<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>递归的实现、特性以及思维要点</title>
      <link href="/2020/11/11/di-gui-de-shi-xian-te-xing-yi-ji-si-wei-yao-dian/"/>
      <url>/2020/11/11/di-gui-de-shi-xian-te-xing-yi-ji-si-wei-yao-dian/</url>
      
        <content type="html"><![CDATA[<h1 id="递归是什么"><a href="#递归是什么" class="headerlink" title="递归是什么"></a>递归是什么</h1><p>递归本质上也是一种循环，只不过通过循环体调用自己来进行所谓的循环。</p><h1 id="一个简单的栗子"><a href="#一个简单的栗子" class="headerlink" title="一个简单的栗子"></a>一个简单的栗子</h1><p>我们拿阶乘举例</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这里拓展下 我们可以开启尾递归优化</span><span class="token keyword">function</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> total <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> total<span class="token punctuation">;</span>  total <span class="token operator">*</span><span class="token operator">=</span> n<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">Factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>递归实际执行过程如下<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkl55gtp1yj316y0t8duo.jpg" width="800"></image></p><h1 id="递归的代码模板"><a href="#递归的代码模板" class="headerlink" title="递归的代码模板"></a>递归的代码模板</h1><p>记住递归的结构能让我们在遇到这类问题的时候，更快、更完整的找到问题的方法。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">recursion</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> parma1<span class="token punctuation">,</span> parma1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 递归终止条件 返回结果</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> Max_level<span class="token punctuation">)</span> <span class="token keyword">return</span> process_result<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 处理当前层逻辑</span>  <span class="token function">process</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> data<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 下探到下一层</span>  self<span class="token punctuation">.</span><span class="token function">recursion</span><span class="token punctuation">(</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> p1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 清理当前层(当需要时)</span>  clear something<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><h1 id="递归的思维要点"><a href="#递归的思维要点" class="headerlink" title="递归的思维要点"></a>递归的思维要点</h1><ul><li>不要人肉进行递归(最大误区)</li><li>找到最近最简的办法，将其拆解成可重复解决的问题(重复子问题)，比如计算n的阶乘，我们可以把这个问题拆解成找 n 和 Factorial(n - 1)相乘的结果</li><li>数学归纳法，寻找n = 1，n = 2成立，且直到 n 都成立的方法。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4. 树 -二叉树、二叉搜索树</title>
      <link href="/2020/10/31/shu-er-cha-shu-er-cha-sou-suo-shu/"/>
      <url>/2020/10/31/shu-er-cha-shu-er-cha-sou-suo-shu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>回忆下，我们说的链表是一维结构，它的查找节点时间复杂度是O(n)的，正式因为这个原因的话，后来就出现了跳表一样的结构，加上了更快的索引，比如从头指针直接跨到第二个节点，注意，这里涉及一个理念，前面也提到过，如果我们想加速，关键点是<strong>升维</strong>，常见的二维的数据结构有<strong>树和图</strong>。</p></blockquote><p>链表结构:<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dn0euezj30rr08zdgf.jpg" width="600"><br><span style="font-weight: bold;">如果链表的节点有多个next指针，指向多个节点，那么它就变成了一个数🌲状结构了。接下来，我们认识一种新的数据结构 - 树。<span></span></span></image></p><h1 id="Tree-树"><a href="#Tree-树" class="headerlink" title="Tree 树"></a>Tree 树</h1><blockquote><p>树是一种数据结构，它是由n(n&gt;=1)个有限结点组成一个具有层次关系的集合。把它叫做“树”是因为它看起来像一棵倒挂的树，也就是说它是根朝上，而叶朝下的。每个结点有零个或多个子结点；没有父结点的结点称为根结点；每一个非根结点有且只有一个父结点；除了根结点外，每个子结点可以分为多个不相交的子树.</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dsdgrhqj30rq0db74j.jpg" alt><br>首先它有个根节点(root)，B节点和C节点都是它的子树🌲，我们称B和C为左子树和右子树，它们是彼此的兄弟节点，同时B和C节点又为它们子节点的父节点。树还分了不同的层，root节点为第0层，B和C为第一层。</p><h2 id="定义树节点"><a href="#定义树节点" class="headerlink" title="定义树节点"></a>定义树节点</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="Binary-Tree-二叉树"><a href="#Binary-Tree-二叉树" class="headerlink" title="Binary Tree 二叉树"></a>Binary Tree 二叉树</h2><blockquote><p>现实中用的更多的还是二叉树，二叉树的子节点只有2个。</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8dz9qlsqj30rr0cemxe.jpg" alt></p><h2 id="树的延伸-Graph-图-简介"><a href="#树的延伸-Graph-图-简介" class="headerlink" title="树的延伸 - Graph 图(简介)"></a>树的延伸 - Graph 图(简介)</h2><p>那么树和图最关键的一个差别是什么呢，就是看有没有环装结构，如果节点本身的话，只连到新的儿子节点，永远不会走回去，如下图，如果F节点有个next指针指向了E，或者指向了A，或者指向了它的父节点C的话，那么就相当于形成了一个环，这是我们按照定义不称为树，而是叫做图。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8e5tnehlj30rs0evq3b.jpg" width="600"></image></p><p><strong>但是在特殊情况下，你也可以理解为Linked list就是特殊化的Tree(多个next指针的链表), Tree就是特殊化的Graph(没有环的🌲)。</strong></p><h2 id="树的遍历"><a href="#树的遍历" class="headerlink" title="树的遍历"></a>树的遍历</h2><ul><li>前序遍历(pre-order)：根-左-右</li><li>中序遍历(In-order)：左-根-右</li><li>后序遍历(Post-order)：右根左</li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/** * @descripe 前序遍历 * @param {TreeNode} root * @return {number[]} */</span><span class="token keyword">var</span> preorderTraversal <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">{</span>        arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前节点收集</span>        <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 左节点搜集</span>        <span class="token function">preorder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 右节点搜集</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这么看来，我们要想查找某个节点的值，时间复杂度还是O(n)的，因为看来需要整个遍历一下，它和一个链表基本上没有太大的区别，那么树到底有什么优势呢？一般来说，树的结构我们会把它变得更加有序，这就好像你的宿舍或者你的办公室、或者你的电脑里面，经常使用的东西，把它排的相对有序的话，那你查找和维护起来就会更加有效，二叉树也是这样，这就是我们接下来要介绍的二叉搜索树。</p><h1 id="二叉搜索树-Binary-Search-Tree"><a href="#二叉搜索树-Binary-Search-Tree" class="headerlink" title="二叉搜索树 (Binary Search Tree)"></a>二叉搜索树 (Binary Search Tree)</h1><blockquote><p>二叉搜索树，也称为二叉排序树、有序二叉树(Ordered Binary Tree)、排序二叉树(Sorted Binary Tree)，是指一棵空树或者具有下列性质的二叉树：</p><ol><li>左子节点树上<strong>所有节点</strong>的值均小于它的根节点上的值</li><li>右子节点树上<strong>所有节点</strong>的值均大于它的根节点上的值</li><li>以此类推，左、右子树也分别为二叉查找树。(这就是重复性！)</li></ol></blockquote><p><strong>二叉搜索树的中序遍历就是升序遍历！！</strong> </p><h2 id="二叉搜索树常见操作"><a href="#二叉搜索树常见操作" class="headerlink" title="二叉搜索树常见操作"></a>二叉搜索树常见操作</h2><ul><li>查询</li><li>插入新节点(创建)</li><li>删除</li></ul><p>它的查询和插入都是O(logn)了，所以就相当于加速了。</p><p><a href="https://visualgo.net/zh/bst" target="_blank" rel="noopener">可视化操作</a></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5. 堆和二叉堆</title>
      <link href="/2020/10/31/dui-he-er-cha-dui/"/>
      <url>/2020/10/31/dui-he-er-cha-dui/</url>
      
        <content type="html"><![CDATA[<h1 id="Heap-堆"><a href="#Heap-堆" class="headerlink" title="Heap 堆"></a>Heap 堆</h1><p>Heap: <strong>可以迅速找到一堆数中的最大值或者最小值的数据结构，</strong>注意找<strong>最大值或最小值</strong>，两者只能取其一。</p><p><strong>将根节点最大的堆叫做大顶堆或大根堆，根节点最小的堆叫小顶堆或小根堆。常见的堆有二叉堆、斐波那契堆等。</strong></p><p>假设是大顶堆，则常见操作(API)及其对应复杂度：</p><ul><li>find-max：O(1)</li><li>delete-max：O(logN)</li><li>insert(create): O(logN) 或者 O(1)</li></ul><p>不同实现的比较：<a href="https://en.wikipedia.org/wiki/Heap_(data_structure)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Heap_(data_structure)</a></p><h1 id="二叉堆"><a href="#二叉堆" class="headerlink" title="二叉堆"></a>二叉堆</h1><p>通过完全二叉树来实现(注意：不是二叉搜索树)；二叉堆(大顶)它满足以下性质：</p><ol><li><strong>是一颗完全树🌲(根和每个节点都是满的，最下面一层最后一个节点之前所有的坑位都要占满)</strong></li><li><strong>树中任意节点的值总是 &gt;= 其子节点的值</strong></li><li><strong>它的实现相对比较容易，但是其实二叉堆的时间复杂度在所有堆类型里只是刚刚及格。</strong></li></ol><p>以下就为完全二叉树，除了最下面一层不是丰满状态以外，每一层都是满的，而且任意节点的值都是大于等于其子节点的。注意，这里70是最下面一层最后一个节点，70之前元素必须满才行，如果去掉50就不是完全树了，但是去掉70是可以的，去掉70之后50变成最后一个节点了，50之前节点满就行。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk8wjpw0rtj30rs0fsq36.jpg" width="600"></image></p><p>由于它的这个性质，我们就能保证根节点就是最大的节点。</p><h2 id="二叉堆实现细节"><a href="#二叉堆实现细节" class="headerlink" title="二叉堆实现细节"></a>二叉堆实现细节</h2><ol><li>二叉堆一般都通过”数组”来实现</li><li>因为二叉堆是从根节点到左子，再到右子依次排下来，假设”第一个元素”在数组中的索引为0的话，上图中二叉堆对应数组为[110, 100, 90, 40, …]，则父节点和子节点的位置关系如下：<blockquote><ul><li>索引为i的左孩子的索引是(2 * i + 1)</li><li>索引为i的右孩子的索引是(2 * i + 2)</li><li>索引为i的父节点的索引是 Math.floor((n - 1) / 2) (向下取整)</li></ul></blockquote></li></ol><h2 id="二叉堆插入元素-Insert-O-logN"><a href="#二叉堆插入元素-Insert-O-logN" class="headerlink" title="二叉堆插入元素 Insert(O(logN))"></a>二叉堆插入元素 Insert(O(logN))</h2><ol><li>新元素一律插入到堆的尾部</li><li>依次向上调整到整个堆的结构(一直到根即可)</li></ol><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk937l4oxuj315l0u0n9d.jpg" width="500"><p>插入新元素会先添加到堆的尾部，也就是插到40的左子节点。</p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93bv0ly0j31ku0p0tgj.jpg" width="500"><p>然后要把85依次往上浮动，如果85大于他的父亲节点，那么就跟它的父亲节点交换位置，直到走到根节点。整个操作最坏会遍历一侧的堆，也就是O(log2的N次方)</p><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93hf9nwdj31f00tgguz.jpg" width="500"><h2 id="二叉堆删除堆顶操作-Delete-Max-logn"><a href="#二叉堆删除堆顶操作-Delete-Max-logn" class="headerlink" title="二叉堆删除堆顶操作 Delete Max (logn)"></a>二叉堆删除堆顶操作 Delete Max (logn)</h2><ol><li>将堆尾的元素替换到顶部(即堆顶被替换删除掉)</li><li>依次从<strong>根部向下</strong>调整整个堆的结构(挪上去然后调整下来)</li></ol><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk93r32959j31p50u0e0n.jpg" alt></p></image></image></image>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>6. 图</title>
      <link href="/2020/10/31/tu/"/>
      <url>/2020/10/31/tu/</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><blockquote><p>不管是在面试还是在平时工程的时候，图相关的算法和应用都越来越少，特别是在现在算法面试中，基本上很少考图相关的东西，在这里的话，我们就粗略了解下即可，如果工程中需要用到图的，肯定要和实际要解决的业务情况相结合来考虑。</p></blockquote><h1 id="什么是图"><a href="#什么是图" class="headerlink" title="什么是图"></a>什么是图</h1><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pp8mv2rj307y057gm2.jpg" alt><br>图论〔Graph Theory〕是数学的一个分支。它以图为研究对象。<strong>图论中的图是由若干给定的点及连接两点的线所构成的图形</strong>，这种图形通常用来描述某些事物之间的某种特定关系，用点代表事物，用连接两点的线表示相应两个事物间具有这种关系。</p><p><strong>图论是一种表示 “多对多” 的关系。</strong></p><p><strong>图是由顶点和边组成的：(可以无边，但至少包含一个顶点)</strong></p><ul><li>一组顶点：通常用 V(vertex) 表示顶点集合</li><li>一组边：通常用 E(edge) 表示边的集合</li></ul><p><strong>图可以分为有向图和无向图，在图中：</strong></p><ul><li>(v, w) 表示无向边，即 v 和 w 是互通的</li><li>&lt;v, w&gt; 表示有向边，该边始于 v，终于 w</li></ul><p><strong>图可以分为有权图和无权图：</strong></p><ul><li>有权图：每条边具有一定的权重(weight)，通常是一个数字</li><li>无权图：每条边均没有权重，也可以理解为权为 1</li></ul><p><strong>图又可以分为连通图和非连通图：</strong></p><ul><li>连通图：所有的点都有路径相连</li><li>非连通图：存在某两个点没有路径相连</li></ul><p><strong>图中的顶点有度的概念：</strong></p><ul><li>度(Degree)：所有与它连接点的个数之和</li><li>入度(Indegree)：存在于有向图中，所有接入该点的边数之和</li><li>出度(Outdegree)：存在于有向图中，所有接出该点的边数之和</li></ul><h1 id="图的表示方法"><a href="#图的表示方法" class="headerlink" title="图的表示方法"></a>图的表示方法</h1><ol><li><strong>邻阶矩阵</strong><ul><li>在 n 个顶点的图需要有一个 n × n 大小的矩阵</li><li>在一个无权图中，矩阵坐标中每个位置值为 1 代表两个点是相连的，0 表示两点是不相连的</li><li>在一个有权图中，矩阵坐标中每个位置值代表该两点之间的权重，0 表示该两点不相连</li><li>在无向图中，邻接矩阵关于对角线相等</li></ul></li><li><strong>邻阶表</strong><ul><li>对于每个点，存储着一个链表，用来指向所有与该点直接相连的点</li><li>对于有权图来说，链表中元素值对应着权重</li></ul></li></ol><p>例如在无向无权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pv1nvexj30k00akgmx.jpg" alt></p><p>在无向有权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9pxk9j16j31is0teqki.jpg" alt></p><p>可以看出<strong>在无向图中，邻接矩阵关于对角线对称。</strong></p><p>而在有向无权图中：<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9q26nmqxj31dw0t2gw2.jpg" alt></p><p><strong>邻接矩阵和链表对比：</strong><br>邻接矩阵由于没有相连的边也占有空间，因此存在浪费空间的问题，而邻接链表则比较合理地利用空间。<br>邻接链表比较耗时，牺牲很大的时间来查找，因此比较耗时，而邻接矩阵法相比邻接链表法来说，时间复杂度低。</p><h1 id="图的遍历"><a href="#图的遍历" class="headerlink" title="图的遍历"></a>图的遍历</h1><p>图的遍历就是要找出图中所有的点，一般有以下两种方法：</p><p><strong>1. 深度优先遍历：(Depth First Search, DFS)</strong><br>基本思路：深度优先遍历图的方法是，从图中某顶点 v 出发</p><ol><li>访问顶点 v</li><li>从 v 的未被访问的邻接点中选取一个顶点 w，从 w 出发进行深度优先遍历</li><li>重复上述两步，直至图中所有和v有路径相通的顶点都被访问到</li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 伪代码实现，类似于树的先序遍历</span><span class="token comment" spellcheck="true">// 图的遍历和树的DFS或者BFS最大区别是，树不会重复遍历节点，但是图会，所以需要加visited标识</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">DFS</span><span class="token punctuation">(</span>Vertex v<span class="token punctuation">)</span> <span class="token punctuation">{</span>  visited<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>v 的每个邻接点 W<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">DFS</span><span class="token punctuation">(</span>W<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>2. 广度优先搜索：(Breadth First Search, BFS)</strong><br>广度优先搜索，可以被形象地描述为 “浅尝辄止”，它也需要一个队列以保持遍历过的顶点顺序，以便按出队的顺序再去访问这些顶点的邻接顶点。<br>实现思路：</p><ol><li>顶点 v 入队列</li><li>当队列非空时则继续执行，否则算法结束</li><li>出队列取得队头顶点 v；访问顶点 v 并标记顶点 v 已被访问</li><li>查找顶点 v 的第一个邻接顶点 col</li><li>若 v 的邻接顶点 col 未被访问过的，则 col 继续</li><li>查找顶点 v 的另一个新的邻接顶点 col，转到步骤 5 入队列，直到顶点 v 的所有未被访问过的邻接点处理完。转到步骤 2</li></ol><p>要理解深度优先和广度优先搜索，首先要理解搜索步，一个完整的搜索步包括两个处理：</p><ol><li>获得当前位置上，有几条路可供选择</li><li>根据选择策略，选择其中一条路，并走到下个位置</li></ol><p><strong>相当于在漆黑的夜里，你只能看清你站的位置和你前面的路，但你不知道每条路能够通向哪里。</strong>搜索的任务就是，给出初始位置和目标位置，要求找到一条到达目标的路径。 </p><ul><li>深度优先就是，从初始点出发，不断向前走，如果碰到死路了，就往回走一步，尝试另一条路，直到发现了目标位置。这种不撞南墙不回头的方法，即使成功也不一定找到一条好路，但好处是需要记住的位置比较少。</li><li>广度优先就是，从初始点出发，把所有可能的路径都走一遍，如果里面没有目标位置，则尝试把所有两步能够到的位置都走一遍，看有没有目标位置；如果还不行，则尝试所有三步可以到的位置。这种方法，一定可以找到一条最短路径，但需要记忆的内容实在很多，要量力而行。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3. 哈希表、映射、集合</title>
      <link href="/2020/10/29/ha-xi-biao-ying-she-ji-he/"/>
      <url>/2020/10/29/ha-xi-biao-ying-she-ji-he/</url>
      
        <content type="html"><![CDATA[<h1 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h1><blockquote><p>我们通常使用的 Map，Set 结构底层基本都是用 Hash 表来实现的，当然还有些会用到二叉树来实现。<strong>哈希表也叫散列表，是根据关键码值(key value)而直接进行访问的数据结构。它通过把要存储的值映射到表中的一个位置(key 或者 index)来访问记录，以加快查找的速度。</strong>这个映射函数叫散列函数(Hash Function)，存放记录的数组叫做哈希表(或散列表)。</p></blockquote><h1 id="工程实践"><a href="#工程实践" class="headerlink" title="工程实践"></a>工程实践</h1><blockquote><p>根据一个key(比如人名)来存储值的一些场景</p><ul><li>电话号码薄</li><li>用户信息表</li><li>缓存 (LRU Cache)</li><li>键值对存储 (比如Redis)</li></ul></blockquote><h1 id="Hash-Function"><a href="#Hash-Function" class="headerlink" title="Hash Function"></a>Hash Function</h1><p>我们首先来看下哈希表中，映射函数Hash Fuction做了什么<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6k96qiiij30ru0b8t9f.jpg" alt></p><blockquote><p>我们有一个string需要存储，它的值为 lies， 那如何存呢，方块代表哈希函数，lies传入后返回一个下标，如图所示返回一个整数9，这样存下即可。</p></blockquote><p>有同学可能会问，lies 下标为何对应9呢，有什么规律么，这就是所谓的 Hash 函数的处理，这个 Hash 函数有很多种，我们在这里列举一个简单的 Hash 函数，就是把每一个字符的 ASCII 码加在一起，然后再模上一个数，比如模上10，429 % 10 得到9。这就是一个简单的 Hash 函数，现实中一些 Hash 函数往往比较复杂，而且 Hash 函数选得好的话，可以让这些数值尽量的分散，而不会发生所谓的碰撞，因为这里的话，lies 算出来得9，那么其他字符也有可能为9，如下图:<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6myjezknj324i0tytrf.jpg" alt></p><p>也就是说，对于不同的要存储的数据，它经过 Hash 函数之后，如果得到一个相同的值，这种情况就叫做 <strong>Hash 碰撞</strong>。 </p><p>如果9这个位置要存多个元素，我们要做的事情也比较简单，可以依次往下面存，占别人的位置。当然还有一种更好的办法或者在工程上常用的一种方式是再增加一个维度，这个位置不止存一个数了，也就是从这里开始，拉出来一个链表，这样的方法叫做<strong>拉链式解决冲突法</strong>。原本需要 O(1) 复杂度的查询，<strong>最坏的情况下</strong>: 如果发生了很多 Hash 碰撞，它的查询时间就要遍历链表，如果链表很长，它就会效率退化，退化到所谓的 O(n) 级别。<strong>好的情况下</strong>: 如果设计的很好的话，Hash 函数碰撞的几率很小，所以在平均时刻的话，我们可以认为，整个 Hash 表的查询是 O(1)。</p><p>借助下图的完整结构，好好体会下。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6nbqnenxj31ni0u00z9.jpg" alt></p><h1 id="Hash-表的时间复杂度"><a href="#Hash-表的时间复杂度" class="headerlink" title="Hash 表的时间复杂度"></a>Hash 表的时间复杂度</h1><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk6ngpd1o6j31me0u04fi.jpg" alt><br>我们发现，它的查询、添加、删除大部分都是 O(1) 的时间复杂度，但是在最坏的情况下，比如哈希函数选的非常不好，或者哈希表的整个 Size 太小了，就导致经常发生冲突，一冲突的话当前存储的值就会退化一个链表了，这个时候，它的时间复杂度就是 O(n) 了。现在计算机的内存越来越大，Hash 表可以开的很大很大，同时随着哈希函数的不断优化，一般来说，我们都可以认为哈希表在正常的情况下，就是 O(1) 的时间复杂度进行查询、添加和删除元素。</p><h1 id="Map-和-Set-结构"><a href="#Map-和-Set-结构" class="headerlink" title="Map 和 Set 结构"></a>Map 和 Set 结构</h1><blockquote><p>真正的工程中，我们使用的就不是 hash 表了，而是在它的基础上抽象出来的，使用比较多的就是 Map 和 Set。</p></blockquote><p><strong>Map： key-value对，key不重复</strong></p><ul><li>new HasMap() / new TreeMap() </li><li>map.Set(key, val)</li><li>map.get(key)</li><li>map.has(key)</li><li>map.size()</li><li>map.clear()</li></ul><p><strong>Set： 不重复元素的集合</strong></p><ul><li>new HashSet() / new TreeSet()</li><li>set.add(value)</li><li>set.delete(value)</li><li>set.has(value)</li></ul><p>注意：js中对象并不是严格意义上的hash映射<br><a href="https://juejin.im/post/6844903422420844557" target="_blank" rel="noopener">JS中 Object 作为 Hash 表使用避坑指北</a></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实现 instanceof</title>
      <link href="/2020/10/27/shou-xie-instanceof/"/>
      <url>/2020/10/27/shou-xie-instanceof/</url>
      
        <content type="html"><![CDATA[<pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>left<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// left实例没有原型链了</span>    <span class="token keyword">let</span> proto <span class="token operator">=</span> left<span class="token punctuation">.</span>__proto__<span class="token punctuation">;</span>​    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ​        <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">==</span> right<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        proto <span class="token operator">=</span> proto<span class="token punctuation">.</span>__proto__<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手写Promise</title>
      <link href="/2020/10/27/shou-xie-promise/"/>
      <url>/2020/10/27/shou-xie-promise/</url>
      
        <content type="html"><![CDATA[<p>我们分步来实现promise</p><h1 id="step1-声明-Promise类并绑定this"><a href="#step1-声明-Promise类并绑定this" class="headerlink" title="step1: 声明_Promise类并绑定this"></a>step1: 声明_Promise类并绑定this</h1><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "fulfilled", value: "success"}</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "rejected", value: "fail"}</span></code></pre><p>这里需要注意的一点就是，回调函数需要绑定当前的this，不然因为class内部是严格模式，如果传入的函数执行了resolve或者reject方法时，里面的this为undefined，就会报错。</p><p><strong>我们发现，可以先执行resolve，再执行reject，不符合promise状态不可变的特性，所以进行我们的第二步修饰~</strong></p><h1 id="step2-状态保护与执行者异步错误捕获"><a href="#step2-状态保护与执行者异步错误捕获" class="headerlink" title="step2: 状态保护与执行者异步错误捕获"></a>step2: 状态保护与执行者异步错误捕获</h1><p>这个步骤我们做了两件事</p><ul><li><strong>当promise的状态为pending时，resolve和reject方法中才能更改状态。</strong></li><li><strong>如果cb执行过程中，出现错误，promise状态应该变成reject。所以要给cb增加try catch。</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// _Promise {status: "fulfilled", value: "success"}</span><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xxxsksks<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Promise {status: "rejected", value: ReferenceError: xxxsksks is not defined</span><span class="token comment" spellcheck="true">//     at &lt;anonymous>:3:17</span><span class="token comment" spellcheck="true">//     at new _Promise (&lt;anonymous>:6:…}</span></code></pre><h1 id="step3-Then的基础构建"><a href="#step3-Then的基础构建" class="headerlink" title="step3: Then的基础构建"></a>step3: Then的基础构建</h1><ul><li><strong>可以通过then接收promise返回结果，类中声明then方法</strong></li><li><strong>onFulfilled, onReject方法可以不传</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// success</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// fail</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不传reject回调 不会报错</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  </code></pre><h1 id="step4-实现Then的异步操作-微任务-与异常捕获"><a href="#step4-实现Then的异步操作-微任务-与异常捕获" class="headerlink" title="step4: 实现Then的异步操作(微任务)与异常捕获"></a>step4: 实现Then的异步操作(微任务)与异常捕获</h1><ul><li><strong>Then方法里的函数也可能报错，报错也要把promise变成rejected状态，也需要加try catch</strong></li><li><strong>利用setTimeout模拟微任务的执行顺序</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模拟微任务顺序</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ReferenceError: sn is not defined</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// ReferenceError: sn is not defined</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// success</span></code></pre><h1 id="step5-Promise的-pending-状态处理"><a href="#step5-Promise的-pending-状态处理" class="headerlink" title="step5: _Promise的 pending 状态处理"></a>step5: _Promise的 pending 状态处理</h1><ul><li><strong>如果promise不是立即返回结果，也就是.then方法执行而且状态为pending，这时候需要记录回调函数，等待resolve或者reject执行时，执行回调</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 执行reslove时 执行成功回调</span>                task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行reslove时 执行失败回调</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 记录then方法中的回调函数 注意是一对一对的压哦 </span>                <span class="token comment" spellcheck="true">// 注意所有错误都交给reject方法 后续优化</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cc<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// VM8622:3 ReferenceError: cc is not defined</span></code></pre><h1 id="step6-异步回调执行顺序跳转"><a href="#step6-异步回调执行顺序跳转" class="headerlink" title="step6: 异步回调执行顺序跳转"></a>step6: 异步回调执行顺序跳转</h1><ul><li><strong>我们希望.then的回调永远是异步的 比如以下代码，我们期望先输出2，再输出1</strong><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  </code></pre></li></ul><p>ok， 来改写代码</p><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 记录then方法中的回调函数 注意是一对一对的压哦 </span>                <span class="token comment" spellcheck="true">// 注意所有错误都交给reject方法 后续优化</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 2</span><span class="token comment" spellcheck="true">// 1</span></code></pre><h1 id="step7-then-then-链式操作"><a href="#step7-then-then-链式操作" class="headerlink" title="step7: .then().then()链式操作"></a>step7: .then().then()链式操作</h1><ul><li><strong>因为每个.then都返回一个promise，我们可以用递归的方式，让.then方法返回一个新的_promsie, 新的_Promise 执行resolve或者reject方法传递上个then 的返回值</strong></li><li><strong>注意 then 返回值的promise状态默认是成功的</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'ys'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Uncaught TypeError: Cannot read property 'then' of undefined</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">onReject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "000"</span><span class="token comment" spellcheck="true">// VM15140:9 success 111</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "111"</span><span class="token comment" spellcheck="true">// VM15140:9 fail 222</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链式调用then失败？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 1  "111"</span><span class="token comment" spellcheck="true">// VM15140:9 fail 222</span></code></pre><h1 id="step8-then-方法错误传递"><a href="#step8-then-方法错误传递" class="headerlink" title="step8: then()方法错误传递"></a>step8: then()方法错误传递</h1><ul><li><strong>.then方法内部错误，需要下一个.then的onReject来捕捉, 修改返回的_Promise的错误处理即可</strong></li></ul><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aaa<span class="token punctuation">,</span> <span class="token string">'000'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'错了错了'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 错了错了 ReferenceError: aaa is not defined</span></code></pre><h1 id="step9-实现then-的穿透传递【reject穿透有问题呀】"><a href="#step9-实现then-的穿透传递【reject穿透有问题呀】" class="headerlink" title="step9: 实现then()的穿透传递【reject穿透有问题呀】"></a>step9: 实现then()的穿透传递【reject穿透有问题呀】</h1><ul><li><strong>如果then方法内部没有传递参数，把变量继续往下传递 return this.value</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 原生promise具有穿透的能力</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// reject 1</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve 1 我们也实现了这种穿透 但是reject 变成了 resolve ？？</span></code></pre><h1 id="step7-then返回promise的处理"><a href="#step7-then返回promise的处理" class="headerlink" title="step7: then返回promise的处理"></a>step7: then返回promise的处理</h1><ul><li><strong>如果then返回了一个new _Promise 需要找到对它进行取值返回操作</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 原生promise具有穿透的能力</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve  1</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark</span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token punctuation">}</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// mark </span>                            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token punctuation">}</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 传递上一个then的返回值 不管后面有没有接收</span>                         <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// resolve 1</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// reject 111</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//  reject 111</span></code></pre><h1 id="step10-优化重复代码"><a href="#step10-优化重复代码" class="headerlink" title="step10: 优化重复代码"></a>step10: 优化重复代码</h1><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里包了一层 _Promise</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><h1 id="step11-then返回类型约束-不能返回实例自身哦"><a href="#step11-then返回类型约束-不能返回实例自身哦" class="headerlink" title="step11: then返回类型约束(不能返回实例自身哦)"></a>step11: then返回类型约束(不能返回实例自身哦)</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'解决'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// TypeError: Chaining cycle detected for promise #&lt;Promise></span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'解决'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Uncaught TypeError: Chaining cycle detected</span></code></pre><h1 id="step12-resolve，reject静态方法实现-Promise-xxx"><a href="#step12-resolve，reject静态方法实现-Promise-xxx" class="headerlink" title="step12: resolve，reject静态方法实现(_Promise.xxx)"></a>step12: resolve，reject静态方法实现(_Promise.xxx)</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 普通值</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// promise 【我们发现后面的成功或者失败状态是依赖返回的promise的状态】</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// resolve: 成功</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// reject: 失败</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token comment" spellcheck="true">// 普通值</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 1</span><span class="token comment" spellcheck="true">// promsie</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 成功</span>_Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve: '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 失败</span></code></pre><h1 id="step13-Promise-all方法实现"><a href="#step13-Promise-all方法实现" class="headerlink" title="step13: _Promise.all方法实现"></a>step13: _Promise.all方法实现</h1><p><strong>Promise有以下特性:</strong></p><ul><li><strong>接收一个iterable作为参数</strong></li><li><strong>全部成功，按传入顺序返回结果集</strong></li><li><strong>一个失败，返回失败项</strong></li><li><strong>参数列表内元素如果非promise，原样返回</strong></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 全部成功 返回成功结果的集合</span><span class="token keyword">let</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ["ys", "笑嘻嘻"]</span><span class="token comment" spellcheck="true">// 如果有一个失败 则返回失败项 状态为rejected</span><span class="token keyword">let</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'哭唧唧'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 哭唧唧</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的是一个promise实例列表</span>    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// if (!Array.isArray(promises)) {</span>        <span class="token comment" spellcheck="true">//   throw new Error("promises must be an iterator")</span>        <span class="token comment" spellcheck="true">// }</span>        <span class="token comment" spellcheck="true">// 注意 参数必须为迭代器对象</span>        <span class="token comment" spellcheck="true">// 迭代器对象能调用...方法转为数组</span>        <span class="token comment" spellcheck="true">// Array.form能将一个没有部署迭代器的类数组转成数组 所以不适合判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'object is not iterable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">let</span> resolvedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> successPromiseSet <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 成功的结果数组</span>            <span class="token comment" spellcheck="true">// 迭代器对象能调用...方法转为数组 再调用forEach</span>            Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 可能输入的不是一个promise 如果不是promise对象原样返回</span>                <span class="token comment" spellcheck="true">// 为了兼容都能调用then方法 用resolve包一层</span>                _Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    successPromiseSet<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>                    resolvedCount<span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 如果结果的数量 = 传递的promise数量 则返回结果集</span>                    resolvedCount <span class="token operator">==</span> promises<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'lalal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u4 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// all result is : ["ys","笑嘻嘻","lalal",4]</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject: '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// reject: 笑嘻嘻</span></code></pre><h1 id="step14-Promise-race静态方法实现"><a href="#step14-Promise-race静态方法实现" class="headerlink" title="step14: _Promise.race静态方法实现"></a>step14: _Promise.race静态方法实现</h1><p><strong>谁快用谁，这个实现起来相当好写， 有值回来 返回即可</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : 笑嘻嘻</span><span class="token comment" spellcheck="true">// 失败状态也可以哦</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// VM117142:14 reject: race winner is : 笑嘻嘻</span></code></pre><details><summary>CODE</summary><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">_Promise</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录异步返回结果需要执行的任务队列</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                     task<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 增加异步执行逻辑</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    task<span class="token punctuation">.</span><span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onFulfilled <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onReject <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            onReject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// 往下传递 被下面res接收</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里判断 实例调用.then不能返回自身实例</span>        <span class="token keyword">let</span> promiseInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">this</span><span class="token punctuation">.</span>thenCbQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> onFulfilled<span class="token punctuation">:</span> val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 因为setTimeout是异步的 所以可以读到实例..</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span> onReject<span class="token punctuation">:</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>promiseInstance<span class="token punctuation">,</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promiseInstance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">parse</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果实例和.then方法返回的实例一样 报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 注意 then返回值的promise状态默认是成功的</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// res 是 _Promise的实例</span>                res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// onReject -> reject </span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法resolve</span>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">_Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// value 是 _Promise的实例 返回结果成功或者失败依赖value的状态</span>                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法reject实现较为简单</span>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的是一个promise实例列表</span>    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> successPromiseSet <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 成功的结果数组</span>            promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>promise <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    successPromiseSet<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 如果结果的数量 = 传递的promise数量 则返回结果集</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">.</span>length <span class="token operator">==</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">resolve</span><span class="token punctuation">(</span>successPromiseSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 传进来的也是一个promise实例列表 </span>    <span class="token comment" spellcheck="true">// promise 一个状态改变 就不能再次更改</span>    <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>promise <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></details><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : ys</span><span class="token keyword">var</span> u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'笑嘻嘻'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>u1<span class="token punctuation">,</span> u2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'race winner is : '</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> reason <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'reject: race winner is : '</span> <span class="token operator">+</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// race winner is : 笑嘻嘻</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2. 栈、队列、双端队列和优先队列</title>
      <link href="/2020/10/25/zhan-dui-lie-shuang-duan-dui-lie-he-you-xian-dui-lie/"/>
      <url>/2020/10/25/zhan-dui-lie-shuang-duan-dui-lie-he-you-xian-dui-lie/</url>
      
        <content type="html"><![CDATA[<h1 id="栈-Stack"><a href="#栈-Stack" class="headerlink" title="栈 (Stack)"></a>栈 (Stack)</h1><blockquote><p>栈的话，可以想象成一个先入后出的容器结构，先进来的元素就叠在一起了，不能从最下面出任何元素。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1eet4h7ij31240u0h4g.jpg" width="500"></image></p></blockquote><h1 id="队列-Queue"><a href="#队列-Queue" class="headerlink" title="队列 (Queue)"></a>队列 (Queue)</h1><blockquote><p>队列的话，更好理解，类似去银行窗口排队，先进先出。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1ehobyzhj328m0li459.jpg"></image></p></blockquote><h1 id="Stack-amp-Queue-总结"><a href="#Stack-amp-Queue-总结" class="headerlink" title="Stack &amp; Queue 总结"></a>Stack &amp; Queue 总结</h1><ul><li>Stack: 先入后出，添加、删除皆为O(1)，因为是无序的，所以查询操作为O(n)</li><li>Queue: 先入先出，添加、删除皆为O(1)，因为是无序的，所以查询操作为O(n)</li></ul><h1 id="双端队列-Deque"><a href="#双端队列-Deque" class="headerlink" title="双端队列 (Deque)"></a>双端队列 (Deque)</h1><blockquote><p>Double-Ended Queue的缩写</p></blockquote><blockquote><p>实战中，我们可能会更多用到栈或队列的衍生结构，双端队列就是队列的衍生结构其中的一种，我们可以在它的头部添加或删除元素，也可以在尾部添加或删除元素。<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gk1enulhbkj31lw0m6qac.jpg"></image></p></blockquote><h1 id="Deque-总结"><a href="#Deque-总结" class="headerlink" title="Deque 总结"></a>Deque 总结</h1><ul><li>简单理解：两端都可以进出的队列</li><li>插入和删除都是O(1操作)，因为是无序的，查询操作为O(n)</li></ul><h1 id="优先队列-Priority-Queue"><a href="#优先队列-Priority-Queue" class="headerlink" title="优先队列 (Priority Queue)"></a>优先队列 (Priority Queue)</h1><ul><li>插入操作O(1)</li><li>取出操作O(logN) - 按照元素的优先级取出，看起来是比普通队列取出操作O(1)变慢了，但是这样设计的一个好处是，比如排队，vip可以先行，类似于这种现象。其实如果用普通队列来实现优先取出的话，时间复杂度为O(n)，更慢了</li><li>底层具体实现的数据结构较为多样和复杂(只要知道有很多种方法可以实现即可)：<ol><li>heap(堆)实现: 但是heap也有多种实现，不一定是二叉树实现的堆，它可能是Fibonacci(斐波那契)堆，也可能是其他形式的堆。</li><li>bst(二叉搜索树)实现: 也可以是平衡的二叉搜索树来实现，比如说红黑树或者AVL来实现。</li><li>treap等一些高级数据结构来实现</li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>js继承</title>
      <link href="/2020/10/20/js-ji-cheng/"/>
      <url>/2020/10/20/js-ji-cheng/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>众所周知，在 ES 6 之前没有类的概念，所以不能像 Java 中一个 extends 关键字就搞定了继承关系，需要一些 tricks 来实现，下面就介绍一些比较常用的方法。</p><h1 id="原型链继承"><a href="#原型链继承" class="headerlink" title="原型链继承"></a>原型链继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 继承开始</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>只要是原型链中出现过的原型，都可以说是该原型链派生的实例的原型。<br>优点：</p><ol><li>简单易于实现，父类的新增的实例与属性子类都能访问<br>缺点：</li><li>子类型无法给超类型传递参数，在面向对象的继承中，我们总希望通过 var child = new Child(‘son’, ‘father’); 让子类去调用父类的构造器来完成继承。而不是通过像这样 new Parent(‘father’) 去调用父类。</li><li>Child.prototype.sayName 必须写在 Child.prototype = new Parent(‘father’); 之后，不然就会被覆盖掉。</li><li>无法实现多继承</li></ol><h1 id="构造函数继承"><a href="#构造函数继承" class="headerlink" title="构造函数继承"></a>构造函数继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>doSomthing <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 继承开始</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>相当于 Parent 这个函数在 Child 函数中执行了一遍，并且将所有与 this 绑定的变量都切换到了 Child 上，这样就克服了第一种方式带来的问题。<br>优点：</p><ol><li>解决了子类构造函数向父类构造函数中传递参数</li><li>可以实现多继承（call或者apply多个父类）<br>缺点：</li><li>只能继承父类的实例属性和方法，不能继承原型属性和方法</li><li>无法实现函数复用，每个子类都有父类实例函数的副本，影响性能</li></ol><h1 id="组合式继承"><a href="#组合式继承" class="headerlink" title="组合式继承"></a>组合式继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>doSomething <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 第二次调用 Parent</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 第一次调用 Parent</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 修正指向</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>组合式继承是比较常用的一种继承方法，其背后的思路是使用原型链实现对原型属性和方法的继承，而通过借用构造函数来实现对实例属性的继承。</p><p>这样，既通过在原型上定义方法实现了函数复用，又保证每个实例都有它自己的属性。<br><strong>组合式继承是 JS 最常用的继承模式，但组合继承使用过程中会被调用两次：一次是创建子类型的时候，另一次是在子类型构造函数的内部。</strong></p><p>显然从上述的代码中可以看出，第一次调用构造函数显然是没有必要的，因为第一次调用构造函数时候不需要函数内部的那些实例属性，这么写只是想获得其原型上的方法罢了，所以这时候你可能会这样写：</p><pre class=" language-js"><code class="language-js">Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></code></pre><p>这样写显然是不对的：</p><ol><li>首先，你这样写的话相当于是子类和父类都指向同一个对象，这时候如果你添加了新的方法给 Child 但实际上 Parent 并不需要，相当于强行给 Parent 添加了一个未知的方法。</li><li>其次，仔细想想，这样体现不出继承的多态性，比如此时子类想要重写父类的 getName 的方法，那么父类的方法也就会随之修改，这显然违背了多态性。</li></ol><p>也就是说我们第一次调用构造函数的时候，其实是不管构造函数里面的内容，所以我们何不 new 一个空函数，将其 prototype 指向 Parent.prototype</p><h1 id="寄生组合式继承"><a href="#寄生组合式继承" class="headerlink" title="寄生组合式继承"></a>寄生组合式继承</h1><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    F<span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>parent<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// parent name: father</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'son'</span><span class="token punctuation">,</span> <span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// child name: son</span></code></pre><p>这就是所谓的<strong>寄生组合式继承方式</strong>，跟组合式继承的区别在于，他不需要在一次实例中调用两次父类的构造函数，假如说父类的构造器代码很多，还需要调用两次的话对系统肯定会有影响，<strong>寄生组合式继承的思想在于：用一个 F 空的构造函数去取代执行了 Parent 这个构造函数。</strong></p><p>在上面的代码中，我们手动创建了一个 create 函数，但是其实是存在于 Object 对象中，不需要我们手动去创建，所以上面的代码可以改为：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Parent<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 利用Object.create创建一个空对象 对象的__proto__执行Parent.prototype</span><span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Parent<span class="token punctuation">,</span> Child<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>     Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Parent<span class="token punctuation">,</span> Child<span class="token punctuation">)</span><span class="token punctuation">;</span>Child<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>sayName <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>parent<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// parent name: father</span><span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token string">'son'</span><span class="token punctuation">,</span> <span class="token string">'father'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>child<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// child name: son</span></code></pre><h1 id="ES6继承"><a href="#ES6继承" class="headerlink" title="ES6继承"></a>ES6继承</h1><p>当然，如果你学习过 ES 6，那么写继承关系就会特别简单，如果你学过 Java 就会发现，ES 6 中的继承跟 Java 太像了，上述的代码可改为：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent do something!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// super关键字作为函数调用 会创建this为{} </span>    <span class="token comment" spellcheck="true">// 并隐式调用 Parent.constructor.call(this, parentName) </span>      <span class="token keyword">super</span><span class="token punctuation">(</span>parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 取值时 super关键字为父类构造函数</span>       <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child name:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prototype、__proto__与constructor</title>
      <link href="/2020/10/20/prototype-proto-yu-constructor/"/>
      <url>/2020/10/20/prototype-proto-yu-constructor/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为一名前端工程师，必须搞懂JS中的prototype、__proto__与constructor属性，相信很多初学者对这些属性存在许多困惑，容易把它们混淆，本文旨在帮助大家理清它们之间的关系并彻底搞懂它们。这里说明一点，__proto__属性的两边是各由两个下划线构成。</p><h1 id="现在正式开始"><a href="#现在正式开始" class="headerlink" title="现在正式开始"></a>现在正式开始</h1><p>让我们从如下一个简单的例子展开讨论，并配以相关的图帮助理解。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">let</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以上代码表示创建一个构造函数Foo()，并用new关键字实例化该构造函数得到一个实例化对象f1。<br>虽然是简简单单的两行代码，然而它们背后的关系却是错综复杂的，如下图所示：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpbgowbjj31d40rkacr.jpg" alt></p><p>看到这图<strong>别怕</strong>，让我们一步步剖析，彻底搞懂它们。</p><p><strong>图的说明：</strong></p><p>右下角为图例，红色箭头表示__proto__属性指向；</p><p>绿色箭头表示prototype属性的指向；</p><p>棕色箭头表示constructor属性的指向；</p><p>蓝色方块表示对象，浅绿色方块表示函数；</p><p>图的中间部分即为它们之间的联系，图的最左边即为例子代码；</p><p><strong>首先，我们需要牢记两点：</strong></p><ol><li><strong>__proto__和constructor属性是对象所独有的；</strong></li><li><strong>prototype属性是函数所独有的。</strong></li><li>但是由于JS中<strong>函数也是一种对象，所以函数也拥有__proto__和constructor属性，这点是致使我们产生困惑的很大原因之一。</strong></li></ol><p>上图有点复杂，我们把它按照属性分别拆开，然后进行分析：</p><h1 id="proto"><a href="#proto" class="headerlink" title="__proto__"></a>__proto__</h1><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpicbo25j31dq0qg40w.jpg" alt></p><p><strong>第一</strong>，这里我们仅留下__proto__属性，它是<strong>对象所独有的，可以看到__proto__属性都是由一个对象指向一个对象</strong>，即指向它们的原型对象（也可以理解为父对象），那么这个属性的作用是什么呢？</p><p style="worr-break: break-all;">它的作用就是当访问一个对象的属性时，如果该对象内部不存在这个属性，那么就会去它的__proto__属性所指向的那个对象（可以理解为父对象）里找，如果父对象也不存在这个属性，则继续往父对象的__proto__属性所指向的那个对象（可以理解为爷爷对象）里找，如果还没找到，则继续往上找….直到原型链顶端null（可以理解为原始人。。。）</p><p>此时若还没找到，则返回undefined（可以理解为，再往上就已经不是“人”的范畴了，找不到了，到此为止），由以上这种通过__proto__属性来连接对象直到null的一条链即为我们所谓的原型链。</p><h1 id="prototype"><a href="#prototype" class="headerlink" title="prototype"></a>prototype</h1><p>第二，接下来我们看prototype属性：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpoidwrnj31bf0oojt6.jpg" alt></p><p>prototype属性，别忘了一点，就是我们前面提到要牢记的两点中的第二点，它是<strong>函数所独有的，它是从一个函数指向一个对象。</strong></p><p>它的含义是函数的原型对象，也就是这个函数（其实所有函数都可以作为构造函数）所创建的实例的原型对象，由此可知：f1.__proto__ === Foo.prototype，它们两个完全一样。</p><p>那prototype属性的作用又是什么呢？</p><p>它的作用就是包含可以由特定类型的所有实例共享的属性和方法，也就是让该函数所实例化的对象们都可以找到公用的属性和方法。</p><h1 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h1><p>最后，我们来看一下constructor属性：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpr2jeexj31c80q90uv.jpg" alt><br><strong>constructor属性也是对象才拥有的，它是从一个对象指向一个函数</strong>，含义就是指向该对象的构造函数，每个对象都有构造函数(本身拥有或继承而来，继承而来的要结合__proto__属性查看会更清楚点，如下图所示)，从图中可以看出Function这个对象比较特殊，它的构造函数就是它自己（因为Function可以看成是一个函数，也可以是一个对象），所有函数最终都是由Function()构造函数得来，所以constructor属性的终点就是Function()。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvptqdjiij31cx0qwacx.jpg" alt></p><p>这里解释一下上段中“每个对象都有构造函数”这句话。这里的意思是每个对象都可以找到其对应的constructor，因为创建对象的前提是需要有constructor，而这个constructor可能是对象自己本身显式定义的或者通过__proto__在原型链中找到的。而单从constructor这个属性来讲，只有prototype对象才有。每个函数在创建的时候，JS会同时创建一个该函数对应的prototype对象，而函数创建的对象.__proto__ === 该函数.prototype，该函数.prototype.constructor===该函数本身，故通过函数创建的对象即使自己没有constructor属性，它也能通过__proto__找到对应的constructor，所以任何对象最终都可以找到其构造函数（null如果当成对象的话，将null除外）。如下：<br><image src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvpvfaxejj30sw0grt9y.jpg" width="500"></image></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol><li><p>我们需要牢记两点：①<strong>__proto__和constructor属性是对象所独有的；</strong> ② <strong>prototype属性是函数所独有的，因为函数也是一种对象，所以函数也拥有__proto__和constructor属性。</strong></p></li><li><p><strong>__proto__属性的作用就是当访问一个对象的属性时，如果该对象内部不存在这个属性，那么就会去它的__proto__属性所指向的那个对象（父对象）里找，一直找，直到__proto__属性的终点null，然后返回undefined，通过__proto__属性将对象连接起来的这条链路即我们所谓的原型链。</strong></p></li><li><p><strong>prototype属性的作用就是让该函数所实例化的对象们都可以找到公用的属性和方法，即f1.__proto__ === Foo.prototype。</strong></p></li><li><p><strong>constructor属性的含义就是指向该对象的构造函数，所有函数（此时看成对象了）最终的构造函数都指向Function()。</strong></p></li></ol><p>本文就此结束了，希望对那些对JS中的prototype、__proto__与constructor属性有困惑的同学有所帮助。</p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack4篇(上)</title>
      <link href="/2020/10/13/webpack4-pian-shang/"/>
      <url>/2020/10/13/webpack4-pian-shang/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是webpack"><a href="#什么是webpack" class="headerlink" title="什么是webpack"></a>什么是webpack</h1><p>webpack4 可以看做是模块打包机：它做的事情是，分析你的项目结构，找到JS模板以及其他的一些浏览器不能直接运行的拓展语言(Scss, Ts)等，并将其打包为合适的格式以供浏览器使用。</p><h1 id="webpack可以做什么"><a href="#webpack可以做什么" class="headerlink" title="webpack可以做什么"></a>webpack可以做什么</h1><ul><li><strong>代码转换： es6转es5，sccc、less转css等</strong></li><li><strong>文件优化： 压缩代码体积，合并文件，摇树优化等</strong></li><li><strong>代码分割： 公共模块抽离，路由懒加载等</strong></li><li><strong>模块合并： 多个模块合并成一个模块，按功能来分类</strong></li><li><strong>自动刷新： 自己启动一个本地服务，来实现代码变更后，可以更新我们的页面</strong></li><li><strong>代码校验： 校验代码是否符合规范</strong></li><li><strong>自动发布： 打包结果发布到服务器上，后面提到的方法</strong></li></ul><h1 id="webpack安装"><a href="#webpack安装" class="headerlink" title="webpack安装"></a>webpack安装</h1><p>安装本地的webpack</p><pre class=" language-js"><code class="language-js">yarn add webpack@<span class="token operator">^</span><span class="token number">4.32</span><span class="token punctuation">.</span><span class="token number">2</span> webpack<span class="token operator">-</span>cli@<span class="token operator">^</span><span class="token number">3.3</span><span class="token punctuation">.</span><span class="token number">2</span> <span class="token operator">-</span>D</code></pre><h1 id="webpack可以进行零配置"><a href="#webpack可以进行零配置" class="headerlink" title="webpack可以进行零配置"></a>webpack可以进行零配置</h1><p>webpack默认支持js、json，所以我们可以零配置打包js代码，默认会找src/index.js作为入口文件。</p><pre class=" language-js"><code class="language-js"><span class="token operator">-</span> src  <span class="token operator">-</span> index<span class="token punctuation">.</span>js<span class="token comment" spellcheck="true">// index.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后执行 npx webpack, 就在我们的dist/文件夹生成了一个打包后的main.js，此时默认采用mode为生产环境(production)，会自动优化、压缩。</p><h1 id="手动配置webpack"><a href="#手动配置webpack" class="headerlink" title="手动配置webpack"></a>手动配置webpack</h1><p>比如我们想更改mode为开发环境，希望打包后的代码不被压缩，我们可以手动配置webpack。<strong>默认配置文件的名字为 webpack.config.js或 webpackfile.js</strong>，其实扒开 webpack-cli 中就能找到这样一段代码，</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// node_modules/webpack-cli/bin/config/config.yargs.js</span>defaultDescription<span class="token punctuation">:</span> <span class="token string">"webpack.config.js or webpackfile.js"</span></code></pre><p><strong>如果我们期望更改webpack启动配置文件的名称，可以通过 npx webpack --config someName.js来来指定文件。</strong></p><p>新建文件 src/a.js，webpack.conf.my.js 并修改代码如下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/a.js</span><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span>  a<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> obj <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.conf.my.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 更清晰的打包结果</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 入口</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 打包后的文件名</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 路径必须是个绝对路径</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>package.json中增加build命令</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>    <span class="token operator">...</span><span class="token punctuation">,</span>    <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"build"</span><span class="token punctuation">:</span> <span class="token string">"npx webpack --config webpack.conf.my.js"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><h1 id="分析打包后的文件"><a href="#分析打包后的文件" class="headerlink" title="分析打包后的文件"></a>分析打包后的文件</h1><p>执行npm run build (如果需要额外参数 需要加一个 --)，生成打包后的文件 build/build.js， 我们来分析下这个文件</p><details><summary> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">CODE</font></summary><pre class=" language-js"><code class="language-js"> <span class="token comment" spellcheck="true">// webpack自执行启动函数 入参是一个对象 { './src/a.js': function, './src/index.js': function }</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 已缓存的模块 非首次加载的模块从这里面拿</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 实现了一个require方法 接收一个模块id 模块id即是路径 类似 './src/a.js'</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>         <span class="token punctuation">}</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)  声明一个新的module对象 并在缓存对象中缓存</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块id</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块状态 是否加载成功</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 模块导出</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 解析模块(传入的 moduleId对应的 function) 把 module.exports这个对象当成 this，把 module，module.exports，__webpack_require__作为实参传给函数使用 modules[moduleId]是一个函数 模块内部的 require换成了 __webpack_require__</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded 更改模块加载状态</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// Return the exports of the module 导出模块返回结果</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>     <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__) __webpack_require__上挂在全部传入的modules参数</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// expose the module cache __webpack_require__上挂在cache的模块对象</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports 给每个exports出的对象设置可枚举和可取值属性</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// define __esModule on exports 为每个模块exports出对象设置Symbol.toStringTag 也就是Object.toString.call(exports)返回的[object Module]</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports 函数默认值 不传的话为src/index.js 加载并return出加载到的模块exports的值</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = {\n  a: 1\n}\n\n//# sourceURL=webpack:///./src/a.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 注意这里 obj接收了 __webpack_require__的返回值，也就是对应模块的exports，所以是{ a: 1 }，然后打印obj 得出结果</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"var obj  = __webpack_require__(/*! ./a.js */ \"./src/a.js\");\n\nconsole.log(obj);\n\n//# sourceURL=webpack:///./src/index.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details><ol><li><strong>webpack启动函数是一个自执行函数，接收参数为{ 模块路径1: function, 模块路径2: function }这样一个对象，内部实现了自己require方法，先分析的入口文件问src/index.js，代码中遇到模块加载，则继续调用<strong>webpack_require</strong>方法加载模块。</strong></li><li><strong>加载过的文件会被缓存，第二次加载直接从内存中的缓存对象中拿。</strong></li><li><strong>任何打包进build.js中的模块，都有三个属性，{ 模块id，模块加载状态，模块exports }， 入口文件的导入的其实是其他模块的module.exports。</strong></li></ol><h1 id="热启动-webpack-dev-server"><a href="#热启动-webpack-dev-server" class="headerlink" title="热启动 webpack-dev-server"></a>热启动 webpack-dev-server</h1><p>内部通过express来实现的这样一个静态服务。</p><pre class=" language-js"><code class="language-js">yarn add webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server <span class="token operator">-</span>D</code></pre><p><strong>webpack-dev-server把打包文件写在内存中，所以不会在我们build文件夹中体现，可以通过npx webpack-dev-server来启动一个服务</strong>，当然更多我们会用到一些配置，webpack配置文件增加以下配置项</p><pre class=" language-js"><code class="language-js">  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpack-dev-server配置</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 启动端口</span>    progress<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 进度条</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./build'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 以 build目录作为静态服务启动的文件</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 自动打开浏览器</span>  <span class="token punctuation">}</span></code></pre><p>build文件加新增文件index.html</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./bundle.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>配置启动命令</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// package.json</span><span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"webpack-dev-server --config webpack.conf.my.js"</span></code></pre><p>执行npm run dev，可以打开一个页面，并输出我们的结果。</p><h1 id="html-webpack-plugin"><a href="#html-webpack-plugin" class="headerlink" title="html-webpack-plugin"></a>html-webpack-plugin</h1><p>我们并不希望在build文件夹中手动添加index.html，并手动引入资源，我们希望我们项目真正的html模板被打包，这时候，可以使用 html-webpack-plugin</p><pre class=" language-js"><code class="language-js">yarn add html<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>src目录下新建index.html, 不用引入任何文件~ </p><pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span><span class="token operator">&lt;</span>head<span class="token operator">></span>  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>title<span class="token operator">></span>webpack4 学习<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre><p>webpack配置中增加plugin配置</p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 是一个数组 放着所有的webpack插件的实例</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      template<span class="token punctuation">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模板路径</span>      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 打包后的文件名</span>      minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>        removeAttributeQuotes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 删除html中的属性双引号</span>        <span class="token comment" spellcheck="true">// collapseWhitespace: true // 压缩成一行</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      hash<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// 引入资源路径后的hash值 比如./build?xxssss</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>打包结果</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>bundle.5cd64a02.js?5cd64a021942ccddb94f</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h1 id="css-loader-style-loader"><a href="#css-loader-style-loader" class="headerlink" title="css-loader, style-loader"></a>css-loader, style-loader</h1><p>loader的作用就是对我们的源代码进行转换，要引入 css，需要正确的 loader将它转换成真正的 module。比如常用的css-loader，style-loader，需要注意它们的区别：</p><ul><li><strong>css-loader 是用来解析 @import这种语法的，并将css包装成一个模块，模块导出的是base.css的内容，然后webpack将@import替换成<strong>webpack_require</strong>，去加载这个模块</strong></li><li><strong>style-loader 是把生成的css插入header标签中</strong></li><li><strong>可以use多个loader，方法是把use对应的value配置成数组</strong></li><li><strong>loader是有顺序的，默认是从右向左执行，从下到上执行，比如我需要先处理css文件，然后把css内容插入到html的header标签的最底部，所以我需要把css-loader写后面, style-loader写在前面。</strong></li></ul><p><strong>比如 index.css中引用 base.css，此时会打包出一个</strong></p><pre class=" language-js"><code class="language-js"> <span class="token comment" spellcheck="true">// ./node_modules/css-loader/dist/cjs.js!./base.css</span> __webpack_exports__<span class="token punctuation">[</span>\"<span class="token keyword">default</span>\"<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>___CSS_LOADER_EXPORT___<span class="token punctuation">)</span><span class="token punctuation">;</span> 并且在打包出的index<span class="token punctuation">.</span>css文件中把@<span class="token keyword">import</span>替换成了 <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>"<span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>css<span class="token operator">-</span>loader<span class="token operator">/</span>dist<span class="token operator">/</span>cjs<span class="token punctuation">.</span>js<span class="token operator">!</span><span class="token punctuation">.</span><span class="token operator">/</span>base<span class="token punctuation">.</span>css\"<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>配置style-loader, css-loader</p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>             test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>             use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                     <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                    opttions<span class="token punctuation">:</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 插入到head标签顶部 这里略 </span>                        insert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">insertAtTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                 <span class="token punctuation">}</span><span class="token punctuation">,</span>                 <span class="token string">'css-loader'</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><h1 id="配置less-loader"><a href="#配置less-loader" class="headerlink" title="配置less-loader"></a>配置less-loader</h1><p>less-loader 能帮我们处理less文件，把less文件转换成css文件，所以它应该在css-loader之前执行，根据单模块从右向左的执行顺序，less-loader应该配置在最右边。注意，less-loader会调用 less来进行语法转换，所以我们需要安装 less和 less-loader两个包。</p><pre class=" language-js"><code class="language-js">yarn add less less<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>更改配置</p><pre class=" language-js"><code class="language-js">    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                    <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                     <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'less-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span></code></pre><h1 id="mini-css-extract-plugin-抽离css文件"><a href="#mini-css-extract-plugin-抽离css文件" class="headerlink" title="mini-css-extract-plugin 抽离css文件"></a>mini-css-extract-plugin 抽离css文件</h1><p>我们可以看到，现在所有的css都放在style标签中了<br><image src="https://tva1.sinaimg.cn/large/0081Kckwly1gkwvg3a2lkj314e0nck0k.jpg" width="500"><br>能不能把他提取成一个文件，通过link标签去引用呢，ok，mini-css-extract-plugin 就是做这样一个事儿，它的loader也取代了style-loader，因为我们不再需要style标签引入css了。</image></p><pre class=" language-js"><code class="language-js">yarn add mini<span class="token operator">-</span>css<span class="token operator">-</span>extract<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>改下配置文件</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 如果需要抽离成多个css 可以多次引用 不同的变量名即可</span><span class="token keyword">let</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// plgin中使用</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 抽离css</span>            filename<span class="token punctuation">:</span> <span class="token string">'main.css'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 抽离出的文件名</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'less-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>看下打包后的文件</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span>en</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    ...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span>main.css?acd7a28111ac8e884862</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span>stylesheet</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>study</span><span class="token punctuation">></span></span>         学习使我快乐    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>bundle.js?acd7a28111ac8e884862</span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h1 id="postcss-loader-autoprefixer-添加css前缀"><a href="#postcss-loader-autoprefixer-添加css前缀" class="headerlink" title="postcss-loader, autoprefixer 添加css前缀"></a>postcss-loader, autoprefixer 添加css前缀</h1><p>我们使用autoprefixer来给css文件添加加各类浏览器兼容的前缀，以 Can I Use 上的 浏览器支持数据 为基础，自动处理兼容性问题，它需要搭配postcss-loader(后处理器)使用。</p><pre class=" language-js"><code class="language-js">yarn add postcss<span class="token operator">-</span>loader autoprefixer  <span class="token operator">-</span>D</code></pre><p>修改webpack配置文件</p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>             test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>             use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>                <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 在解析css为模块和解析css内@import之前使用</span>                <span class="token string">'less-loader'</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><p>根目录添加postcss.config.js 或者直接写进postcss-loader配置中</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// postcss.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>最后一步: 在package.json中增加配置，也可以根目录创建.browserslistrc文件</p><pre class=" language-js"><code class="language-js">  <span class="token string">"browserslist"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token string">"last 2 versions"</span><span class="token punctuation">,</span>    <span class="token string">"> 1%"</span><span class="token punctuation">,</span>    <span class="token string">"iOS 7"</span><span class="token punctuation">,</span>    <span class="token string">"last 3 iOS versions"</span>  <span class="token punctuation">]</span></code></pre><h1 id="uglifyjs-webpack-plugin-optimize-css-assetts-webpack-plugin-js，css压缩"><a href="#uglifyjs-webpack-plugin-optimize-css-assetts-webpack-plugin-js，css压缩" class="headerlink" title="uglifyjs-webpack-plugin, optimize-css-assetts-webpack-plugin (js，css压缩)"></a>uglifyjs-webpack-plugin, optimize-css-assetts-webpack-plugin (js，css压缩)</h1><p>我们知道，当 mode为 production时，js会自动压缩，那 css不能压缩怎么办呢。</p><p><strong>抽离css后，需要借助 optimize-css-assetts-webpack-plugin 帮我们压缩css，需要配置optimization.minimizer，然而配置之后，js又不能自动压缩了， 所以我们一般配合 uglify完成 css和 js的压缩任务。</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> OptimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> UglifyjsWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglifyjs-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 压缩js 配置css压缩后 js自动压缩失效 需要用此插件进行压缩</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>    optimization<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 优化项 只在生产环境生效</span>        <span class="token keyword">new</span> <span class="token class-name">UglifyjsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 压缩js</span>            cache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 是否使用缓存</span>            parallel<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 是否是并发压缩js的</span>            sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">// 压缩完后 源码映射 为了更好调试</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">OptimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 压缩 css</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="babel-loader，-babell-core，-babel-preset-env-es6-转成-es5"><a href="#babel-loader，-babell-core，-babel-preset-env-es6-转成-es5" class="headerlink" title="babel-loader，@babell/core，@babel/preset-env (es6 转成 es5)"></a>babel-loader，@babell/core，@babel/preset-env (es6 转成 es5)</h1><p>如果我们在a.js中加了一个箭头函数，然后在入口文件引入a.js，却发现打包后的 bundle.js里面还是箭头函数(webpack预设的js模块解析并没有对js进行语法转换，我们需要添加自己的loader去干这件事)，这在一些不支持es6语法的浏览器中会报错的，为了解决这个问题，我们需要把高版本的 js按照es5标准进行转换。</p><pre class=" language-js"><code class="language-js">yarn add babel<span class="token operator">-</span>loader @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span>D</code></pre><p><strong>babel-loader： 用于对 js源文件进行处理。</strong><br><strong>@babel/core： 调用transform方法去转换 js源代码。</strong><br><strong>@babel/preset-env：转化规则，把标准的语法转换为低级的语法。</strong></p><p>webpack 增加 babel-loader 配置</p><pre class=" language-js"><code class="language-js">    module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>            <span class="token punctuation">{</span>                 test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>                 use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                    loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                    options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库</span>                            <span class="token string">'@babel/preset-env'</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-syntax-class-properties-解析class类提案语法"><a href="#babel-plugin-syntax-class-properties-解析class类提案语法" class="headerlink" title="@babel/plugin-syntax-class-properties 解析class类提案语法"></a>@babel/plugin-syntax-class-properties 解析class类提案语法</h1><p>如果我们在 a.js中添加了以下这段豪横无比的代码，webpack会无情报错的。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这时候，@babel/plugin-syntax-class-properties懂你</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>syntax<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>properties <span class="token operator">-</span>D</code></pre><p>更改webpack配置 </p><pre class=" language-js"><code class="language-js">  module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>          test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>          use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>            loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>            options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库 是大的插件的集合</span>                    <span class="token string">'@babel/preset-env'</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                plugins<span class="token punctuation">:</span>  <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置一个个的插件</span>                    <span class="token string">'@babel/plugin-proposal-class-properties'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-proposal-decorators-解析类装饰器"><a href="#babel-plugin-proposal-decorators-解析类装饰器" class="headerlink" title="@babel/plugin-proposal-decorators 解析类装饰器"></a>@babel/plugin-proposal-decorators 解析类装饰器</h1><pre class=" language-js"><code class="language-js">@log<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> ys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们给class类加一个修饰器，build的时候还是会报错的，因为修饰器提案想要进行语法转换也需要一个包，@babel/plugin-proposal-decorators</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>proposal<span class="token operator">-</span>decorators <span class="token operator">-</span>D</code></pre><p>修改 babel-loader配置 此处参考babel官网提供的用法 <a href="https://babeljs.io/docs/en/babel-plugin-proposal-decorators" target="_blank" rel="noopener">babel-plugin-proposal-decorators</a></p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 用 babel-loader 把 es6转成 es5</span>                    presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 预设插件库 是大的插件的集合</span>                    <span class="token string">'@babel/preset-env'</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    plugins<span class="token punctuation">:</span>  <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置一个个的插件</span>                        <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-decorators"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"legacy"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-class-properties"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">"loose"</span> <span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="babel-plugin-transform-runtime-babel-runtime-注入运行时辅助代码"><a href="#babel-plugin-transform-runtime-babel-runtime-注入运行时辅助代码" class="headerlink" title="@babel/plugin-transform-runtime @babel/runtime 注入运行时辅助代码"></a>@babel/plugin-transform-runtime @babel/runtime 注入运行时辅助代码</h1><p>此时我们再给入口index.js增加 </p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">class</span> <span class="token class-name">Person2</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>打包后我们看到，<strong>bundle.js里面声明了两次 _classCallCheck 方法，是否可以公用呢?</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> Constructor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>\"Cannot call a <span class="token keyword">class</span> <span class="token class-name">as</span> a <span class="token keyword">function</span>\"<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们在index.js文件中继续添加 </p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后npm run dev启动服务，打开页面，报错如下</p><pre class=" language-js"><code class="language-js">Uncaught ReferenceError<span class="token punctuation">:</span> regeneratorRuntime is not defined</code></pre><p>wtf? 这个方法是哪里来的？ 其实 Generator 或者更高级的 Promise 语法进行转化的时候，使用了 regeneratorRuntime 辅助方法却并没有加上这个辅助方法，需要增强编译，我们可以是使用 @babel/plugin-transform-runtime，这是一个代码运行时的包，会在代码运行时根据需要注入一些辅助性的代码。</p><p>@babel/plugin-transform-runtime是我们开发时候需要用的包，但是上线打包的话，我们也需要带上这些补丁代码，babel为我们提供了 @babel/runtime 去处理线上代码的打包。</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>runtime <span class="token operator">-</span>Dyarn add @babel<span class="token operator">/</span>runtime   <span class="token comment" spellcheck="true">// 生产环境需要用的 就不加-D</span></code></pre><p>webpack增加配置，注意，这步操作要排除 node_modules 中的js，仅包含 src目录下的 js代码</p><pre class=" language-js"><code class="language-js"></code></pre><p>这时候可以看到，打包出的源码中自动引入了@babel/runtime下的包啦</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/@babel/runtime/helpers/classCallCheck.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/@babel/runtime/helpers/classCallCheck.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span></code></pre><h1 id="babel-polyfill-高级api不能使？垫一下！"><a href="#babel-polyfill-高级api不能使？垫一下！" class="headerlink" title="@babel/polyfill  高级api不能使？垫一下！"></a>@babel/polyfill  高级api不能使？垫一下！</h1><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token string">'sss'</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>如果我们使用再高级的语法，比如 es7 新增的字符串的 includes 方法，依旧不会被解析出 es5 标准的语法，打包后仍是includes，我们需要引入 @babel/polyfill 来解决此类问题。</strong></p><p>注意，这个包在生产环境打包也是需要的</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>polyfill</code></pre><p>在需要的地方引入</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> <span class="token string">'@babel/polyfill'</span><span class="token punctuation">;</span><span class="token string">'sss'</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>打包后发现引入了数组的includes方法模块</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/***/</span> <span class="token string">"./node_modules/core-js/fn/array/includes.js"</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span></code></pre><h1 id="expose-loader，webpack-ProvidePlugin-引全局包"><a href="#expose-loader，webpack-ProvidePlugin-引全局包" class="headerlink" title="expose-loader，webpack.ProvidePlugin 引全局包"></a>expose-loader，webpack.ProvidePlugin 引全局包</h1><p>很多第三方模块依赖jquery，而且依赖的是window.jquery，也就是全局的 jquery。</p><pre class=" language-js"><code class="language-js">yarn add jquery</code></pre><p>比如我们在a.js中增加如下代码</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>$<span class="token punctuation">,</span> $<span class="token punctuation">,</span> <span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn undefined jquery</span></code></pre><p>我们看到打包后的文件里是有jquery的, jquery被包成一个闭包去执行，暴露出去，但是 window 上没有。如果有插件依赖了 window.jquery怎么办呢，别急，expose-loader可以暴露全局变量，注意，<strong>它是一个内联loader</strong>，</p><pre class=" language-js"><code class="language-js">yarn add expose<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>语法如下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// expose-loader?exposes[]=暴露到全局的别名!引用包名</span><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'expose-loader?exposes[]=$!jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>$<span class="token punctuation">,</span> $<span class="token punctuation">,</span> <span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn fn jquery</span></code></pre><p>当然也可以不用内联loader，配到webpack文件里去，参考官方写法。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             loader<span class="token punctuation">:</span> <span class="token string">'expose-loader'</span><span class="token punctuation">,</span>            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                exposes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'$'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span></code></pre><p>但是我们发现，这样不是很友好，能不能直接用，而不需要每个模块都去去 import 呢？</p><p>可以使用webpack.ProvidePlugin去声明全局变量</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token comment" spellcheck="true">// 把包引为全局变量，需要注意的是，这种全局变量并不会挂到 window 上</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>             $<span class="token punctuation">:</span> <span class="token string">'jquery'</span> <span class="token comment" spellcheck="true">// 引入 node_modules/jquery 声明为 $, 每个模块中都注入，而不是挂在window</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>consolle<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fn</span></code></pre><h1 id="externals-忽略不需要被打包的模块-外部引入，模块内二次引入"><a href="#externals-忽略不需要被打包的模块-外部引入，模块内二次引入" class="headerlink" title="externals 忽略不需要被打包的模块(外部引入，模块内二次引入)"></a>externals 忽略不需要被打包的模块(外部引入，模块内二次引入)</h1><p>如果我在index.html通过 cdn 引入了 jquery，此时 window.jquery 即为 jquery，但是呢，我很任性，不希望用的时候写那么长的变量名，于是我做了以下操作</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span></code></pre><p>这时一看打包文件，引入了双份的 jquery，我 emm..</p><p>我又比较有洁癖，只想引入一个包，怎么办呢？ webpack提供了 externals属性，它可以让我们打包时忽略已经外部引用的包。</p><pre class=" language-js"><code class="language-js">externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>    jquery<span class="token punctuation">:</span> <span class="token string">'$'</span><span class="token punctuation">}</span></code></pre><h1 id="file-loader和更强大的url-loader进行图片处理"><a href="#file-loader和更强大的url-loader进行图片处理" class="headerlink" title="file-loader和更强大的url-loader进行图片处理"></a>file-loader和更强大的url-loader进行图片处理</h1><p>图片有几种引入方式</p><ul><li>在 js 中创建图片引入</li><li>css background引入<br>file-loader用来解析图片，file-loader 默认会在内部生成一张带hash的图片，到 build 目录下，并且把生成的图片路径返回回来。<pre class=" language-js"><code class="language-js">yarn add file<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre></li></ul><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>js中引入图片</strong></font></p><p>新建img.js，并在 index.js 中引入它。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> logo <span class="token keyword">from</span> <span class="token string">'../logo.png'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注意 返回的是一个图片地址</span><span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>image<span class="token punctuation">.</span>src <span class="token operator">=</span> logo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 思考，如果我们这里直接访问一个图片呢，比如 '../logo.png' 它会被打包么？</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>增加loader规则</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token string">'file-loader'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p>ok， 大功告成</p><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>css中引入图片</strong></font></p><pre class=" language-css"><code class="language-css"><span class="token selector">// index<span class="token class">.less</span>body </span><span class="token punctuation">{</span>  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url">url(./logo.png)</span> no-repeat<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>因为 css-loader 默认会把引入的图片 css中引入的图片，转换成一个外部模块，比如以上代码，实际上被 css-loader转换成以下代码，所以他也会打包。</p><pre class=" language-css"><code class="language-css"><span class="token selector">body </span><span class="token punctuation">{</span>  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token url">url(require('./logo.png')</span><span class="token punctuation">)</span> no-repeat<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>假设我们有一个场景，如果图片小于 5k，就把它转成 base64(不会发请求，但是大小会比源文件大三分之一)，否则用 file-loader产生真实的图片，防止过多的静态资源请求，这时候我们可以使用 url-loader。</p><pre class=" language-js"><code class="language-js">yarn add url<span class="token operator">-</span>loader <span class="token operator">-</span>D</code></pre><p>替换file-loader</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 5k以下转成base64 以上转成真正的图片</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ok，重新打包后，可以看到小图片被转成base64了</p><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>data:image/png;base64,/9j/4AAQSkZJRgABAQAASABIAAD<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><h1 id="文件按类型打包到各自目录"><a href="#文件按类型打包到各自目录" class="headerlink" title="文件按类型打包到各自目录"></a>文件按类型打包到各自目录</h1><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">图片分类</font><br>图片分类很简单，只需要把 url-loader 配置中加个 outputPath即可，url-loader会自动帮我们处理好图片的引入路径哦。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 模块</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 配置规则</span>        <span class="token punctuation">{</span>            test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/</span><span class="token punctuation">,</span>            use<span class="token punctuation">:</span> <span class="token punctuation">{</span>                loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 5k以下转成base64 以上转成真正的图片</span>                    outputPath<span class="token punctuation">:</span> <span class="token string">'img/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">css分类</font><br>css分类只需要更改 MiniCssExtractPlugin 输出的 filename即可。</p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 是一个数组 放着所有的webpack插件的实例</span>    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 抽离css</span>      filename<span class="token punctuation">:</span> <span class="token string">'css/main.css'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 抽离出的文件名</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>这时候 build 目录会出现 css/index.css 文件引入的背景图片路径为 img/xxx.png，解决办法是给 MiniCssExtractPlugin.loader增加 publicPath</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>     test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>     use<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 把css抽离出 并link标签引入 </span>            loader<span class="token punctuation">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>            options<span class="token punctuation">:</span><span class="token punctuation">{</span>                publicPath<span class="token punctuation">:</span> <span class="token string">'../'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token string">'css-loader'</span><span class="token punctuation">,</span>        <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>        <span class="token string">'less-loader'</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ok，齐活儿。</p><h1 id="打包多页应用"><a href="#打包多页应用" class="headerlink" title="打包多页应用"></a>打包多页应用</h1><p>多页应用比单页应用复杂的一点是，多个入口，多个出口。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 抽离html</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 多入口</span>        home<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>        other<span class="token punctuation">:</span> <span class="token string">'./src/other.js'</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>     output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>        path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> <span class="token string">'home.html'</span><span class="token punctuation">,</span>            chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'home'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 该页使用到的代码块儿</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> <span class="token string">'other.html'</span><span class="token punctuation">,</span>            chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'other'</span><span class="token punctuation">]</span>         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="sourcemap"><a href="#sourcemap" class="headerlink" title="sourcemap"></a>sourcemap</h1><p>我们在解析 js 中，会把一些高级语法转换成低级语法，甚至生产环境伴随着代码，比如下面一行代码报错，我们很难追溯到报错的地方。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">class</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">'报错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们把 mode 改成 production，执行 npm run dev去启动服务。<br>页面报错了，错误出现在 bundle.js 第一行。</p><pre class=" language-js"><code class="language-js">Uncaught TypeError<span class="token punctuation">:</span> console<span class="token punctuation">.</span>lo is not a <span class="token keyword">function</span>    at <span class="token keyword">new</span> <span class="token class-name">t</span> <span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>js<span class="token operator">?</span>03a176d0736bff01997d<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p>点进去一看，都是压缩过的代码(这里截取一部分)，实际情况更复杂，更难调试。</p><pre class=" language-js"><code class="language-js"><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"sssss"</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">"报错了"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">159</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>是不是应该有一个映射文件，我点进去看到的应该是源码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1) 源码映射 会单独生成一个 sourcemap文件 出错了会标识当前报错的列和行</span>    devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 增加映射文件 可以帮我们调试源代码</span>    <span class="token comment" spellcheck="true">// 2) 'eval-source-map' 不会单独打包出 sourcemap 文件(集成到打包后的文件中)，也可以显示行和列，并且显示源码</span>    <span class="token comment" spellcheck="true">// devtool: 'eval-source-map',</span>    <span class="token comment" spellcheck="true">// 3) 'cheap-module-source-map' 不会产生列，单独生成一个 sourcemap 文件</span>    <span class="token comment" spellcheck="true">// devtool: 'eval-source-map',</span>    <span class="token comment" spellcheck="true">// 4) 'cheap-module-eval-source-map' 不会产生列，不会产生文件，集成到打包后的文件中</span>    <span class="token comment" spellcheck="true">// devtool: 'cheap-module-eval-source-map',</span></code></pre><p>这时候打包，页面能看到报错列和行</p><pre class=" language-js"><code class="language-js">index<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">28</span> Uncaught TypeError<span class="token punctuation">:</span> console<span class="token punctuation">.</span>lo is not a <span class="token keyword">function</span>    at <span class="token keyword">new</span> <span class="token class-name">t</span> <span class="token punctuation">(</span>index<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">)</span></code></pre><p>点进去，可以看到源码</p><pre class=" language-js"><code class="language-js"><span class="token operator">...</span><span class="token comment" spellcheck="true">// 测试 source map</span><span class="token keyword">class</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">lo</span><span class="token punctuation">(</span><span class="token string">'报错了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">...</span></code></pre><h1 id="watch-监听文件改动-可以看到实体文件"><a href="#watch-监听文件改动-可以看到实体文件" class="headerlink" title="watch 监听文件改动 可以看到实体文件"></a>watch 监听文件改动 可以看到实体文件</h1><p>就算用 webpack-dev-server 启动， 监测到代码变化后，浏览器可以看到及时更新的效果，但是并没有自动打包修改目录中的代码，是在内存中打包，我们可以用 watch 方法来实现监测到代码变化后自动打包修改的代码。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span></code></pre><p>这时候执行 npm run build 就不会退出 build 进程，会等待文件改变，并实时打包。<br>也可以加一些额外配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    watch<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    watchOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 监控选项</span>        poll<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 每秒检查 1000 次</span>        aggregateTimeout<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 防抖 500ms触发一次</span>        ignored<span class="token punctuation">:</span> <span class="token operator">/</span>node_modules<span class="token operator">/</span> <span class="token comment" spellcheck="true">// 忽略文件</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><h1 id="copy-webpack-plugin-拷贝文件到打包目录"><a href="#copy-webpack-plugin-拷贝文件到打包目录" class="headerlink" title="copy-webpack-plugin 拷贝文件到打包目录"></a>copy-webpack-plugin 拷贝文件到打包目录</h1><pre class=" language-js"><code class="language-js">yarn add copy<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span>D</code></pre><p>文件根目录创建 doc文件夹，新增 doc/a.txt</p><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>             <span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 可以执行多个拷贝</span>            patterns<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">"doc"</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token string">"doc"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="bannerPlugin-代码版权声明插件"><a href="#bannerPlugin-代码版权声明插件" class="headerlink" title="bannerPlugin 代码版权声明插件"></a>bannerPlugin 代码版权声明插件</h1><p>webpack内置插件，用于代码前署名。</p><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>BannerPlugin</span><span class="token punctuation">(</span><span class="token string">'make 2020 by ys'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 代码版权声明</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>打包可以看见版权的声明</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/*! make 2020 by ys */</span>body<span class="token punctuation">,</span><span class="token operator">**</span><span class="token comment" spellcheck="true">/*! make 2020 by ys */</span><span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">**</span></code></pre><h1 id="devServer-配置跨域-amp-mock数据"><a href="#devServer-配置跨域-amp-mock数据" class="headerlink" title="devServer 配置跨域 &amp; mock数据"></a>devServer 配置跨域 &amp; mock数据</h1><p>设置代理</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        proxy<span class="token punctuation">:</span> <span class="token punctuation">{</span>             <span class="token string">'/api'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                target<span class="token punctuation">:</span> <span class="token string">'http://xxx.com'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//  配置api代理 转发到一个地址</span>                pathRewrite<span class="token punctuation">:</span>  <span class="token punctuation">{</span> <span class="token string">'/api'</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 匹配到之后 转发时去掉 /api </span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>因为 webpack-dev-server 也是启动了一个 express 服务，所以我们如果可以拿到 app 实例，是不是就可以 mock 接口了?  方便的是，devServer 提供了这样的钩子。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token function">before</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>            app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'ys'</span><span class="token punctuation">,</span>                    action<span class="token punctuation">:</span> <span class="token string">'moce data'</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样配合上面，我们就可以在前端通过 /api/user 访问到这个接口啦。</p><h1 id="resolve-配置解析三方包规则-amp-别名"><a href="#resolve-配置解析三方包规则-amp-别名" class="headerlink" title="resolve 配置解析三方包规则 &amp; 别名"></a>resolve 配置解析三方包规则 &amp; 别名</h1><p>我们可以通过配置 resolve 设置解析第三方包的范围，入口文件，别名等。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>         <span class="token comment" spellcheck="true">// 包的查找范围只在本级目录下 node_modus</span>        modules<span class="token punctuation">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 引入包时 后缀查找规则 先后排序</span>        extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.css'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">'.vue'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 引入包时 默认读包 package.json 中字段找入口时候的优先级(默认先找main属性)</span>        mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 入口文件的名字 默认是 index.js</span>        mainFiles<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'base.js'</span><span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// 配置解析别名 解决引入包名过长问题</span>        alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">'@/assets'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'src/assets'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">'@/libs'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'src/libs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="利用DefinePlugin-定义环境变量-其实是全局变量哦"><a href="#利用DefinePlugin-定义环境变量-其实是全局变量哦" class="headerlink" title="利用DefinePlugin 定义环境变量(其实是全局变量哦)"></a>利用DefinePlugin 定义环境变量(其实是全局变量哦)</h1><p>我们可以通过 webpack 内置插件 DefinePlugin 来为页面注入全局变量。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 多出口</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            ENV<span class="token punctuation">:</span> <span class="token string">'"dev"'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 页面就能拿到啦 这个可以动态给值 注意引号</span>            flag<span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Boolean true</span>            SUM<span class="token punctuation">:</span> <span class="token string">'1+1'</span> <span class="token comment" spellcheck="true">// 2</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h1 id="webpack-merge-区分环境做配置合并"><a href="#webpack-merge-区分环境做配置合并" class="headerlink" title="webpack-merge 区分环境做配置合并"></a>webpack-merge 区分环境做配置合并</h1><pre class=" language-js"><code class="language-js">yarn add webpack<span class="token operator">-</span>merge <span class="token operator">-</span>D</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.dev.js</span><span class="token keyword">let</span>  <span class="token punctuation">{</span> smart <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>    mode<span class="token punctuation">:</span> <span class="token string">'developmeent'</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// do something on dev</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// loaders/babel-loader.js</span><span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  <span class="token comment" spellcheck="true">// 调用 @babel/core 内 transform 方法进行转换 </span>  babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>    presets<span class="token punctuation">:</span> options<span class="token punctuation">.</span>presets<span class="token punctuation">,</span>    sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到参数(错误，编译后源码，souremap) 自动帮我们返回结果</span>    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 模块化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模块化发展史</title>
      <link href="/2020/10/13/mo-kuai-hua/"/>
      <url>/2020/10/13/mo-kuai-hua/</url>
      
        <content type="html"><![CDATA[<h1 id="为何前端需要模块化"><a href="#为何前端需要模块化" class="headerlink" title="为何前端需要模块化"></a>为何前端需要模块化</h1><p>为了彻底弄清楚模块化这个东西，我们要从最开始模块化的起源说起。</p><h2 id="无模块化的原始时代"><a href="#无模块化的原始时代" class="headerlink" title="无模块化的原始时代"></a>无模块化的原始时代</h2><p>最开始js只是作为一个脚本语言来使用，做一些简单的表单校验，动画实现等。<br>代码都是这样，直接把代码写在script标签里，而且代码量很少</p><pre class=" language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'Btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onClick <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><h2 id="代码量剧增带来的灾难性问题"><a href="#代码量剧增带来的灾难性问题" class="headerlink" title="代码量剧增带来的灾难性问题"></a>代码量剧增带来的灾难性问题</h2><p>后来随着ajax异步请求的出现，前端能做的事情越来越多，代码量飞速增长。<br>也暴露出一些问题。</p><ol><li><strong>全局变量的灾难</strong><br>这个非常好理解，就是大家的代码都在一个作用域，不同的人定义的变量可能会重复从而产生覆盖。</li></ol><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 试想彭彭定义了一个变量 </span>name <span class="token operator">=</span> <span class="token string">'pengpeng'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 后来，丁满后面又定义了</span>name <span class="token operator">=</span>  <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 再后来， 彭彭开始使用他定义的变量</span><span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'pengpeng'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><p>这就杯具了。</p><ol start="2"><li><strong>依赖关系管理的灾难</strong><pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"a.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"b.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span> src<span class="token operator">=</span><span class="token string">"c.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>如果c依赖了b，b依赖了a，则script引入的顺序必须被依赖的放在前面，试想要是有几十个文件，我们都要弄清楚文件依赖关系然后手动，按顺序引入，无疑这是非常痛苦的事情。</li></ol><h2 id="早期的解决方式"><a href="#早期的解决方式" class="headerlink" title="早期的解决方式"></a>早期的解决方式</h2><ol><li><p><strong>闭包</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> moduleA <span class="token operator">=</span> <span class="token keyword">function</span>（） <span class="token punctuation">{</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token punctuation">{</span>   add<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这样function内部的变量就对全局隐藏了，达到了封装的目的，但是最外层模块名还是暴露在全局，要是模快越来越多，依然会存在模块名冲突的问题.</p></li><li><p><strong>命名空间</strong><br>Yahoo的YUI早起的做法</p><pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>moduleA<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> app<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>moduleA<span class="token punctuation">.</span>a <span class="token operator">+</span> c<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>毫无疑问以上两种方法都不够优雅。<br>那么，模块化到底需要解决什么问题提呢？我们先设想一下可能有以下几点:</p><blockquote><ul><li>安全的包装一个模块的代码，避免全局污染</li><li>唯一标识一个模块</li><li>优雅的将模块api暴露出去</li><li>方便的使用模块</li></ul></blockquote></li></ol><h1 id="服务端模块化"><a href="#服务端模块化" class="headerlink" title="服务端模块化"></a>服务端模块化</h1><p>Nodejs出现开创了一个新的纪元，使得我们可以使用javascript写服务器代码，对于服务端而言必然是需要模块化的。</p><h2 id="Nodejs-与-CommonJs的关系"><a href="#Nodejs-与-CommonJs的关系" class="headerlink" title="Nodejs 与 CommonJs的关系"></a>Nodejs 与 CommonJs的关系</h2><ul><li>node的模块化能以一种成熟的姿态出现离不开CommonJs规范</li><li>在服务器端CommonJS能以一种寻常的姿态写进各个公司的项目代码中，离不开Node的优异表现</li><li>Node并非完全按照规范实现，针对模块规范进行了一定的取舍，同时也增加了少许自身特性<blockquote><p>以上三点是摘自朴灵的《深入浅出Nodejs》</p></blockquote></li></ul><h2 id="CommonJS规范简介"><a href="#CommonJS规范简介" class="headerlink" title="CommonJS规范简介"></a>CommonJS规范简介</h2><p>CommonJS对模块的定义非常简单，主要分为<strong>模块引用</strong>，<strong>模块定义</strong>和<strong>模块标识</strong>3部分</p><h3 id="模块引用"><a href="#模块引用" class="headerlink" title="模块引用"></a><strong>模块引用</strong></h3><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./add.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'config.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="模块定义"><a href="#模块定义" class="headerlink" title="模块定义"></a><strong>模块定义</strong></h3><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> xx<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以在另一个文件中引入模块并导出另一个模块</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./add.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>其实，<strong>一个文件代表一个模块，一个模块除了自己的函数作用域之外，最外层还有一个模块作用域，module就是代表这个模块，exports是module的属性。require也在这个模块的上下文中，用来引入外部模块。</strong></p><h3 id="模块标识"><a href="#模块标识" class="headerlink" title="模块标识"></a><strong>模块标识</strong></h3><p>模块标识就是require( )函数的参数，规范是这样的：</p><blockquote><ul><li>必须是字符串</li><li>可以是以./ ../开头的相对路径</li><li>可以是绝对路径</li><li>可以省略后缀名</li></ul></blockquote><p>CommonJS的模块规范定义比较简单，意义在于将类聚的方法和变量等限定在私有的作用域中，同时支持引入和导出将上下游模块无缝衔接，每个模块具有独立的空间，它们互不干扰。</p><h2 id="Nodejs的模块化实现"><a href="#Nodejs的模块化实现" class="headerlink" title="Nodejs的模块化实现"></a>Nodejs的模块化实现</h2><p><strong>Node模块在实现中并非完全按照CommonJS来，进行了取舍，增加了一些自身的的特性。</strong><br>Node中一个文件是一个模块——module<br>一个模块就是一个Module的实例<br>Node中Module构造函数:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> Module（id<span class="token punctuation">,</span> parent）<span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>    parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 实例化一个模块</span> <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>其中id 是模块id，exports是这个模块要暴露出来的api，parent是父级模块，loaded表示这个模块是否加载完成，因为CommonJS是运行时加载，loaded表示文件是否已经执行完毕返回一个对象。</p><h1 id="前端模块化"><a href="#前端模块化" class="headerlink" title="前端模块化"></a>前端模块化</h1><p>前面我们所说的CommonJS规范，都是基于node来说的，所以前面说的CommonJS都是针对服务端的实现。</p><h2 id="前端模块化和服务端模块化有什么区别？"><a href="#前端模块化和服务端模块化有什么区别？" class="headerlink" title="前端模块化和服务端模块化有什么区别？"></a>前端模块化和服务端模块化有什么区别？</h2><ul><li>服务端加载一个模块，直接就从硬盘或者内存中读取了，消耗时间可以忽略不计</li><li>浏览器需要从服务端下载这个文件，所以说如果用CommonJS的require方式加载模块，需要等代码模块下载完毕，并运行之后才能得到所需要的API。</li></ul><h2 id="为什么CommonJS不适用于前端模块？"><a href="#为什么CommonJS不适用于前端模块？" class="headerlink" title="为什么CommonJS不适用于前端模块？"></a>为什么CommonJS不适用于前端模块？</h2><p><strong>如果我们在某个代码模块里使用CommonJS的方法require了一个模块，而这个模块需要通过http请求从服务器去取，如果网速很慢，而CommonJS又是同步的，所以将阻塞后面代码的执行，从而阻塞浏览器渲染页面，使得页面出现假死状态。</strong></p><p>因此后面AMD规范随着RequireJS的推广被提出，异步模块加载，不阻塞后面代码执行的模块引入方式，就是解决了前端模块异步模块加载的问题。</p><h2 id="AMD-amp-amp-requieJs"><a href="#AMD-amp-amp-requieJs" class="headerlink" title="AMD &amp;&amp; requieJs"></a>AMD &amp;&amp; requieJs</h2><p>AMD——异步模块加载规范 与CommonJS的主要区别就是异步模块加载，就是模块加载过程中即使require的模块还没有获取到，也不会影响后面代码的执行。</p><p>RequireJS——AMD规范的实现。其实也可以说AMD是RequireJS在推广过程中对模块定义的规范化产出。</p><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 独立模块定义 ---- 不依赖其它模块的模块定义</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  method1<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  method2<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 或者</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    method1<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    method2<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 非独立模块——依赖其他模块的模块定义</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'math'</span><span class="token punctuation">,</span> <span class="token string">'graph'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>math<span class="token punctuation">,</span> graph<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 模块引用：</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>  a<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  b<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h3 id="对比CommonJs和AMD"><a href="#对比CommonJs和AMD" class="headerlink" title="对比CommonJs和AMD"></a>对比CommonJs和AMD</h3><ul><li>CommonJS一般用于服务端，AMD一般用于浏览器客户端</li><li>CommonJS和AMD都是<strong>运行时加载</strong><blockquote><p>如果一种模块加载方式满足两种条件，那就是运行时加载</p><ol><li>运行时能确定模块之间的依赖关系(依赖前置)</li><li>require一个模块的时候，模块会先被执行，并返回一个对象，并且这个对象是整体加载的</li></ol></blockquote></li></ul><h2 id="CMD-amp-amp-SeaJS"><a href="#CMD-amp-amp-SeaJS" class="headerlink" title="CMD &amp;&amp; SeaJS"></a>CMD &amp;&amp; SeaJS</h2><p>CMD——通用模块规范，由国内的玉伯提出。<br>SeaJS——CMD的实现，其实也可以说CMD是SeaJS在推广过程中对模块定义的规范化产出。<br>与AMD规范的主要区别在于定义模块和依赖引入的部分。<strong>AMD需要在声明模块的时候指定所有的依赖</strong>，通过形参传递依赖到模块内容中：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dep1'</span><span class="token punctuation">,</span> <span class="token string">'dep2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>dep1<span class="token punctuation">,</span> dep2<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>与AMD模块规范相比，CMD模块更接近于Node对CommonJS规范的定义，CMD规范中，一个文件就是一个模块，使用define来进行模块：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span></code></pre><p>这里的define是一个全局函数，用来定义模块，这里的factory参数既可以是函数，又可以是字符串或对象。<strong>如果参数是字符串或对象时，表示该模块的接口就是是该对象或字符串</strong></p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'website'</span><span class="token punctuation">:</span><span class="token string">'oecom'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'这里是OECOM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>当factory为函数时，此函数就是模块的构造方法，该函数默认为提供三个参数：require,exports,module，在需要依赖模块时，随时调用require( )引入即可</strong>，示例如下：</p><pre class=" language-js"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//依赖模块a 推崇就近原则</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//调用模块a的方法</span>  a<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>也就是说与AMD相比，<strong>CMD推崇依赖就近(延迟执行，用到再引入)， AMD推崇依赖前置(提前执行)</strong></p><h2 id="UMD-Universal-Module-Definition-通用模块规范"><a href="#UMD-Universal-Module-Definition-通用模块规范" class="headerlink" title="UMD(Universal Module Definition), 通用模块规范"></a>UMD(Universal Module Definition), 通用模块规范</h2><p>如下是codemirror模块lib/codemirror.js模块的定义方式：</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">,</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span>        <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// Node , CommonJS</span>       <span class="token punctuation">:</span> <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd           <span class="token operator">?</span> <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span>                   <span class="token comment" spellcheck="true">//AMD CMD</span>         <span class="token punctuation">:</span> <span class="token punctuation">(</span>global<span class="token punctuation">.</span>CodeMirror <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//模块挂载到全局</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>可以看说所谓的兼容模式是将几种常见模块定义方式都兼容处理。<br>目前为止，前端常用的几种模块化规范都已经提到，还有一种我们项目里用得非常多的模块化引入和导出，就是ES6的模块化。</p><h2 id="ES6模块化"><a href="#ES6模块化" class="headerlink" title="ES6模块化"></a>ES6模块化</h2><p>如前面所述，<strong>CommonJS和AMD都是运行时加载。ES6在语言规格层面上实现了模块功能，是编译时加载</strong>，完全可以取代现有的CommonJS和AMD规范，可以成为<strong>浏览器和服务器通用的模块解决方案</strong>。这里关于ES6模块我们项目里使用非常多，所以详细讲解。</p><p><strong>Es6模块导出—export</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 导出变量</span><span class="token keyword">export</span> <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'pengpeng'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 导出函数</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 常用导出方式(推荐)</span><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token string">'18'</span><span class="token punctuation">;</span><span class="token keyword">const</span> addr <span class="token operator">=</span> <span class="token string">'卡尔斯特森林'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> year <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// as 用法</span><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span>  s <span class="token keyword">as</span> t<span class="token punctuation">,</span>  s <span class="token keyword">as</span> m<span class="token punctuation">,</span> <span class="token punctuation">}</span></code></pre><p><strong>Es6模块导出—import</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 一般用法</span><span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// as 用法</span><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> personName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>整体模块加载</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> name <span class="token operator">=</span> <span class="token string">'xixi'</span><span class="token punctuation">;</span><span class="token keyword">export</span> age <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//逐一加载</span><span class="token keyword">import</span> <span class="token punctuation">{</span> age<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//整体加载</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> person <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>ES6模块使用——export default</strong><br>其实export default，在项目里用的非常多，一般一个Vue组件或者React组件我们都是使用export default命令，需要注意的是使用export default命令时，import是不需要加{}的。而不使用export default时，import是必须加{}，示例如下：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> getName <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>export default其实是导出一个叫做default的变量，所以其后面不能跟变量声明语句。</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//错误</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><p><strong>值得注意的是我们可以同时使用export 和export default</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> name <span class="token operator">=</span> <span class="token string">'dingman'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> getName<span class="token punctuation">,</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span></code></pre><p><strong>import命令具有提升效果，会提升到整个模块的头部，首先执行，如下也不会报错</strong></p><pre class=" language-js"><code class="language-js"><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'person_module'</span><span class="token punctuation">;</span></code></pre><p>前面一直提到，<strong>CommonJS是运行时加载，ES6时编译时加载</strong>，那么两个有什么本质的区别呢？</p><h2 id="ES6模块与CommonJS模块加载区别"><a href="#ES6模块与CommonJS模块加载区别" class="headerlink" title="ES6模块与CommonJS模块加载区别"></a>ES6模块与CommonJS模块加载区别</h2><p><strong>ES6模块的设计思想，是尽量的静态化，使得编译时就能确定模块的依赖关系，以及输入和输出的变量。所以说ES6是编译时加载</strong>，不同于CommonJS的运行时加载(实际加载的是一整个对象)，ES6模块不是对象，而是通过export命令显式指定输出的代码，输入时也采用静态命令的形式：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ES6模块</span><span class="token keyword">import</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// CommonJS模块</span><span class="token keyword">let</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以上这种写法es6加载与CommonJS的模块加载有什么不同？</p><ul><li>当require path模块时，其实 <strong>CommonJS会将path模块运行一遍，并返回一个对象，并将这个对象缓存起来，这个对象包含path这个模块的所有API。以后无论多少次加载这个模块都是取这个缓存的值，也就是第一次运行的结果，除非手动清除。</strong></li><li>ES6会从path模块只加载3个方法，其他不会加载，这就是编译时加载。ES6可以在编译时就完成模块加载，当ES6遇到import时，不会像CommonJS一样去执行模块，而是生成一个动态的只读引用，当真正需要的时候再到模块里去取值，所以<strong>ES6模块是动态引用，并且不会缓存值。</strong></li></ul><p>因为CommonJS模块输出的是值的拷贝，所以当模块内值变化时，不会影响到输出的值。基于Node做以下尝试：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js Node环境</span><span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span><span class="token punctuation">{</span>  age<span class="token punctuation">:</span> age<span class="token punctuation">,</span>  addAge<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    age<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./person.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>person<span class="token punctuation">.</span><span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出结果 可以看到内部age的变化并不会影响person.age的值，这是因为person.age的值始终是第一次运行时的结果的拷贝。s</span><span class="token number">18</span><span class="token number">18</span></code></pre><p>再看ES6</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// person.js</span><span class="token keyword">export</span> <span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  age<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// my_module</span><span class="token keyword">import</span> <span class="token punctuation">{</span> age<span class="token punctuation">,</span> addAge <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./person.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">addAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 输出结果</span><span class="token number">18</span><span class="token number">19</span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>前端模块化规范包括CommonJS/ AMD/CMD/ES6模块化，平时我们可能只知其中一种但不能全面了解他们的发展历史、用法和区别，以及当我们使用require 和import的时候到底发生了什么，这篇文章给大家算是比较全面的做了一次总结。</p>]]></content>
      
      
      <categories>
          
          <category> 模块化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack4篇(下)</title>
      <link href="/2020/10/13/webpack4-pian-xia/"/>
      <url>/2020/10/13/webpack4-pian-xia/</url>
      
        <content type="html"><![CDATA[<p>书接上篇。</p><h1 id="优化-module-noParse-不解析某些包的依赖库"><a href="#优化-module-noParse-不解析某些包的依赖库" class="headerlink" title="[优化] module.noParse 不解析某些包的依赖库"></a>[优化] module.noParse 不解析某些包的依赖库</h1><p>如果我们确信，某个包不会依赖其他包，那么可以配置 module.noParse 不去解析依赖库，如果依赖库很多的情况下，这种方法能明显提升打包效率。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">smart</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>       noParse<span class="token punctuation">:</span> <span class="token regex">/jquery/</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 不去解析 jquery 中的依赖库</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="优化-webpack-IgnorePlugin-忽略包内引用-手动维护引用"><a href="#优化-webpack-IgnorePlugin-忽略包内引用-手动维护引用" class="headerlink" title="[优化] webpack.IgnorePlugin 忽略包内引用 手动维护引用"></a>[优化] webpack.IgnorePlugin 忽略包内引用 手动维护引用</h1><p>比如我们有一个moment包，使用如下:</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置语言</span>moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endof</span><span class="token punctuation">(</span><span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "十四天前"</span></code></pre><p>我这里面只用了一个方法，打包却有 1.2M，分析了下，原来在 moment 入口文件 moment.js 中，它帮我们引入了各国的语言包。</p><pre class=" language-js"><code class="language-js"><span class="token function">aliasedRequire</span><span class="token punctuation">(</span><span class="token string">'./locale/'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>不过，我们实际需要的只有一个中文的包，这时候我们可以屏蔽掉包内对外部的某一个依赖，手动去维护这个引用。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> webpack <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>         <span class="token comment" spellcheck="true">// 如果从 moment 引入了 .locale 就把它忽略掉</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorPlugin</span><span class="token punctuation">(</span><span class="token regex">/\.\/locale/</span><span class="token punctuation">,</span> <span class="token regex">/moment/</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>然后执行我们代码，发现打包文件少了500k，moment设置语言不好使了，打印出去 in 14 hours，这时候我们需要手动引入需要的中文包。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 手动引入所需要的语言包</span><span class="token keyword">import</span> <span class="token string">'moment/locale/zh-cn'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置语言</span>moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endof</span><span class="token punctuation">(</span><span class="token string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "十四天前"</span></code></pre><h1 id="优化-dllPlugin-动态链接库-生成mainfest-json-构建速度提升10倍"><a href="#优化-dllPlugin-动态链接库-生成mainfest-json-构建速度提升10倍" class="headerlink" title="[优化] dllPlugin 动态链接库 生成mainfest.json 构建速度提升10倍"></a>[优化] dllPlugin 动态链接库 生成mainfest.json 构建速度提升10倍</h1><p>当我们一个项目引入了多个较大的包以后，这些包本身并不会运行，我们也不会修改这些包的代码，但是每当我们修改了业务代码之后，这些包也会被重新打包。极大的浪费了时间，这时我们就需要使用这个工具预先把静态资源提前打包，以后修改源文件再打包时就不会打包这些静态资源文件了。</p><p><strong>将静态资源文件（运行依赖包）与源文件分开打包，先使用DllPlugin给静态资源打包，再使用DllReferencePlugin让源文件引用资源文件。</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>h1<span class="token operator">></span>hello webpack<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>贴上webpack配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./dist'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>              <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span>              <span class="token string">'@babel/preset-react'</span> <span class="token comment" spellcheck="true">// 解析webpack语法</span>            <span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      template<span class="token punctuation">:</span> <span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模板路径</span>      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>执行 npx webpack</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 3110msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">:</span><span class="token number">50</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js    <span class="token number">870</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">251</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>   </code></pre><p>可以看到，每次打包耗时3s，打包出来的文件有 870k，可是我们只写了一句代码~ 这其中包含了 react 和 react-dom 包的内容，这两个文件我们不会更改，我们能不能每次打包前，把这两个包抽离出去，引入到页面，打包后直接用呢。</p><p>我们新增两个文件</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.react.js</span><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    test<span class="token punctuation">:</span> <span class="token string">'./src/test.js'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>分析打包后的 test.js，此处只留下一些关键代码</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span>    <span class="token comment" spellcheck="true">// The module cache</span>    <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The require function</span>    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token punctuation">{</span>    <span class="token string">"./src/test.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = 123;\n\n//# sourceURL=webpack:///./src/test.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>可以看到，打包后的文件把我们的 exports 返回了，却并没有接收。我们可以在外部定义一个变量结束模块返回值。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span>    <span class="token comment" spellcheck="true">// The module cache</span>    <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The require function</span>    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/test.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>    <span class="token punctuation">{</span>    <span class="token string">"./src/test.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"module.exports = 123;\n\n//# sourceURL=webpack:///./src/test.js?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 123</span></code></pre><p>ok，可以拿到我们模块的输出结果，但是不能每次都这么手动去加啊，其实 output 属性提供了配置项 library: ‘a’</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    test<span class="token punctuation">:</span> <span class="token string">'./src/test.js'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 用变量 a 接收模块输出的结果  var a = (fn() {  return module.exports; } ())</span>    library<span class="token punctuation">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// 解析方式 </span>    <span class="token comment" spellcheck="true">// 不写默认为var 代表 var a = 模块返回结果 </span>    <span class="token comment" spellcheck="true">// 如果是 commonjs 代表 export['a'] = 模块返回结果</span>    <span class="token comment" spellcheck="true">// umd 代表兼容各版本写法</span>    libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这时候，a变量就能拿到模块的返回值了，我们需要做一件事儿，就是把入口文件，换成真正需要提取的库名</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">// 把两个包统一作为名为 react 的入口文件</span>     react<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 打包出的应为 _dll_react_vendor.js</span>    filename<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor.js'</span><span class="token punctuation">,</span>     path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 用变量 _dll_react_vendor 接收模块输出的结果  </span>    <span class="token comment" spellcheck="true">// var _dll_react_vendor = (fn() {  return module.exports; } ())</span>    library<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor'</span><span class="token punctuation">,</span>     libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>       name<span class="token punctuation">:</span> <span class="token string">'_dll_[name]_vendor'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 需要跟上面变量名一致，便于查找</span>      path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'mainfest.json'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 生成资产清单文件</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>这时候打包，我们就发现 dist 目录新增文件 _dll_react_vendor.js，mainfest.json</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mainfest.json</span><span class="token punctuation">{</span>  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"_dll_react_vendor"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 根据这个去找对应 js 所以要跟 js 文件名一样</span>  <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"./node_modules/object-assign/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/object-assign/index.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"./node_modules/react-dom/cjs/react-dom.development.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/react-dom/cjs/react-dom.development.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"./node_modules/react-dom/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"./node_modules/react-dom/index.js"</span><span class="token punctuation">,</span>      <span class="token string">"buildMeta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"providedExports"</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>资产清单上记录着 [name].js 上提供了哪些包。</strong></p><p>修改 html</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- 引入dll动态库 --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/_dll_react_vendor.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p><strong>此时我们引入了 dll 动态库，我们是不是需要告诉 webpack，你引入包的时候，先去我动态库中查找是否有这些包，如果有的话，就别打包了。怎么告诉它呢，webpack 提供了配套使用的 c，我们来修改 webpack.config.js 代码，注意，不是 webpack.config.react.js 哦。</strong></p><pre class=" language-js"><code class="language-js">  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// 先去查找 dll 资源清单，清单找不到的时候，再去打包文件</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>       manifest<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'manifest.json'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span></code></pre><p>第一次要先执行dll文件的打包命令(不然因为 manifest.json 未生成，DllReferencePlugin 会报错哦)</p><pre class=" language-js"><code class="language-js">npx webpack <span class="token operator">--</span>config<span class="token operator">=</span>webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>react<span class="token punctuation">.</span>js</code></pre><p>然后打包我们的主文件即可</p><pre class=" language-js"><code class="language-js">npx webpack</code></pre><p>发现主文件大小从 870k 变为 6k，打包时间从 3110ms 变为 409ms</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 409msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">12</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js   <span class="token number">6.27</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">299</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js</code></pre><h1 id="优化-happypack-多线程打包"><a href="#优化-happypack-多线程打包" class="headerlink" title="[优化] happypack 多线程打包"></a>[优化] happypack 多线程打包</h1><p>由于HappyPack 对file-loader、url-loader 支持的不友好，所以不建议对该loader使用。</p><pre class=" language-js"><code class="language-js">yarn add happypack <span class="token operator">-</span>D</code></pre><p>修改 js的loader 为 happypack/loader，并添加 plugin 配置</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'Happypack/loader?id=haha'</span> <span class="token comment" spellcheck="true">// 代表 js 需要多线程</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// css 同</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// css 同</span>    <span class="token keyword">new</span> <span class="token class-name">Happypack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      id<span class="token punctuation">:</span> <span class="token string">'haha'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// id 标识符，要和 rules 中指定的 id 对应起来</span>      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>           loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>           options<span class="token punctuation">:</span> <span class="token punctuation">{</span>             presets<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-react'</span><span class="token punctuation">]</span>           <span class="token punctuation">}</span>         <span class="token punctuation">}</span>      <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>打包下，发现启动了三个线程去打包，但是打包比之前还慢了 100ms，这是怎么回事呢？</p><pre class=" language-js"><code class="language-js"><span class="token operator">></span> npx webpackHappy<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">:</span> Version<span class="token punctuation">:</span> <span class="token number">5.0</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span> Threads<span class="token punctuation">:</span> <span class="token number">3</span>Happy<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">:</span> All <span class="token keyword">set</span><span class="token punctuation">;</span> signaling webpack to proceed<span class="token punctuation">.</span>Hash<span class="token punctuation">:</span> 5107dc46f2f09ddd86c9Version<span class="token punctuation">:</span> webpack <span class="token number">4.44</span><span class="token punctuation">.</span><span class="token number">2</span>Time<span class="token punctuation">:</span> 989msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">15</span>     Asset       Size  Chunks             Chunk Names bundle<span class="token punctuation">.</span>js   <span class="token number">6.27</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainindex<span class="token punctuation">.</span>html  <span class="token number">299</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js</code></pre><p>原来，如果代码量不多的话，使用 happypack 反而会拖慢打包速度哦，所以酌情看需不需要开启多线程打包~</p><h1 id="自带优化-js-的-tree-shaking-生产环境-amp-amp-import-语法生效"><a href="#自带优化-js-的-tree-shaking-生产环境-amp-amp-import-语法生效" class="headerlink" title="[自带优化] js 的 tree-shaking (生产环境 &amp;&amp;  import 语法生效)"></a>[自带优化] js 的 tree-shaking (生产环境 &amp;&amp;  import 语法生效)</h1><p>修改下代码</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> calc <span class="token keyword">from</span> <span class="token string">'./test'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span><span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">'sum'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> minus <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token string">'minus'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> sum<span class="token punctuation">,</span> minus <span class="token punctuation">}</span></code></pre><p>这时候打包，我们发现 sum 和 minus 都在 dist/bundle.js 中，但是我只用到了 sum 呀，能不能把我没用到的方法不打包呢，这时候我们把 mode 改为生成环境再次打包，发现 minus 方法被优化掉了，这就是 webpack4 自带的摇树优化。</p><p>需要注意的是，摇树优化只针对 import 语法导入的模块生效，require 无效哦。</p><h1 id="自带优化-scope-hoisting-作用域提升-生效条件如上"><a href="#自带优化-scope-hoisting-作用域提升-生效条件如上" class="headerlink" title="[自带优化] scope hoisting 作用域提升 (生效条件如上)"></a>[自带优化] scope hoisting 作用域提升 (生效条件如上)</h1><p><strong>webpack3之后，webpack新增了 scope hoisting优化，在 webpack 中会自动省略一些可以简化的代码(import语法)，并且正常来说 webpack 的引入都是把各个模块分开，通过 <strong>webpack_require</strong>  导入导出模块，但是使用 scope hoisting 后会把需要导入的文件直接移入导入者顶部，这就是所谓的 hoisting。</strong></p><p><strong>记得设置 mode 为 production哦</strong></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// inex.js</span><span class="token keyword">import</span> calc <span class="token keyword">from</span> <span class="token string">'./test'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">let</span> d <span class="token operator">=</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">'----------------'</span><span class="token punctuation">)</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// test.js</span><span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">'sum'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">let</span> minus <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token string">'minus'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> sum<span class="token punctuation">,</span> minus <span class="token punctuation">}</span></code></pre><p>我们分析打包后的代码， 发现一些重复的代码都被干掉了(a，b，c，d)，直接把结果6放上了，而且引用其他模块的方法，也是直接声明在了当前模块的顶端，减少了引用操作，这就是 scope hoisting!!!</p><pre class=" language-js"><code class="language-js">  <span class="token operator">...</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token string">"use strict"</span><span class="token punctuation">;</span>    r<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> e <span class="token operator">+</span> t <span class="token operator">+</span> <span class="token string">"sum"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">n</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token operator">...</span></code></pre><h1 id="优化-splitChunks-抽取公共代码-避免多次打包"><a href="#优化-splitChunks-抽取公共代码-避免多次打包" class="headerlink" title="[优化] splitChunks 抽取公共代码 避免多次打包"></a>[优化] splitChunks 抽取公共代码 避免多次打包</h1><p>新增 a.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">,</span> <span class="token string">'--------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>新增 b.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// b.js</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">,</span> <span class="token string">'--------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>新增 other.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// other.js</span><span class="token keyword">import</span> <span class="token string">'./a'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./b'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'other.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> <span class="token string">'./a'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./b'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 入口和出口配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>    index<span class="token punctuation">:</span> <span class="token string">'./src/index'</span><span class="token punctuation">,</span>    other<span class="token punctuation">:</span> <span class="token string">'./src/other'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p>执行打包，可以看到，dist/index.js 和 dist/other.js 都有公共模块的代码。</p><p>能不能把这两个模块抽离出来，变成一个公共模块，然后在 index 和 other分别引入这个模块呢，这样就不会打包两遍 a.js 和 b.js 啦。webpack提供了 splitChunks 来帮助我们抽离公共文件。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 分割代码块</span>      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 缓存组</span>        common<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 我们定义一个公共的模块</span>          chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>          minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这时候进行打包，我们发现 dist 目录多了一个 common~index~other.js，这里面就是我们要提取的公共模块代码，而 dist/index.js 和 dist/other.js 则没有公共模块的代码。</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span>window<span class="token punctuation">.</span>webpackJsonp <span class="token operator">=</span> window<span class="token punctuation">.</span>webpackJsonp <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token string">"--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token string">"--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>这时候我们又有一个想法，如果我们引了两次 jquery，你都给我提到 common 模块中，那得多大呀，我想把第三方包抽成一个 vendor包！</strong></p><p>我们来模拟一下，在 index.js 和 other.js 中都加上如下代码</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这时候打包，一看 common~index~other.js 增加了 80k，这是不能容忍的！</p><p>这时我们可以加一个要抽离出的公共包，叫 vendor。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 分割代码块</span>      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 缓存组</span>        common<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 我们定义一个公共的模块</span>          chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>          minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      vendor<span class="token punctuation">:</span> <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 如果引了 node_modules 下的包才考虑抽离</span>        chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 从入口处开始 就要提取代码</span>        minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 大于0字节就抽离</span>        minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 引用至少2次 就抽离</span>        priority<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">// 权重比上面的高一点 优先检查三方包的抽离以免全部打进 common</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行打包命令，我们发现 jquery 已经从 common包中抽离出去了</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 3910msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">28</span>                Asset       Size  Chunks             Chunk Namescommon<span class="token operator">~</span>index<span class="token operator">~</span>other<span class="token punctuation">.</span>js  <span class="token number">163</span> bytes       <span class="token number">0</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  common<span class="token operator">~</span>index<span class="token operator">~</span>other           index<span class="token punctuation">.</span>html  <span class="token number">396</span> bytes          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>               index<span class="token punctuation">.</span>js   <span class="token number">1.58</span> KiB       <span class="token number">2</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  index             other<span class="token punctuation">.</span>js   <span class="token number">1.58</span> KiB       <span class="token number">3</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  othervendor<span class="token operator">~</span>index<span class="token operator">~</span>other<span class="token punctuation">.</span>js   <span class="token number">88.5</span> KiB       <span class="token number">1</span>  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  vendor<span class="token operator">~</span>index<span class="token operator">~</span>other</code></pre><h1 id="import-懒加载"><a href="#import-懒加载" class="headerlink" title="import() 懒加载"></a>import() 懒加载</h1><p>比如页面有个按钮，点击按钮，我希望加载某段js。</p><p>新建 src/source.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// source.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'ys'</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'杨帅加油'</span><span class="token punctuation">;</span>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// es2020 草案中的语法 jsonp实现动态加载文件 返回一个 promise 实例</span>  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./source.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们点击按钮，可以看到 network加载了一段 js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 5.js</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>webpackJsonp<span class="token operator">=</span>window<span class="token punctuation">.</span>webpackJsonp<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>s<span class="token punctuation">,</span>w<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token string">"use strict"</span><span class="token punctuation">;</span>w<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token operator">=</span><span class="token string">"ys"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>同时页面打印出 模块的导出值 ys</p><p><strong>import()函数可以用在任何地方，不仅仅是模块，非模块的脚本也可以使用。它是也是 vue 和 react 路由懒加载的实现，它是运行时执行，也就是说，什么时候运行到这一句，就会加载指定的模块。另外，import()函数与所加载的模块没有静态连接关系，这点也是与import语句不相同。import()类似于 Node 的require方法，区别主要是前者是异步加载，后者是同步加载。</strong></p><h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>在之前，每次更改代码，都会导致页面重新刷新，我们能不能做到，只更新某一部分，let do it</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// source.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'log from source!'</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">import</span> str <span class="token keyword">from</span> <span class="token string">'./source'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 热更关键代码</span><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./source'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件更新了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./source'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 因为 import只能在顶上用</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>    hot<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 注意加了这行代码</span>    port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    open<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    contentBase<span class="token punctuation">:</span> <span class="token string">'./dist'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>       <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 热更新插件</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>这时候修改代码，页面就会热更啦</p><h1 id="Tapable-webpack核心之事件流"><a href="#Tapable-webpack核心之事件流" class="headerlink" title="Tapable  - webpack核心之事件流"></a>Tapable  - webpack核心之事件流</h1><p><strong>webpack 本质上是一种事件流的机制，它的工作流程就是将各种插件串联起来，而实现这一切的核心就是 Tapable，Tapable有点类似于 nodejs 的 events 库，核心原理也是依赖于发布订阅模式。</strong></p><p>在 webpack/lib/Compiler.js中 </p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>    Tapable<span class="token punctuation">,</span>    SyncHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 同步钩子</span>    SyncBailHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 同步钩子</span>    AsyncParallelHook<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 异步钩子</span>    AsyncSeriesHook <span class="token comment" spellcheck="true">// 异步钩子</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里我们就来应用下这些方法，并且实现它的原理，为后面手写代码做准备。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gl2tjc7kk4j30re0cgmxj.jpg" alt></p><p>安装 tapable</p><pre><code>yarn add tapable</code></pre><h2 id="SyncHook-同步钩子"><a href="#SyncHook-同步钩子" class="headerlink" title="SyncHook -- 同步钩子"></a>SyncHook -- 同步钩子</h2><p>维护同步函数队列，调用时依次执行，不可以中止执行。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ysvue 学习 ys</code></pre><p>实现这样一个同步的钩子也很简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ysSyncHook.js</span><span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span></code></pre><h2 id="SyncBailHook-带保险-可以控制是否往下执行-的同步钩子"><a href="#SyncBailHook-带保险-可以控制是否往下执行-的同步钩子" class="headerlink" title="SyncBailHook -- 带保险(可以控制是否往下执行)的同步钩子"></a>SyncBailHook -- 带保险(可以控制是否往下执行)的同步钩子</h2><p>维护同步函数队列，调用时依次执行，可以中止执行。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'太难了，学不会了'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回一个非 undefined 的值 即终止！</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ys</code></pre><p>手动实现也特别简单，只需要修改边界条件即可</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncBailHook</span><span class="token keyword">class</span> <span class="token class-name">SyncBailHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 终止条件为某次执行结果不为undefined 或者全部执行完毕</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!==</span> undefined <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="SyncWaterfallHook-函数执行结果依次传递的同步钩子"><a href="#SyncWaterfallHook-函数执行结果依次传递的同步钩子" class="headerlink" title="SyncWaterfallHook -- 函数执行结果依次传递的同步钩子"></a>SyncWaterfallHook -- 函数执行结果依次传递的同步钩子</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// start.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token string">'webpack4 学会了！！'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 传递给下一个函数的data</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 ysvue 学习 webpack4 学会了！！</code></pre><p>emm.. 实现起来也比较简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncWaterfallHook</span><span class="token keyword">class</span> <span class="token class-name">SyncWaterfallHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ret<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 有结果就传递结果给下个函数 没有结果则传递 args</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="SyncLoopHook-循环执行的可控制同步钩子"><a href="#SyncLoopHook-循环执行的可控制同步钩子" class="headerlink" title="SyncLoopHook -- 循环执行的可控制同步钩子"></a>SyncLoopHook -- 循环执行的可控制同步钩子</h2><p>webpack 本身没有用到这个方法，但这个方法挺有意思的，这个钩子一旦被调用，就会循环执行，直到钩子回调函数返回 undefined。</p><p>比如下面这个例子，webpack4 我想学习三遍之后，再学习 vue。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tap 方法注册监听函数 call 方法执行回调</span><span class="token comment" spellcheck="true">// let { SyncLoopHook } = require('./ysSyncLoopHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">const</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpakc4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token operator">++</span>_this<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token string">'继续学习 webpack4'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 挨个触发已注册函数的回调 并传参</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpakc4 学习 yswebpakc4 学习 yswebpakc4 学习 ysvue 学习 ys</code></pre><p>哈.. 实现起来也比较简单</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 SyncLoopHook</span><span class="token keyword">class</span> <span class="token class-name">SyncLoopHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 某次循环终止条件为返回值等于 undefined</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!==</span> undefined<span class="token punctuation">)</span> i<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncParallelHook-异步并行的钩子-tapAsync版"><a href="#AsyncParallelHook-异步并行的钩子-tapAsync版" class="headerlink" title="AsyncParallelHook -- 异步并行的钩子(tapAsync版)"></a>AsyncParallelHook -- 异步并行的钩子(tapAsync版)</h2><p>异步钩子的用法和同步区别在于，异步钩子是用 tapAsync 方法注册监听函数 callAsync 方法执行回调，并且每个监听函数都要调用 cb。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncParallelHook } = require('./ysAsyncParallelHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 1s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 2s later</span></code></pre><p>可以看到，上面代码监听函数每次回调中都执行了cb()，原理是存在着一个计数器，如果执行完毕的任务数等于注册的监听函数数量，则执行我们传入的回调函数，它的实现特别像 Promise.all。</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncParallelHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapAsync</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> finallyCb <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 弹出最后一个参数</span>    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 计数</span>    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      count<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">finallyCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 并发执行 forEach</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>task <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token function">task</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncParallelHook-异步并行的钩子-tapPromise版"><a href="#AsyncParallelHook-异步并行的钩子-tapPromise版" class="headerlink" title="AsyncParallelHook -- 异步并行的钩子(tapPromise版)"></a>AsyncParallelHook -- 异步并行的钩子(tapPromise版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapPromise 方法注册监听函数 promise 方法执行回调</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><h2 id="AsyncParallelBillHook-异步并行可取消的钩子-不再赘述"><a href="#AsyncParallelBillHook-异步并行可取消的钩子-不再赘述" class="headerlink" title="AsyncParallelBillHook -- 异步并行可取消的钩子 不再赘述"></a>AsyncParallelBillHook -- 异步并行可取消的钩子 不再赘述</h2><h2 id="AsyncSeriesHook-异步串行的钩子-tapAsync版"><a href="#AsyncSeriesHook-异步串行的钩子-tapAsync版" class="headerlink" title="AsyncSeriesHook -- 异步串行的钩子(tapAsync版)"></a>AsyncSeriesHook -- 异步串行的钩子(tapAsync版)</h2><p>如果我们下一个注册的监听函数回调依赖了上一个函数回调的返回结果，这时候就不能并发执行了。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesHook } = require('./ysAsyncSeriesHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// webpack4 学习 和 vue 学习 全部执行完 才会执行回调</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>手动实现它并不费劲</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncSeriesHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// args => ['name'] 并没有实际意义 作为一个参数标识</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapAsync</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> finallyCb <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 全部执行完毕 触发最终钩子回调</span>    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 每个函数回调内执行后(cb执行)，调用该方法执行下一个函数(递归)</span>    <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finallyCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> tasks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncSeriesHook-异步串行的钩子-tapPromise版"><a href="#AsyncSeriesHook-异步串行的钩子-tapPromise版" class="headerlink" title="AsyncSeriesHook -- 异步串行的钩子(tapPromise版)"></a>AsyncSeriesHook -- 异步串行的钩子(tapPromise版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapPromise 方法注册监听函数 promise 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesHook } = require('./ysAsyncSeriesHookPromise'); // promise 版 同步并发</span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// new 出来一个同步钩子 接收一个参数</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 promise 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 ys  <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦！<span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>ok，我们来实现它</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 手动实现 AsyncParallelHook</span><span class="token keyword">class</span> <span class="token class-name">AsyncSeriesHook</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">tapPromise</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">promise</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token operator">...</span>other<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取出第一个任务</span>    <span class="token keyword">return</span> other<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 类似 redux 源码</span>      <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapAsync版"><a href="#AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapAsync版" class="headerlink" title="AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapAsync版)"></a>AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapAsync版)</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token comment" spellcheck="true">// let { AsyncSeriesWaterfallHook } = require('./ysAsyncSeriesWaterfallHook'); </span><span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// cb第一个参数为error 则不继续调用 为null 则往下继续调用 第二个参数为传递的参数</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><p>执行此文件，笔者使用的是 run code 插件</p><pre class=" language-js"><code class="language-js">webpack4 学习 ys <span class="token comment" spellcheck="true">// 2s later</span>vue 学习 result <span class="token comment" spellcheck="true">// 3s later</span>学习结束啦 <span class="token comment" spellcheck="true">// 3s later</span></code></pre><p>实现一下</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// let { AsyncSeriesWaterfallHook } = require('tapable'); // 提供 tapAsync 方法注册监听函数 callAsync 方法执行回调</span><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ysAsyncSeriesWaterfallHook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">class</span> <span class="token class-name">Lesson</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 定义一些钩子</span>      arch<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'webpack4'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'webpack4 学习'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// cb第一个参数为error 则不继续调用 为null 则往下继续调用 第二个参数为传递的参数</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vue 学习'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 启动钩子的方法</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ys'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 这里改成 callAsync 全部执行完毕后 执行该回调</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'学习结束啦！'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lesson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册了这两个事件</span>l<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行这两个事件</span></code></pre><h2 id="AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapPromise版"><a href="#AsyncSeriesWaterfallHook-传递结果的异步串行钩子-tapPromise版" class="headerlink" title="AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapPromise版)"></a>AsyncSeriesWaterfallHook -- 传递结果的异步串行钩子(tapPromise版)</h2><p>略..</p><h2 id="tapable库用法总结"><a href="#tapable库用法总结" class="headerlink" title="tapable库用法总结"></a>tapable库用法总结</h2><p>tapable提供的钩子函数，有<strong>三种注册监听函数的方法</strong>，分别是 </p><ul><li>tap 同步注册</li><li>tapAsync(cb) 异步注册</li><li>tapPromise(异步注册的是promise)</li></ul><p><strong>调用的方法也是有三种</strong></p><ul><li>call </li><li>callAsync</li><li>promise</li></ul><h1 id="手写-webpack"><a href="#手写-webpack" class="headerlink" title="手写 webpack"></a>手写 webpack</h1><p>目录结构</p><pre class=" language-js"><code class="language-js"><span class="token operator">-</span>bin  <span class="token operator">-</span> ys<span class="token operator">-</span>pack<span class="token operator">-</span> lib  <span class="token operator">-</span> Compiler<span class="token punctuation">.</span>js<span class="token operator">-</span> src  <span class="token operator">-</span> index<span class="token punctuation">.</span>js<span class="token operator">-</span> webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span><span class="token keyword">var</span>  a  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'导入模块: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// a.js</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span></code></pre><h2 id="1-读取-webpack-config-js-文件"><a href="#1-读取-webpack-config-js-文件" class="headerlink" title="1) 读取 webpack.config.js 文件"></a>1) 读取 webpack.config.js 文件</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// bin/ys-pack</span>#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 拿到 webpack 配置文件</span><span class="token keyword">let</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用来编译的类</span><span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 配置传入</span>compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 运行编译</span></code></pre><h2 id="2）添加-compiler-编译类-解析模块id-模块内容"><a href="#2）添加-compiler-编译类-解析模块id-模块内容" class="headerlink" title="2）添加 compiler 编译类 解析模块id 模块内容"></a>2）添加 compiler 编译类 解析模块id 模块内容</h2><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// lib/Compiler.js</span><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 需要保存入口文件的路径</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './src/index.js' </span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前执行命令的文件根目录 用于查找入口文件的真实路径</span>    <span class="token comment" spellcheck="true">// 需要保存所有的模块依赖</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 结构为 路径: 代码 也就是编译后源码的webpack启动函数参数</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`模块id：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p>此刻执行 npx-pack</p><pre class=" language-js"><code class="language-js">模块id：<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">,</span>模块内容：<span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-添加-parse方法-替换require、修复依赖模块id"><a href="#3-添加-parse方法-替换require、修复依赖模块id" class="headerlink" title="3) 添加 parse方法 替换require、修复依赖模块id"></a>3) 添加 parse方法 替换require、修复依赖模块id</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`模块id：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @description 生成 AST 解析语法树   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">,</span> <span class="token string">'bingo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><h2 id="4-parse-方法实现"><a href="#4-parse-方法实现" class="headerlink" title="4) parse 方法实现"></a>4) parse 方法实现</h2><p>这里介绍几个node包</p><ul><li>babylon 将 js 转换成 ast</li><li>@babel/traverse 遍历 ast </li><li>@babel/types 替换 ast 某节点</li><li>@babel/generator 将 ast 解码生 js代码</li></ul><p><a href="https://astexplorer.net/" target="_blank" rel="noopener">在线查看 ast 结构</a></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 源码解析成 ast</span>    <span class="token keyword">let</span> dependncies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块依赖的模块数组</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token function">CallExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里建议在以上贴的网站参考 require('a.js') 转成的 ast结构</span>        <span class="token keyword">let</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对应的节点</span>        <span class="token comment" spellcheck="true">// 如果标签为 require</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span><span class="token punctuation">;</span>          <span class="token keyword">let</span> moduleName <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './a.js'</span>          <span class="token comment" spellcheck="true">// 拼上扩展名</span>          moduleName <span class="token operator">=</span> moduleName <span class="token operator">+</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 拼上要处理的父路径</span>          moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ./src/a.js</span>          node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 通过 types 替换掉 ast 某节点</span>          dependncies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 放入依赖数组</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 重新转成 js 代码</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p>执行 npx ys-pack</p><pre class=" language-js"><code class="language-js">修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>模块依赖包列表：<span class="token punctuation">[</span><span class="token string">"./src/a.js"</span><span class="token punctuation">]</span></code></pre><h2 id="5-递归解析依赖模块"><a href="#5-递归解析依赖模块" class="headerlink" title="5) 递归解析依赖模块"></a>5) 递归解析依赖模块</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 递归完毕后 this.modules保存着所有加载的模块</span>    <span class="token comment" spellcheck="true">// 递归 解析主模块依赖的模块 </span>    dependncies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行 npx ys-pack</p><pre class=" language-js"><code class="language-js">修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/a.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"导入模块:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>'模块依赖包列表：<span class="token punctuation">[</span><span class="token string">"./src/a.js"</span><span class="token punctuation">]</span>修正后的模块源码：<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span>模块依赖包列表：<span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre><p>run 方法内增加打印</p><pre class=" language-js"><code class="language-js"><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>输出</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">'./src/index.js'</span><span class="token punctuation">:</span> <span class="token string">'var a = __webpack_require__("./src/a.js");\n\nconsole.log("导入模块:" + a);'</span><span class="token punctuation">,</span>  <span class="token string">'./src/a.js'</span><span class="token punctuation">:</span> <span class="token string">'var a = 1;\nmodule.exports = a;'</span><span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js</code></pre><h2 id="6-增加-emitFile-方法-使用-modules-组装-ejs模板-并输出"><a href="#6-增加-emitFile-方法-使用-modules-组装-ejs模板-并输出" class="headerlink" title="6) 增加 emitFile 方法 使用 modules 组装 ejs模板 并输出"></a>6) 增加 emitFile 方法 使用 modules 组装 ejs模板 并输出</h2><p>安装 ejs 模块</p><pre class=" language-js"><code class="language-js">yarn add ejs <span class="token operator">-</span>D</code></pre><p>新增文件 lib/template.ejs</p><details><summary>模板代码</summary><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The module cache</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The require function</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Execute the module function</span><span class="token comment" spellcheck="true">/******/</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded</span><span class="token comment" spellcheck="true">/******/</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Return the exports of the module</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__)</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the module cache</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define __esModule on exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// create a fake namespace object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 1: value is a module id, require it</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 2: merge all properties of value into the ns</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 4: return value when already ns object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 8|1: behave like require</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"&lt;%-entryId%>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/************************************************************************/</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> modules<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">%</span><span class="token operator">></span>              <span class="token string">"&lt;%-key%>"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`&lt;%-modules[key]%>`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 这里有个逗号哦</span>            <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span> <span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span> code<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token operator">-</span>modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">%</span><span class="token operator">-</span>key<span class="token operator">%</span><span class="token operator">></span></code></pre></details><p>修改 Compiler.js 增加 emitFile 方法</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span><span class="token keyword">const</span> getDirName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dirname<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 发射文件 用数据渲染我们的 lib/template.ejs 并输出到 this.config.output.path</span>    <span class="token comment" spellcheck="true">// 输出路径</span>    <span class="token keyword">let</span> outPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> templateString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取 ejs 模板</span>    <span class="token keyword">let</span> outputCode <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>templateString<span class="token punctuation">,</span> <span class="token punctuation">{</span> entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span> modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 渲染 ejs 模板 得到打包后的源码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能会有多个出口文件~</span>    <span class="token comment" spellcheck="true">// 资源中 输出路径对应的打包后代码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>outPath<span class="token punctuation">]</span> <span class="token operator">=</span> outputCode<span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 循环输出 output files</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  writeFileSync <span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 没有文件夹则自动创建的 writeFileSync 方法</span>    <span class="token function">mkdirp</span><span class="token punctuation">(</span><span class="token function">getDirName</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>执行 npx ys-pack</p><details><summary>dist/bundle.js</summary><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// webpackBootstrap</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The module cache</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// The require function</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Check if module is in cache</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Create a new module (and put it into the cache)</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">/******/</span>             exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Execute the module function</span><span class="token comment" spellcheck="true">/******/</span>         modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Flag the module as loaded</span><span class="token comment" spellcheck="true">/******/</span>         module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token comment" spellcheck="true">// Return the exports of the module</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the modules object (__webpack_modules__)</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// expose the module cache</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define getter function for harmony exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// define __esModule on exports</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>             Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// create a fake namespace object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 1: value is a module id, require it</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 2: merge all properties of value into the ns</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 4: return value when already ns object</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// mode &amp; 8|1: behave like require</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> ns<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// getDefaultExport function for compatibility with non-harmony modules</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">var</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span><span class="token comment" spellcheck="true">/******/</span>             <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> module<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>         <span class="token keyword">return</span> getter<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Object.prototype.hasOwnProperty.call</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// __webpack_public_path__</span><span class="token comment" spellcheck="true">/******/</span>     __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token comment" spellcheck="true">// Load entry module and return exports</span><span class="token comment" spellcheck="true">/******/</span>     <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"./src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/************************************************************************/</span><span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>              <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`var a = __webpack_require__("./src/a.js");console.log('导入模块: ' + a);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`// a.jsvar a = 1;module.exports = a;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">/******/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details>run code 执行该文件<pre class=" language-js"><code class="language-js">导入模块<span class="token punctuation">:</span> <span class="token number">1</span></code></pre><h2 id="7-简易webpack完成，附-Compiler-完整代码"><a href="#7-简易webpack完成，附-Compiler-完整代码" class="headerlink" title="7) 简易webpack完成，附 Compiler 完整代码"></a>7) 简易webpack完成，附 Compiler 完整代码</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// js 转 ast</span><span class="token keyword">let</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历 ast </span><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 替换 ast 某节点</span><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将 ast 解码生 js代码</span><span class="token keyword">let</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span><span class="token keyword">const</span> getDirName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dirname<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @description 用来编译的工具类 * @param { Object } webpack 配置 * @returns void */</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 需要保存入口文件的路径</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './src/index.js' </span>    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前执行命令的文件根目录 用于查找入口文件的真实路径</span>    <span class="token comment" spellcheck="true">// 需要保存所有的模块依赖</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 结构为 路径: 代码 也就是编译后源码的webpack启动函数参数</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/** 启动 webpack 并且 创建模块依赖关系   * @description    * @param { String } 入口文件真实路径   * @param { Boolean } 是否主模块   */</span>  <span class="token function">buildModule</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到当前模块内容</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 模块id 需要改造下 绝对路径 -> 相对路径 (webpack打包后的模块id是一个相对路径) </span>    <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比如 ./src/index.js</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId <span class="token operator">=</span> moduleName<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 保存主入口</span>    <span class="token comment" spellcheck="true">// path.dirname(moduleName) 为 ./src 把它传进去进行路径修复</span>    <span class="token comment" spellcheck="true">// sourceCode 目标模块打包结果代码 dependncies为依赖列表</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`修正后的模块源码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> sourceCode <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, 模块依赖包列表：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dependncies<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> sourceCode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块的id -> 当前模块打包的源码</span>    <span class="token comment" spellcheck="true">// 递归 依赖性也进行解析</span>    dependncies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 发射文件 用数据渲染我们的 lib/template.ejs 并输出到 this.config.output.path</span>    <span class="token comment" spellcheck="true">// 输出路径</span>    <span class="token keyword">let</span> outPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">let</span> templateString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取 ejs 模板</span>    <span class="token keyword">let</span> outputCode <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>templateString<span class="token punctuation">,</span> <span class="token punctuation">{</span> entryId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">,</span> modules<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 渲染 ejs 模板 得到打包后的源码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能会有多个出口文件~</span>    <span class="token comment" spellcheck="true">// 资源中 输出路径对应的打包后代码</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>outPath<span class="token punctuation">]</span> <span class="token operator">=</span> outputCode<span class="token punctuation">;</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 循环输出 output files</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * @description 解析源码 核心步骤 当前模块依赖文件导入模块路径修复 require替换   * @param { String } source 当前模块内容   * @param { String } parentPath 修复当前模块依赖模块路径需要的父级路径 如'./a.js' -> './src/a.js'   * @returns { Object } sourceCode: 当前模块对应源码(替换了require) dependncies 当前模块依赖列表   */</span>  <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> parentPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 源码解析成 ast</span>    <span class="token keyword">let</span> dependncies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当前模块依赖的模块数组</span>    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token function">CallExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里建议在以上贴的网站参考 require('a.js') 转成的 ast结构</span>        <span class="token keyword">let</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对应的节点</span>        <span class="token comment" spellcheck="true">// 如果标签为 require</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span><span class="token punctuation">;</span>          <span class="token keyword">let</span> moduleName <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// './a.js'</span>          <span class="token comment" spellcheck="true">// 拼上扩展名</span>          moduleName <span class="token operator">=</span> moduleName <span class="token operator">+</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// 拼上要处理的父路径</span>          moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ./src/a.js</span>          node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 通过 types 替换掉 ast 某节点</span>          dependncies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 放入依赖数组</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 重新转成 js 代码</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependncies <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  writeFileSync <span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 没有文件夹则自动创建的 writeFileSync 方法</span>    <span class="token function">mkdirp</span><span class="token punctuation">(</span><span class="token function">getDirName</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler<span class="token punctuation">;</span></code></pre><p><strong>至此 我们自己的打包工具拥有了简单的打包能力，那怎么引用loader跟plugin呢~</strong></p><h2 id="8-增加-loader-less-loader，style-loader"><a href="#8-增加-loader-less-loader，style-loader" class="headerlink" title="8) 增加 loader (less-loader，style-loader)"></a>8) 增加 loader (less-loader，style-loader)</h2><p>新增 loader 文件夹，增加 less-loader，style-loader两个文件。</p><p>安装 less</p><pre class=" language-js"><code class="language-js">yarn add less <span class="token operator">-</span>D</code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// less-loader.js</span><span class="token keyword">let</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">lessLoader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> css <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>  less<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>    css <span class="token operator">=</span> res<span class="token punctuation">.</span>css<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> css<span class="token punctuation">;</span><span class="token punctuation">}</span>css <span class="token operator">=</span> css<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\n/g</span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 处理换行符</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> lessLoader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// style-loader.js</span><span class="token keyword">function</span> <span class="token function">styleLoader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 接收源码(到这里已经是css啦) 塞进页面 style 标签</span>  <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`    let style = document.createElement('style');    style.innerHtml = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;    document.head.appendChild(style);  `</span></span>  <span class="token keyword">return</span> style<span class="token punctuation">;</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> styleLoader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span>  path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token comment" spellcheck="true">// 这里是绝对路径 如果不写路径直接写 loader 名称 默认从 node_modules 中引入</span>          path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'style-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compole.js 增加使用 loader 逻辑</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token comment" spellcheck="true">// require 模块走这里 先读取模块内容 再经过 loader 转换 </span>  <span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 所有 rules</span>    <span class="token keyword">let</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 拿到每个规则来处理</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">let</span> rule <span class="token operator">=</span> rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> <span class="token punctuation">{</span> test<span class="token punctuation">,</span> use<span class="token punctuation">:</span> loaderList <span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>      <span class="token keyword">let</span> loaderListLen <span class="token operator">=</span> loaderList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// test的正则能匹配到的模块路径，则启用 loader 从右向左依次处理源码</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">function</span> <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>loaderList<span class="token punctuation">[</span><span class="token operator">--</span>loaderListLen<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 取最后一个loader 且每次减 1</span>          source <span class="token operator">=</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>loaderListLen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 递归执行</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> source<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行编译 npx ys-pack</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// build.js</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>              <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`var a = __webpack_require__("./src/a.js");__webpack_require__("./src/index.less"); // 引入lessconsole.log('导入模块: ' + a);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/a.js"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`// a.jsvar a = 1;module.exports = a;`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"./src/index.less"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`let style = document.createElement('style');style.innerHtml = "body {\n  background: red;\n}\n";document.head.appendChild(style);`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 可能有换行符 所以为了方便这里我们使用模板字符串</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </code></pre><p>可以看到，less文件以及正常打包了~<br>dist 文件新建 index.html，引入 build.js，打开 html，可以看到页面变红哦</p><p>总结:</p><ul><li><strong>loader 是一个函数，主要是对输出内容做二次处理。</strong></li><li><strong>loader 在 require 且 正则匹配后缀成功时调用。</strong></li><li><strong>loader 从右向左执行，从下到上</strong></li></ul><h2 id="9-增加-plugins"><a href="#9-增加-plugins" class="headerlink" title="9) 增加 plugins"></a>9) 增加 plugins</h2><p>安装 tapable 到你了~</p><pre class=" language-js"><code class="language-js">yarn add tapable</code></pre><p>增加插件plugins/emit-plugin.js，entry-options-plugin.js(插件内部提供了一个apply方法去注册监听函数，接收 Compiler实例)</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// plugins/emit.plugin.js</span><span class="token keyword">class</span> <span class="token class-name">EmitPlugin</span> <span class="token punctuation">{</span>  <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数 但是并没有执行哦</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'emit结束，也就是 bundle.js 生成后执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EmitPlugin<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// plugins/emit.plugin.js</span><span class="token keyword">class</span> <span class="token class-name">EmitPlugin</span> <span class="token punctuation">{</span>  <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'emit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注册监听函数 但是并没有执行哦</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'emit结束，也就是 bundle.js 生成后执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EmitPlugin<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> EmitPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/emit-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> EntryOptionsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/entry-options-pllugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">EntryOptionsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">EmitPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>ys-pack 新增 entryOptions 钩子初始化 钩子调用 </p><pre class=" language-js"><code class="language-js">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 1) 需要找到当前执行的路径 拿到 webpack.config.js</span><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 拿到 webpack 配置文件</span><span class="token keyword">let</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/Compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 用来编译的类</span><span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 配置传入</span><span class="token comment" spellcheck="true">// 这时候调用 entryOptions 钩子 </span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 标识运行编译</span></code></pre><p>Compiler.js 中增加钩子执行调用</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span><span class="token keyword">let</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>      entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 入口钩子 new Compiler 传入 webpack 配置时 调用</span>      afterPlugins<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译完插件后加载钩子(插件此时并没有执行，只是注册了监听函数) </span>      run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 运行时钩子 this.run方法执行，webpack开始编译前调用</span>      compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译钩子 this.buildModule 执行前调用</span>      afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 编译后钩子 this.buildModule 执行后调用</span>      emit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 发射文件 // this.emit 执行完毕 生成 bundle.js 时调用</span>      done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 执行完成钩子 全部完成调用</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果webpack配置传递了 plugins 参数</span>    <span class="token keyword">let</span> plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 这一步只是在 plugin 内部通过 apply 方法完成监听函数注册，也就是调用了 tap 方法，没有 call 哦</span>      plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>plugin <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>         plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 依次执行 把当前 Compiler 实例放进去</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterPlugins<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 插件编译完成 监听函数通过 apply 注册上了</span>  <span class="token punctuation">}</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// run 方法执行时候</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 编译开始钩子</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 编译结束</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 完事儿啦</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token operator">...</span><span class="token punctuation">}</span></code></pre><p>执行编译 npx ys-pack</p><pre class=" language-js"><code class="language-js">入口执行，也就是 <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>就会执行emit结束，也就是 bundle<span class="token punctuation">.</span>js 生成后执行</code></pre><h1 id="再探-loader-特性"><a href="#再探-loader-特性" class="headerlink" title="再探 loader 特性"></a>再探 loader 特性</h1><h2 id="resolveLoader-别名和模块配置！"><a href="#resolveLoader-别名和模块配置！" class="headerlink" title="resolveLoader 别名和模块配置！"></a>resolveLoader 别名和模块配置！</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 参数即为源代码</span>  <span class="token comment" spellcheck="true">// do something</span>  <span class="token keyword">return</span> source<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> loader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">[</span>          path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>每次都写绝对路径是不是太长了呢，但是不写路径又默认从 node_modules 引，怎么办。可以使用 resolveLoader 起一个别名。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoder<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    alias<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 别名</span>      loader1<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>但是这样还是比较麻烦，能不能就不用手动写路径，自动寻找 loader 呢，其实我们可以规定从哪里找 loader</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loader'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样的话，如果 node_modules 中找不到 loader, 就会自动去我们 loader 文件夹下找。</p><h2 id="loader-真的是-从右往左，从下往上执行的么？"><a href="#loader-真的是-从右往左，从下往上执行的么？" class="headerlink" title="loader 真的是 从右往左，从下往上执行的么？"></a>loader 真的是 从右往左，从下往上执行的么？</h2><p>我们知道，常规的loader是从下到上执行，比如我有3个loader，都是处理 js 的，那么默认是从下到上执行，我们能手动操控执行顺序么(也可以倒序写)，这里我们来认识下 loader 的分类。</p><ul><li><strong>pre(前置执行的loader)</strong></li><li><strong>normal(正常的loader)</strong></li><li><strong>inline(行内的loader)</strong></li><li><strong>post(后置执行的loader)</strong></li></ul><p><strong>执行顺序是 pre &gt; normal &gt; inline &gt; post</strong><br>我们可以给每个loader 增加一个 enforce 属性，来改变它的类型来影响执行顺序。</p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  resolveLoder<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader1'</span><span class="token punctuation">,</span>        enforce<span class="token punctuation">:</span> <span class="token string">'pre'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader2'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token string">'loader3'</span><span class="token punctuation">,</span>        enforce<span class="token punctuation">:</span> <span class="token string">'post'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这样，执行顺序就变成 1， 2， 3了。</p><p><strong>注意: inline-loader 和原本的 loader 定义并没有什么不同，除了用法！以下是内联 loader的一些特殊用法</strong></p><ol><li>加入!前缀， 不使用 config loader 中的normal loader，例如 require(‘!a-loader!./a.js’);</li><li>加入!!前缀，不执行其他类型 loader，例如 require(‘!!a-loader!./a.js’);</li><li>加入-!前缀，不使用 config loader 中的 normal loader, pre loader，例如 require(‘-!a-loader!./a.js’);</li></ol><p><strong>那相同分类的 loader，难道执行顺序就是从右往左，从上到下么？</strong></p><p>loader其实由两部分组成，也可以说是它的两个阶段。</p><ul><li><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>Pitch loader，它会按正常传递顺序执行</strong></font></li><li><font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;"><strong>Normal loader，我们实际运行的执行顺序</strong></font></li></ul><p><span style="font-weight: 900; word-break: break-all; color: #bf30ac;">比如 [‘a’, ‘b’, ‘c’]，正常调用顺序应该是 c、b、a，但是真正调用顺序是 a.pitch()、b.pitch()、c.pitch()、c、b、a， 如果其中任何一个 pitch loader 返回了值就相当于在它以及它右边的 loader 已经执行完毕。比如如果 b 返回了字符串 “result b”，接下来只有 a 会被系统执行，且 a 的loader收到的参数是 result b。</span></p><p>也就是说 Pitch loader 的初衷是为了提升效率，少执行几个 loader。<br><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gl6fq52nxzj30yh0u0dve.jpg" width="500"></p><pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loader 3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> source<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>pitch <span class="token operator">=</span> res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token string">'i will go back'</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h1 id="实现-babel-loader"><a href="#实现-babel-loader" class="headerlink" title="实现 babel-loader"></a>实现 babel-loader</h1><p>安装其他 babel 相关</p><pre class=" language-js"><code class="language-js">yarn add @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env <span class="token operator">-</span>Dyarn add loader<span class="token operator">-</span>utils <span class="token operator">-</span>D <span class="token comment" spellcheck="true">// loader 工具库 用于帮我们拿到 loader中配置的 options</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//  loader-utils 可以帮我们在 loader 中拿到该配置</span>            presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>babel-loader实现</strong></p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// /Users/ys/study/webpack学习源码/手写各种loader/src/index.js</span>  <span class="token comment" spellcheck="true">// 调用 @babel/core 内 transform 方法进行转换 </span>  babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>    presets<span class="token punctuation">:</span> options<span class="token punctuation">.</span>presets<span class="token punctuation">,</span>    sourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    filename<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 生成的文件名(source查看 webpack:// 源码展示的名字)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 拿到参数(错误，编译后源码，souremap) 自动帮我们返回结果</span>    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">class</span> <span class="token class-name">Ys</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ys'</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">let</span> ys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ys<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>执行 npx webpack进行打包，发现我们的 es6 语法被转成 es5了，但是没有 sourcemap 怎么办，需要知道，我们想让打包出 sourcemap，webpack 配置必须把 devtool 置为相应模式才行。</p><pre class=" language-js"><code class="language-js">devtool<span class="token punctuation">:</span> <span class="token string">'source-map'</span></code></pre><h1 id="自创-loader-之-banner-loader"><a href="#自创-loader-之-banner-loader" class="headerlink" title="自创 loader 之 banner-loader"></a>自创 loader 之 banner-loader</h1><p>我们实现一个 loader，来根据配置或者读取文件内容来为源码署名，如果配置 options.filename，则使用 options.filename 中的文件进行署名，不然使用 options.text！</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 工具类 我们需要它拿到 options</span><span class="token keyword">let</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 校验模块</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>         test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'banner-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            text<span class="token punctuation">:</span> <span class="token string">'amosyang署名'</span><span class="token punctuation">,</span>            filename<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'banner-template.js'</span><span class="token punctuation">)</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>根目录创建 banner-template.js</p><pre class=" language-js"><code class="language-js">杨帅署名<span class="token number">2</span></code></pre><p>loaders 目录下创建 banner-loader.js</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> validateOptions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'schema-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 校验模块</span><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 是否启用缓存</span>  <span class="token comment" spellcheck="true">// this.cacheable(false); // 每次均重新打包</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>cacheable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 不传参数默认为 true  </span>  <span class="token comment" spellcheck="true">// 拿到 loader 配置的 options</span>  <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// loader 内部提供的 异步方法，可以帮助我们返回结果</span>  <span class="token keyword">let</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 创建 options 骨架</span>    type<span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>    properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token punctuation">{</span>        type<span class="token punctuation">:</span> <span class="token string">'string'</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      filename<span class="token punctuation">:</span> <span class="token punctuation">{</span>        type<span class="token punctuation">:</span> <span class="token string">'string'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 参数(传入的骨架 实际接收的参数 参数错误时，抛出错误的文件名)</span>  <span class="token function">validateOptions</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'banner-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当 webpack 配置为 true 时，监听此文件修改</span>    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> data <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> options<span class="token punctuation">.</span>text <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">**/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> source <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行 npx webpack 可以看到我们的文件都被加上签名啦</p><pre class=" language-js"><code class="language-js"><span class="token operator">...</span><span class="token string">"use strict"</span><span class="token punctuation">;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"/**杨帅署名2221**/\n\nfunction _classCallCheck(){...}"</span></code></pre><p>这时候有一个问题，如果我在 webpack 中开启了监听</p><pre class=" language-js"><code class="language-js">watch<span class="token punctuation">:</span> <span class="token boolean">true</span></code></pre><p>这时候我修改了 banner-template.js 内的模板内容，发现重新 build了，这一切都归功于其中一句代码，我们在 loader 内添加了这个模板为监听文件。</p><pre class=" language-js"><code class="language-js"> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 当 webpack 配置为 true 时，监听此文件修改</span></code></pre><h1 id="实现-file-loader"><a href="#实现-file-loader" class="headerlink" title="实现 file-loader"></a>实现 file-loader</h1><p>src 下 copy 进来一张图片 public.png</p><p>修改 src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> p <span class="token keyword">from</span> <span class="token string">'./public.png'</span><span class="token punctuation">;</span><span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> p<span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.png|jpg|gif$/</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 目的就是根据图片生成一个 md5 戳 发射到 dist目录下，发射完成后，模块本身返回一个带 hash 的图片名</span>        use<span class="token punctuation">:</span> <span class="token string">'file-loader'</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// laoders/file-loader.js</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 根据传入的格式 二进制内容 产生一个 文件名</span>  <span class="token keyword">let</span> filename <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">interpolateName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'[hash].[ext]'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> content<span class="token punctuation">:</span> source <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 发射文件</span>  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实际导出的是这个处理过文件名</span><span class="token punctuation">}</span>loader<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置接收的 source 为二进制</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行编译 npx build，成功~</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 437msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">32</span>                               Asset      Size  Chunks             Chunk Names                           bundle<span class="token punctuation">.</span>js  <span class="token number">4.65</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainc37f803ecaf165e89ca5344e6120b7af<span class="token punctuation">.</span>png   <span class="token number">693</span> KiB          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">]</span> <span class="token number">508</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span><span class="token keyword">public</span><span class="token punctuation">.</span>png<span class="token punctuation">]</span> <span class="token number">53</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre><h1 id="实现-url-loader"><a href="#实现-url-loader" class="headerlink" title="实现 url-loader"></a>实现 url-loader</h1><p>src 下 copy 进来一张图片 public.png</p><p>修改 src/index.js</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/index.js</span><span class="token keyword">import</span> p <span class="token keyword">from</span> <span class="token string">'./public.png'</span><span class="token punctuation">;</span><span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> p<span class="token punctuation">;</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改 webpack 配置</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>    filename<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不同于 resolve 解析模块 这个是专门解析 loader的</span>    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>           <span class="token punctuation">{</span>        test<span class="token punctuation">:</span> <span class="token regex">/\.png|jpg|gif$/</span><span class="token punctuation">,</span>        use<span class="token punctuation">:</span> <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> <span class="token punctuation">{</span>            limit<span class="token punctuation">:</span> <span class="token number">200</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token comment" spellcheck="true">// 大于 200k 产生文件 小于200k 变成 base64</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// laoders/file-loader.js</span><span class="token keyword">let</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取文件类型</span><span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> <span class="token punctuation">{</span> limit <span class="token punctuation">}</span> <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">&amp;&amp;</span> limit <span class="token operator">></span> source<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 注意此处根据 source.length 判断文件大小</span>    <span class="token comment" spellcheck="true">// 把文件变成 base64</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`module.exports="data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 调用 file-loader 完成此步操作</span>    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./file-loader'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>loader<span class="token punctuation">.</span>row <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader<span class="token punctuation">;</span></code></pre><p>执行编译 npx build，成功~</p><pre class=" language-js"><code class="language-js">Time<span class="token punctuation">:</span> 437msBuilt at<span class="token punctuation">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">32</span>                               Asset      Size  Chunks             Chunk Names                           bundle<span class="token punctuation">.</span>js  <span class="token number">4.65</span> KiB    main  <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  mainc37f803ecaf165e89ca5344e6120b7af<span class="token punctuation">.</span>png   <span class="token number">693</span> KiB          <span class="token punctuation">[</span>emitted<span class="token punctuation">]</span>  Entrypoint main <span class="token operator">=</span> bundle<span class="token punctuation">.</span>js<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">]</span> <span class="token number">508</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span><span class="token keyword">public</span><span class="token punctuation">.</span>png<span class="token punctuation">]</span> <span class="token number">53</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 模块化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>http缓存策略</title>
      <link href="/2020/10/12/liu-lan-qi-huan-cun-ce-lue/"/>
      <url>/2020/10/12/liu-lan-qi-huan-cun-ce-lue/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是缓存"><a href="#什么是缓存" class="headerlink" title="什么是缓存"></a>什么是缓存</h1><p> 是应用程序中很重要的一个概念，在有大量数据交换的应用程序中，我们会采取一些方式将那些实时性要求不高的数据生成副本并存储在某个相对来说可快速到达、访问、获取的仓库，这样在需要这些数据的时候我们直接从这个仓库中获取数据。</p><h1 id="缓存带来的好处"><a href="#缓存带来的好处" class="headerlink" title="缓存带来的好处"></a>缓存带来的好处</h1><ol><li>提升数据交换的性能（速度）</li><li>缓解服务器或数据库的压力</li></ol><h1 id="缓存策略"><a href="#缓存策略" class="headerlink" title="缓存策略"></a>缓存策略</h1><p>HTTP缓存分为强缓存和协商缓存两种，其中强缓存的优先级最高，在浏览器没有命中强缓存的情况下，会选择协商缓存。注意：强缓存和协商缓存的资源文件全部取自本地缓存。</p><h2 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h2><ol><li>不会发送http请求到服务器，状态码200, 缓存空间为 <font style="font-weight: 900;">memory cache</font>(内存存储, 浏览器或页面标签关闭后内存中的缓存就会被释放) 或者 <font style="font-weight: 900;">disk cache</font>(硬盘存储, 浏览器或页面标签关闭后硬盘中的缓存不会消失，下次进入页面还能从硬盘中获取)</li><li>根据两个字段判断是否命中缓存，分别是 expires(http1.0) 和 cache-control (http1.1，优先级大于expires), 为了向下兼容，两者一般同时设置</li></ol><p><strong>expires: -1 | 绝对时间(Thu Jul 16 2020 14:22:59 GM)</strong> </p><blockquote><p>首次加载，响应头包含此字段，下次访问，服务器会对比本地时间和expires，这个资源在这个时间点之前都可以直接从缓存中获取。<br>expires依赖于本地时间，如果服务端与客户端设置的时间不同，或者手动改变了本地时间，就会出现问题，不能达到预期的效果。</p></blockquote><p><strong>cache-control: public, max-age=7200</strong></p><blockquote><p>这是一个相对时间（单位：秒），这里代表资源的缓存在这个请求之后的2小时内都有效。</p></blockquote><h2 id="协商缓存-对比缓存"><a href="#协商缓存-对比缓存" class="headerlink" title="协商缓存(对比缓存)"></a>协商缓存(对比缓存)</h2><ol><li>会发送http请求到服务器，命中时状态码为200，意为not modified，标识服务器文件并没有改变，本地缓存空间的文件仍然可用, 此时状态码为304</li><li>根据两对字段判断是否命中缓存，分别是Last-Modified / If-Modified-Since 和 Etag / If-None-Match (优先级高)</li></ol><p><strong>Last-Modified / If-Modified-Since：绝对时间(Thu Jul 16 2020 14:22:59 GM)</strong></p><blockquote><p>第一次访问一个资源的时候，服务器会在response header中返回一个Last-Modified，代表这个资源最后的修改时间，当浏览器再次访问这个资源的时候，会在request header中带上 If-Modified-Since，值为上次请求时服务器返回的 Last-Modified 的值，然后服务器根据资源上次修改的时间确认资源在这段期间内是否更改过，如果没有，则返回304，如果有，则返回200并返回最新的资源。但是这样会有个问题，如果资源的修改时间变了，但是内容却没变，这是再利用Last-Modified来计算是否需要重新响应这无疑会带来资源浪费，所以Etag诞生了</p></blockquote><p><strong>Etag / If-None-Match：’5b506e03-25856’</strong> </p><blockquote><p> Etag是通过一个校验码来对比资源是否更改过的，而不是通过资源的修改时间。当一个资源修改时，其校验码也会更改。当浏览器请求资源时，服务器会返回一个Etag字段，然后浏览器下一次请求时，会带上 If-None-Match ，值为上次服务器返回的Etag的值，服务器经过校验码的对比后决定返回200或304。</p></blockquote><p>Etag和Last-Modified优先级</p><blockquote><p>Etag可以解决 Last-Modified 不太好处理的问题，Etag能更准确地控制缓存，因此，如果http请求中若同时出现Etag和Last-Modified，Etag的优先级是高于 Last-Modified 的。具体地说，Last-Modified 有以下一些问题：</p><ol><li>一些文件也许会周期性的更改，但是他的内容并不改变(仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新GET；</li><li>某些文件修改非常频繁，比如在秒以下的时间内进行修改，(比方说1s内修改了N次)，If-Modified-Since能检查到的粒度是s级的，这种修改无法判断(或者说UNIX记录MTIME只能精确到秒)；</li><li>某些服务器不能精确的得到文件的最后修改时间。</li></ol></blockquote><p><strong>拓展:</strong><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjvwdln8qlj30l10dodhf.jpg" alt></p> <font style="background: #f9f2f4; color: #c7254e;padding: 3px 5px; border-radius: 5px;">强 ETag 要求资源在字节级别必须完全相符，弱 ETag 在值前有个“W/”标记，只要求资源在语义上没有变化，但内部可能会有部分发生了改变（例如 HTML 里的标签顺序调整，或者多了几个空格）。</font><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.jianshu.com/p/c78b5de7a889" target="_blank" rel="noopener">详解Http缓存策略</a><br><a href="https://blog.csdn.net/zhanghuimin_0214/article/details/105619895" target="_blank" rel="noopener">浏览器缓存机制与缓存策略</a></p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>彻底搞懂EventLoop</title>
      <link href="/2020/10/11/yi-wen-che-di-gao-dong-eventloop/"/>
      <url>/2020/10/11/yi-wen-che-di-gao-dong-eventloop/</url>
      
        <content type="html"><![CDATA[<h1 id="浏览器工作原理"><a href="#浏览器工作原理" class="headerlink" title="浏览器工作原理"></a>浏览器工作原理</h1><div style="word-break: break-all">首先，浏览器本身是multi-process(多进程)架构，顶层只有一个 Brower Process(浏览器进程)用以协调浏览器的其它进程，负责管理Tabs，协调Renderer Process(渲染进程)和其他进程(Plugin Process、GPU Process等，这里暂且只关注渲染进程)，<font style="color: #c7254e;">在chrome中，一个Tab对应一个渲染进程，渲染进程是多线程的，其中main thread负责页面渲染(GUI render engine)，JS执行(JS engine) 和 event loop;</font> 值得一提的是，network component 可以开2~6个 I/O thread平行去处理;</div><h1 id="JS单线程的含义"><a href="#JS单线程的含义" class="headerlink" title="JS单线程的含义"></a>JS单线程的含义</h1><p>JS是一门单线程语言，在html5中虽然提出了web-worker，但javascript是单线程这一核心仍未改变。所以一切javascript版的”多线程”都是单线程模拟出来的，一切javascript多线程都是纸老虎！</p><h1 id="浏览器下的事件循环"><a href="#浏览器下的事件循环" class="headerlink" title="浏览器下的事件循环"></a>浏览器下的事件循环</h1><p>既然js是单线程，那就像只有一个窗口的银行，客户需要排队一个一个办理业务，同理js任务也要一个一个顺序执行。如果一个任务耗时过长，那么后一个任务也必须等着。那么问题来了，假如我们想浏览新闻，但是新闻包含的超清图片加载很慢，难道我们的网页要一直卡着直到图片完全显示出来？因此聪明的程序员将任务分为两类：</p><ul><li>同步任务</li><li>异步任务</li></ul><p>当我们打开网站时，网页的渲染过程就是一大堆同步任务，比如页面骨架和页面元素的渲染。而像加载图片音乐之类占用资源大耗时久的任务，就是异步任务。关于这部分有严格的文字定义，但本文的目的是用最小的学习成本彻底弄懂执行机制，所以我们用导图来说明：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjl9iu0fvxj30vw0qojta.jpg" alt></p><ul><li>同步和异步任务分别进入不同的执行”场所”，同步的进入主线程，异步的进入Event Table并注册函数。</li><li>当指定的事情完成时，Event Table会将这个函数移入Event Queue。</li><li>主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行。</li><li>上述过程会不断重复，也就是常说的Event Loop(事件循环)。</li></ul><p>我们不禁要问了，那怎么知道主线程执行栈为空啊？js引擎存在monitoring process进程，会持续不断的检查主线程执行栈是否为空，一旦为空，就会去Event Queue那里检查是否有等待被调用的函数。</p><h5>执行规则</h5><ul><li>首先在执行栈（call stack）中的内容执行完毕清空后，会在事件队列（Event queue）检查一下哪些是宏任务哪些是微任务，然后执行所有的微任务(其中会将微任务执行当中新注册的微任务一并调用执行完)，然后执行一个宏任务，之后再次执行所有的微任务。也就是说在主线程（main thread）任务执行完毕后会把任务队列中的微任务全部执行，然后再执行一个宏任务，这个宏任务执行完再次检查队列内部的微任务，有就全部执行没有就再执行一个宏任务。</li><li>JS是单线程但是浏览器是多线程。你的异步任务是浏览器开启对应的线程来执行的，最后放入JS引擎中进行执行。</li><li>所以在执行定时器、事件、ajax这些异步事件的时候是另外三个线程在执行代码，并不是JS引擎在做事情，在这些线程达到某一特定事件把任务放入JS引擎的线程中，同时GUI线程（渲染界面HTMl的线程）与JS线程是互斥的，在JS引擎执行时GUI线程会被冻结、挂起。</li></ul><h1 id="宏任务和微任务"><a href="#宏任务和微任务" class="headerlink" title="宏任务和微任务"></a>宏任务和微任务</h1><p>宏任务 macrotask, 也叫tasks，包括:</p><ul><li>整体代码script(整体script作为第一个宏任务进入主线程)</li><li>setTimeout</li><li>setInterval</li><li>setImmediate (Node独有)</li><li>requestAnimationFrame (浏览器独有, 更准确的说它不属于宏任务也不属于微任务)</li><li>I/O</li><li>UI rendering (浏览器独有)</li></ul><p>微任务microtask, 也叫jobs, 包括:</p><ul><li>Promise.then catch finally (注意不是说 Promise，new promise直接执行)</li><li>process.nextTick(优先级最高)</li><li>MutationObserver(用来监视DOM变动)</li><li>Object.observe</li></ul><p>说了这么多文字，不如直接一段代码更直白：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    url<span class="token punctuation">:</span>www<span class="token punctuation">.</span>javascript<span class="token punctuation">.</span>com<span class="token punctuation">,</span>    data<span class="token punctuation">:</span>data<span class="token punctuation">,</span>    success<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送成功!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'代码执行结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>上面是一段简易的ajax请求代码：</p><ul><li>ajax进入Event Table，注册回调函数success。</li><li>执行console.log(‘代码执行结束’)。</li><li>ajax事件完成，回调函数success进入Event Queue。</li><li>主线程从Event Queue读取回调函数success并执行。</li></ul><h1 id="又爱又恨的setTimeout"><a href="#又爱又恨的setTimeout" class="headerlink" title="又爱又恨的setTimeout"></a>又爱又恨的setTimeout</h1><p>大名鼎鼎的setTimeout无需再多言，大家对他的第一印象就是异步可以延时执行，我们经常这么实现延时3秒执行：</p><pre class=" language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>   <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'立即执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>根据前面我们的结论，setTimeout是异步的，应该先执行console.log这个同步任务，所以我们的结论是：</p><pre><code>  1. 执行console &quot;立即执行&quot;  2. task()</code></pre><p>去验证一下，结果正确！</p><p>然后我们修改一下前面的代码：</p><pre class=" language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等10000秒</span></code></pre><p>乍一看其实差不多嘛，但我们把这段代码在chrome执行一下，却发现控制台执行task()需要的时间远远超过3秒，说好的延时三秒，为啥现在需要这么长时间啊？<br>这时候我们需要重新理解setTimeout的定义。我们先说上述代码是怎么执行的：</p><ul><li>task()进入Event Table并注册,计时开始。</li><li>执行sleep函数，很慢，非常慢，计时仍在继续。</li><li>3秒到了，计时事件timeout完成，task()进入Event Queue，但是sleep也太慢了吧，还没执行完，只好等着。</li><li>sleep终于执行完了，task()终于从Event Queue进入了主线程执行。</li></ul><p>上述的流程走完，我们知道setTimeout这个函数，是经过指定时间后，把要执行的任务(本例中为task())加入到Event Queue中，又因为是单线程任务要一个一个执行，如果前面的任务需要的时间太久，那么只能等着，导致真正的延迟时间远远大于3秒。</p><p>我们还经常遇到setTimeout(fn,0)这样的代码，0秒后执行又是什么意思呢？是不是可以立即执行呢？</p><p>答案是不会的，setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，意思就是不用再等多少秒了，只要主线程执行栈内的同步任务全部执行完成，栈为空就马上执行。举例说明：</p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 代码1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'先执行这里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行啦'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 先执行这里</span><span class="token comment" spellcheck="true">// 执行啦</span><span class="token comment" spellcheck="true">// 代码2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'先执行这里'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行啦'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 先执行这里</span><span class="token comment" spellcheck="true">// ... 3s later</span><span class="token comment" spellcheck="true">// 执行啦</span></code></pre><p><font style="font-weight: 900;">关于setTimeout要补充的是，即便主线程为空，0毫秒实际上也是达不到的。根据HTML的标准，最低是4毫秒。</font>有兴趣的同学可以自行了解。[存疑]</p><h1 id="又恨又爱的setInterval"><a href="#又恨又爱的setInterval" class="headerlink" title="又恨又爱的setInterval"></a>又恨又爱的setInterval</h1><p>上面说完了setTimeout，当然不能错过它的孪生兄弟setInterval。他俩差不多，只不过后者是循环的执行。对于执行顺序来说，setInterval会每隔指定的时间将注册的函数置入Event Queue，如果前面的任务耗时太久，那么同样需要等待。</p><p>唯一需要注意的一点是，对于setInterval(fn,ms)来说，我们已经知道不是每过ms秒会执行一次fn，而是每过ms秒，会有fn进入Event Queue。<font style="font-weight: 900;">一旦setInterval的回调函数fn执行时间超过了延迟时间ms，那么就完全看不出来有时间间隔了</font>。这句话请读者仔细品味。</p><h1 id="Promise-与-process-nextTick-callback"><a href="#Promise-与-process-nextTick-callback" class="headerlink" title="Promise 与 process.nextTick(callback)"></a>Promise 与 process.nextTick(callback)</h1><p>传统的定时器我们已经研究过了，接着我们探究Promise与process.nextTick(callback)的表现。</p><p>Promise的定义和功能本文不再赘述，而process.nextTick(callback)类似Node版的”setTimeout”，<font style="font-weight: 900; word-break: break-all;">它是在本轮循环执行的，而且是所有异步任务里面最快执行的。Node 执行完所有同步任务，接下来就会执行process.nextTick的任务队列。</font></p><p>我们进入正题，除了广义的同步任务和异步任务，我们对任务有更精细的定义：</p><ul><li>macro-task(宏任务)：包括整体代码script，setTimeout，setInterval</li><li>micro-task(微任务)：Promise，process.nextTick</li></ul><p>不同类型的任务会进入对应的Event Queue，比如setTimeout和setInterval会进入相同的Event Queue。</p><p>事件循环的顺序，决定js代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。听起来有点绕，我们用一段代码说明：</p><pre class=" language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`then: val = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> val <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>这段代码作为宏任务，进入主线程。</li><li>先遇到setTimeout，那么将其回调函数注册后分发到宏任务Event Queue。(注册过程与上同，下文不再描述)</li><li>接下来遇到了Promise，new Promise立即执行，then函数分发到微任务Event Queue。</li><li>遇到console.log()，立即执行。</li><li>好啦，整体代码script作为第一个宏任务执行结束，看看有哪些微任务？我们发现了then在微任务Event Queue里面，执行。</li><li>ok，第一轮事件循环结束了，我们开始第二轮循环，当然要从宏任务Event Queue开始。我们发现了宏任务Event Queue中setTimeout对应的回调函数，立即执行。</li><li>结束。<pre><code>// promise// console // then: val = 1// setTimeout</code></pre>事件循环，宏任务，微任务的关系如图所示<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjlb89r7cvj30vu0qojt5.jpg" width="500"></li></ul><p>我们来分析一段较复杂的代码，看看你是否真的掌握了js的执行机制：</p><pre class=" language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>第一轮事件循环流程分析如下：</p><ul><li>整体script作为第一个宏任务进入主线程，遇到console.log，输出1。</li><li>遇到setTimeout，其回调函数被分发到宏任务Event Queue中。我们暂且记为setTimeout1。</li><li>遇到process.nextTick()，其回调函数被分发到微任务Event Queue中。我们记为process1。</li><li>遇到Promise，new Promise直接执行，输出7。then被分发到微任务Event Queue中。我们记为then1。</li><li>又遇到了setTimeout，其回调函数被分发到宏任务Event Queue中，我们记为setTimeout2。</li></ul><table><thead><tr><th align="center">宏任务Event Queue(tasks queue)</th><th align="left">微任务Event Queue(jobs queue)</th></tr></thead><tbody><tr><td align="center">setTimeout1</td><td align="left">process1</td></tr><tr><td align="center">setTimeout2</td><td align="left">then1</td></tr></tbody></table><ul><li>上表是第一轮事件循环宏任务结束时各Event Queue的情况，此时已经输出了1和7。</li><li>我们发现了process1和then1两个微任务。</li><li>执行process1,输出6。</li><li>执行then1，输出8。</li></ul><p>好了，第一轮事件循环正式结束，这一轮的结果是输出1，7，6，8。那么第二轮时间循环从setTimeout1宏任务开始：</p><ul><li>首先输出2。接下来遇到了process.nextTick()，同样将其分发到微任务Event Queue中，记为process2。new Promise立即执行输出4，then也分发到微任务Event Queue中，记为then2。</li></ul><table><thead><tr><th align="center">宏任务Event Queue(tasks queue)</th><th align="left">微任务Event Queue(jobs queue)</th></tr></thead><tbody><tr><td align="center">setTimeout2</td><td align="left">process2</td></tr><tr><td align="center"></td><td align="left">then2</td></tr></tbody></table><ul><li>第二轮事件循环宏任务结束，我们发现有process2和then2两个微任务可以执行。</li><li>输出3。</li><li>输出5。</li><li>第二轮事件循环结束，第二轮输出2，4，3，5。</li><li>第三轮事件循环开始，此时只剩setTimeout2了，执行。</li><li>直接输出9。</li><li>将process.nextTick()分发到微任务Event Queue中。记为process3。</li><li>直接执行new Promise，输出11。</li><li>将then分发到微任务Event Queue中，记为then3。</li></ul><table><thead><tr><th align="center">宏任务Event Queue(tasks queue)</th><th align="left">微任务Event Queue(jobs queue)</th></tr></thead><tbody><tr><td align="center"></td><td align="left">process3</td></tr><tr><td align="center"></td><td align="left">then3</td></tr></tbody></table><ul><li>第三轮事件循环宏任务执行结束，执行两个微任务process3和then3。</li><li>输出10。</li><li>输出12。</li><li>第三轮事件循环结束，第三轮输出9，11，10，12。<br>整段代码，共进行了三次事件循环，完整的输出为1，7，6，8，2，4，3，5，9，11，10，12。<br>(请注意，node环境下的事件监听依赖libuv与前端环境不完全相同，输出顺序可能会有误差)</li></ul><h1 id="Node下的-Event-Loop"><a href="#Node下的-Event-Loop" class="headerlink" title="Node下的 Event Loop"></a>Node下的 Event Loop</h1><p>基于libuv(c 语⾔实现的⼀个⾼性能异步⾮阻塞 IO 库，⽤来实现 node.js 的事件循环)实现，而libuv是 Node 的新跨平台抽象层，libuv使用异步IO事件驱动的编程方式，核心是提供i/o的事件循环和异步回调。libuv的API包含有时间，非阻塞的网络，异步文件操作，子进程等等。Node.js 中，先执行全局script代码，执行完同步代码调用栈清空后，先从微任务队列 Next Tick Queue中依次取出所有任务放入调用栈中执行，再从微任务队列 other Microtask Queue中依次取出所有任务放到调用栈中执行。然后开始宏任务的6个阶段，每个阶段都将该宏任务队列中所有任务都取出来执行(注意, 这里和浏览器不一样，浏览器只取一个)，每个宏任务阶段执行完毕后，开始执行微任务，再开始执行下一阶段宏任务，以此构成事件循环。</p><h2 id="Node-Event-Loop执行的六个阶段"><a href="#Node-Event-Loop执行的六个阶段" class="headerlink" title="Node Event Loop执行的六个阶段"></a>Node Event Loop执行的六个阶段</h2><ul><li><p>timers：执行setTimeout() 和 setInterval()中到期的callback。</p></li><li><p>pending callback: 上一轮循环中有少数的I/O callback会被延迟到这一轮的这一阶段执行</p></li><li><p>idle, prepare：仅内部使用</p></li><li><p>poll: 最为重要的阶段，执行I/O callback，在适当的条件下会阻塞在这个阶段</p></li><li><p>check: 执行setImmediate的callback</p></li><li><p>close callbacks: 执行close事件的callback，例如socket.on(‘close’[,fn])、http.server.on(‘close, fn)</p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjlnt5htktj31090u0aee.jpg" width="400"></li><li><p>Node 事件循环每个阶段都会有对应的宏任务队列(注意，6个阶段对应4个宏任务队列，宏任务队里一般不考虑Idle和poll), 每个阶段宏任务队列执行完毕，都会执行微任务队列, 如此往复执行。</p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjlnxksntnj30si17aaid.jpg" width="400"></li></ul><h2 id="Node-JS-event-loop-过程"><a href="#Node-JS-event-loop-过程" class="headerlink" title="Node JS event loop 过程"></a>Node JS event loop 过程</h2><ol><li>执行全局script代码</li><li>执行microtask 微任务，最优先执行 Next Tick Queue (process.nextTick所在的微任务队列) 任务，再执行其他微任务队列中的任务。</li><li>开始执行宏任务，共6个阶段，<font style="font-weight: 900;">从第一个阶段开始执行相应的每一个阶段中的macrotask队列中的所有任务</font>， 注意，这里是所有每个阶段宏任务队列中的所有任务，在浏览器EventLoop中只取宏任务队列的第一个任务出来执行，每一个阶段的宏任务队列执行完毕后，开始执行微任务，也就是重复步骤2。</li><li>Timer Queue -&gt; 步骤2 -&gt; I/O Queue -&gt; 步骤2 -&gt; Check queue -&gt; 步骤2 -&gt; Close Callback Queue -&gt; 步骤2 -&gt; Timer Queue…</li><li>下图就是Node中的Event Loop【简化版】<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjlqpjhjjbj30rs0g3wfg.jpg" width="500"></li></ol><h5>小试牛刀</h5><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// node.js</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise resolve'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// timeout1</span>  <span class="token comment" spellcheck="true">// timeout2</span>  <span class="token comment" spellcheck="true">// timeout3</span>  <span class="token comment" spellcheck="true">// timeout4</span>  <span class="token comment" spellcheck="true">// promise resolve</span></code></pre><h1 id="Node与浏览器的-Event-Loop-差异"><a href="#Node与浏览器的-Event-Loop-差异" class="headerlink" title="Node与浏览器的 Event Loop 差异"></a>Node与浏览器的 Event Loop 差异</h1><ol><li>浏览器的Event Loop 和 Node.js 的 Event Loop 是不同的，实现机制也不一样，不能混为一谈</li><li>Node.js 可以理解成有多个宏任务队列(4个)和2个微任务队列(Next Tick Queue 和 Other Microtask Queue)，浏览器的eventloop 中 只存在一个宏任务队列和1个微任务队列。</li><li>浏览器环境下，microtask的任务队列是每个macrotask执行完之后执行，而在Node.js中，microtask会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行microtask队列的任务。从任务调度的角度上来看，node 的事件循环机制要高效、省时一些。</li></ol><h1 id="setTimeout-与-setImmediate"><a href="#setTimeout-与-setImmediate" class="headerlink" title="setTimeout 与 setImmediate"></a>setTimeout 与 setImmediate</h1><p>setImmediate()方法用于中断长时间运行的操作，并在完成其他操作后立即运行回调函数。</p><h5>setTimeout 与 setImmediate执行顺序不固定，取决于node的准备时间。</h5><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// node 环境运行</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// setTimeout</span>  <span class="token comment" spellcheck="true">// setImmediate</span>  或  <span class="token comment" spellcheck="true">// setImmediate</span>  <span class="token comment" spellcheck="true">// setTimeout</span></code></pre><p>为什么结果不确定呢？<br>setTimeout/setInterval第二个参数的取值范围是[1, 2^31 - 1], 如果超过这个范围则会初始化为1ms(这里讨论的是设定值的范围，不是具体执行代码的时间)， 也就是setTimeout(fn, 0) == setTimeout(fn, 1)<br>我们知道setTimeout的回调是在timer阶段执行的，setImmediate是在check阶段执行，因为eventloop的开始会先检查timer阶段有没有需要执行的任务，但是在开始之前到timer阶段需要消耗一段时间(执行整体script消耗的时间)。所以会出现2种情况:</p><ol><li>timer前的准备时间大于等于1ms，检查timer阶段时，setTimeout回调已被放入宏任务队列。此时先执行setTimeout回调，再执行check阶段的setImmediate回调, 输出 setTimeout &gt; setImmediate</li><li>timer前的准备时间小于1ms, 则先执行check阶段的setImmediate回调，下一轮循环的timer阶段执行setTimeout回调</li></ol><p>如果我们想要确保setTimeout先执行怎么办? 延迟script代码执行 到 检查timer 之间的时间即可</p><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// node 环境运行</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 增加同步代码执行时间</span></code></pre><p>这样输出就能保证setTimeout在前。</p><p>那如果我们想确保setImmediate在前怎么办呢？设想如果node代码运行起始阶段就在timer之后、check之前, 不就能保证setImmediate先执行了么。如下图，如果我们把代码包在I/O回调中，就可以了<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjlshlpwcvj30mg0i4jsh.jpg" width="400"></p><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// node 代码实现</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这样输出就能保证setImmediate在前。</p><h1 id="一些特殊的点"><a href="#一些特殊的点" class="headerlink" title="一些特殊的点"></a>一些特殊的点</h1><ul><li>async 隐式返回 Promise 作为结果，执行完 await 之后直接跳出 async 函数，让出执行的所有权，当前任务的其他代码执行完之后再次获得执行权进行执行</li><li>立即 resolve 的 Promise 对象，是在本轮”事件循环”的结束时执行，而不是在下一轮”事件循环”的开始时</li><li>在一轮event loop中多次修改同一dom，只有最后一次会进行绘制。</li><li>渲染更新（Update the rendering）会在event loop中的tasks和microtasks完成后进行，但并不是每轮event loop都会更新渲染，这取决于是否修改了dom和浏览器觉得是否有必要在此时立即将新状态呈现给用户。如果在一帧的时间内（时间并不确定，因为浏览器每秒的帧数总在波动，16.7ms只是估算并不准确）修改了多处dom，浏览器可能将变动积攒起来，只进行一次绘制，这是合理的。</li><li>如果希望在每轮event loop都即时呈现变动，可以使用requestAnimationFrame。</li></ul><h1 id="不一样的-node-11"><a href="#不一样的-node-11" class="headerlink" title="不一样的 node 11"></a>不一样的 node 11</h1><pre class=" language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>考虑以上代码，了解node的eventloop的同学应该会这样想：</p><ol><li>理想情况下这个就是一开始将两个setTimeout放进timers的阶段。</li><li>等到时间到达后运行timer1，把promise1的Promise放入timers的下一阶段微任务队列中，同理继续运行timers的阶段，执行timer2，把promise2的Promise放入timers的下一阶段微任务队列中。</li><li>直到timers队列全部执行完，才开始运行微任务队列，也就是promise1和promise2.<br>那么如果机器运行良好就是以下结果：<pre class=" language-js"><code class="language-js">timer1timer2promise1promise2</code></pre>node10运行结果确实是这样，是没问题的。但node11运行后居然是：<pre class=" language-js"><code class="language-js">timer1promise1timer2promise2</code></pre></li></ol><p><strong>可以看到，执行了一个 setTimeout 之后，立刻执行了微任务</strong></p><p><strong>那么为什么要这么做呢？</strong><br>当然是为了和浏览器更加趋同。</p><p>了解浏览器的eventloop可能就知道，浏览器的宏任务队列执行了一个，就会执行微任务。</p><p>简单的说，可以把浏览器的宏任务和node10的timers比较，就是node10只有全部执行了timers阶段队列的全部任务才执行微任务队列，而浏览器只要执行了一个宏任务就会执行微任务队列。</p><p>现在node11在timer阶段的setTimeout,setInterval…和在check阶段的immediate都在node11里面都修改为一旦执行一个阶段里的一个任务就立刻执行微任务队列。</p><h1 id="常见面试题"><a href="#常见面试题" class="headerlink" title="常见面试题"></a>常见面试题</h1><pre class=" language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'microtask in microtask'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after return'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>val2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">,</span> val2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>val3<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then3'</span><span class="token punctuation">,</span> val3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'同步代码'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 同步代码 -> 0 -> microtask in microtask -> then2, 100 > then3, undefined</span></code></pre><pre class=" language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// script start->async2 end->Promise->script end->async1 end->promise1->promise2->setTimeout </span></code></pre><p><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Event Loop可视化演绎</a></p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>时间复杂度和空间复杂度</title>
      <link href="/2020/10/04/shi-jian-fu-za-du-he-kong-jian-fu-za-du/"/>
      <url>/2020/10/04/shi-jian-fu-za-du-he-kong-jian-fu-za-du/</url>
      
        <content type="html"><![CDATA[<h1 id="时间复杂度和空间复杂度"><a href="#时间复杂度和空间复杂度" class="headerlink" title="时间复杂度和空间复杂度"></a>时间复杂度和空间复杂度</h1><blockquote><p>注：时间复杂度和空间复杂度本身如果要严格意义的数学证明的话，它的公式比较繁复，而且很多时间让人觉得望而却步，不建议大家看这么严谨的数学证明。</p></blockquote><h2 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h2><h3 id="BIG-O-notation-大O符号表示法"><a href="#BIG-O-notation-大O符号表示法" class="headerlink" title="BIG O notation (大O符号表示法)"></a>BIG O notation (大O符号表示法)</h3><blockquote><ol><li>大O符号（Big O notation）是用于描述函数渐进行为的数学符号。更确切地说，它是用另一个（通常更简单的）函数来描述一个函数数量级的渐近上界。在数学中，它一般用来刻画被截断的无穷级数尤其是渐近级数的剩余项；在计算机科学中，它在分析算法复杂性的方面非常有用。<a href="https://baike.baidu.com/item/%E5%A4%A7O%E7%AC%A6%E5%8F%B7/656100?fr=aladdin" target="_blank" rel="noopener">百度百科-大O符号</a></li><li>注：O(1)不代表时间复杂度就是1，也可能是2、3、4等，只是所有这些常数复杂度，在 BIG O 表示法中称为 O(1) 复杂度, 其实也可以称之为常数复杂度，O(n) 线性时间复杂度可能运行了n次，也可能运行了2n次，在 BIG O 表示法中一律称为O(n), 所以前面的常数系数是不用考虑的。</li></ol></blockquote><ul><li>O(1): Constant Complexity 常数复杂度</li><li>O(logn): Logarithmic Complexity 对数复杂度</li><li>O(n): Linear Complexity 线性时间复杂度</li><li>O(n²): N square Complexity 平方</li><li>O(n³): N cubic Complexity 立方</li><li>O(2^n): Exponential Growth 指数</li><li>O(n!): Facorial 阶乘 </li></ul><p>怎么去看一段代码的时间复杂度呢，我们通常需要关注的是, 这个函数或者说这段代码根据n的不同情况，它会运行多少次。</p><h3 id="常数复杂度代码解析"><a href="#常数复杂度代码解析" class="headerlink" title="常数复杂度代码解析"></a>常数复杂度代码解析</h3><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// 代码块1 时间复杂度为 O(1)</span>  <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 代码块2 时间复杂度为 O(?)</span>  <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>代码块1, 不管n等于多少, 都只输出了一次，所以时间复杂度为O(1)<br>代码块2, 不管n等于多少，都只输出了三次, 所以时间时间复杂度也为O(1)</p></blockquote><h3 id="线性、平方、立方时间复杂度代码解析"><a href="#线性、平方、立方时间复杂度代码解析" class="headerlink" title="线性、平方、立方时间复杂度代码解析"></a>线性、平方、立方时间复杂度代码解析</h3><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// O(n)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`hey - I am busy looking at: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> i <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// O(n²)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`hey - I am busy looking at: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> i <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> j <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// O(n³)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`hey - I am busy looking at: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> i <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> j <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> k <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>第一段代码, n 为 1时, 执行一次，n 等于 100时, 输出100次, 符合线性时间复杂度的条件 执行次数为 常数 * n, 表示为 O(n)<br>第二段代码, n 为 1时, 执行一次，n 等于 3时，输出9次, 符合平方时间复杂度的条件 执行次数为 n², 表示为 O(n²)<br>第三代代码同理, 我们扩展一下 如果把第二段代码由一个嵌套的结构写成并列的，那么它的时间复杂度是多少?</p></blockquote><pre class=" language-js"><code class="language-js">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 观察得之，n = 1，输出了2次，n = 2， 输出了4次，n = 3， 输出了6次， 也就是说最深层代码会执行 2 * n次，时间复杂度为 O(2n), 也就是 O(n)</span></code></pre><h3 id="对数时间复杂度代码解析"><a href="#对数时间复杂度代码解析" class="headerlink" title="对数时间复杂度代码解析"></a>对数时间复杂度代码解析</h3><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// O(logn)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>如果n为4， 则只会执行2次，如果n为8，则执行3次，可以看出去永远执行 log2(n)次(也就是2的多少次幂), 所以它的时间复杂度为 O(logn)</p></blockquote><h3 id="指数级的时间复杂度-斐波那契数列"><a href="#指数级的时间复杂度-斐波那契数列" class="headerlink" title="指数级的时间复杂度(斐波那契数列)"></a>指数级的时间复杂度(斐波那契数列)</h3><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// 斐波那契数列比较特殊，它的时间复杂度为 O(k^n) 其中k表示一个常数</span>  <span class="token keyword">function</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">fib</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><blockquote><p>怎么分析一个递归函数的时间复杂度呢? 关键点在于我们需要了解他的递归总共执行了这个语句多少次，如果是简单的循环很好理解，n次就执行了n次，递归的话因为层层嵌套，变得异常复杂，这时我们往往需要借助画一个树形结构来理解递归，我们称之为递归状态的递归树或者状态树。 我们知道 斐波那契数列为: 0, 1, 1, 2, 3, 5, 8, 13, 21…, 面试时通常有人会写出以上最最简单的递归写法，这段语句的话，它的时间复杂度我们来分析下。我们假设 n 初始值为6, 我们要计算第六位数字，这个时候执行fib(6)会引出fib(5)和fib(4), 同理可得, fib(5)计算的话, 需要计算 fib(4)和fib(3), 可以看出一个节点执行都会引出两个分支, 用状态树来表示的话:<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjdp58k58zj31wc0u01kx.jpg" alt><br>我们可以看出, 每个节点都会往下展开为2个节点(不管此节点有没有计算过), 所以求第六个数的时候，就变成了2^6这样一个繁复的时间复杂度。</p></blockquote><h3 id="时间复杂度曲线"><a href="#时间复杂度曲线" class="headerlink" title="时间复杂度曲线"></a>时间复杂度曲线</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjdoawkulzj319h0u0qqw.jpg" alt></p><blockquote><p>我们可以看到，当n比较小(运算数量级小)的时候，也就是 n 小于4时，不同的时间复杂度其实差不多，当n增大的时候，会发现指数级(当然还有阶乘)涨的是非常快的, 也就是说如果你在写一段程序中，把指数级(2^n) 降到平方级(n²)的话，那么从这个曲线来看，当n较大时，你得到的收益是非常高的。</p></blockquote><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// 求 1到n的循环累加</span>  <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 代码段1 暴力求解法  时间复杂度 O(n)</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    sum <span class="token operator">+</span><span class="token operator">=</span> i<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 代码段2 利用等差数列求和公式求和 因为无论n为多少 都只执行一次(常数次) 所以时间复杂度为 O(1) </span>  sum <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre><blockquote><p>从上图得之, 当n无限大, 带来的收益也是非常大的, 所以不同的代码实现，执行性能上会有区别哦。</p></blockquote><h2 id="递归的四种情形"><a href="#递归的四种情形" class="headerlink" title="递归的四种情形"></a>递归的四种情形</h2><ol><li>二分查找: 一般发生在一个数列本身有序，而且你要在这个有序数列中找到你要的目标数，所以每次都一分为2，只查一边，时间复杂度是 n(logn)</li><li>二叉树遍历: 时间复杂度为 O(n), </li><li><font color="Hotpink"> 排好序的二维矩阵中进行二分查找，根据主定理可以得出，最后的时间复杂度为 O(n)的，一维的矩阵中查找，时间复杂度为 O(logn)</font></li><li><font color="Hotpink"> 归并排序(merge sort): 所有排序中最优的办法，时间复杂度为 O(nlogin)</font></li></ol><h3 id="思考题-都可回答根据主定理-这里不做描述"><a href="#思考题-都可回答根据主定理-这里不做描述" class="headerlink" title="思考题(都可回答根据主定理, 这里不做描述)"></a>思考题(都可回答根据主定理, 这里不做描述)</h3><ol><li>二叉树遍历: 前序、中序、后序：时间复杂度是多少?<blockquote><p>O(n) 不管怎么遍历, 每个节点都只走一次, 有n个节点, 则遍历n次, 线性于这个二叉树的节点总数。</p></blockquote></li><li>图的遍历: 时间复杂度是多少?<blockquote><p>O(n) 同理, 图的每个节点访问一次且只访问一次，所以图的遍历时间复杂度也是线性于图的节点总数。</p></blockquote></li><li>搜索算法: DFS、BFS时间复杂度是多少?<blockquote><p> O(n) 这里的n指的是搜索空间里面的节点总数。</p></blockquote></li><li>二分查找: 时间复杂度是多少？<blockquote><p> O(logn) </p></blockquote></li></ol><h2 id="空间复杂度"><a href="#空间复杂度" class="headerlink" title="空间复杂度"></a>空间复杂度</h2><blockquote><p>空间复杂度与时间复杂度的情况类似，但是更加的简单，我们就直接用最简单的方法来分析即可，<br>如果你的代码包含了一维数组，传入n个元素, 那么空间复杂度就是 O(n), <font color="Hotpink"> 如果开了二维数组, 长度都为n，那么空间复杂度基本上就为n²</font>, 如果有递归，那么递归最大的深度就是空间复杂度的最大债，如果递归和数组同时存在，则两者之间的最大值就是你的空间复杂度。 </p></blockquote><h3 id="斐波那契数列数列递归求解法的空间复杂度分析"><a href="#斐波那契数列数列递归求解法的空间复杂度分析" class="headerlink" title="斐波那契数列数列递归求解法的空间复杂度分析"></a>斐波那契数列数列递归求解法的空间复杂度分析</h3><blockquote><p>在上文递归状态图中我们看到，时间复杂度为O(2^n), 而这段代码没有用到数组，所以它的空间复杂度为 O(n).</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>1. 数组、链表与跳表</title>
      <link href="/2020/10/04/shu-zu-lian-biao-yu-tiao-biao/"/>
      <url>/2020/10/04/shu-zu-lian-biao-yu-tiao-biao/</url>
      
        <content type="html"><![CDATA[<h1 id="数组、链表与跳表"><a href="#数组、链表与跳表" class="headerlink" title="数组、链表与跳表"></a>数组、链表与跳表</h1><h2 id="Array-数组"><a href="#Array-数组" class="headerlink" title="Array ((数组))"></a>Array ((数组))</h2><blockquote><p>数组的话大家应用的应该非常多了, 列举出来他们的常见写法如下</p></blockquote><pre><code>  Java, C++: int a[100]; // 100 表示数组大小  Python: list = [];  Javascript: let list = [1, 2, 3]</code></pre><blockquote><p>数组底层的硬件实现的话，有一个叫做内存管理器的东西，每当你申请一个数组，计算机实际上是在内存中给你开辟了一段连续的地址。每一个地址((该数组上每一个元素所在的地址))都可以通过内存管理器进行访问，下图就为数组相应的内存地址，所以访问第一个元素和访问任意一个元素的时间复杂度是一样的, 也就是常数级的访问，为 O((1))<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjja0kfjfqj31ji0u0b29.jpg" alt></p></blockquote><h3 id="插入元素"><a href="#插入元素" class="headerlink" title="插入元素"></a>插入元素</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((n))</font></p><blockquote><p>如下图, 比如把D插入到3号位置, 那么 E F G都要往下移位置, 在最坏的情况下，整个数组的元素都要挪动，在好的情况下((插入到数组尾部)), 也需要挪动一个数组，平均下来每次都要挪动一半数组, 所以数组插入操作的时间复杂度为 O((n))</p></blockquote><div style="display: flex; justify-content: space-around;">  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjja3heqdqj310x0u00yi.jpg" width="300" height="300" style="height: 300px !important;">  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjja62n56rj31580u0af4.jpg" width="300" height="300" style="height: 300px !important;"></div><h3 id="删除元素"><a href="#删除元素" class="headerlink" title="删除元素"></a>删除元素</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((n))</font></p><blockquote><p>比如删除 Z 元素后, 要把 D E F元素往上移动, 然后把最后一个元素设置为空，唤起垃圾回收机制即可，如果你必须手动管理内存的话，就把这一个数组的size减少即可。</p></blockquote><div style="display: flex; justify-content: space-around;">  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjalti2wpj316b0u0dia.jpg" width="300" height="300" style="height: 300px !important;">  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjammmu67j315k0u043b.jpg" width="300" height="300" style="height: 300px !important;"></div><h3 id="修改元素"><a href="#修改元素" class="headerlink" title="修改元素"></a>修改元素</h3><p><font style="font-weight: 900;"> 如果根据下标修改就是O((1))，如果通过查找就是O((n))</font> </p><h3 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((1))</font><br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjea9om9jj31q60tsady.jpg" alt></p><h2 id="Linked-List-链表"><a href="#Linked-List-链表" class="headerlink" title="Linked List((链表))"></a>Linked List((链表))</h2><blockquote><p>链表这个数据结构就是为了弥补我们前面提到的数组某些操作时间复杂度过高的缺陷, 链表每个节点是什么呢? 一般我们定义个 class Node {  },  里面至少包含2个成员变量value和next，每个节点就是该类的实例化对象啦，next指向下一个元素，串在一起就构成了类似于数组的一个结构。如果只有一个next指针的话，我们叫做<font style="font-weight: 900;">单链表</font>，如果还有个先前指针((prev或者previous))的话，就叫做<font style="font-weight: 900;">双向链表</font>，整个链表的头结点为head, 尾节点为tail, tail节点的指针的next一般指向none，但是如果tail节点的next指回head节点，那么这就叫做<font style="font-weight: 900;">循环链表</font>，类似于一条头尾连接的蜈蚣或环状蛇。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjat9xqudj32550u0n60.jpg" alt></p></blockquote><h3 id="增加节点"><a href="#增加节点" class="headerlink" title="增加节点"></a>增加节点</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((1))</font></p><blockquote><p>插入元素的操作简化为只需要把前面节点的next指向新节点，新节点的next元素指向之前的下一个节点即可，这样的话总共操作两次，是常数次的，所以时间复杂度是 O((1))<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjdoeezotj326s0petjn.jpg" alt></p></blockquote><h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((1)), 同增加节点</font></p><h3 id="修改元素-1"><a href="#修改元素-1" class="headerlink" title="修改元素"></a>修改元素</h3><p><font style="font-weight: 900;"> 如果根据下标修改就是O((1))，如果通过查找就是O((n))</font> </p><h3 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((n))</font></p><blockquote><p>这里我们看到，增加/删除节点时，没有引起整个链表的群移操作，正是因为这样，所以它的增加和删除节点操作的效率非常高，为O((1)), 但是也是因为这样一个结构，导致了你要访问链表中任何一个位置, 它的操作就不再是简单的了，举个例子，要访问头节点和尾结点是很容易的，也就是 O((1)) 即可，但是其他位置必须从头节点一步一步往后挪去访问，时间复杂度是 O((n)), 可以看出，并没有很完美的数据结构, 如果有的话, 也不需要 Array 和 Linked list 并存了。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjje5pmsecj311g0u00zd.jpg" width="300" height="300"></p></blockquote><h3 id="工程中的应用"><a href="#工程中的应用" class="headerlink" title="工程中的应用"></a>工程中的应用</h3><p>LRU Cache 缓存算法</p><h2 id="Skip-list-跳表"><a href="#Skip-list-跳表" class="headerlink" title="Skip list((跳表))"></a>Skip list((跳表))</h2><blockquote><p>链表除了查找元素时间复杂度为O((n))之外，其他都趋近完美，但是如果链表元素本身有序排列的时候这时如果我们要快速查询，比如5在什么地方或者5存不存在，如果是普通的数组可以用二分查找，但是在链表里面怎么办? 怎么有效地加速呢？于是在1990年前后，一种新的数据结构出现了它的名字叫做跳表。如下图：平衡树和二分查找都是19世纪60年代诞生的, 跳表的出现是用来取代平衡树和二分查找的。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjezlga7ej31rc0u0e81.jpg" alt></p></blockquote><p>思考一下：如何给有序的链表查询操作加速呢<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjgt70gswj30vq07gdg4.jpg" alt></p><p>现在我们有个场景，想快速找到上图链表中的 10 这个元素，只能从头开始遍历链表，直到找到我们需要找的元素。查找路径：1、3、4、5、7、8、9、10。这样的查找效率很低，平均时间复杂度很高O((n))。那有没有办法提高链表的查找速度呢？如下图所示，我们从链表中每两个元素抽出来，加一级索引，一级索引指向了原始链表，即：通过一级索引 7 的down指针可以找到原始链表的 7 。那现在怎么查找 10 这个元素呢？</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjgt8rc4sj30vq0diq3q.jpg" alt><br>先在索引找 1、4、7、9，遍历到一级索引的 9 时，发现 9 的后继节点是 13，比 10 大，于是不往后找了，而是通过 9 找到原始链表的 9，然后再往后遍历找到了我们要找的 10，遍历结束。有没有发现，加了一级索引后，查找路径：1、4、7、9、10，查找节点需要遍历的元素相对少了，我们不需要对 10 之前的所有数据都遍历，查找的效率提升了。</p><p>那如果加二级索引呢？如下图所示，查找路径：1、7、9、10。是不是找 10 的效率更高了？这就是跳表的思想，用“空间换时间”，通过给链表建立索引，提高了查找的效率。</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjgt9qwyhj30vq0if0tt.jpg" alt><br>可能同学们会想，从上面案例来看，提升的效率并不明显，本来需要遍历8个元素，优化了半天，还需要遍历 4 个元素，其实是因为我们的数据量太少了，当数据量足够大时，效率提升会很大。如下图所示，假如有序单链表现在有1万个元素，分别是 0~9999。现在我们建了很多级索引，最高级的索引，就两个元素 0、5000，次高级索引四个元素 0、2500、5000、7500，依次类推，当我们查找 7890 这个元素时，查找路径为 0、5000、7500 … 7890，通过最高级索引直接跳过了5000个元素，次高层索引直接跳过了2500个元素，从而使得<font style="font-weight: 900;">链表能够实现二分查找</font>。由此可以看出，当元素数量较多时，索引提高的效率比较大，近似于二分查找。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjgwjmj8hj30yg0anjth.jpg" alt><br>到这里大家应该已经明白了什么是跳表。跳表是可以实现二分查找的有序链表。</p><h3 id="查找元素-1"><a href="#查找元素-1" class="headerlink" title="查找元素"></a>查找元素</h3><p><font style="font-weight: 900;"> 时间复杂度O((logn))</font><br>既然跳表可以提升链表查找元素的效率，那查找一个元素的时间复杂度到底是多少呢？查找元素的过程是从最高级索引开始，一层一层遍历最后下沉到原始链表。所以，时间复杂度 = 索引的高度 * 每层索引遍历元素的个数。</p><p>先来求跳表的索引高度。如下图所示，假设每两个结点会抽出一个结点作为上一级索引的结点，原始的链表有n个元素，则一级索引有n/2 个元素、二级索引有 n/4 个元素、k级索引就有 n/$2^{k}$个元素。最高级索引一般有2个元素，即：最高级索引 h 满足 2 = n/$2^{h}$，即 h = $ log_2n $ - 1，最高级索引 h 为索引层的高度加上原始数据一层，跳表的总高度 h = $ log_2n $。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjh1xw6vpj30vq0c7752.jpg" alt></p><p>我们看上图中加粗的箭头，表示查找元素 x 的路径，那查找过程中每一层索引最多遍历几个元素呢？</p><p>图中所示，现在到达第 k 级索引，我们发现要查找的元素 x 比 y 大比 z 小，所以，我们需要从 y 处下降到 k-1 级索引继续查找，k-1级索引中比 y 大比 z 小的只有一个 w，所以在 k-1 级索引中，我们遍历的元素最多就是 y、w、z，发现 x 比 w大比 z 小之后，再下降到 k-2 级索引。所以，k-2 级索引最多遍历的元素为 w、u、z。其实每级索引都是类似的道理，每级索引中都是两个结点抽出一个结点作为上一级索引的结点。 现在我们得出结论：当每级索引都是两个结点抽出一个结点作为上一级索引的结点时，每一层最多遍历3个结点。</p><p>跳表的索引高度 h = $ log_2n $，且每层索引最多遍历 3 个元素。所以跳表中查找一个元素的时间复杂度为 O(( 3*logn ))，省略常数即：O((logn))。</p><p><font style="font-weight: 900;"> 空间复杂度O((n))</font><br>跳表通过建立索引，来提高查找元素的效率，就是典型的“空间换时间”的思想，所以在空间上做了一些牺牲，那空间复杂度到底是多少呢？</p><p>假如原始链表包含 n 个元素，则一级索引元素个数为 n/2、二级索引元素个数为 n/4、三级索引元素个数为 n/8 以此类推。所以，索引节点的总和是：n/2 + n/4 + n/8 + …  + 8 + 4 + 2 = n-2，空间复杂度是 O((n))。</p><p>如下图所示：如果每三个结点抽一个结点做为索引，索引总和数就是 n/3 + n/9 + n/27 + … + 9 + 3 + 1 = n/2，减少了一半。所以我们可以通过较少索引数来减少空间复杂度，但是相应的肯定会造成查找效率有一定下降，我们可以根据我们的应用场景来控制这个阈值，看我们更注重时间还是空间。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjh33sljzj30vq0aiaae.jpg" alt><br>But，索引结点往往只需要存储 key 和几个指针，并不需要存储完整的对象，所以当对象比索引结点大很多时，索引占用的额外空间就可以忽略了。举个例子：我们现在需要用跳表来给所有学生建索引，学生有很多属性：学号、姓名、性别、身份证号、年龄、家庭住址、身高、体重等。学生的各种属性只需要在原始链表中存储一份即可，我们只需要用学生的学号（int 类型的数据）建立索引，所以索引相对原始数据而言，占用的空间可以忽略。</p><h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><p><font style="font-weight: 900;"> 时间复杂度O((logn))</font><br>插入数据看起来也很简单，跳表的原始链表需要保持有序，所以我们会向查找元素一样，找到元素应该插入的位置。如下图所示，要插入数据6，整个过程类似于查找6，整个的查找路径为 1、1、1、4、4、5。查找到第底层原始链表的元素 5 时，发现 5 小于 6 但是后继节点 7 大于 6，所以应该把 6 插入到 5 之后 7 之前。整个时间复杂度为查找元素的时间复杂度 O((logn))。</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjjh95sje6j30vq0nggmz.jpg" alt></p><h3 id="动态维护索引"><a href="#动态维护索引" class="headerlink" title="动态维护索引"></a>动态维护索引</h3><p>如下图所示，假如一直往原始列表中添加数据，但是不更新索引，就可能出现两个索引节点之间数据非常多的情况，极端情况，跳表退化为单链表，从而使得查找效率从 O(logn) 退化为 O(n)。那这种问题该怎么解决呢？我们需要在插入数据的时候，索引节点也需要相应的增加、或者重建索引，来避免查找效率的退化。那我们该如何去维护这个索引呢？<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmctnh36j30vq0dpjrv.jpg" alt></p><p>比较容易理解的做法就是完全重建索引，我们每次插入数据后，都把这个跳表的索引删掉全部重建，重建索引的时间复杂度是多少呢？因为索引的空间复杂度是 O((n))，即：索引节点的个数是 O((n)) 级别，每次完全重新建一个 O((n)) 级别的索引，时间复杂度也是 O((n)) 。造成的后果是：为了维护索引，导致每次插入数据的时间复杂度变成了 O((n))。</p><p>那有没有其他效率比较高的方式来维护索引呢？假如跳表每一层的晋升概率是 1/2，最理想的索引就是在原始链表中每隔一个元素抽取一个元素做为一级索引。换种说法，<font style="font-weight: 900;">我们在原始链表中随机的选 n/2 个元素做为一级索引是不是也能通过索引提高查找的效率呢？</font> 当然可以了，因为一般随机选的元素相对来说都是比较均匀的。如下图所示，随机选择了n/2 个元素做为一级索引，虽然不是每隔一个元素抽取一个，但是对于查找效率来讲，影响不大，比如我们想找元素 16，仍然可以通过一级索引，使得遍历路径较少了将近一半。如果抽取的一级索引的元素恰好是前一半的元素 1、3、4、5、7、8，那么查找效率确实没有提升，但是这样的概率太小了。我们可以认为：当原始链表中<font style="font-weight: 900;">元素数量足够大，且抽取足够随机</font>的话，我们得到的索引是均匀的。我们要清楚设计良好的数据结构都是为了应对大数据量的场景，如果原始链表只有 5 个元素，那么依次遍历 5 个元素也没有关系，因为数据量太少了。所以，我们可以维护一个这样的索引：<font style="font-weight: 900;">随机选 n/2 个元素做为一级索引、随机选 n/4 个元素做为二级索引、随机选 n/8 个元素做为三级索引，依次类推，一直到最顶层索引。</font>这里每层索引的元素个数已经确定，且每层索引元素选取的足够随机，所以可以通过索引来提升跳表的查找效率。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmh0igfxj30vq0digme.jpg" alt></p><p>那代码该如何实现，才能使跳表满足上述这个样子呢？可以在每次新插入元素的时候，尽量让该元素有 1/2 的几率建立一级索引、1/4 的几率建立二级索引、1/8 的几率建立三级索引，以此类推，就能满足我们上面的条件。现在我们就需要一个概率算法帮我们把控这个 1/2、1/4、1/8 … ，当每次有数据要插入时，先通过概率算法告诉我们这个元素需要插入到几级索引中，然后开始维护索引并把数据插入到原始链表中。下面开始讲解这个概率算法代码如何实现。</p><p>我们可以实现一个 randomLevel 函数，该方法会随机生成 1~MAX_LEVEL 之间的数（MAX_LEVEL表示索引的最高层数），且该方法有 1/2 的概率返回 1、1/4 的概率返回 2、1/8的概率返回 3，以此类推。</p><p>randomLevel 函数返回 1 表示当前插入的该元素不需要建索引，只需要存储数据到原始链表即可（概率 1/2）<br>randomLevel 函数返回 2 表示当前插入的该元素需要建一级索引（概率 1/4）<br>randomLevel 函数返回 3 表示当前插入的该元素需要建二级索引（概率 1/8）<br>randomLevel 函数返回 4 表示当前插入的该元素需要建三级索引（概率 1/16）<br>。。。以此类推<br>所以，通过 randomLevel 函数，我们可以控制整个跳表各级索引中元素的个数。重点来了：randomLevel 函数返回 2 的时候会建立一级索引，我们想要一级索引中元素个数占原始数据的 1/2，但是 randomLevel 函数返回 2 的概率为 1/4，那是不是有矛盾呢？明明说好的 1/2，结果一级索引元素个数怎么变成了原始链表的 1/4？我们先看下图，应该就明白了。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmj496paj30vq0nggmz.jpg" alt></p><p>假设我们在插入元素 6 的时候，randomLevel 函数返回 1，则我们不会为 6 建立索引。插入 7 的时候，randomLevel 函数返回3 ，所以我们需要为元素 7 建立二级索引。这里我们发现了一个特点：当建立二级索引的时候，同时也会建立一级索引；当建立三级索引时，同时也会建立一级、二级索引。所以，一级索引中元素的个数等于 [ 原始链表元素个数 ] * [ randomLevel 函数返回值 &gt; 1 的概率 ]。因为 randomLevel 函数返回值 &gt; 1就会建索引，凡是建索引，无论几级索引必然有一级索引，所以一级索引中元素个数占原始数据个数的比率为 randomLevel 函数返回值 &gt; 1 的概率。那 randomLevel 函数返回值 &gt; 1 的概率是多少呢？因为 randomLevel 函数随机生成 1~MAX_LEVEL 的数字，且 randomLevel 函数返回值 1 的概率为 1/2，则 randomLevel 函数返回值 &gt; 1 的概率为 1 - 1/2 = 1/2。即通过上述流程实现了一级索引中元素个数占原始数据个数的 1/2。</p><p>同理，当 randomLevel 函数返回值 &gt; 2 时，会建立二级或二级以上索引，都会在二级索引中增加元素，因此二级索引中元素个数占原始数据的比率为 randomLevel 函数返回值 &gt; 2 的概率。 randomLevel 函数返回值 &gt; 2 的概率为 1 减去 randomLevel = 1 或 =2 的概率，即 1 - 1/2 - 1/4 = 1/4。OK，达到了我们设计的目标：二级索引中元素个数占原始数据的 1/4。</p><p>以此类推，可以得出，遵守以下两个条件：</p><p>randomLevel 函数，随机生成 1~MAX_LEVEL 之间的数（MAX_LEVEL表示索引的最高层数），且有 1/2的概率返回 1、1/4的概率返回 2、1/8的概率返回 3 …<br>randomLevel 函数返回 1 不建索引、返回2建一级索引、返回 3 建二级索引、返回 4 建三级索引 …<br>就可以满足我们想要的结果，即：一级索引中元素个数应该占原始数据的 1/2，二级索引中元素个数占原始数据的 1/4，三级索引中元素个数占原始数据的 1/8 ，依次类推，一直到最顶层索引。</p><p>但是问题又来了，怎么设计这么一个 randomLevel 函数呢？直接撸代码：</p><pre class=" language-java"><code class="language-java">  <span class="token comment" spellcheck="true">// 该 randomLevel 方法会随机生成 1~MAX_LEVEL 之间的数，且 ：</span>  <span class="token comment" spellcheck="true">//        1/2 的概率返回 1</span>  <span class="token comment" spellcheck="true">//        1/4 的概率返回 2</span>  <span class="token comment" spellcheck="true">//        1/8 的概率返回 3 以此类推</span>  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">randomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 当 level &lt; MAX_LEVEL，且随机数小于设定的晋升概率时，level   1</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SKIPLIST_P <span class="token operator">&amp;&amp;</span> level <span class="token operator">&lt;</span> MAX_LEVEL<span class="token punctuation">)</span>      level <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> level<span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre><p>上述代码可以实现我们的功能，而且，我们的案例中晋升概率 SKIPLIST_P 设置的 1/2，即：每两个结点抽出一个结点作为上一级索引的结点。如果我们想节省空间利用率，可以适当的降低代码中的 SKIPLIST_P，从而减少索引元素个数，Redis 的 zset 中 SKIPLIST_P 设定的 0.25。下图所示，是Redis t_zset.c 中 zslRandomLevel 函数的实现：<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmo3cp8wj30uy0b6418.jpg" alt></p><p>Redis 源码中 ((random(())&amp;0xFFFF)) &lt; ((ZSKIPLIST_P * 0xFFFF)) 在功能上等价于我代码中的 Math.random(()) &lt; SKIPLIST_P ，只不过 Redis 作者 antirez 使用位运算来提高浮点数比较的效率。</p><p>整体思路大家应该明白了，那插入数据时维护索引的时间复杂度是多少呢？元素插入到单链表的时间复杂度为 O(1)，我们索引的高度最多为 logn，当插入一个元素 x 时，最坏的情况就是元素 x 需要插入到每层索引中，所以插入数据到各层索引中，最坏时间复杂度是 O(logn)。</p><p>过程大概理解了，再通过一个例子描述一下跳表插入数据的全流程。现在我们要插入数据 6 到跳表中，首先 randomLevel() 返回 3，表示需要建二级索引，即：一级索引和二级索引需要增加元素 6。该跳表目前最高三级索引，首先找到三级索引的 1，发现 6 比 1大比 13小，所以，从 1 下沉到二级索引。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmru1ejzj30vq0ngabn.jpg" alt></p><p>下沉到二级索引后，发现 6 比 1 大比 7 小，此时需要在二级索引中 1 和 7 之间加一个元素6 ，并从元素 1 继续下沉到一级索引。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmt4mak1j30vq0ngtaf.jpg" alt></p><p>下沉到一级索引后，发现 6 比 1 大比 4 大，所以往后查找，发现 6 比 4 大比 7 小，此时需要在一级索引中 4 和 7 之间加一个元素 6 ，并把二级索引的 6 指向 一级索引的 6，最后，从元素 4 继续下沉到原始链表。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmtry5apj30vq0ngq4t.jpg" alt></p><p>下沉到原始链表后，就比较简单了，发现 4、5 比 6小，7比6大，所以将6插入到 5 和 7 之间即可，整个插入过程结束。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkmu5o09uj30vq0ngtao.jpg" alt></p><p>整个插入过程的路径与查找元素路径类似， 每层索引中插入元素的时间复杂度 O((1))，所以整个插入的时间复杂度是 O((logn))。</p><h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><p><font style="font-weight: 900;"> 时间复杂度为 O((logn))</font><br>跳表删除数据时，要把索引中对应节点也要删掉。如下图所示，如果要删除元素 9，需要把原始链表中的 9 和第一级索引的 9 都删除掉。<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gjkncupyqbj30vq0if75j.jpg" alt></p><p>跳表中，删除元素的时间复杂度是多少呢？</p><p>删除元素的过程跟查找元素的过程类似，只不过在查找的路径上如果发现了要删除的元素 x，则执行删除操作。跳表中，每一层索引其实都是一个有序的单链表，单链表删除元素的时间复杂度为 O((1))，索引层数为 logn 表示最多需要删除 logn 个元素，所以删除元素的总时间包含 查找元素的时间 加 删除 logn个元素的时间 为 O((logn)) + O((logn)) = 2 O((logn))，忽略常数部分，删除元素的时间复杂度为 O((logn))</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>跳表是可以实现二分查找的有序链表；</li><li>每个元素插入时随机生成它的level；</li><li>最底层包含所有的元素；</li><li>如果一个元素出现在level((x))，那么它肯定出现在x以下的level中；</li><li>每个索引节点包含两个指针，一个向下，一个向右；（笔者目前看过的各种跳表源码实现包括Redis 的zset 都没有向下的指针，那怎么从二级索引跳到一级索引呢？留个悬念，看源码吧，文末有跳表实现源码）</li><li>跳表查询、插入、删除的时间复杂度为O((log n))，与平衡二叉树接近；</li></ol><h2 id="为什么Redis选择使用跳表而不是红黑树来实现有序集合？"><a href="#为什么Redis选择使用跳表而不是红黑树来实现有序集合？" class="headerlink" title="为什么Redis选择使用跳表而不是红黑树来实现有序集合？"></a>为什么Redis选择使用跳表而不是红黑树来实现有序集合？</h2><ol><li>skiplist的复杂度和红黑树一样，而且实现起来更简单。</li><li>在并发环境下skiplist有另外一个优势，红黑树在插入和删除的时候可能需要做一些rebalance的操作，这样的操作可能会涉及到整个树的其他部分，而skiplist的操作显然更加局部一些，所需要顶住的节点更少，因此在这种的情况下性能好一些。</li><li>按照范围区间查找元素（比如查找值在 [100, 356] 之间的数据）, 红黑树的效率没有跳表高。跳表可以做到 O((logn)) 的时间复杂度定位区间的起点，然后在原始链表中顺序往后遍历就可以了，非常高效。</li></ol><p><a href="https://github.com/redis/redis/blob/unstable/src/t_zset.c" target="_blank" rel="noopener">redis zet源码</a></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序基础架构深入解析</title>
      <link href="/2020/02/20/xiao-cheng-xu-ji-chu-jia-gou-shen-ru-jie-xi/"/>
      <url>/2020/02/20/xiao-cheng-xu-ji-chu-jia-gou-shen-ru-jie-xi/</url>
      
        <content type="html"><![CDATA[<h1 id="小程序页面基础文件结构"><a href="#小程序页面基础文件结构" class="headerlink" title="小程序页面基础文件结构"></a>小程序页面基础文件结构</h1><p>我们知道，小程序一个页面，由以下文件构成：</p><pre class=" language-js"><code class="language-js"><span class="token operator">-</span> wxml   <span class="token operator">=</span><span class="token operator">></span> 类似 html<span class="token operator">-</span> wxss   <span class="token operator">=</span><span class="token operator">></span> 类似 css<span class="token operator">-</span> js     <span class="token operator">=</span><span class="token operator">></span> js 文件<span class="token operator">-</span> json   <span class="token operator">=</span><span class="token operator">></span> 一些配置项</code></pre><p>其中，js 是由 js 引擎运行，比如 V8，而 css 和 html 是由浏览器的渲染引擎来处理的，那么究竟上线之后，微信把 wxml、wxss 文件打包成 html、css， 还是有自己的渲染引擎呢？这里我们带着疑问往下看。</p>]]></content>
      
      
      <categories>
          
          <category> 小程序架构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序架构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>测试工程师</title>
      <link href="/2017/12/08/javascript-qa-ce-shi-gong-cheng-shi/"/>
      <url>/2017/12/08/javascript-qa-ce-shi-gong-cheng-shi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>专业名词注解</p><ul><li>TDD: 测试驱动开发，关注所有的功能是否被实现(每一个功能都必须有对应的测试用例, suite配合test利用assert(‘tobi’ == user.name))，国内企业能推动的比较少。</li><li>BDD: 行为驱动开发，关注整体行为是否符合整体预期，编写的每一行代码都有目的提供一个全面的测试用例集。expect/should, describe 配合 it 了利用自然语言 expect(1).toEqual(fn()) 去断言结果，国内企业多数采用的开发方式。</li></ul></blockquote><h1 id="为什么需要-QA-测试"><a href="#为什么需要-QA-测试" class="headerlink" title="为什么需要 QA 测试"></a>为什么需要 QA 测试</h1><ul><li>正确性: 测试可以验证代码的正确性，在上线前做到心里有底。</li><li>自动化: 当然手工也可以测试，通过console可以打印出内部信息，但是这是一次性的事情，下次测试还需要从头来过，效率不能得到保证。通过编写测试用例，可以做到一次编写，多次运行。</li><li>解释性: 测试用例用于测试接口、模块，那么在测试用例中就会涉及如何使用这些 API。其他开发人员如果要使用这些 API，那阅读测试用例是一种很好地途径，有时比文档说明更清晰。</li><li>驱动开发、指导设计: 代码被测试的前提是代码本身的可测试性，那么要保证代码的可测试性，就需要在开发中注意 API 的设计，TDD(测试驱动开发) 将测试前移就是起到这么一个作用。</li><li>保证重构: 互联网行业产品迭代速度很快，迭代后必然存在代码重构的过程，那怎么才能保证重构后的代码质量呢 ？ 有测试用例做后盾，就可以大胆的进行重构。</li></ul><h1 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h1><ul><li>目的: 单元测试能够让开发者明确知道代码结果</li><li>原则: 单一职责、接口抽象、层次分离</li><li>断言库: 保证最小单元是否正常运行检测方法</li><li>测试风格: 测试驱动开发(TDD)、行为驱动开发(BDD)均是敏捷开发方法论。</li></ul><h2 id="单元测试框架-star数统计截止到博客撰写时间"><a href="#单元测试框架-star数统计截止到博客撰写时间" class="headerlink" title="单元测试框架(star数统计截止到博客撰写时间)"></a>单元测试框架(star数统计截止到博客撰写时间)</h2><ul><li>better-assert (TDD断言库 Github 190star 19fork)</li><li>should.js (BDD断言库 Github 2295star 194fork)</li><li>expect.js (BDD断言库 Github 1391star 162fork)</li><li>chai.js (TDD BDD双模 Github 2823star 271fork)</li><li>Jasmine.js (BDD断言库 Github 10723star 1680fork)</li><li>Node.js (本身集成 require(‘assert’));</li><li>Intern (更是一个大而全的单元测试框架)</li><li>Qunit (一个游离在 jQuery 左右的测试框架)</li><li>Macaca (一套完整的自动化测试解决方案 国产神奇来自阿里巴巴)</li></ul><blockquote><p>单元测试运行流程<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giq2dg09stj30yw0u0kjl.jpg" width="300" height="300"></p></blockquote><h2 id="karma-集成-jasmine-驱动自动化单元测试"><a href="#karma-集成-jasmine-驱动自动化单元测试" class="headerlink" title="karma 集成 jasmine 驱动自动化单元测试"></a>karma 集成 jasmine 驱动自动化单元测试</h2><p><a href="https://karma-runner.github.io/latest/intro/installation.html" target="_blank" rel="noopener">karma</a></p><ul><li>npm install karma --save-dev</li><li>npm install karma-jasmine karma-phantomjs-launcher jasmine-core --save-dev</li><li>npm install karma-cli -g</li></ul><blockquote><p>附：目录结构<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gintjqxifgj30gm0eigoj.jpg" width="300" height="300"></p></blockquote><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// unit/index.js </span>window<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// unit/index.spec.js</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'测试基本的函数API'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  it <span class="token punctuation">(</span><span class="token string">'+1函数的应用'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">expect</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><p>根目录(unit-test)下执行 karma init  生成 karma配置文件<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giq2sga1gyj31zw0pmk3v.jpg" alt></p></li><li><p>编辑生成的 karma.conf.js </p></li></ul><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>    files<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token string">'./tests/unit/*.js'</span><span class="token punctuation">,</span>      <span class="token string">'./tests/unit/*.spec.js'</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 无头(虚拟)浏览器 二进制程序 无界面 只支持es5代码 可以持续集成</span>    singleRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 无头浏览器需设置为true </span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// package.json 增加 scripts</span><span class="token string">"unit"</span><span class="token punctuation">:</span> <span class="token string">"karma start"</span><span class="token comment" spellcheck="true">// 执行测试</span>npm run unit<span class="token comment" spellcheck="true">// 输出如下 代表测试通过</span><span class="token number">03</span> <span class="token number">09</span> <span class="token number">2020</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">51.027</span><span class="token punctuation">:</span>WARN <span class="token punctuation">[</span>filelist<span class="token punctuation">]</span><span class="token punctuation">:</span> All files matched by <span class="token string">"/Users/ys/2020-9月复习/unit-test/tests/unit/*.spec.js"</span> were excluded or matched by prior matchers<span class="token punctuation">.</span><span class="token number">03</span> <span class="token number">09</span> <span class="token number">2020</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">51.046</span><span class="token punctuation">:</span>INFO <span class="token punctuation">[</span>karma<span class="token operator">-</span>server<span class="token punctuation">]</span><span class="token punctuation">:</span> Karma v5<span class="token number">.2</span><span class="token punctuation">.</span><span class="token number">1</span> server started at http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">9876</span><span class="token operator">/</span><span class="token number">03</span> <span class="token number">09</span> <span class="token number">2020</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">51.046</span><span class="token punctuation">:</span>INFO <span class="token punctuation">[</span>launcher<span class="token punctuation">]</span><span class="token punctuation">:</span> Launching browsers PhantomJS <span class="token keyword">with</span> concurrency unlimited<span class="token number">03</span> <span class="token number">09</span> <span class="token number">2020</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">51.051</span><span class="token punctuation">:</span>INFO <span class="token punctuation">[</span>launcher<span class="token punctuation">]</span><span class="token punctuation">:</span> Starting browser PhantomJS<span class="token number">03</span> <span class="token number">09</span> <span class="token number">2020</span> <span class="token number">21</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">52.194</span><span class="token punctuation">:</span>INFO <span class="token punctuation">[</span>PhantomJS <span class="token number">2.1</span><span class="token punctuation">.</span><span class="token number">1</span> <span class="token punctuation">(</span>Mac OS <span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Connected on socket cq53bpq4EaLPA5IRAAAA <span class="token keyword">with</span> id <span class="token number">4306079</span>PhantomJS <span class="token number">2.1</span><span class="token punctuation">.</span><span class="token number">1</span> <span class="token punctuation">(</span>Mac OS <span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Executed <span class="token number">1</span> <span class="token keyword">of</span> <span class="token number">1</span> SUCCESS <span class="token punctuation">(</span><span class="token number">0.008</span> secs <span class="token operator">/</span> <span class="token number">0.002</span> secs<span class="token punctuation">)</span>TOTAL<span class="token punctuation">:</span> <span class="token number">1</span> SUCCESS<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 番外 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token comment" spellcheck="true">// 如果要运行有头浏览器 比如 chrome 需要修改 karma.con.js</span><span class="token punctuation">{</span>   browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 有头的将来没法做持续集成</span>   singleRun<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// 设置为false时 当browsers不为PhantomJs(无头浏览器)时候 会打开浏览器</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 安装 karma-chrome-launcher </span><span class="token operator">-</span> npm install karma<span class="token operator">-</span>chrome<span class="token operator">-</span>launcher <span class="token operator">--</span>save<span class="token operator">-</span>dev<span class="token comment" spellcheck="true">// 执行测试 npm run unit</span><span class="token comment" spellcheck="true">// 此时会先打开谷歌浏览器, 然后命令行输出执行结果, 然后关闭浏览器, 假设我们给定一个错误期望结果 expect(window.add(1)).toBe(3);</span><span class="token comment" spellcheck="true">// 会输出如下</span>Chrome <span class="token number">85.0</span><span class="token punctuation">.</span><span class="token number">4183.83</span> <span class="token punctuation">(</span>Mac OS <span class="token number">10.13</span><span class="token punctuation">.</span><span class="token number">6</span><span class="token punctuation">)</span> 测试基本的函数API <span class="token operator">+</span><span class="token number">1</span>函数的应用 FAILED        Error<span class="token punctuation">:</span> Expected <span class="token number">2</span> to be <span class="token number">3</span><span class="token punctuation">.</span>            at <span class="token operator">&lt;</span>Jasmine<span class="token operator">></span>            at UserContext<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">></span> <span class="token punctuation">(</span>tests<span class="token operator">/</span>unit<span class="token operator">/</span>index<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">)</span>            at <span class="token operator">&lt;</span>Jasmine<span class="token operator">></span></code></pre><h2 id="玩点花样"><a href="#玩点花样" class="headerlink" title="玩点花样"></a>玩点花样</h2><pre class=" language-js"><code class="language-js"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  添加代码覆盖率检查优化 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token comment" spellcheck="true">// 代码覆盖率检查 (覆盖总逻辑分支比例)</span>npm i karma<span class="token operator">-</span>coverage <span class="token operator">--</span>dev<span class="token comment" spellcheck="true">// 我们把index.js 内容更改为</span>window<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token number">1</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// index.spec.js 此处没有覆盖到 a !== 1的分支</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"测试基本函数的API"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"+1函数的应用"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">expect</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// karma.config 增加</span><span class="token punctuation">{</span>  preprocessors<span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token string">"./tests/unit/*.js"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'coverage'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 指定文件</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'coverage'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 生成报表 coverage 覆盖率检查</span>  coverageReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 生成覆盖率报表的目录</span>    type<span class="token punctuation">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span>    dir<span class="token punctuation">:</span> <span class="token string">'./doc/coverage/'</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>执行 npm run unit   ./docs/coverage 文件会生成一个覆盖率报表 打开 index.html<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gilpaq94lgj32la0ha785.jpg" alt></p></blockquote><blockquote><p>还可以点开index.js 查看没有覆盖到的分支行数奥<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gilpgya6fjj31wu0fyq97.jpg" alt></p></blockquote><h2 id="jest-对-React-组件做单测"><a href="#jest-对-React-组件做单测" class="headerlink" title="jest 对 React 组件做单测"></a>jest 对 React 组件做单测</h2><blockquote><p>Facebook出的 测试框架, 对 react 支持较好</p><ul><li>新建项目 react-jest, npm init -y 初始化</li><li>npm i @testing-library/react react-dom react-scripts jest-dom –save-dev</li><li>添加文件 src/index.js  src/index.spec.js</li><li>附: 目录结构<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gir7lkaqm7j30c408mabt.jpg" width="300" height="300"></li></ul></blockquote><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// src/index.js</span>  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>  <span class="token keyword">export</span> <span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span>div<span class="token operator">></span>        <span class="token operator">&lt;</span>h2 data<span class="token operator">-</span>testid<span class="token operator">=</span><span class="token string">"js-h2"</span><span class="token operator">></span><span class="token punctuation">(</span>ｷ｀ﾟДﾟ´<span class="token punctuation">)</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>        <span class="token operator">&lt;</span>ul data<span class="token operator">-</span>testid<span class="token operator">=</span><span class="token string">"js-ul"</span><span class="token operator">></span>          <span class="token operator">&lt;</span>li<span class="token operator">></span>Javascript<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>          <span class="token operator">&lt;</span>li<span class="token operator">></span>CSS<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// src/index.spec.js</span>  <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>  <span class="token keyword">import</span>  <span class="token punctuation">{</span> render<span class="token punctuation">,</span> cleanup<span class="token punctuation">,</span> fireEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing-library/react'</span><span class="token punctuation">;</span>  <span class="token keyword">import</span> <span class="token punctuation">{</span> App <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./index'</span><span class="token punctuation">;</span>  <span class="token function">afterEach</span><span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 执行结果清除</span>  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'基础的react单元测试'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'index组件测试'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> getByTestId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 渲染组件</span>      <span class="token keyword">const</span> <span class="token punctuation">[</span>ul<span class="token punctuation">,</span> nav<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">getByTestId</span><span class="token punctuation">(</span><span class="token string">'js-ul'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getByTestId</span><span class="token punctuation">(</span><span class="token string">'js-h2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 找到元素</span>      <span class="token function">expect</span><span class="token punctuation">(</span>ul<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">expect</span><span class="token punctuation">(</span>nav<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'(ｷ｀ﾟДﾟ´)!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// package.json 添加命令 </span>  <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"jest"</span><span class="token punctuation">:</span> <span class="token string">"react-scripts test --env=jsdom"</span>  <span class="token punctuation">}</span></code></pre><ul><li>执行 npm run jest<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gir7r0870uj30qs0e4dkp.jpg" alt></li></ul><h1 id="e2e-测试"><a href="#e2e-测试" class="headerlink" title="e2e 测试"></a>e2e 测试</h1><ul><li>即端对端测试，属于黑盒测试，通过编写测试用例，自动化模拟用户操作，确保组件间通信正常，程序流数据传递如预期。</li></ul><h2 id="使用-selenium-webdriver-实现-e2e-测试"><a href="#使用-selenium-webdriver-实现-e2e-测试" class="headerlink" title="使用 selenium-webdriver 实现 e2e 测试"></a>使用 selenium-webdriver 实现 e2e 测试</h2><ul><li><a href="https://www.npmjs.com/package/selenium-webdriver" target="_blank" rel="noopener">包链接</a></li><li>新建项目 e2e, 初始化npm:  npm init -y</li><li>npm install selenium-webdriver --save-dev</li><li>项目根目录添加 baidu.spec.js</li><li>附: 目录结构<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gio0osz2unj30co0aq76a.jpg" width="300" height="300"></li></ul><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// baidu.spec.js</span><span class="token keyword">const</span> <span class="token punctuation">{</span>Builder<span class="token punctuation">,</span> By<span class="token punctuation">,</span> Key<span class="token punctuation">,</span> until<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'selenium-webdriver'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> driver <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forBrowser</span><span class="token punctuation">(</span><span class="token string">'chrome'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 打开chrome浏览器</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'http://www.baidu.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 打开百度网页</span>    <span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">findElement</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">'wd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendKeys</span><span class="token punctuation">(</span><span class="token string">'javascript'</span><span class="token punctuation">,</span> Key<span class="token punctuation">.</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 找到 name = wd 的输入框 输入 javascript 按下return键</span>    <span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>until<span class="token punctuation">.</span><span class="token function">titleIs</span><span class="token punctuation">(</span><span class="token string">'javascript_百度搜索'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//  下个页面标题应该等于 'javascript_百度搜索' 等待时间为1000毫秒</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>下载对应浏览器驱动 我们以谷歌为栗<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ginusvbcrdj31am0oodpe.jpg" alt></li><li>选择版本对应版本的驱动 (注意, 浏览器版本要和驱动版本对应)<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ginv8xaqd1j31fc0fin98.jpg" alt></li><li>下载 解压到我们项目根目录</li><li>package.json中新增命令 e2e<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ginvbcfzccj31fk0huam0.jpg" alt></li><li>执行 npm run e2e 此时会自动打开我们的chrome浏览器 打开百度网页 输入 javascript 执行搜索<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gio067dtyyj311x0u01ky.jpg" alt></li><li>驱动版本不符合浏览器版本报错(此时不能成功调起浏览器)<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gio0cims77j321e0860zh.jpg" alt></li><li>执行成功的命令行打印<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gio09tyuchj321203qjsk.jpg" alt></li><li>执行失败的命令行打印<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gio08rs3pdj321s07awjx.jpg" alt></li></ul><h2 id="rize-puppeteer-写法更清爽的e2e测试方案"><a href="#rize-puppeteer-写法更清爽的e2e测试方案" class="headerlink" title="rize + puppeteer - 写法更清爽的e2e测试方案"></a>rize + puppeteer - 写法更清爽的e2e测试方案</h2><blockquote><p>rize: 一个可以让你简单、优雅的使用 puppeteer 的 Node.js 库<br>puppeteer: phantom.js(单例测试时候的无头浏览器)不维护后 这个是谷歌推出的 可以理解成我们日常使用的Chrome的无界面版本以及对其进行操控的js接口套装, 也是无头浏览器</p></blockquote><ul><li>npm install –save-dev puppeteer rize</li></ul><blockquote><p>附：目录结构<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giq3lin5jwj30ii08ygnn.jpg" width="300" height="300"></p></blockquote><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// test/git.spec.js</span>  <span class="token keyword">const</span> Rize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> rize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rize    <span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'https://github.com/'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 打开github</span>    <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'input.header-search-input'</span><span class="token punctuation">,</span> <span class="token string">'node'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 找到class为header-search-input的输入框 输入node</span>    <span class="token punctuation">.</span><span class="token function">press</span><span class="token punctuation">(</span><span class="token string">'Enter'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 回车</span>    <span class="token punctuation">.</span><span class="token function">waitForNavigation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'timeout'</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 等待跳转</span>    <span class="token punctuation">.</span><span class="token function">assertSee</span><span class="token punctuation">(</span><span class="token string">'Node.js'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 断言是否页面出现 Node.js 文字</span>    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </code></pre><h2 id="nightwatch-守夜人-更好用的e2e测试框架"><a href="#nightwatch-守夜人-更好用的e2e测试框架" class="headerlink" title="nightwatch(守夜人) - 更好用的e2e测试框架"></a>nightwatch(守夜人) - 更好用的e2e测试框架</h2><blockquote><p>这里不作讨论，有兴趣的话可以自己尝试下~</p></blockquote><h1 id="backstop-js-实现ui自动化测试"><a href="#backstop-js-实现ui自动化测试" class="headerlink" title="backstop.js 实现ui自动化测试"></a>backstop.js 实现ui自动化测试</h1><blockquote><p>phantomCss 也能做，但是这里我们介绍功能更强大的backstopjs</p></blockquote><ul><li><a href="https://www.npmjs.com/package/backstopjs" target="_blank" rel="noopener">参考地址</a></li><li>新建项目 ui-backstop, npm init -y</li><li>cnpm install -g backstopjs (略慢)</li><li>backstop init<blockquote><p>附：目录结构</p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gises4dhodj30ce06aq4a.jpg" width="300" height="300"></blockquote></li></ul><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// backstop.json</span>  <span class="token punctuation">{</span>    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"qq"</span><span class="token punctuation">,</span>    <span class="token string">"viewports"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        <span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"phone"</span><span class="token punctuation">,</span>        <span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token number">375</span><span class="token punctuation">,</span>        <span class="token string">"height"</span><span class="token punctuation">:</span> <span class="token number">667</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"ipad"</span><span class="token punctuation">,</span>        <span class="token string">"width"</span><span class="token punctuation">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>        <span class="token string">"height"</span><span class="token punctuation">:</span> <span class="token number">768</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string">"onBeforeScript"</span><span class="token punctuation">:</span> <span class="token string">"puppet/onBefore.js"</span><span class="token punctuation">,</span>     <span class="token string">"onReadyScript"</span><span class="token punctuation">:</span> <span class="token string">"puppet/onReady.js"</span><span class="token punctuation">,</span>    <span class="token string">"scenarios"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        <span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"map"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 以腾讯地图为例</span>        <span class="token string">"cookiePath"</span><span class="token punctuation">:</span> <span class="token string">"backstop_data/engine_scripts/cookies.json"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 如果网站需要登录 这里可以种植 cookie</span>        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://map.qq.com/m/"</span><span class="token punctuation">,</span>        <span class="token string">"referenceUrl"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string">"readyEvent"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string">"readySelector"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string">"delay"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token string">"hideSelectors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">"removeSelectors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">"hoverSelector"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string">"clickSelector"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token string">"postInteractionWait"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token string">"selectors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">"selectorExpansion"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token string">"expect"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token string">"misMatchThreshold"</span> <span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>        <span class="token string">"requireSameDimensions"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string">"paths"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"bitmaps_reference"</span><span class="token punctuation">:</span> <span class="token string">"backstop_data/bitmaps_reference"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 参考的文件夹 ui图放里面</span>      <span class="token string">"bitmaps_test"</span><span class="token punctuation">:</span> <span class="token string">"backstop_data/bitmaps_test"</span><span class="token punctuation">,</span>      <span class="token string">"engine_scripts"</span><span class="token punctuation">:</span> <span class="token string">"backstop_data/engine_scripts"</span><span class="token punctuation">,</span>      <span class="token string">"html_report"</span><span class="token punctuation">:</span> <span class="token string">"./docs/backstop_data/html_report"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 导出报表路径</span>      <span class="token string">"ci_report"</span><span class="token punctuation">:</span> <span class="token string">"./docs/backstop_data/ci_report"</span> <span class="token comment" spellcheck="true">// Jenkins 或者 travis 报表路径</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"report"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"browser"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"puppeteer"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 包自带引擎 </span>    <span class="token string">"engineOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>      <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--no-sandbox"</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"asyncCaptureLimit"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token string">"asyncCompareLimit"</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>    <span class="token string">"debug"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token string">"debugWindow"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span></code></pre><ul><li>执行 backstop test<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gisf2l8r94j31i80kqjwl.jpg" alt></li></ul><h1 id="mocha-实现异步代码测试-接口测试"><a href="#mocha-实现异步代码测试-接口测试" class="headerlink" title="mocha 实现异步代码测试(接口测试)"></a>mocha 实现异步代码测试(接口测试)</h1><ul><li>新建项目 async-mocha, npm init -y</li><li>新建目录 tests/service/router.spec.js</li><li>根目录新建 mochaRunner.js</li><li>cnpm i axios –save-dev</li><li>cnpm i mocha –save</li><li>cnpm install –save-dev mochawesome  // 报表</li></ul><blockquote><p>附：目录结构<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gisehfccknj30ho0cagob.jpg" width="300" height="300"></p></blockquote><pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// router.spec.js</span>  <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'node 接口'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    it <span class="token punctuation">(</span><span class="token string">'test 接口测试'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>      axios<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'http://slsljxjkss.com/sss'</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>xx <span class="token operator">==</span> <span class="token string">'期望值'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'数据请求出错'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// mochaRunner.js</span>  <span class="token keyword">const</span> Mocha <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mocha'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> mocha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mocha</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    reporter<span class="token punctuation">:</span> <span class="token string">'mochawesome'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 指定报表</span>    reporterOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>      reportDir<span class="token punctuation">:</span> <span class="token string">'./docs/mochawesome-reporter'</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  mocha<span class="token punctuation">.</span><span class="token function">addFile</span><span class="token punctuation">(</span><span class="token string">'./tests/service/router.spec.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  mocha<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 退出</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><p>npm run mocha<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1giseivmewyj31j20kcth7.jpg" alt></p></li><li><p>打开 docs 下生成的报表<br><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giseg82eejj32k40t615s.jpg" alt></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> qa测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux系列</title>
      <link href="/2017/10/22/qian-duan-bi-hui-linux-xi-lie/"/>
      <url>/2017/10/22/qian-duan-bi-hui-linux-xi-lie/</url>
      
        <content type="html"><![CDATA[<p>附 <a href="https://www.kernel.org/" target="_blank" rel="noopener">linux官方网站</a></p><h1 id="linux是什么"><a href="#linux是什么" class="headerlink" title="linux是什么"></a>linux是什么</h1><blockquote><p>linux简单来说就是操作系统的内核，包含一些最基本的功能，我们所说的 centos, ubuntu等都是 linux 的发行版。</p></blockquote><h1 id="linux-下的目录都是做什么用的"><a href="#linux-下的目录都是做什么用的" class="headerlink" title="linux 下的目录都是做什么用的"></a>linux 下的目录都是做什么用的</h1><table><thead><tr><th align="center">目录</th><th align="center">应放置档案内容</th></tr></thead><tbody><tr><td align="center">/bin</td><td align="center">系统有很多放置执⾏行行档的⽬目录，但/bin⽐比较特殊。因为/bin放置的是在单⼈维护模式下还能够被操作的指令。在/bin底下的指令可以被root与⼀一般帐号所使⽤用，主要有: cat, chmod(修改权限), chown, date, mv, mkdir, cp, bash等常⽤的指令。</td></tr><tr><td align="center">/boot</td><td align="center">主要放置开机会使⽤到的档案，包括Linux核⼼档案以及开机选单与开机所需设定档等等。Linux kernel常⽤用的档名为: vmlinuz ，如果使⽤用的是grub这个开机管理程式，则还会存在/boot/grub/这个⽬目录。</td></tr><tr><td align="center">/dev</td><td align="center">在Linux系统上，任何装置与周边设备都是以档案的型态存在于这个⽬录当中。 只要通过存取这个⽬录下的某个档案，就等于存取某个装置。⽐较重要的档案有/dev/null, /dev/zero, /dev/tty, /dev/lp, / dev/hd, /dev/sd* 等。</td></tr><tr><td align="center">/etc</td><td align="center">系统主要的设定档⼏乎都放置在这个⽬录内，例如人员的帐号密码档、各种服务的启始档等等。 一般来说，这个目录下的各档案属性是可以让一般使用者查阅的，但是只有root有权力修改。 FHS建议不要放置可执行档(binary)在这个⽬录中。 ⽐较重要的档案有:  /etc/inittab,  /etc/init.d/,  /etc/modprobe.conf,  /etc/X11/,  /etc/fstab,  /etc/sysconfig/ 等等。 另外，其下重要的⽬目录有:  /etc/init.d/: 所有服务的预设启动 script都是放在这⾥里里的，例如要启动或者关闭iptables的话:  /etc/init.d/iptables start、 /etc/init.d/ iptables stop/etc/xinetd.d/:这就是所谓的 super daemon 管理的各项服务的设定档目录。  /etc/X11/: 与X Window有关的各种设定档都在这里，尤其是 xorg.conf 或 XF86Config 这两个 X Server 的设定档。</td></tr><tr><td align="center">/home</td><td align="center">这是系统预设的使⽤者家目录 (home directory)。 在你新增一个一般使⽤者帐号时， 预设的使⽤者家目录都会规范到这里来。⽐较重要的是，家目录有两种代号: ~ 代 表当前使⽤用者的家⽬目录，⽽而 ~guest 则代表⽤用户名为guest的家⽬目录。</td></tr><tr><td align="center">/lib</td><td align="center">系统的函式库⾮常的多，⽽ /lib 放置的则是在开机时会用到的函式库，以及在 /bin 或/sbin 底下的指令会呼叫的函式库⽽已。什么是函式库呢? 你可以将他想成是外挂，某些指令必须要有这些外挂才能够顺利完成程式的执行。 尤其重要的是 /lib/modules/ 这个⽬目录，因为该目录会放置核⼼相关的模组(驱动程式)。</td></tr><tr><td align="center">/media</td><td align="center">media是媒体的英文，顾名思义，这个 /media 底下放置的就是可移除的装置。 包括软 碟、光碟、DVD等等装置都暂时挂载于此。 常⻅见的档名有: /media/floppy, /media/cdrom 等。</td></tr><tr><td align="center">/mnt</td><td align="center">如果你想要暂时挂载某些额外的装置，⼀般建议你可以放置到这个目录中。在早时候，这个⽬录的⽤途与 /media 相同啦。 只是有了了/ media 之后，这个⽬录就⽤来暂时挂载⽤了。</td></tr><tr><td align="center">/opt</td><td align="center">这个是给第三⽅协力软体放置的⽬录。 什么是第三⽅协力软体啊? 举例例来说，KDE 这个桌面管理系统是⼀个独立的计画，不过他可以安装到 Linux 系统中，因此 KDE 的软体就建议放置到此⽬录下了了。另外，如果你想要⾃行安装额外的软体(⾮原本的 distribution 提供的)，那么也能够将你的软体安装到这里来。不过，以前的 Linux 系统 中，我们还是习惯放置在 /usr/local 目录下。</td></tr><tr><td align="center">/root</td><td align="center">系统管理理员 (root) 的家⽬目录。之所以放在这里，是因为如果进⼊单⼈维护模式⽽仅挂载根⽬目录时，该⽬录就能够拥有 root 的家目录，所以我们会希望root的家目录与根目录放置在同⼀个分区中。</td></tr><tr><td align="center">/sbin</td><td align="center">Linux有⾮常多指令是⽤来设定系统环境的，这些指令只有root才能够利用来设定系统，其他使⽤者最多只能⽤来查询⽽已。放在/sbin底下的为开机过程中所需要的，⾥面包括了了开机、修复、还原系统所需要的指令。⾄至于某些伺服器软体程式，一般则放置到 /usr/sbin/ 当中。⾄于本机自⾏安装的软体所产⽣的系统执⾏档 (system binary)，则放置到 /usr/local/sbin/ 当中了。常见的指令包括:fdisk, fsck, ifconfig, init, mkfs 等等。</td></tr><tr><td align="center">/srv</td><td align="center">srv 可以视为 service 的缩写，是一些⽹路服务启动之后，这些服务所需要取用的资料目录。常⻅的服务例如 WWW, FTP 等等。举例来说，WWW 伺服器需要的⽹页资料就可以放置在 /srv/www/ ⾥里里⾯面。呵呵，看来平时我们编写的代码应该放到这里了。</td></tr><tr><td align="center">/tmp</td><td align="center">这是让⼀般使用者或者是正在执行的程序暂时放置档案的地⽅。这个⽬录是任何⼈都能够存取的，所以你需要定期的清理一下。当然，重要资料不可放置在此⽬录啊。 因为 FHS 甚⾄建议在开机时，应该要将 /tmp下的资料都删除。</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Js 面试题</title>
      <link href="/2017/09/10/yi-dao-mian-shi-ti-zhi-dian-cao-zuo-fu-you-xian-ji/"/>
      <url>/2017/09/10/yi-dao-mian-shi-ti-zhi-dian-cao-zuo-fu-you-xian-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="直接上代码"><a href="#直接上代码" class="headerlink" title="直接上代码"></a>直接上代码</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> n<span class="token punctuation">:</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token keyword">var</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>     a<span class="token punctuation">.</span>x <span class="token operator">=</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> n<span class="token punctuation">:</span><span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>    <span class="token function">alert</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// { n: 2 } </span></code></pre><p>为什么第一个是 undefined 呢 ? 我们来分析一下 !</p><ol><li>首先 a 指向一个堆地址, 内容为 n: 1</li><li>然后 b 指向 a, 其实也就是 b 和 a 目前指向了同一个堆地址</li><li>a.x 点操作符的优先级为 19, 而等号操作符的优先级为 10, 所以点操作符指向是在赋值前, 也就是我们先给 a 指向的堆地址, 重新分配了一个 key 值 x 的变量, 此时并没有赋值操作, 相当于给此时指针指向的堆地址分配了一个key为x的变量，但是没给值。并且点操作符计算锁定！就是说就算此时给a重新赋值，指向另一个堆地址，a.x 也是指向 { n: 1, x: undefined } 堆内存中的 x</li><li>点操作符执行完成后, 开始执行等号操作符, 按照约定从右向左执行, 也就是依次执行 <pre class=" language-js"><code class="language-js">     a <span class="token operator">=</span> <span class="token punctuation">{</span> n<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 此时 a 为 { n: 2 }</span>     <span class="token punctuation">[</span>a<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> a <span class="token comment" spellcheck="true">// 此赋值执行前 [a] = { n: 1, x: undefined } [a.x] = undefined  </span></code></pre> 中括号代表不会重新计算 a.x 的指向的内存地址, 也就是说 此时的a 虽然指向了新的内存区 { n: 2 }, 但此处(点操作符)已被执行过了, 计算的时候 a 还是 和 b 指向一个内存区域，然后执行赋值语句 [a.x] 也就是 b.x 指向 a。 此刻 a = { n:2 } 所以 b = { n: 1, x: { n: 2 } }</li><li>完成全部赋值操作 此时 b 指向的堆地址的值为 { n: 1, x: { n: 2 } }, a 指向的堆地址为 { n: 2 }</li></ol><p>建议画图理解</p>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>列表的JS实现</title>
      <link href="/2017/09/10/suan-fa-ji-chu-zhi-shu-ju-jie-gou/"/>
      <url>/2017/09/10/suan-fa-ji-chu-zhi-shu-ju-jie-gou/</url>
      
        <content type="html"><![CDATA[<h1 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h1><h2 id="列表的概念和用途"><a href="#列表的概念和用途" class="headerlink" title="列表的概念和用途"></a>列表的概念和用途</h2><ul><li>日常生活中, 我们使用购物清单、待办事项列表都是列表。计算机中的列表也是一样。</li><li>元素不是很多 (不然内存吃不消, 元素很多的一般不用列表结构)。</li><li>不需要很长序列查找元素或者排序 (如果涉及到很长查找或排序，列表是不适合的)。</li><li>列表是一种最自然的数据组织方式。</li></ul><h2 id="列表的关键概念定义"><a href="#列表的关键概念定义" class="headerlink" title="列表的关键概念定义"></a>列表的关键概念定义</h2><ol><li><p>列表是一组有序的数据(这里的有序不是指排序, 可以简单理解成一类，能组织到一起的数据), 每个列表中的数据项称为<font color="Hotpink"> 元素</font>。元素的数量受内存控制。</p></li><li><p>不包含任何元素的列表称为<font color="Hotpink"> 空列表</font>。</p></li></ol><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><blockquote><p>这里用es5实现 因为es6有些东西不需要手动实现了 比如 迭代器</p></blockquote><pre class=" language-js"><code class="language-js">  <span class="token keyword">const</span> <span class="token punctuation">{</span> fuchsia <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"color-name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 列表需要有一些自己完整的属性</span>  <span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>listSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 列表的元素个数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 列表当前位置</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 初始化一个空数组用来保存列表元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>clear <span class="token operator">=</span> clear<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 清空列表中的所有元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>find <span class="token operator">=</span> find<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 查找元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>toString <span class="token operator">=</span> toString<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回字符串形式列表</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>insert <span class="token operator">=</span> insert<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在现有元素后插入新元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>append <span class="token operator">=</span> append<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 在列表元素末尾增加新元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>remove <span class="token operator">=</span> remove<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从列表中删除新元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>front <span class="token operator">=</span> front<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从列表的当前位置移动到第一个位置</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从列表的当前位置移动到最后一个位置</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将当前位置前移一位</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将当前位置后移一位</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 列表中包含的元素个数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>currPos <span class="token operator">=</span> currPos<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 返回列表元素当前位置</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>moveTo <span class="token operator">=</span> moveTo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 将当前元素移动到指定位置</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getElement <span class="token operator">=</span> getElement<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 显示当前的元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>contains <span class="token operator">=</span> contains<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 是否包含某元素</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">append</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">find</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> fountAt <span class="token operator">=</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fountAt <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>fountAt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">--</span><span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">insert</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> after<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> insertPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>insertPos <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>insertPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 创建一个空数组</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>listSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 移动下标到 List 头部</span>  <span class="token keyword">function</span> <span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token operator">--</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">currPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">moveTo</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> position<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  names<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  names<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'小白'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  names<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'小绿'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// names.next();</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>names<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 迭代器</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span>front<span class="token punctuation">;</span> names<span class="token punctuation">.</span><span class="token function">currPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> names<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> names<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>names<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Js 函数声明提升的问题</title>
      <link href="/2017/09/10/yi-dao-mian-shi-ti-zhi-js-zhong-de-han-shu-sheng-ming-ti-sheng/"/>
      <url>/2017/09/10/yi-dao-mian-shi-ti-zhi-js-zhong-de-han-shu-sheng-ming-ti-sheng/</url>
      
        <content type="html"><![CDATA[<pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">;</span>            <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// test is not a function</span></code></pre><p>注解: (谷歌) test is not a function 逻辑代码会阻止函数体提示, 但是函数声明还是可以提升的~ 相当于声明 var test; 同理~<br>         (低版本ie) 2<br>         (某版本火狐) 1</p><pre class=" language-js"><code class="language-js">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefiend</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端中的this指向</title>
      <link href="/2017/09/08/qian-duan-zhong-de-this-zhi-xiang/"/>
      <url>/2017/09/08/qian-duan-zhong-de-this-zhi-xiang/</url>
      
        <content type="html"><![CDATA[<h1 id="js变量提升基础"><a href="#js变量提升基础" class="headerlink" title="js变量提升基础"></a>js变量提升基础</h1><pre class=" language-js"><code class="language-js">知识点<span class="token number">1</span>：    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefiend</span>    <span class="token comment" spellcheck="true">// 其实 var a 是执行了的, 只是if (false) a = 1; 这个赋值操作没执行。</span>知识点<span class="token number">2</span>：    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> test<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// function test() {...}</span>    <span class="token comment" spellcheck="true">// 是不是惊呆啦! 为什么 var test; 却没有覆盖掉函数,</span>    <span class="token comment" spellcheck="true">// 只var不赋值不是为 undefined么! </span>    <span class="token comment" spellcheck="true">// 其实直接 var test 和 var undefined不太一样</span>    <span class="token comment" spellcheck="true">// 前者为无意义的声明，如果该变量有值, js 是不会处理这样的声明的。</span>    <span class="token comment" spellcheck="true">// 举个例子</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 1</span>    <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 因为函数提升优先级最高, 所以提升后的代码为</span>    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> test<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>    test <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 很显然答案是函数体啦</span></code></pre><h1 id="变量提升以及函数声明提升的优先级"><a href="#变量提升以及函数声明提升的优先级" class="headerlink" title="变量提升以及函数声明提升的优先级"></a>变量提升以及函数声明提升的优先级</h1><pre class=" language-js"><code class="language-js">    <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>弹出函数体 function a() { alert(10); } </li><li>10</li><li>3</li><li>a is not a function<blockquote><p>注解: ==函数声明提升的时候连着函数体一起提升,<br>且优先级大于变量声明，也就是a函数声明会提到最前面, 具体的指向步骤是这样的<br>function a() { alert(10); } <br> var a;<br>a = 3;<br>alert(a);==</p></blockquote></li></ol></blockquote></details><br><h1 id="函数声明的作用域问题"><a href="#函数声明的作用域问题" class="headerlink" title="函数声明的作用域问题"></a>函数声明的作用域问题</h1><pre class=" language-js"><code class="language-js">   <span class="token punctuation">(</span><span class="token keyword">function</span> test <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i am test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><p>test is no defiend<br><br>注解: 函数声明只能在当前作用域生效。特别的一点是es6花括号作用域, 只能使let, const失效。比如:</p><pre class=" language-js"><code class="language-js">    <span class="token punctuation">{</span>        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span>        <span class="token keyword">function</span> A <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AAA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>     <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>    <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// AAA</span></code></pre></blockquote></details><br><h1 id="函数名与变量引用的冲突"><a href="#函数名与变量引用的冲突" class="headerlink" title="函数名与变量引用的冲突"></a>函数名与变量引用的冲突</h1><pre class=" language-js"><code class="language-js">   <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">function</span> test <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i am test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><p>test is no defiend<br><br>注解: 把函数声明到一个变量上时, 对函数命名是没有作用的;</p></blockquote></details><br><h1 id="变量表达式声明的函数的函数名在函数内部不能被重写"><a href="#变量表达式声明的函数的函数名在函数内部不能被重写" class="headerlink" title="变量表达式声明的函数的函数名在函数内部不能被重写"></a>变量表达式声明的函数的函数名在函数内部不能被重写</h1><pre class=" language-js"><code class="language-js">   <span class="token punctuation">(</span><span class="token keyword">function</span> test2 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     test2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test2<span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">function</span> test <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      test <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>function test () {<br>   test = 1;<br>   console.log(test);<br>}</li><li>test2 is not defined</li><li>function test () {<br>   test = 1;<br>   console.log(test);<br>}<br><br><br>注解: ==函数表达式定义的时候==, ==函数的名字==外部不能访问，内部也不能修改。<br>什么是函数表达式, 以上两种都是, 和函数声明的区别就是函数表达式不以function开头定义的。<br>对比下面的写法: <pre class=" language-js"><code class="language-js"> <span class="token comment" spellcheck="true">// 函数声明</span> <span class="token keyword">function</span> <span class="token function">zhijia</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     zhijia <span class="token operator">=</span> <span class="token string">"老师"</span><span class="token punctuation">;</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>zhijia<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token function">zhijia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 老师</span></code></pre></li></ol></blockquote></details><br><h1 id="来点花样"><a href="#来点花样" class="headerlink" title="来点花样"></a>来点花样</h1><pre class=" language-js"><code class="language-js">   <span class="token punctuation">(</span><span class="token keyword">function</span> test <span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token keyword">function</span> test2 <span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        w<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>test2 is not defined</li><li>2</li><li>1<br><br><br>注解: window传进自执行函数 但是test2这个函数并没有绑定在window上。自执行函数的this本身就指向window。</li></ol></blockquote></details><br><h1 id="自执行函数的this指向"><a href="#自执行函数的this指向" class="headerlink" title="自执行函数的this指向"></a>自执行函数的this指向</h1><pre class=" language-js"><code class="language-js">   obj <span class="token operator">=</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fn<span class="token punctuation">)</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>windows对象<br></li><li>undefined<br><br>注解: 非严格模式下, 自执行函数的this永远指向window</li></ol></blockquote></details><br><h1 id="自执行函数的this指向-1"><a href="#自执行函数的this指向-1" class="headerlink" title="自执行函数的this指向"></a>自执行函数的this指向</h1><pre class=" language-js"><code class="language-js">   obj <span class="token operator">=</span> <span class="token punctuation">{</span>        fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// "use strict";</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fn<span class="token punctuation">)</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>windows对象<br></li><li>undefined<br><br>注解: 非严格模式下, 自执行函数的this永远指向window。打开注释试一下~</li></ol></blockquote></details><br><h1 id="你不知道的js-书中一处错误记录"><a href="#你不知道的js-书中一处错误记录" class="headerlink" title="[你不知道的js] 书中一处错误记录"></a>[你不知道的js] 书中一处错误记录</h1><pre class=" language-js"><code class="language-js">   <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>undefined<br></li></ol></blockquote><blockquote><p>注解: 是不是很诧异为什么输出的是undefinede而不是a is not defined; 因为此时输出的是this.a, this -&gt; window, 也就是访问的window.a。对象下面的属性读不到会输出undefined, 尝试下改成console.log(a)~</p></blockquote></details><br><h1 id="this特点-谁调用指向谁-没人调用指向window"><a href="#this特点-谁调用指向谁-没人调用指向window" class="headerlink" title="this特点 谁调用指向谁 没人调用指向window"></a>this特点 谁调用指向谁 没人调用指向window</h1><pre class=" language-js"><code class="language-js">   <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>   <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token punctuation">{</span>       a<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>       init<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">// this.a = 60;</span>               console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>           go<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>           <span class="token keyword">return</span> go<span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">// var p = test.init();</span>   <span class="token comment" spellcheck="true">// p();</span>   <span class="token keyword">new</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 请写出答案 放出注释后 再写出下一版答案</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>20<br></li><li>50<br></li></ol></blockquote><h2 id="放开注释后-答案为"><a href="#放开注释后-答案为" class="headerlink" title="放开注释后 答案为"></a>放开注释后 答案为</h2><blockquote><ol><li>20<br></li><li>60<br></li></ol></blockquote><blockquote><p>注解: 非严格模式下，箭头函数的this永远指向他调用地方的上下文this, (es6对象方法声明函数和箭头函数不能被new调用), test.init中的go方法, 因为没有调用者, this指向window。<br><br></p></blockquote></details><h1 id="补充-gt-箭头函数this指向"><a href="#补充-gt-箭头函数this指向" class="headerlink" title="补充-&gt; 箭头函数this指向"></a>补充-&gt; 箭头函数this指向</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>        a<span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">k</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// fn.apply(obj);</span>    <span class="token comment" spellcheck="true">// fn.call(obj);</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>{a: 2}<br></li><li>{a: 2}<br></li></ol></blockquote><blockquote><p>注解: 非严格模式下，箭头函数的this永远指向他调用地方的上下文this</p></blockquote></details><br><h1 id="new遇到es6函数！！！"><a href="#new遇到es6函数！！！" class="headerlink" title="new遇到es6函数！！！"></a>new遇到es6函数！！！</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>        foo<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'jc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'yd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> f <span class="token operator">=</span> o<span class="token punctuation">.</span>foo<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">new</span> <span class="token class-name">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> o<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">new</span> <span class="token class-name">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>jc<br></li><li>b is not a constructor<br></li></ol></blockquote><blockquote><p>注解: es6对象方法声明方法和箭头函数不能被new调用</p></blockquote></details><br><h1 id="bind-能改变箭头函数的this指向么"><a href="#bind-能改变箭头函数的this指向么" class="headerlink" title="bind 能改变箭头函数的this指向么"></a>bind 能改变箭头函数的this指向么</h1><pre class=" language-js"><code class="language-js">   <span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>        a<span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> fn1 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        k<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span> b<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// k.bind(null)(); </span>    <span class="token punctuation">}</span>    fn1<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>{ a: 2 }<br></li></ol></blockquote><blockquote><p>注解: 箭头函数没有this。</p></blockquote></details><br><h1 id="bind遇到new"><a href="#bind遇到new" class="headerlink" title="bind遇到new"></a>bind遇到new</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>        a<span class="token punctuation">:</span> <span class="token number">30</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">new</span> <span class="token class-name">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>undefined<br></li></ol></blockquote><blockquote><p>注解: new使bind失效。<br>new 绑定 &gt; 显式绑定(bind, apply, call) &gt; 隐式绑定(函数更改this指向) &gt; 默认绑定</p></blockquote></details><br><h1 id="开胃菜"><a href="#开胃菜" class="headerlink" title="开胃菜"></a>开胃菜</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token string">"use strict"</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token string">"use strict"</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>undefined<br></li><li>2<br></li><li>undefined<br></li></ol></blockquote><blockquote><p>注解: 自执行函数的this非严格模式下永远指向window, 严格模式下为undefined, 而没有东西的调用fn2, 因为它没有调用者, fn2内部this指向window, 所以第一题是2, 第二题严格模式下没有window, 所以为undefined;<br>注意严格模式的作用范围, 只是对当前作用域有效。自执行函数的 “use strict”并不会作用到fn2函数内部。</p></blockquote><pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// { a: 3 }</span>    <span class="token comment" spellcheck="true">// window</span></code></pre></details><br><h1 id="原型链权重问题"><a href="#原型链权重问题" class="headerlink" title="原型链权重问题"></a>原型链权重问题</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> c1 <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> c2 <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> c3 <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">'fe'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    c1<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'shunshun'</span><span class="token punctuation">;</span>    c2<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ys'</span><span class="token punctuation">;</span>    c3<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'nice'</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">c1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">c2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">c3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> </code></pre><details><summary> 答案</summary><br><blockquote><ol><li>‘shunshun’<br></li><li>undefined<br></li><li>‘fe’<br></li></ol></blockquote><blockquote><p>注解: 最有意思的是第二个打印的结果, 注意传入的是undefined。</p></blockquote></details><br><h1 id="杂耍"><a href="#杂耍" class="headerlink" title="杂耍"></a>杂耍</h1><pre class=" language-js"><code class="language-js">    <span class="token number">1</span><span class="token punctuation">.</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token number">2</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>     <span class="token number">3</span><span class="token punctuation">.</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token number">4</span><span class="token punctuation">.</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token number">5</span><span class="token punctuation">.</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token number">6</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token number">7</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token number">8</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token number">9</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">;</span>    <span class="token number">10</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">;</span>    <span class="token number">11</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"a"</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>0<br></li><li>“[object Object]”<br></li><li>“1”</li><li>“1[object Object]”</li><li>“NAN”</li><li>“1,2,3[object Object]”</li><li>true</li><li>false</li><li>true</li><li>false</li><li>true</li></ol></blockquote><blockquote><p>注解: </p><blockquote><ol><li>{ } 是空代码块, 什么都没干, 数组隐式调用自身的toString方法, 所以打印1相当于 + ( [].toString() ), 相当于+ “”, + 使”” 转化成整数0, 故为0；</li><li>如上, 这句相当于一个[].toString() + {}.toString(); 相当于”” + “[object Object]”; 故答案为 [object Object]; 这里需要注意的是中括号里的第一个object没有任何意义。仅仅是js为了区分其他类型给的一个标识(typeof显示的)。</li><li>略</li><li>需要注意的是, +”1” = 1; +”” =0; 但是+”1,2” = NAN;</li><li>略</li><li>略<br><br>…</li></ol></blockquote></blockquote></details><br><h1 id="杂耍-1"><a href="#杂耍-1" class="headerlink" title="杂耍"></a>杂耍</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>        m <span class="token operator">=</span> <span class="token punctuation">{</span> v<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token punctuation">{</span> k<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">test</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">alert</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>undefined<br></li></ol></blockquote><blockquote><p>注解: 把test形参m改成n就明白了; 必须滴~ 不解释。</p></blockquote></details><br><h1 id="函数声明提升的范围"><a href="#函数声明提升的范围" class="headerlink" title="函数声明提升的范围"></a>函数声明提升的范围</h1><pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 提升了 值为undefined</span>        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><details><summary> 答案</summary><br><blockquote><ol><li>test is not a function<br></li></ol></blockquote><blockquote><p>注解: 自执行函数在自己内部相当于声明了test, 但是因为逻辑（if (false)）, 导致函数体提升不出来。而在自执行函数里面访问test, 因为找到一个没有赋值的声明, 所以不往上去查找window里的test, 如果改成如下就可以了。</p></blockquote><pre class=" language-js"><code class="language-js">    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        window<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 或者</span>     <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// if (false) {</span>        <span class="token comment" spellcheck="true">//    function test() {</span>        <span class="token comment" spellcheck="true">//        console.log(2);</span>        <span class="token comment" spellcheck="true">//    }</span>        <span class="token comment" spellcheck="true">//  }</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 内部找不到 往父层找 func test</span>        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Js 执行上下文</title>
      <link href="/2017/09/06/js-zhi-xing-shang-xia-wen/"/>
      <url>/2017/09/06/js-zhi-xing-shang-xia-wen/</url>
      
        <content type="html"><![CDATA[<div align="middle"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=407679465&auto=1&height=66"></iframe></div><p>时间过得很快，转眼见算上实习都工作一年有余了，回顾这段历程，还是有很多收获的，特开此博客记录各种心得(不仅限学习哦)。</p><h1 id="ok-谈正事儿"><a href="#ok-谈正事儿" class="headerlink" title="ok 谈正事儿~"></a>ok 谈正事儿~</h1><hr><h1 id="执行上下文栈"><a href="#执行上下文栈" class="headerlink" title="执行上下文栈"></a>执行上下文栈</h1><p>因为 js 是单线程的, 所以它一次只能做一件事情, 而一个 js 文件中会有很多操作, 比如执行全局代码, 函数代码, 每执行一次都会生成多个执行上下文, js 中采用栈的方式来处理它, 大家都知道栈的执行是先进后出(队列是先进先出), 因此全局的执行上下文永远是最底层的，在程序执行完毕的时候出栈。</p><pre class=" language-js"><code class="language-js">    <span class="token operator">&lt;</span>script<span class="token operator">></span>      <span class="token keyword">function</span> Func <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">1</span>           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><html>  <div style="background: rgb(245, 247, 249); padding: 10px; border-radius: 3px; font-size: 13px; color: rgb(49, 49, 49); font-weight: 600; line-height: 30px;">    1. 首先我们把执行上下文栈假设成一个数组,这样比较好理解，当代码还未执行时，执行上下文栈是 [ ]。<br>    2. 执行到 script 标签时, 会生成一个全局环境的执行上线文(globalContext), 压入我们的执行栈 [globalContext] <br>    3. 编译器遇到 Func 函数, 会生成一个执行上下文 FuncContext, 压入执行栈 [FuncContext, globalContext] <br>    4. 执行 Func 函数, 此时的 Func 的执行上下文内部会做一些修改, 后面我们会讨论, 函数执行后, 在栈顶的 FuncContext 会自      &nbsp;&nbsp;&nbsp;&nbsp;动弹出, 栈底的globalContext会到栈顶的位置 <br>    5. 该 js 执行完毕后, globalContext 弹出, 执行上下文栈 被回收, 至此一个完整的 js 走完了。  </div></html><h1 id="执行上下文到底是什么"><a href="#执行上下文到底是什么" class="headerlink" title="执行上下文到底是什么"></a>执行上下文到底是什么</h1><html>  <div style="background: rgb(245, 247, 249); padding: 10px; border-radius: 3px; font-size: 13px; color: rgb(49, 49, 49); font-weight: 600; line-height: 30px;">    一段可以执行的代码在被执行的时候，会创建一个执行上下文, 执行上下文，可以理解为当前代码的执行环境.  </div></html><h1 id="那什么是可以执行的代码呢-？"><a href="#那什么是可以执行的代码呢-？" class="headerlink" title="那什么是可以执行的代码呢 ？"></a>那什么是可以执行的代码呢 ？</h1><html>  <div style="background: rgb(245, 247, 249); padding: 10px; border-radius: 3px; font-size: 13px; color: rgb(49, 49, 49); font-weight: 600; line-height: 30px;">    1. 全局代码(全局环境): 代码首次执行的默认环境, 不包括函数体内的代码, 一旦代码被载入，引擎最先进入的就是这个环境。<br>    2. 函数代码(函数环境): 当函数被调用执行时，会进入当前函数中执行环境。<br>    3. eval(使用较少, 不推荐使用, 这里不做讨论)。<br>  </div></html><h1 id="执行上下文由什么组成"><a href="#执行上下文由什么组成" class="headerlink" title="执行上下文由什么组成?"></a>执行上下文由什么组成?</h1><html>  <div style="background: rgb(245, 247, 249); padding: 10px; border-radius: 3px; font-size: 13px; color: rgb(49, 49, 49); font-weight: 600; line-height: 30px;">    每个执行上下文都有三个重要的属性, 分别是: <br>    1. 变量对象 (Variable object，VO) <br>    2. 作用域链 (Scope chain) <br>    3. this的指向 <br>  </div></html><h1 id="VO-是什么？"><a href="#VO-是什么？" class="headerlink" title="VO 是什么？"></a>VO 是什么？</h1><html>  <div style="background: rgb(245, 247, 249); padding: 10px; border-radius: 3px; font-size: 13px; color: rgb(49, 49, 49); font-weight: 600; line-height: 30px;">    执行上下文在创建的时候会先创建变量对象 vo，VO 保存了函数中的所有形参，实参，局部变量，this 指针等函数执行时的函数内部的数据情况（此时还没有执行代码），在全局执行上下文中叫做变量对象 VO，在函数执行上下文中叫做活动对象 AO，其实两个是一样的，具体如下 <br><br>    1. 函数的形参和实参（如果是函数上下文）    <p style="background: pink; padding: 10px; border-radius: 3px;">       由名称和对应值组成的一个变量对象的属性被创建<br>      没有实参传入，形参就用undefined表示    </p>    2.函数的声明，function fn()    <p style="background: pink; padding: 10px; border-radius: 3px;">       由函数的名称和内容来创建一个变量对象 { fn: function }, 这也是函数声明函数体也会提升的原因。    </p>    3. 变量的声明，如 var a    <p style="background: pink; padding: 10px; border-radius: 3px;">       由名称和 undefined 来创建一个变量对象 { a: undefined }, 变量声明只提升变量的 key, 并赋值为 undefined。    </p>  </div></html><br><html>  <code style="background-color: #fff5f5; color: #ff502c; font-size: 13px; padding: 5px 10px; opacty: .7">    我们还用分析执行上下文栈时的代码改造下来举栗子  </code></html><pre class=" language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">1</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><html>  <div style="padding: 10px; border-radius: 3px; font-size: 13px; color: #fff; font-weight: 600; line-height: 30px;">    函数还没开始执行时候, 此时的 AO(活动对象) 为  </div></html><pre class=" language-js"><code class="language-js">  AO <span class="token operator">=</span> <span class="token punctuation">{</span>    arguments：<span class="token punctuation">{</span>        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        length<span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    a<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    b<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>    c<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>    d<span class="token punctuation">:</span> reference to <span class="token keyword">function</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><html>  <div style="padding: 10px; border-radius: 3px; font-size: 13px; color: #fff; font-weight: 600; line-height: 30px;">    当执行 fn 函数的代码时，AO 会依次赋值,当执行完毕后,此时的 AO  </div></html><pre class=" language-js"><code class="language-js">  AO <span class="token operator">=</span> <span class="token punctuation">{</span>    arguments：<span class="token punctuation">{</span>        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        length<span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    a<span class="token punctuation">:</span> <span class="token number">2</span>    b<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    c<span class="token punctuation">:</span> reference to FunctionExpression <span class="token string">"c"</span>    d<span class="token punctuation">:</span> reference to <span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span> </code></pre><html>  <div style="padding: 10px; border-radius: 3px; font-size: 13px; color: #fff; font-weight: 600; line-height: 30px;">    我们用 AO 对象的变化来演示了执行上下文的活动对象, 小伙伴们明白了么 ?  </div></html>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
